<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Pranav Rajan&#39;s Blog</title>
<link>https://mozartfish.github.io/blog/index.html</link>
<atom:link href="https://mozartfish.github.io/blog/index.xml" rel="self" type="application/rss+xml"/>
<description>This is a blog</description>
<generator>quarto-1.3.450</generator>
<lastBuildDate>Tue, 13 Feb 2024 08:00:00 GMT</lastBuildDate>
<item>
  <title>FastAI Lesson 7: Collaborative Filtering</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/fastai-lesson7/FastAILesson7.html</link>
  <description><![CDATA[ 




<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>All of this code was written by Jeremy Howard and the FastAI Team. I modified it slightly to include my own print statements, comments and additional helper functions based on Jeremy’s code. This is the source for the original code <a href="https://www.kaggle.com/code/jhoward/scaling-up-road-to-the-top-part-3">Scaling Up: Road to the Top, Part 3</a>, <a href="https://www.kaggle.com/code/jhoward/multi-target-road-to-the-top-part-4">Multi-Target: Road to the Top, Part 4</a> and <a href="https://www.kaggle.com/code/jhoward/collaborative-filtering-deep-dive/notebook">Collaborative Filtering Deep Dive</a>.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this lesson, Jeremy explains Collaborative Filtering and its application in <em>recommendation systems</em> and continues the discussion of his process for the <a href="https://www.kaggle.com/competitions/paddy-disease-classification">Paddy Doctor: Paddy Disease Classification</a> challenge. The section on <em>cross-entropy loss</em> was difficult for me but rewatching the cross entropy loss section of the video and reworking the cross entropy loss spreadsheet calculations helped me understand how cross entropy loss works.</p>
</section>
<section id="jeremy-howards-advice" class="level2">
<h2 class="anchored" data-anchor-id="jeremy-howards-advice">Jeremy Howard’s Advice</h2>
<ul>
<li>The stuff that happens in the first layer of the model and the last layer including the loss function that sits between the last layer and the loss are very important in deep learning</li>
</ul>
</section>
<section id="terminology" class="level2">
<h2 class="anchored" data-anchor-id="terminology">Terminology</h2>
<p><strong>Ensemble</strong> - model which is itself the result of combining a number of other models. The simplest way to do ensembling is to take the average of the predictions of each model.</p>
<p><strong>Gradient Accumulation</strong> - rather than updating the model weights after ever batch based on that batch’s gradients, instead keep <em>accumulating</em> (adding) the gradients for a few batches, and thenupdate the model weights with those accumulated gradients.</p>
<p><strong>Collaborative Filtering (Recommendation Systems)</strong> - look at what products the current user has used or liked, find other users that hae used or liked similar products and then recommend other products that those users have used or liked.</p>
<p><strong>Latent Factors</strong> - Find what features matter. In the movie case study, the latent factors are what things matter most to a person when they choose to watch a particular movie.</p>
<p><strong>Embeddings</strong> - special layer in pytorch that indexes into a vector using an integer, and has its derivative calculated in such a way that it is identical to what would have been if it had done a matrix multiplication with a one-hot-encoded vector.</p>
<p><strong>Weight Decay</strong> - weight decay or <code>L2 Regularization</code> is adding to your loss function the sum of all the weights squared. When computing the gradients, this forces the weights to be as small as possibl. This helps prevent overfitting because the larger the coefficients are, the sharper the canyons appear in the loss function</p>
</section>
<section id="cross-entropy-loss" class="level2">
<h2 class="anchored" data-anchor-id="cross-entropy-loss">Cross Entropy Loss</h2>
<p>Cross Entropy Loss is confusing to understand just by looking at the math equations in the <a href="https://pytorch.org/docs/stable/generated/torch.nn.CrossEntropyLoss.html">pytorch documentation</a>. Here I will try my best to explain how it works.</p>
<p>Like the other loss functions Jeremy has talked about cross entropy loss is a loss function we are using to determine how good our model is. In order to compute the cross entropy loss we do the following steps:</p>
<ol type="1">
<li>Compute the SoftMax</li>
<li>Compute the Cross Entropy Loss using the SoftMax</li>
</ol>
<section id="softmax" class="level3">
<h3 class="anchored" data-anchor-id="softmax">SoftMax</h3>
<p>In the FastAI Lesson 7 video, Jeremy uses an example with five different image classes: <strong>cat</strong>, <strong>dog</strong>, <strong>plane</strong>, <strong>fish</strong>, <strong>building</strong> with the goal of predicting whether some image is one of those categories. I will be using the same example.</p>
<p>Given some random weights and after doing some work, the image model will output 5 <code>output</code> values corresponding to the image classes from above:</p>
<p><strong>cat</strong> = -4.89 <strong>dog</strong> = 2.60 <strong>plane</strong> = 0.59 <strong>fish</strong> = -2.07 <strong>building</strong> = -4.57</p>
<p>To use these values in cross entropy loss, they need to be converted to probabilities. <strong>Softmax</strong> is a function that converts numbers to probabilities using the following equation: <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Be%5E%7Bz_%7Bi%7D%7D%7D%7B%5Csum_%7Bj=1%7D%5E%7BK%7De%5E%7Bz_%7Bj%7D%7D%7D"></p>
<p>In the equation, <strong>K</strong> represents the number of categories, <strong>zj</strong> and <strong>zi</strong>represents the output value for the corresponding category. Adding up the softmax results for each category, we get a total of <strong>1.0</strong> because the sum of all probabilities in an experiment is <strong>1.0</strong>.</p>
</section>
<section id="cross-entropy" class="level3">
<h3 class="anchored" data-anchor-id="cross-entropy">Cross Entropy</h3>
<p>The cross entropy function is defined as the following: <img src="https://latex.codecogs.com/png.latex?-%5Csum_%7Bi=1%7D%5E%7BM%7Dy_%7Bi%7D%5Clog%7Bp(y_%7Bi%7D)%7D%20+%20(1%20-%20y_%7Bi%7D)%5Clog(1%20-%20p(y_%7Bi%7D))"></p>
<p>In the equation, <strong>M</strong> represents the number of categories and <strong>yi</strong> represents the category.</p>
<p>Using the probabilities calculated by the softmax function we can simplify the cross entropy function to the following: -sum(<strong>actual target value</strong> * <strong>log(prediction probability)</strong>).</p>
<p>Cross Entropy is finding the probability of the target class where the actual target value is 1 and then taking the log of the probability - where 1 is the correct value and 0 is the incorrect value.</p>
</section>
<section id="binary-cross-entropy" class="level3">
<h3 class="anchored" data-anchor-id="binary-cross-entropy">Binary Cross Entropy</h3>
<p><img src="https://latex.codecogs.com/png.latex?-%5Csum_%7Bi=1%7D%5E%7BN%7Dy_%7Bi%7Dlog(p(y_%7Bi%7D)%20+%20(1%20-%20y_%7Bi%7D)log(1%20-%20p(y_%7Bi%7D))"></p>
<p>In the equation, the <strong>sum</strong> represents the total over the number of trials, <strong>yi</strong> represents the label.</p>
</section>
</section>
<section id="load-data-and-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-data-and-libraries">Load Data and Libraries</h2>
<div class="cell" data-outputid="980a2141-655f-4a3e-fa17-ca19b6a6747a" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import libraries and files</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># required libraries + packages for any ml/data science project</span></span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fastai library contains all the packages above and wraps them in the fastai library</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uqq fastai</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install PyTorch Image Models (TIMM)</span></span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install timm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6.13</span></span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kaggle API package install</span></span>
<span id="cb1-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install kaggle</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install pynvml</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Collecting timm==0.6.13
  Downloading timm-0.6.13-py3-none-any.whl (549 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 549.1/549.1 kB 2.9 MB/s eta 0:00:00
Requirement already satisfied: torch&gt;=1.7 in /usr/local/lib/python3.10/dist-packages (from timm==0.6.13) (2.1.0+cu121)
Requirement already satisfied: torchvision in /usr/local/lib/python3.10/dist-packages (from timm==0.6.13) (0.16.0+cu121)
Requirement already satisfied: pyyaml in /usr/local/lib/python3.10/dist-packages (from timm==0.6.13) (6.0.1)
Requirement already satisfied: huggingface-hub in /usr/local/lib/python3.10/dist-packages (from timm==0.6.13) (0.20.3)
Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm==0.6.13) (3.13.1)
Requirement already satisfied: typing-extensions in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm==0.6.13) (4.9.0)
Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm==0.6.13) (1.12)
Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm==0.6.13) (3.2.1)
Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm==0.6.13) (3.1.3)
Requirement already satisfied: fsspec in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm==0.6.13) (2023.6.0)
Requirement already satisfied: triton==2.1.0 in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm==0.6.13) (2.1.0)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from huggingface-hub-&gt;timm==0.6.13) (2.31.0)
Requirement already satisfied: tqdm&gt;=4.42.1 in /usr/local/lib/python3.10/dist-packages (from huggingface-hub-&gt;timm==0.6.13) (4.66.1)
Requirement already satisfied: packaging&gt;=20.9 in /usr/local/lib/python3.10/dist-packages (from huggingface-hub-&gt;timm==0.6.13) (23.2)
Requirement already satisfied: numpy in /usr/local/lib/python3.10/dist-packages (from torchvision-&gt;timm==0.6.13) (1.25.2)
Requirement already satisfied: pillow!=8.3.*,&gt;=5.3.0 in /usr/local/lib/python3.10/dist-packages (from torchvision-&gt;timm==0.6.13) (9.4.0)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2-&gt;torch&gt;=1.7-&gt;timm==0.6.13) (2.1.5)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;huggingface-hub-&gt;timm==0.6.13) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;huggingface-hub-&gt;timm==0.6.13) (3.6)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;huggingface-hub-&gt;timm==0.6.13) (2.0.7)
Requirement already satisfied: certifi&gt;=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;huggingface-hub-&gt;timm==0.6.13) (2024.2.2)
Requirement already satisfied: mpmath&gt;=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy-&gt;torch&gt;=1.7-&gt;timm==0.6.13) (1.3.0)
Installing collected packages: timm
Successfully installed timm-0.6.13
Requirement already satisfied: kaggle in /usr/local/lib/python3.10/dist-packages (1.5.16)
Requirement already satisfied: six&gt;=1.10 in /usr/local/lib/python3.10/dist-packages (from kaggle) (1.16.0)
Requirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from kaggle) (2024.2.2)
Requirement already satisfied: python-dateutil in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.8.2)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.31.0)
Requirement already satisfied: tqdm in /usr/local/lib/python3.10/dist-packages (from kaggle) (4.66.1)
Requirement already satisfied: python-slugify in /usr/local/lib/python3.10/dist-packages (from kaggle) (8.0.4)
Requirement already satisfied: urllib3 in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.0.7)
Requirement already satisfied: bleach in /usr/local/lib/python3.10/dist-packages (from kaggle) (6.1.0)
Requirement already satisfied: webencodings in /usr/local/lib/python3.10/dist-packages (from bleach-&gt;kaggle) (0.5.1)
Requirement already satisfied: text-unidecode&gt;=1.3 in /usr/local/lib/python3.10/dist-packages (from python-slugify-&gt;kaggle) (1.3)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;kaggle) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;kaggle) (3.6)
Collecting pynvml
  Downloading pynvml-11.5.0-py3-none-any.whl (53 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 53.1/53.1 kB 897.6 kB/s eta 0:00:00
Installing collected packages: pynvml
Successfully installed pynvml-11.5.0</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.imports <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zipfile</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Function for loading kaggle datasets locally or on kaggle</span></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Returns a local path to data files</span></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">- input: Kaggle API Login Credentials, Kaggle Contest Name '''</span></span>
<span id="cb3-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> loadData(creds, dataFile):</span>
<span id="cb3-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable to check whether we're running on kaggle website or not</span></span>
<span id="cb3-11">    iskaggle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.environ.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'KAGGLE_KERNEL_RUN_TYPE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb3-12"></span>
<span id="cb3-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># path for kaggle API credentials</span></span>
<span id="cb3-14">    cred_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'~/.kaggle/kaggle.json'</span>).expanduser()</span>
<span id="cb3-15"></span>
<span id="cb3-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> cred_path.exists():</span>
<span id="cb3-17">        cred_path.parent.mkdir(exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-18">        cred_path.write_text(creds)</span>
<span id="cb3-19">        cred_path.chmod(<span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0o600</span>)</span>
<span id="cb3-20"></span>
<span id="cb3-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from Kaggle to path and extract files at path location</span></span>
<span id="cb3-22"></span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># local machine</span></span>
<span id="cb3-24">    path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(dataFile)</span>
<span id="cb3-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> iskaggle <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> path.exists():</span>
<span id="cb3-26">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> kaggle</span>
<span id="cb3-27">        kaggle.api.competition_download_cli(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(path))</span>
<span id="cb3-28">        zipfile.ZipFile(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.zip'</span>).extractall(path)</span>
<span id="cb3-29"></span>
<span id="cb3-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kaggle</span></span>
<span id="cb3-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> iskaggle:</span>
<span id="cb3-32">        fileName <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'../input/'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dataFile</span>
<span id="cb3-33">        path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fileName</span>
<span id="cb3-34"></span>
<span id="cb3-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> path</span></code></pre></div>
</div>
<div class="cell" data-outputid="331d9a10-dffd-4997-b4a1-8ff823ac5431" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">creds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb4-2">dataFile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'paddy-disease-classification'</span></span>
<span id="cb4-3">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loadData(creds, dataFile)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading paddy-disease-classification.zip to /content
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 1.02G/1.02G [00:14&lt;00:00, 76.2MB/s]</code></pre>
</div>
</div>
<div class="cell" data-outputid="ba07aeae-c4a5-4358-a6ce-085d92d2981c" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check data files</span></span>
<span id="cb7-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span> ls {path}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>sample_submission.csv  test_images  train.csv  train_images</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set up default settings</span></span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings, logging, torch</span>
<span id="cb9-3">warnings.simplefilter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>)</span>
<span id="cb9-4">logging.disable(logging.WARNING)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load data files</span></span>
<span id="cb10-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb10-3">set_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb10-4"></span>
<span id="cb10-5">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>)</span>
<span id="cb10-6">test_files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_image_files(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test_images'</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>()</span></code></pre></div>
</div>
</section>
<section id="paddy-doctor" class="level2">
<h2 class="anchored" data-anchor-id="paddy-doctor">Paddy Doctor</h2>
<section id="part-3" class="level3">
<h3 class="anchored" data-anchor-id="part-3">Part 3</h3>
<section id="memory-gradient-accumulation" class="level4">
<h4 class="anchored" data-anchor-id="memory-gradient-accumulation">Memory + Gradient Accumulation</h4>
<ul>
<li>Goal: Train an ensemble of large models with large inputs</li>
<li>The bottleneck for training such models is GPU memory</li>
<li>Kaggle GPUS have 16280 MiB of available memory</li>
</ul>
<div class="cell" data-outputid="2c6d6f88-2627-4886-ff48-6e9dc8f16e35" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># file count</span></span>
<span id="cb11-2">df.label.value_counts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>normal                      1764
blast                       1738
hispa                       1594
dead_heart                  1442
tungro                      1088
brown_spot                   965
downy_mildew                 620
bacterial_leaf_blight        479
bacterial_leaf_streak        380
bacterial_panicle_blight     337
Name: label, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - bacterial panicle blight has the least files so use that for testing models and images</span></span>
<span id="cb13-2">trn_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train_images'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bacterial_panicle_blight'</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - finetune argument to specify whether to run fine_tune() or the fit_one_cycyle() -&gt; fit_one_cycle()</span></span>
<span id="cb14-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># is faster since it doesn't do an intiial fine-tuning of the head</span></span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - In the finetune function the TTA predictions on the test set are calculated and returned</span></span>
<span id="cb14-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - accum argument is used for calculating gradient accumulation</span></span>
<span id="cb14-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> train(arch, size, item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>), accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>):</span>
<span id="cb14-6">    dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>item,</span>
<span id="cb14-7">        batch_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>size, min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>), bs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span>accum)</span>
<span id="cb14-8">    cbs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> GradientAccumulation(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> accum <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> []</span>
<span id="cb14-9">    learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, arch, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>error_rate, cbs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cbs).to_fp16()</span>
<span id="cb14-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> finetune:</span>
<span id="cb14-11">        learn.fine_tune(epochs, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb14-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> learn.tta(dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dls.test_dl(test_files))</span>
<span id="cb14-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span>:</span>
<span id="cb14-14">        learn.unfreeze()</span>
<span id="cb14-15">        learn.fit_one_cycle(epochs, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span></code></pre></div>
</div>
</section>
<section id="gradient-accumulation" class="level4">
<h4 class="anchored" data-anchor-id="gradient-accumulation">Gradient Accumulation</h4>
<ul>
<li>fastai has a GradientAccumulation parameter that you pass to define how many batches of gradients are accumulated</li>
<li>After adding up all the gradients over accum batches, we need to divide the batch size by that number</li>
<li>the resulting loop is nearly identical to using the original batch size but the amount of memory used is the same as using a batch size <code>accum</code> times smaller</li>
</ul>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># single epoch training loop without gradient accumulation</span></span>
<span id="cb15-2"></span>
<span id="cb15-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for x, y in dl:</span></span>
<span id="cb15-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   calc_loss(coeffs, x, y).backward()</span></span>
<span id="cb15-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   coeffs.data.sub_(coeffs.grad * lr)</span></span>
<span id="cb15-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#   coeffs.grad.zero_()</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gradient accumulation added (assuming a target effective batch size of 64)</span></span>
<span id="cb16-2"></span>
<span id="cb16-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># # number of items seen since last weight update</span></span>
<span id="cb16-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># count = 0</span></span>
<span id="cb16-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for x,y in dl:</span></span>
<span id="cb16-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  # update count based on this minibatch size</span></span>
<span id="cb16-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     count += len(x)</span></span>
<span id="cb16-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     calc_loss(coeffs, x, y).backward()</span></span>
<span id="cb16-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  # count is greater than accumulation target, so do weight update</span></span>
<span id="cb16-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     if count &gt; 64:</span></span>
<span id="cb16-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         coeffs.data.sub_(coeffs.grad * lr)</span></span>
<span id="cb16-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         coeffs.grad.zero_()</span></span>
<span id="cb16-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># # reset count</span></span>
<span id="cb16-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#         count = 0</span></span></code></pre></div>
</div>
</section>
<section id="memory-consumption-analysis" class="level4">
<h4 class="anchored" data-anchor-id="memory-consumption-analysis">Memory Consumption Analysis</h4>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gc</span>
<span id="cb17-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> report_gpu():</span>
<span id="cb17-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(torch.cuda.list_gpu_processes())</span>
<span id="cb17-4">    gc.collect()</span>
<span id="cb17-5">    torch.cuda.empty_cache()</span></code></pre></div>
</div>
<div class="cell" data-outputid="485fb2e6-4502-4116-dbc4-6a88440c3204" data-execution_count="13">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># accum = 1</span></span>
<span id="cb18-2">train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convnext_small_in22k'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb18-3">report_gpu()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://dl.fbaipublicfiles.com/convnext/convnext_small_22k_224.pth" to /root/.cache/torch/hub/checkpoints/convnext_small_22k_224.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>00:08</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU:0
process       4883 uses     3260.000 MB GPU memory</code></pre>
</div>
</div>
<div class="cell" data-outputid="abe6bd3f-f7c0-4af2-b90f-fd04f9669756" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># accum = 2</span></span>
<span id="cb21-2">train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convnext_small_in22k'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb21-3">report_gpu()</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>00:03</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU:0
process       4883 uses     2200.000 MB GPU memory</code></pre>
</div>
</div>
<div class="cell" data-outputid="b2843ee4-b057-481b-dbf8-35e53b3cbeca" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># accum = 4</span></span>
<span id="cb23-2">train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convnext_small_in22k'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb23-3">report_gpu()</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>00:05</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU:0
process       4883 uses     1664.000 MB GPU memory</code></pre>
</div>
</div>
<div class="cell" data-outputid="370c87cf-b20b-4d2e-b3b1-e83319e53250" data-execution_count="16">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convnext large</span></span>
<span id="cb25-2">train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convnext_large_in22k'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">224</span>, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb25-3">report_gpu()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://dl.fbaipublicfiles.com/convnext/convnext_large_22k_224.pth" to /root/.cache/torch/hub/checkpoints/convnext_large_22k_224.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>00:07</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU:0
process       4883 uses    10082.000 MB GPU memory</code></pre>
</div>
</div>
<div class="cell" data-outputid="238a0346-6964-4de7-ca34-60ee542471cc" data-execution_count="17">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convnext_large_in22k'</span>, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">320</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">240</span>), epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb28-2">report_gpu()</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>00:08</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU:0
process       4883 uses    13422.000 MB GPU memory</code></pre>
</div>
</div>
<div class="cell" data-outputid="ae7baef0-f2db-4849-8ae5-0042d80ce837" data-execution_count="18">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># vit_large - close to going over 16280MiB in Kaggle</span></span>
<span id="cb30-2">train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vit_large_patch16_224'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">224</span>, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb30-3">report_gpu()</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU:0
process       4883 uses    14360.000 MB GPU memory</code></pre>
</div>
</div>
<div class="cell" data-outputid="3daa1ca9-8fab-4dcf-c151-a86e4ab91ec4" data-execution_count="19">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># swinv2</span></span>
<span id="cb32-2">train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'swinv2_large_window12_192_22k'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb32-3">report_gpu()</span>
<span id="cb32-4"></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://github.com/SwinTransformer/storage/releases/download/v2.0.0/swinv2_large_patch4_window12_192_22k.pth" to /root/.cache/torch/hub/checkpoints/swinv2_large_patch4_window12_192_22k.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU:0
process       4883 uses    12508.000 MB GPU memory</code></pre>
</div>
</div>
<div class="cell" data-outputid="b63e401c-db11-4731-e4dc-8bbb0d41dd7c" data-execution_count="20">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># swin</span></span>
<span id="cb35-2">train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'swin_large_patch4_window7_224'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">224</span>, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, finetune<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb35-3">report_gpu()</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://github.com/SwinTransformer/storage/releases/download/v1.0.0/swin_large_patch4_window7_224_22kto1k.pth" to /root/.cache/torch/hub/checkpoints/swin_large_patch4_window7_224_22kto1k.pth</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>00:07</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>GPU:0
process       4883 uses    10924.000 MB GPU memory</code></pre>
</div>
</div>
</section>
<section id="experimenting-with-different-models" class="level4">
<h4 class="anchored" data-anchor-id="experimenting-with-different-models">Experimenting with different models</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># image sizes</span></span>
<span id="cb38-2">res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">640</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span></span>
<span id="cb38-3"></span>
<span id="cb38-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># different models</span></span>
<span id="cb38-5">models <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb38-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convnext_large_in22k'</span>: {</span>
<span id="cb38-7">        (Resize(res), (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">320</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">224</span>)),</span>
<span id="cb38-8">    }, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'vit_large_patch16_224'</span>: {</span>
<span id="cb38-9">        (Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">224</span>),</span>
<span id="cb38-10">        (Resize(res), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">224</span>),</span>
<span id="cb38-11">    }, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'swinv2_large_window12_192_22k'</span>: {</span>
<span id="cb38-12">        (Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>),</span>
<span id="cb38-13">        (Resize(res), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>),</span>
<span id="cb38-14">    }, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'swin_large_patch4_window7_224'</span>: {</span>
<span id="cb38-15">        (Resize(res), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">224</span>),</span>
<span id="cb38-16">    }</span>
<span id="cb38-17">}</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># switch to all training images</span></span>
<span id="cb39-2">trn_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train_images'</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="83ae3128-05e4-4707-a9af-6724e67fb5db">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - each model is using different training and validation sets so results are not comparable</span></span>
<span id="cb40-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - append each set of TTA predictions on the test set into the tta_res list</span></span>
<span id="cb40-3">tta_res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb40-4"></span>
<span id="cb40-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> arch,details <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> models.items():</span>
<span id="cb40-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> item,size <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> details:</span>
<span id="cb40-7">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'---'</span>,arch)</span>
<span id="cb40-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(size)</span>
<span id="cb40-9">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(item.name)</span>
<span id="cb40-10">        tta_res.append(train(arch, size, item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>item, accum<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#, epochs=1))</span></span>
<span id="cb40-11">        gc.collect()</span>
<span id="cb40-12">        torch.cuda.empty_cache()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--- convnext_large_in22k
(320, 224)
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}
--- vit_large_patch16_224
224
Resize -- {'size': (480, 480), 'method': 'squish', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}
--- vit_large_patch16_224
224
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}
--- swinv2_large_window12_192_22k
192
Resize -- {'size': (480, 480), 'method': 'squish', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}
--- swinv2_large_window12_192_22k
192
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}
--- swin_large_patch4_window7_224
224
Resize -- {'size': (480, 640), 'method': 'crop', 'pad_mode': 'reflection', 'resamples': (&lt;Resampling.BILINEAR: 2&gt;, &lt;Resampling.NEAREST: 0&gt;), 'p': 1.0}</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.858722</td>
<td>0.499460</td>
<td>0.165786</td>
<td>03:24</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.385716</td>
<td>0.208010</td>
<td>0.061509</td>
<td>04:33</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.310007</td>
<td>0.212928</td>
<td>0.061028</td>
<td>04:31</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.351554</td>
<td>0.228603</td>
<td>0.066314</td>
<td>04:28</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.221846</td>
<td>0.182669</td>
<td>0.054301</td>
<td>04:27</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.153551</td>
<td>0.156956</td>
<td>0.045171</td>
<td>04:29</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.149726</td>
<td>0.149253</td>
<td>0.037001</td>
<td>04:27</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.090776</td>
<td>0.127437</td>
<td>0.031235</td>
<td>04:26</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.081606</td>
<td>0.115022</td>
<td>0.028832</td>
<td>04:30</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.044530</td>
<td>0.108681</td>
<td>0.023546</td>
<td>04:26</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.035370</td>
<td>0.105452</td>
<td>0.023546</td>
<td>04:25</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.022027</td>
<td>0.110059</td>
<td>0.023546</td>
<td>04:25</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.023722</td>
<td>0.106580</td>
<td>0.022585</td>
<td>04:25</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.004288</td>
<td>0.582304</td>
<td>0.187890</td>
<td>03:54</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.384640</td>
<td>0.259779</td>
<td>0.074003</td>
<td>05:11</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.352266</td>
<td>0.273039</td>
<td>0.075925</td>
<td>05:14</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.378463</td>
<td>0.300954</td>
<td>0.073522</td>
<td>05:10</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.246590</td>
<td>0.394313</td>
<td>0.087458</td>
<td>05:04</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.241524</td>
<td>0.235776</td>
<td>0.061509</td>
<td>05:04</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.139398</td>
<td>0.231180</td>
<td>0.061989</td>
<td>05:04</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.114390</td>
<td>0.198267</td>
<td>0.042287</td>
<td>05:04</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.079242</td>
<td>0.174894</td>
<td>0.035079</td>
<td>05:13</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.040460</td>
<td>0.150516</td>
<td>0.028352</td>
<td>05:14</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.035262</td>
<td>0.140247</td>
<td>0.029313</td>
<td>05:09</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.032867</td>
<td>0.124250</td>
<td>0.025469</td>
<td>05:01</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.019166</td>
<td>0.123131</td>
<td>0.024027</td>
<td>05:02</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.945174</td>
<td>0.587339</td>
<td>0.188852</td>
<td>03:56</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.431525</td>
<td>0.264968</td>
<td>0.085536</td>
<td>05:07</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.373674</td>
<td>0.285950</td>
<td>0.083133</td>
<td>05:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.294009</td>
<td>0.283589</td>
<td>0.075925</td>
<td>05:06</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.283224</td>
<td>0.297093</td>
<td>0.083133</td>
<td>05:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.196644</td>
<td>0.185746</td>
<td>0.048054</td>
<td>05:09</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.153443</td>
<td>0.165554</td>
<td>0.037963</td>
<td>05:15</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.122116</td>
<td>0.162079</td>
<td>0.039885</td>
<td>05:22</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.105744</td>
<td>0.148939</td>
<td>0.036040</td>
<td>05:13</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.073754</td>
<td>0.101312</td>
<td>0.024988</td>
<td>05:07</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.038434</td>
<td>0.106780</td>
<td>0.021624</td>
<td>05:04</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.034042</td>
<td>0.098371</td>
<td>0.019222</td>
<td>05:11</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.022197</td>
<td>0.096102</td>
<td>0.020183</td>
<td>05:12</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.941143</td>
<td>0.501398</td>
<td>0.165786</td>
<td>03:40</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.438842</td>
<td>0.208749</td>
<td>0.061028</td>
<td>04:25</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.355431</td>
<td>0.220552</td>
<td>0.061509</td>
<td>04:33</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.349027</td>
<td>0.397794</td>
<td>0.120135</td>
<td>04:35</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.293179</td>
<td>0.189101</td>
<td>0.053820</td>
<td>04:41</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.206543</td>
<td>0.163805</td>
<td>0.046612</td>
<td>04:40</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.186177</td>
<td>0.128186</td>
<td>0.035560</td>
<td>04:41</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.113470</td>
<td>0.114702</td>
<td>0.025949</td>
<td>04:24</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.112366</td>
<td>0.092310</td>
<td>0.024988</td>
<td>04:24</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.074616</td>
<td>0.091132</td>
<td>0.021144</td>
<td>04:25</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.042644</td>
<td>0.079768</td>
<td>0.020663</td>
<td>04:24</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.042276</td>
<td>0.080345</td>
<td>0.019222</td>
<td>04:24</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.035028</td>
<td>0.081594</td>
<td>0.020183</td>
<td>04:24</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.965668</td>
<td>0.443010</td>
<td>0.141278</td>
<td>03:42</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.448268</td>
<td>0.263037</td>
<td>0.083133</td>
<td>04:27</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.355133</td>
<td>0.252433</td>
<td>0.081211</td>
<td>04:26</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.333021</td>
<td>0.213186</td>
<td>0.064873</td>
<td>04:28</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.278992</td>
<td>0.219155</td>
<td>0.066314</td>
<td>04:26</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.204435</td>
<td>0.168250</td>
<td>0.053820</td>
<td>04:26</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.180749</td>
<td>0.170310</td>
<td>0.045171</td>
<td>04:25</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.143278</td>
<td>0.142150</td>
<td>0.032196</td>
<td>04:25</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.100807</td>
<td>0.110142</td>
<td>0.026910</td>
<td>04:27</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.051518</td>
<td>0.101470</td>
<td>0.023546</td>
<td>04:24</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.039993</td>
<td>0.097524</td>
<td>0.025469</td>
<td>04:25</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.035260</td>
<td>0.094065</td>
<td>0.020183</td>
<td>04:25</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.036998</td>
<td>0.096248</td>
<td>0.020663</td>
<td>04:25</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.966472</td>
<td>0.521585</td>
<td>0.164344</td>
<td>03:16</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      33.33% [4/12 15:46&lt;31:32]
    </div>
    

<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.409947</td>
<td>0.254923</td>
<td>0.073522</td>
<td>03:56</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.363681</td>
<td>0.227124</td>
<td>0.070639</td>
<td>03:56</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.361192</td>
<td>0.202026</td>
<td>0.065834</td>
<td>03:56</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.276248</td>
<td>0.296600</td>
<td>0.083614</td>
<td>03:56</td>
</tr>
</tbody>
</table>
<p>

    </p><div>
      <progress value="50" class="" max="260" style="width:300px; height:20px; vertical-align: middle;"></progress>
      19.23% [50/260 00:41&lt;02:55 0.2991]
    </div>
    
</div>
</div>
</section>
<section id="ensembling-all-the-models" class="level4">
<h4 class="anchored" data-anchor-id="ensembling-all-the-models">Ensembling all the models</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># save all results</span></span>
<span id="cb42-2">save_pickle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tta_res.pkl'</span>, tta_res)</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Learner.tta returns predictions and targets for each row</span></span>
<span id="cb43-2"></span>
<span id="cb43-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get predictions</span></span>
<span id="cb43-4">tta_prs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> first(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>tta_res))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Jeremy's experiments and research figured out that vit was a better than all the other models</span></span>
<span id="cb44-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Based on the experiments, vit has double the weight in the ensemble</span></span>
<span id="cb44-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - vit double weight -&gt; add vit results to the ensemble (or compute a weighted average)</span></span>
<span id="cb44-4">tta_prs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> tta_prs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - ensemble: a model which is itself the result of combining a number of other models</span></span>
<span id="cb45-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - simplest way of ensembling is to take the average of the predictions of each model</span></span>
<span id="cb45-3">avg_pr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack(tta_prs).mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb45-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"avg prediction shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>avg_pr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb45-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"avg prediction rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(avg_pr.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
</div>
</section>
<section id="submission" class="level4">
<h4 class="anchored" data-anchor-id="submission">Submission</h4>
<div class="cell">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>),</span>
<span id="cb46-2">    batch_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">224</span>, min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))</span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1">idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> avg_pr.argmax(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb47-2">vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(dls.vocab)</span>
<span id="cb47-3">sample_sub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_submission.csv'</span>)</span>
<span id="cb47-4">sample_sub[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vocab[idxs]</span>
<span id="cb47-5">sample_sub.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'part3_subm.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb47-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head part3_subm.csv</span></code></pre></div>
</div>
</section>
</section>
<section id="part-4" class="level3">
<h3 class="anchored" data-anchor-id="part-4">Part 4</h3>
<ul>
<li>predict what disease the rice paddy has AND what kind of rice is shown</li>
</ul>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load data files</span></span>
<span id="cb48-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb48-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastcore.parallel <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb48-4">set_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb48-5"></span>
<span id="cb48-6">trn_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train_images'</span></span>
<span id="cb48-7">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>, index_col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image_id'</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="2040d430-6e98-4e55-8dc2-f87f4709b6de" data-execution_count="22">
<div class="sourceCode cell-code" id="cb49" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data summary</span></span>
<span id="cb49-2">df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">

  <div id="df-c55bfb58-4a05-487e-8e46-b99a9281a39c" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">variety</th>
<th data-quarto-table-cell-role="th">age</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">image_id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">100330.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">100365.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">100382.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">100632.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">101918.jpg</td>
<td>bacterial_leaf_blight</td>
<td>ADT45</td>
<td>45</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-c55bfb58-4a05-487e-8e46-b99a9281a39c')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-c55bfb58-4a05-487e-8e46-b99a9281a39c button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-c55bfb58-4a05-487e-8e46-b99a9281a39c');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-2db479e0-a9be-48a8-b87b-48c07ae76a0d">
  <button class="colab-df-quickchart" onclick="quickchart('df-2db479e0-a9be-48a8-b87b-48c07ae76a0d')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-2db479e0-a9be-48a8-b87b-48c07ae76a0d button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="71608df6-8b27-4770-873a-c798fe8f2a79" data-execution_count="23">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - get rice variety from rice image data</span></span>
<span id="cb50-2">df.loc[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'100330.jpg'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'variety'</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>'ADT45'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rice variety helper function</span></span>
<span id="cb52-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_variety(p):</span>
<span id="cb52-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> df.loc[p.name, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'variety'</span>]</span></code></pre></div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dataloader + Datablock setup</span></span>
<span id="cb53-2">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataBlock(</span>
<span id="cb53-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - create an image(contents of file), 2 categorical variables(disease and variety)</span></span>
<span id="cb53-4">    blocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(ImageBlock,CategoryBlock,CategoryBlock),</span>
<span id="cb53-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 1 input(the image), 2 outputs(disease category, variety category)</span></span>
<span id="cb53-6">    n_inp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb53-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - get list of inputs (image files)</span></span>
<span id="cb53-8">    get_items<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>get_image_files,</span>
<span id="cb53-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - create the outputs for each image file (parent image label, variety(from variety function))</span></span>
<span id="cb53-10">    get_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [parent_label,get_variety],</span>
<span id="cb53-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - split data into 80% training, 20% validation</span></span>
<span id="cb53-12">    splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RandomSplitter(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>),</span>
<span id="cb53-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - batch transforms</span></span>
<span id="cb53-14">    item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>),</span>
<span id="cb53-15">    batch_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>)</span>
<span id="cb53-16">).dataloaders(trn_path)</span></code></pre></div>
</div>
<div class="cell" data-outputid="5cd40cec-d31d-4789-a8e7-3c18b58d9c40" data-execution_count="26">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch analysis</span></span>
<span id="cb54-2">dls.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson7/FastAILesson7_files/figure-html/cell-36-output-1.png" class="img-fluid"></p>
</div>
</div>
<section id="disease-model" class="level4">
<h4 class="anchored" data-anchor-id="disease-model">Disease Model</h4>
<ul>
<li>metric and loss function will take three inputs:</li>
</ul>
<ol type="1">
<li>model outputs(metric and loss function inputs)</li>
<li>two targets (disease and variety)</li>
</ol>
<section id="metric-loss-functions" class="level5">
<h5 class="anchored" data-anchor-id="metric-loss-functions">Metric + Loss Functions</h5>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># metric and loss functions</span></span>
<span id="cb55-2"></span>
<span id="cb55-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># metric function</span></span>
<span id="cb55-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> disease_err(inp,disease,variety):</span>
<span id="cb55-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> error_rate(inp,disease)</span>
<span id="cb55-6"></span>
<span id="cb55-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function - cross entropy</span></span>
<span id="cb55-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> disease_loss(inp,disease,variety):</span>
<span id="cb55-9">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> F.cross_entropy(inp,disease)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># learner setup</span></span>
<span id="cb56-2">arch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convnext_small_in22k'</span></span>
<span id="cb56-3">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, arch, loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>disease_loss, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>disease_err, n_out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>).to_fp16()</span>
<span id="cb56-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># learning rate</span></span>
<span id="cb56-5">lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="b03f1a47-10bd-4848-9929-8e6d8bac9fc9" data-execution_count="29">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train and fine tune model</span></span>
<span id="cb57-2">learn.fine_tune(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, lr)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">disease_err</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.295816</td>
<td>0.941801</td>
<td>0.281115</td>
<td>01:24</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">disease_err</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.641056</td>
<td>0.494316</td>
<td>0.152331</td>
<td>01:23</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.466232</td>
<td>0.332578</td>
<td>0.095147</td>
<td>01:25</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.304405</td>
<td>0.187158</td>
<td>0.059587</td>
<td>01:24</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.170902</td>
<td>0.167094</td>
<td>0.048054</td>
<td>01:24</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.126892</td>
<td>0.147188</td>
<td>0.038924</td>
<td>01:24</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="multi-target-model" class="level4">
<h4 class="anchored" data-anchor-id="multi-target-model">Multi-Target Model</h4>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - to predict probability of disease and variety we need model to output a tensor of length 20</span></span>
<span id="cb58-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10 possible diseases, 10 possible varities -&gt; n_out=20 sets this up</span></span>
<span id="cb58-3">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, arch, n_out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>).to_fp16()</span></code></pre></div>
</div>
<section id="metric-loss-functions-1" class="level5">
<h5 class="anchored" data-anchor-id="metric-loss-functions-1">Metric + Loss Functions</h5>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss functions</span></span>
<span id="cb59-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - input tensor is length 20 but need to use first 10 values for disease</span></span>
<span id="cb59-3"></span>
<span id="cb59-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># disease loss</span></span>
<span id="cb59-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> disease_loss(inp, disease, variety):</span>
<span id="cb59-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> F.cross_entropy(inp[:,:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>],disease)</span>
<span id="cb59-7"></span>
<span id="cb59-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variety loss</span></span>
<span id="cb59-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> variety_loss(inp,disease,variety):</span>
<span id="cb59-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> F.cross_entropy(inp[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:],variety)</span>
<span id="cb59-11"></span>
<span id="cb59-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># total loss</span></span>
<span id="cb59-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> combine_loss(inp,disease,variety):</span>
<span id="cb59-14">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> disease_loss(inp,disease,variety) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> variety_loss(inp,disease,variety)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># error rate functions</span></span>
<span id="cb60-2"></span>
<span id="cb60-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># disease metric</span></span>
<span id="cb60-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> disease_err(inp,disease,variety):</span>
<span id="cb60-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> error_rate(inp[:,:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>],disease)</span>
<span id="cb60-6"></span>
<span id="cb60-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variety metric</span></span>
<span id="cb60-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> variety_err(inp,disease,variety):</span>
<span id="cb60-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> error_rate(inp[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:],variety)</span>
<span id="cb60-10"></span>
<span id="cb60-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all error rate</span></span>
<span id="cb60-12">err_metrics <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (disease_err, variety_err)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># all metrics</span></span>
<span id="cb61-2">all_metrics <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> err_metrics <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (disease_loss,variety_loss)</span></code></pre></div>
</div>
</section>
<section id="train-model" class="level5">
<h5 class="anchored" data-anchor-id="train-model">Train Model</h5>
<div class="cell" data-outputid="ee34de3c-b3cf-4fd2-bb32-2b7ae4e7d400" data-execution_count="34">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train learner and finetune</span></span>
<span id="cb62-2">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, arch, loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>combine_loss, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>all_metrics, n_out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>).to_fp16()</span>
<span id="cb62-3">learn.fine_tune(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, lr)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">disease_err</th>
<th data-quarto-table-cell-role="th">variety_err</th>
<th data-quarto-table-cell-role="th">disease_loss</th>
<th data-quarto-table-cell-role="th">variety_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.307458</td>
<td>1.334855</td>
<td>0.288323</td>
<td>0.133109</td>
<td>0.893397</td>
<td>0.441458</td>
<td>01:19</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">disease_err</th>
<th data-quarto-table-cell-role="th">variety_err</th>
<th data-quarto-table-cell-role="th">disease_loss</th>
<th data-quarto-table-cell-role="th">variety_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.010617</td>
<td>0.681740</td>
<td>0.154253</td>
<td>0.062951</td>
<td>0.472450</td>
<td>0.209290</td>
<td>01:25</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.763498</td>
<td>0.449330</td>
<td>0.101874</td>
<td>0.046132</td>
<td>0.312340</td>
<td>0.136990</td>
<td>01:33</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.470782</td>
<td>0.310100</td>
<td>0.066314</td>
<td>0.030274</td>
<td>0.220500</td>
<td>0.089600</td>
<td>01:28</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.289418</td>
<td>0.217040</td>
<td>0.044210</td>
<td>0.018260</td>
<td>0.155922</td>
<td>0.061118</td>
<td>01:29</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.204842</td>
<td>0.204496</td>
<td>0.042287</td>
<td>0.017299</td>
<td>0.155690</td>
<td>0.048806</td>
<td>01:26</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
</section>
</section>
<section id="collaborative-filtering-deep-dive" class="level2">
<h2 class="anchored" data-anchor-id="collaborative-filtering-deep-dive">Collaborative Filtering Deep Dive</h2>
<section id="load-data-set-up" class="level3">
<h3 class="anchored" data-anchor-id="load-data-set-up">Load Data + Set Up</h3>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set up some stuff</span></span>
<span id="cb63-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.collab <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb63-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.tabular.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb63-4">set_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="9a3a76a6-f621-47b1-c86e-3e05331466b8" data-execution_count="36">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># movie dataset</span></span>
<span id="cb64-2">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> untar_data(URLs.ML_100k)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="4931584" class="" max="4924029" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.15% [4931584/4924029 00:00&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load data files</span></span>
<span id="cb65-2">ratings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'u.data'</span>, delimiter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\t</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'user'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'movie'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rating'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'timestamp'</span>])</span></code></pre></div>
</div>
</section>
<section id="exploratory-data-analysis" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h3>
<div class="cell" data-outputid="20aabee1-d645-4ce3-d9ec-a50d1e79648c" data-execution_count="38">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># exploratory analysis</span></span>
<span id="cb66-2">ratings.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="38">

  <div id="df-beb1b27d-2a09-4b1b-948e-ad6c0c1730ec" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">timestamp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>196</td>
<td>242</td>
<td>3</td>
<td>881250949</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>186</td>
<td>302</td>
<td>3</td>
<td>891717742</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>22</td>
<td>377</td>
<td>1</td>
<td>878887116</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>244</td>
<td>51</td>
<td>2</td>
<td>880606923</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>166</td>
<td>346</td>
<td>1</td>
<td>886397596</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-beb1b27d-2a09-4b1b-948e-ad6c0c1730ec')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-beb1b27d-2a09-4b1b-948e-ad6c0c1730ec button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-beb1b27d-2a09-4b1b-948e-ad6c0c1730ec');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-f8494916-cf2d-4876-88e7-8005c3bd1886">
  <button class="colab-df-quickchart" onclick="quickchart('df-f8494916-cf2d-4876-88e7-8005c3bd1886')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-f8494916-cf2d-4876-88e7-8005c3bd1886 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
</section>
<section id="experiments" class="level3">
<h3 class="anchored" data-anchor-id="experiments">Experiments</h3>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very science fiction = 0.98</span></span>
<span id="cb67-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very action = 0.9</span></span>
<span id="cb67-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very not as old = -0.9</span></span>
<span id="cb67-4">last_skywalker <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.98</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>])</span></code></pre></div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># user who likes modern sci-fi movies</span></span>
<span id="cb68-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very science fiction = 0.9</span></span>
<span id="cb68-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very action = 0.8</span></span>
<span id="cb68-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very not as old = -0.6</span></span>
<span id="cb68-5">user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>])</span></code></pre></div>
</div>
<div class="cell" data-outputid="749a0d87-2553-4fb2-bf9d-54d9b4662839" data-execution_count="41">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># match between lastskywalker and user1</span></span>
<span id="cb69-2">(user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> last_skywalker).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>2.1420000000000003</code></pre>
</div>
</div>
<div class="cell" data-outputid="a3654340-e7dc-4d1f-9541-cef5af2d0085" data-execution_count="42">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very science fiction = -0.99</span></span>
<span id="cb71-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very action = -0.3</span></span>
<span id="cb71-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - very not as old = 0.8</span></span>
<span id="cb71-4">casablanca <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.99</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>])</span>
<span id="cb71-5"></span>
<span id="cb71-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># match between casablanca and user</span></span>
<span id="cb71-7">(user1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> casablanca).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>-1.611</code></pre>
</div>
</div>
</section>
<section id="learning-latent-factors" class="level3">
<h3 class="anchored" data-anchor-id="learning-latent-factors">Learning Latent Factors</h3>
<ul>
<li>gradient descent can be used to learn the latent factors</li>
</ul>
<ol type="1">
<li>randomly initialize some parameters. parameters will be a set of latent factors for each user and movie</li>
<li>calculate predictions. take dot product of each movie and user. High number represents match, low number represents mismatch</li>
<li>calculate loss. mean square error is good for representing accuracy of a prediction</li>
</ol>
<div class="cell" data-outputid="748f4c64-c769-48ec-b1fb-25ecb5543fdb" data-execution_count="43">
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># movie data</span></span>
<span id="cb73-2">movies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'u.item'</span>,  delimiter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'|'</span>, encoding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'latin-1'</span>,</span>
<span id="cb73-3">                     usecols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'movie'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>), header<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb73-4">movies.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">

  <div id="df-10d34b59-8c90-4a6d-a0d8-f8d7ec7ff749" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">title</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>Toy Story (1995)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>GoldenEye (1995)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>Four Rooms (1995)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>Get Shorty (1995)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>Copycat (1995)</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-10d34b59-8c90-4a6d-a0d8-f8d7ec7ff749')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-10d34b59-8c90-4a6d-a0d8-f8d7ec7ff749 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-10d34b59-8c90-4a6d-a0d8-f8d7ec7ff749');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-d5fb7dfe-86a2-4cbb-9e89-a80a226e7900">
  <button class="colab-df-quickchart" onclick="quickchart('df-d5fb7dfe-86a2-4cbb-9e89-a80a226e7900')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-d5fb7dfe-86a2-4cbb-9e89-a80a226e7900 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="60ce700e-0bdd-4176-8646-7288441eab78" data-execution_count="44">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># movie + rating data</span></span>
<span id="cb74-2">ratings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ratings.merge(movies)</span>
<span id="cb74-3">ratings.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">

  <div id="df-a65aac4c-3906-4aa9-82ee-ebf7c1900dbb" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">timestamp</th>
<th data-quarto-table-cell-role="th">title</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>196</td>
<td>242</td>
<td>3</td>
<td>881250949</td>
<td>Kolya (1996)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>63</td>
<td>242</td>
<td>3</td>
<td>875747190</td>
<td>Kolya (1996)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>226</td>
<td>242</td>
<td>5</td>
<td>883888671</td>
<td>Kolya (1996)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>154</td>
<td>242</td>
<td>3</td>
<td>879138235</td>
<td>Kolya (1996)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>306</td>
<td>242</td>
<td>5</td>
<td>876503793</td>
<td>Kolya (1996)</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-a65aac4c-3906-4aa9-82ee-ebf7c1900dbb')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-a65aac4c-3906-4aa9-82ee-ebf7c1900dbb button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-a65aac4c-3906-4aa9-82ee-ebf7c1900dbb');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-e3dc893c-d281-4ea4-9269-f1774d1efc06">
  <button class="colab-df-quickchart" onclick="quickchart('df-e3dc893c-d281-4ea4-9269-f1774d1efc06')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-e3dc893c-d281-4ea4-9269-f1774d1efc06 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="c8a31a13-0845-40d7-a59b-89fd81900aa9" data-execution_count="45">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dataloaders</span></span>
<span id="cb75-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - first column is for the user</span></span>
<span id="cb75-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - second column is for the item (movies)</span></span>
<span id="cb75-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - third column is for the rating</span></span>
<span id="cb75-5">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CollabDataLoaders.from_df(ratings, item_name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>, bs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb75-6">dls.show_batch()</span></code></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>542</td>
<td>My Left Foot (1989)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>422</td>
<td>Event Horizon (1997)</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>311</td>
<td>African Queen, The (1951)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>595</td>
<td>Face/Off (1997)</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>617</td>
<td>Evil Dead II (1987)</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>158</td>
<td>Jurassic Park (1993)</td>
<td>5</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>836</td>
<td>Chasing Amy (1997)</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>474</td>
<td>Emma (1996)</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>466</td>
<td>Jackie Chan's First Strike (1996)</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>554</td>
<td>Scream (1996)</td>
<td>3</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># represent movie and user late factor table as matrices</span></span>
<span id="cb76-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - result = index of the move in movie latent factor matrix * index of the user in user late factor matrix</span></span>
<span id="cb76-3">n_users  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dls.classes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'user'</span>])</span>
<span id="cb76-4">n_movies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dls.classes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>])</span>
<span id="cb76-5">n_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb76-6">user_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(n_users, n_factors)</span>
<span id="cb76-7">movie_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(n_movies, n_factors)</span></code></pre></div>
</div>
</section>
<section id="embeddings" class="level3">
<h3 class="anchored" data-anchor-id="embeddings">Embeddings</h3>
<div class="cell" data-outputid="aedd8ff1-62d1-42ca-fe47-95703f981ae6" data-execution_count="47">
<div class="sourceCode cell-code" id="cb77" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># convert index lookup to matrix product</span></span>
<span id="cb77-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - replace indices with one-hot encoded vectors</span></span>
<span id="cb77-3"></span>
<span id="cb77-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># multiply a vector by a one hot-encoded vector representing index 3</span></span>
<span id="cb77-5">one_hot_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> one_hot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, n_users).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span>
<span id="cb77-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"dot product of user factors and one-hot encoded three: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>user_factors<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>t() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> one_hot_3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb77-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"vector at index 3 in user factor matrix: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>user_factors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>dot product of user factors and one-hot encoded three: tensor([-0.4586, -0.9915, -0.4052, -0.3621, -0.5908])
vector at index 3 in user factor matrix: tensor([-0.4586, -0.9915, -0.4052, -0.3621, -0.5908])</code></pre>
</div>
</div>
</section>
<section id="collaborative-filtering-from-scratch" class="level3">
<h3 class="anchored" data-anchor-id="collaborative-filtering-from-scratch">Collaborative Filtering From Scratch</h3>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dot Product Class</span></span>
<span id="cb79-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> DotProduct(Module):</span>
<span id="cb79-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n_users, n_movies, n_factors):</span>
<span id="cb79-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(n_users, n_factors)</span>
<span id="cb79-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb79-6"></span>
<span id="cb79-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb79-8">        users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb79-9">        movies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_factors(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb79-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> movies).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="25ceea6b-56a3-4d8c-e938-b5087f5c9873" data-execution_count="49">
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  - input of the model is a tensor of shape batch_size x 2</span></span>
<span id="cb80-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - first column x[:0] contains user IDS</span></span>
<span id="cb80-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - second column x[:1] contains movie IDS</span></span>
<span id="cb80-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - embedding layers represent matrices of user and movie latent factors</span></span>
<span id="cb80-5">x,y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dls.one_batch()</span>
<span id="cb80-6">x.shape</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>torch.Size([64, 2])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DotProduct(n_users, n_movies, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb82-2">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, model, loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MSELossFlat())</span></code></pre></div>
</div>
<div class="cell" data-outputid="ea2ec440-a22f-4368-bce4-b057d5120569" data-execution_count="51">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train model</span></span>
<span id="cb83-2">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.344786</td>
<td>1.279100</td>
<td>00:08</td>
</tr>
<tr class="even">
<td>1</td>
<td>1.093331</td>
<td>1.109981</td>
<td>00:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.958258</td>
<td>0.990199</td>
<td>00:08</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.814234</td>
<td>0.894916</td>
<td>00:08</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.780714</td>
<td>0.882022</td>
<td>00:08</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># force predictions to be between 0 and 5 (match the reviews)</span></span>
<span id="cb84-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - good to have range go a bit over 5</span></span>
<span id="cb84-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> DotProduct(Module):</span>
<span id="cb84-4">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n_users, n_movies, n_factors, y_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span>)):</span>
<span id="cb84-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(n_users, n_factors)</span>
<span id="cb84-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb84-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_range</span>
<span id="cb84-8"></span>
<span id="cb84-9">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb84-10">        users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb84-11">        movies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_factors(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb84-12">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sigmoid_range((users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> movies).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_range)</span></code></pre></div>
</div>
<div class="cell" data-outputid="31ef6653-879e-4df2-aaa4-04784e66628c" data-execution_count="53">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train model</span></span>
<span id="cb85-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DotProduct(n_users, n_movies, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb85-3">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, model, loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MSELossFlat())</span>
<span id="cb85-4">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.986799</td>
<td>1.005294</td>
<td>00:08</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.878134</td>
<td>0.918898</td>
<td>00:08</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.675850</td>
<td>0.875467</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.483372</td>
<td>0.877939</td>
<td>00:08</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.378927</td>
<td>0.881887</td>
<td>00:08</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="dot-product-bias" class="level3">
<h3 class="anchored" data-anchor-id="dot-product-bias">Dot Product + Bias</h3>
<ul>
<li>some users are more positive or negative in their recommendations than others, and some movies are better or worse than others</li>
<li>the dot product representation from above does not encode this information</li>
</ul>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># add biases</span></span>
<span id="cb86-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> DotProductBias(Module):</span>
<span id="cb86-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n_users, n_movies, n_factors, y_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span>)):</span>
<span id="cb86-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(n_users, n_factors)</span>
<span id="cb86-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(n_users, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb86-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(n_movies, n_factors)</span>
<span id="cb86-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(n_movies, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb86-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_range</span>
<span id="cb86-9"></span>
<span id="cb86-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb86-11">        users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb86-12">        movies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_factors(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb86-13">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> movies).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, keepdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb86-14">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_bias(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_bias(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb86-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sigmoid_range(res, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_range)</span></code></pre></div>
</div>
<div class="cell" data-outputid="10d61429-954a-4a44-8d04-50a2a9de57c3" data-execution_count="55">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train model</span></span>
<span id="cb87-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DotProductBias(n_users, n_movies, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb87-3">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, model, loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MSELossFlat())</span>
<span id="cb87-4">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.938634</td>
<td>0.952516</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.846664</td>
<td>0.865633</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.608090</td>
<td>0.865127</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.413482</td>
<td>0.887318</td>
<td>00:08</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.286971</td>
<td>0.894876</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="weight-decay" class="level3">
<h3 class="anchored" data-anchor-id="weight-decay">Weight Decay</h3>
<div class="cell" data-outputid="7c271d9b-c24a-4cfe-943d-17655b6c4715" data-execution_count="56">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Weight decay with parabola</span></span>
<span id="cb88-2">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb88-3">a_s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>]</span>
<span id="cb88-4">ys <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> a <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> a_s]</span>
<span id="cb88-5">_,ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb88-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> a,y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(a_s,ys): ax.plot(x,y, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'a=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb88-7">ax.set_ylim([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>])</span>
<span id="cb88-8">ax.legend()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>&lt;matplotlib.legend.Legend at 0x7ab900191d50&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson7/FastAILesson7_files/figure-html/cell-66-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="3ae69232-833f-476a-cb7d-cd61f3139346" data-execution_count="57">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train movie model with weight decay parameter</span></span>
<span id="cb90-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - weight decay is parameter that controls the sum of squares added to loss function</span></span>
<span id="cb90-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - in practice it is very inefficient (and potentially numerically unstable) to compute large sums and add them to the loss</span></span>
<span id="cb90-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - fastai sets weight decay with weight decay parameter</span></span>
<span id="cb90-5">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DotProductBias(n_users, n_movies, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb90-6">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, model, loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MSELossFlat())</span>
<span id="cb90-7">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>, wd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.932776</td>
<td>0.961672</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.888625</td>
<td>0.882614</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.771066</td>
<td>0.832743</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.599807</td>
<td>0.822374</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.504981</td>
<td>0.822528</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="embeddings-from-scratch" class="level3">
<h3 class="anchored" data-anchor-id="embeddings-from-scratch">Embeddings from Scratch</h3>
<div class="cell" data-outputid="26393db1-8214-486c-dc46-deed98937fdf" data-execution_count="58">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Embedding Module From Scratch</span></span>
<span id="cb91-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> T(Module):</span>
<span id="cb91-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb91-4">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, bias<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb91-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># self.a = nn.Parameter(torch.ones(3))</span></span>
<span id="cb91-6"></span>
<span id="cb91-7">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T()</span>
<span id="cb91-8">L(t.parameters())</span>
<span id="cb91-9"></span>
<span id="cb91-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check type of t</span></span>
<span id="cb91-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"T type: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>(t.a.weight)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>T type: &lt;class 'torch.nn.parameter.Parameter'&gt;</code></pre>
</div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create tensor with random initialization</span></span>
<span id="cb93-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> create_params(size):</span>
<span id="cb93-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> nn.Parameter(torch.zeros(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>size).normal_(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>))</span></code></pre></div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># DotProduct with bias (and without embedding)</span></span>
<span id="cb94-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> DotProductBias(Module):</span>
<span id="cb94-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, n_users, n_movies, n_factors, y_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span>)):</span>
<span id="cb94-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_params([n_users, n_factors])</span>
<span id="cb94-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_params([n_users])</span>
<span id="cb94-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_params([n_movies, n_factors])</span>
<span id="cb94-7">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> create_params([n_movies])</span>
<span id="cb94-8">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_range</span>
<span id="cb94-9"></span>
<span id="cb94-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb94-11">        users <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors[x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]]</span>
<span id="cb94-12">        movies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_factors[x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb94-13">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (users<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>movies).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb94-14">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_bias[x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.movie_bias[x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]</span>
<span id="cb94-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sigmoid_range(res, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_range)</span></code></pre></div>
</div>
<div class="cell" data-outputid="f91dd64d-723a-4f95-a48f-b68225d79a6b" data-execution_count="61">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train model</span></span>
<span id="cb95-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DotProductBias(n_users, n_movies, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb95-3">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, model, loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MSELossFlat())</span>
<span id="cb95-4">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>, wd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.929254</td>
<td>0.953444</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.865246</td>
<td>0.878304</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.720294</td>
<td>0.838921</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.582796</td>
<td>0.829129</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.474043</td>
<td>0.829031</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="interpreting-embeddings-biases" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-embeddings-biases">Interpreting Embeddings + Biases</h3>
<div class="cell" data-outputid="a80ea34f-5888-4bf9-d564-09ca05fbd4f6" data-execution_count="62">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - biases are easiest to interpret</span></span>
<span id="cb96-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - movies with the lowest values in bias vector</span></span>
<span id="cb96-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - for each of these movies, even when a user is matched to its latent factors, they still don't generally like it</span></span>
<span id="cb96-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - does not tell us whether a movie is of a kind that people tend to enjoy watching but that people tend not to like</span></span>
<span id="cb96-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># watching it even if it is of a kind they would otherwise enjoy</span></span>
<span id="cb96-6">movie_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.model.movie_bias.squeeze()</span>
<span id="cb96-7">idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> movie_bias.argsort()[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span>
<span id="cb96-8">[dls.classes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>][i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> idxs]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>['Lawnmower Man 2: Beyond Cyberspace (1996)',
 'Children of the Corn: The Gathering (1996)',
 'Mortal Kombat: Annihilation (1997)',
 'Amityville 3-D (1983)',
 'Beautician and the Beast, The (1997)']</code></pre>
</div>
</div>
<div class="cell" data-outputid="34df633b-05a9-42a0-d1d0-0c390218af7e" data-execution_count="63">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># movies with high bias</span></span>
<span id="cb98-2">idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> movie_bias.argsort(descending<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span>
<span id="cb98-3">[dls.classes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>][i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> idxs]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="63">
<pre><code>['Titanic (1997)',
 'Shawshank Redemption, The (1994)',
 'Silence of the Lambs, The (1991)',
 'L.A. Confidential (1997)',
 "Schindler's List (1993)"]</code></pre>
</div>
</div>
<div class="cell" data-outputid="e53c08fb-df57-45e9-ca61-fb2e6c6c65c1" data-execution_count="64">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># PCA analysis of the two strongest PCA components</span></span>
<span id="cb100-2">g <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ratings.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rating'</span>].count()</span>
<span id="cb100-3">top_movies <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> g.sort_values(ascending<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>).index.values[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>]</span>
<span id="cb100-4">top_idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([learn.dls.classes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>].o2i[m] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> m <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> top_movies])</span>
<span id="cb100-5">movie_w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.model.movie_factors[top_idxs].cpu().detach()</span>
<span id="cb100-6">movie_pca <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> movie_w.pca(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb100-7">fac0,fac1,fac2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> movie_pca.t()</span>
<span id="cb100-8">idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>))</span>
<span id="cb100-9">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fac0[idxs]</span>
<span id="cb100-10">Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fac2[idxs]</span>
<span id="cb100-11">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>))</span>
<span id="cb100-12">plt.scatter(X, Y)</span>
<span id="cb100-13"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i, x, y <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(top_movies[idxs], X, Y):</span>
<span id="cb100-14">    plt.text(x,y,i, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.random.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>)</span>
<span id="cb100-15">plt.show()</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson7/FastAILesson7_files/figure-html/cell-74-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="fastai-collaborative-filtering" class="level3">
<h3 class="anchored" data-anchor-id="fastai-collaborative-filtering">fastai collaborative filtering</h3>
<div class="cell" data-outputid="9603c337-459a-41ac-ccb9-75de03d5926d" data-execution_count="65">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> collab_learner(dls, n_factors<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, y_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span>))</span>
<span id="cb101-2">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>, wd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.939463</td>
<td>0.954959</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.841215</td>
<td>0.876151</td>
<td>00:09</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.724404</td>
<td>0.832099</td>
<td>00:09</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.597228</td>
<td>0.816953</td>
<td>00:08</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.481373</td>
<td>0.817286</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-outputid="3bb65a84-ff77-4239-b246-33f48471bbf9" data-execution_count="66">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print layer names of model</span></span>
<span id="cb102-2">learn.model</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="66">
<pre><code>EmbeddingDotBias(
  (u_weight): Embedding(944, 50)
  (i_weight): Embedding(1665, 50)
  (u_bias): Embedding(944, 1)
  (i_bias): Embedding(1665, 1)
)</code></pre>
</div>
</div>
<div class="cell" data-outputid="20c90888-58ba-487a-ebd4-d05d2670552e" data-execution_count="67">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># high bias movies</span></span>
<span id="cb104-2">movie_bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.model.i_bias.weight.squeeze()</span>
<span id="cb104-3">idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> movie_bias.argsort(descending<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span>
<span id="cb104-4">[dls.classes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>][i] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> idxs]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>['L.A. Confidential (1997)',
 'Titanic (1997)',
 'Shawshank Redemption, The (1994)',
 'Silence of the Lambs, The (1991)',
 'Rear Window (1954)']</code></pre>
</div>
</div>
</section>
<section id="embedding-distance" class="level3">
<h3 class="anchored" data-anchor-id="embedding-distance">Embedding Distance</h3>
<div class="cell" data-outputid="eaf2582b-1f7d-4d45-a1a1-bd1f7905688e" data-execution_count="68">
<div class="sourceCode cell-code" id="cb106" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - distance between two movie embeddings can define two movies that are nearly identical </span></span>
<span id="cb106-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># because users that would like them would be nearly exactly the same</span></span>
<span id="cb106-3"></span>
<span id="cb106-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find movie most similar to Silence of the Lambs</span></span>
<span id="cb106-5">movie_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.model.i_weight.weight</span>
<span id="cb106-6">idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dls.classes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>].o2i[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Silence of the Lambs, The (1991)'</span>]</span>
<span id="cb106-7">distances <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.CosineSimilarity(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)(movie_factors, movie_factors[idx][<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>])</span>
<span id="cb106-8">idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> distances.argsort(descending<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb106-9">dls.classes[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'title'</span>][idx]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>'Before the Rain (Pred dozhdot) (1994)'</code></pre>
</div>
</div>
</section>
<section id="deep-learning-collaborative-filtering" class="level3">
<h3 class="anchored" data-anchor-id="deep-learning-collaborative-filtering">Deep Learning + Collaborative Filtering</h3>
<div class="cell" data-outputid="16df74a3-ad43-481e-f459-43af4b8008b7" data-execution_count="69">
<div class="sourceCode cell-code" id="cb108" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fastai has a function that returns the recommended size for embeddings matrices for your data based on a heuristic FastAI found</span></span>
<span id="cb108-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># that works well in practice</span></span>
<span id="cb108-3">embs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_emb_sz(dls)</span>
<span id="cb108-4">embs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>[(944, 74), (1665, 102)]</code></pre>
</div>
</div>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb110" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Deep Learning Collaborative Filtering Class</span></span>
<span id="cb110-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> CollabNN(Module):</span>
<span id="cb110-3">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, user_sz, item_sz, y_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span>), n_act<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>):</span>
<span id="cb110-4">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>user_sz)</span>
<span id="cb110-5">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.item_factors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Embedding(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>item_sz)</span>
<span id="cb110-6">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Sequential(</span>
<span id="cb110-7">            nn.Linear(user_sz[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>item_sz[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], n_act),</span>
<span id="cb110-8">            nn.ReLU(),</span>
<span id="cb110-9">            nn.Linear(n_act, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb110-10">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_range</span>
<span id="cb110-11"></span>
<span id="cb110-12">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb110-13">        embs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.user_factors(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]),<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.item_factors(x[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb110-14">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.layers(torch.cat(embs, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb110-15">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> sigmoid_range(x, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.y_range)</span></code></pre></div>
</div>
<div class="cell" data-outputid="e49a78b8-7acc-4adb-fb64-03d72e9a09c1" data-execution_count="71">
<div class="sourceCode cell-code" id="cb111" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create model and train it</span></span>
<span id="cb111-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CollabNN(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>embs)</span>
<span id="cb111-3">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, model, loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>MSELossFlat())</span>
<span id="cb111-4">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>, wd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.943857</td>
<td>0.951898</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.914082</td>
<td>0.898525</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.848892</td>
<td>0.884356</td>
<td>00:10</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.814803</td>
<td>0.875278</td>
<td>00:10</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.761398</td>
<td>0.878594</td>
<td>00:09</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-outputid="dda80c50-99cc-4b19-f077-b27f147e70f7" data-execution_count="72">
<div class="sourceCode cell-code" id="cb112" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># model with hidden layers of 100 and 50</span></span>
<span id="cb112-2">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> collab_learner(dls, use_nn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, y_range<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5.5</span>), layers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>])</span>
<span id="cb112-3">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">5e-3</span>, wd<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.003178</td>
<td>0.998673</td>
<td>00:11</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.877362</td>
<td>0.934763</td>
<td>00:11</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.887651</td>
<td>0.898290</td>
<td>00:11</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.815599</td>
<td>0.865441</td>
<td>00:12</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.788975</td>
<td>0.864559</td>
<td>00:11</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ol type="1">
<li><a href="https://course.fast.ai/Lessons/lesson7.html">FastAI Lesson 7</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/scaling-up-road-to-the-top-part-3">Scaling Up: Road to the Top, Part 3</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/multi-target-road-to-the-top-part-4">Multi-target: Road to the Top, Part 4</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/collaborative-filtering-deep-dive/notebook">Collaborative Filtering Deep Dive</a></li>
<li><a href="https://youtube.com/playlist?list=PLfYUBJiXbdtSLBPJ1GMx-sQWf6iNhb8mM&amp;si=WwPOjgYofy4M9QUW">Jeremy Howard FastAI Live Coding</a></li>
<li><a href="(https://docs.fast.ai/)">fast.ai docs</a></li>
</ol>


</section>

 ]]></description>
  <category>learning</category>
  <category>fastai</category>
  <category>deep learning</category>
  <guid>https://mozartfish.github.io/blog/posts/fastai-lesson7/FastAILesson7.html</guid>
  <pubDate>Tue, 13 Feb 2024 08:00:00 GMT</pubDate>
</item>
<item>
  <title>FastAI Lesson 6: Random Forests</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6.html</link>
  <description><![CDATA[ 




<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>All of this code was written by Jeremy Howard and the FastAI team. I modified it slightly to include my own print statements, comments and additional helper functions based on Jeremy’s code. This is the source for the original code <a href="https://www.kaggle.com/code/jhoward/how-random-forests-really-work/">How random forests really work</a>, <a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">First Steps: Road to the Top, Part 1</a> and <a href="https://www.kaggle.com/code/jhoward/small-models-road-to-the-top-part-2/">Small models: Road to the Top, Part 2</a>.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this lesson, Jeremy goes over Random Forests, Decision Trees, Binary Splits, Bagging and Gradient Boosting. Towards the middle half of the lesson, Jeremy starts a deep dive of his process in achieving the top scores for the <a href="https://www.kaggle.com/competitions/paddy-disease-classification">Paddy Doctor: Paddy Disease Classification</a> challenge.</p>
</section>
<section id="jeremy-howards-advice" class="level2">
<h2 class="anchored" data-anchor-id="jeremy-howards-advice">Jeremy Howard’s Advice</h2>
<ul>
<li>In datasets with many columns, creating a feature importance plot early is helpful in finding which columns are worth studying more closely</li>
<li>Complex models are not always better</li>
<li>Simple models will have trouble providing adequate accuracy for more complex tasks such as recommendation systems, NLP, computer vision, or multivariate time series</li>
<li>Random forests are not sensitive to issues like normalization, interactions, non-linear transformations which make them easy to work with and hard to mess up</li>
</ul>
</section>
<section id="load-data-and-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-data-and-libraries">Load Data and Libraries</h2>
<div class="cell" data-outputid="49fe0e10-dbd2-4cc4-8377-fbbb5edc6c09" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import libraries and files</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># required libraries + packages for any ml/data science project</span></span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fastai library contains all the packages above and wraps them in the fastai library</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uqq fastai</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kaggle API package install</span></span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install kaggle</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install TIMM</span></span>
<span id="cb1-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install timm</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: kaggle in /usr/local/lib/python3.10/dist-packages (1.5.16)
Requirement already satisfied: six&gt;=1.10 in /usr/local/lib/python3.10/dist-packages (from kaggle) (1.16.0)
Requirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from kaggle) (2023.11.17)
Requirement already satisfied: python-dateutil in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.8.2)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.31.0)
Requirement already satisfied: tqdm in /usr/local/lib/python3.10/dist-packages (from kaggle) (4.66.1)
Requirement already satisfied: python-slugify in /usr/local/lib/python3.10/dist-packages (from kaggle) (8.0.1)
Requirement already satisfied: urllib3 in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.0.7)
Requirement already satisfied: bleach in /usr/local/lib/python3.10/dist-packages (from kaggle) (6.1.0)
Requirement already satisfied: webencodings in /usr/local/lib/python3.10/dist-packages (from bleach-&gt;kaggle) (0.5.1)
Requirement already satisfied: text-unidecode&gt;=1.3 in /usr/local/lib/python3.10/dist-packages (from python-slugify-&gt;kaggle) (1.3)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;kaggle) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;kaggle) (3.6)
Collecting timm
  Downloading timm-0.9.12-py3-none-any.whl (2.2 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 2.2/2.2 MB 10.5 MB/s eta 0:00:00
Requirement already satisfied: torch&gt;=1.7 in /usr/local/lib/python3.10/dist-packages (from timm) (2.1.0+cu121)
Requirement already satisfied: torchvision in /usr/local/lib/python3.10/dist-packages (from timm) (0.16.0+cu121)
Requirement already satisfied: pyyaml in /usr/local/lib/python3.10/dist-packages (from timm) (6.0.1)
Requirement already satisfied: huggingface-hub in /usr/local/lib/python3.10/dist-packages (from timm) (0.20.2)
Requirement already satisfied: safetensors in /usr/local/lib/python3.10/dist-packages (from timm) (0.4.1)
Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm) (3.13.1)
Requirement already satisfied: typing-extensions in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm) (4.5.0)
Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm) (1.12)
Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm) (3.2.1)
Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm) (3.1.3)
Requirement already satisfied: fsspec in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm) (2023.6.0)
Requirement already satisfied: triton==2.1.0 in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.7-&gt;timm) (2.1.0)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from huggingface-hub-&gt;timm) (2.31.0)
Requirement already satisfied: tqdm&gt;=4.42.1 in /usr/local/lib/python3.10/dist-packages (from huggingface-hub-&gt;timm) (4.66.1)
Requirement already satisfied: packaging&gt;=20.9 in /usr/local/lib/python3.10/dist-packages (from huggingface-hub-&gt;timm) (23.2)
Requirement already satisfied: numpy in /usr/local/lib/python3.10/dist-packages (from torchvision-&gt;timm) (1.23.5)
Requirement already satisfied: pillow!=8.3.*,&gt;=5.3.0 in /usr/local/lib/python3.10/dist-packages (from torchvision-&gt;timm) (9.4.0)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2-&gt;torch&gt;=1.7-&gt;timm) (2.1.3)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;huggingface-hub-&gt;timm) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;huggingface-hub-&gt;timm) (3.6)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;huggingface-hub-&gt;timm) (2.0.7)
Requirement already satisfied: certifi&gt;=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;huggingface-hub-&gt;timm) (2023.11.17)
Requirement already satisfied: mpmath&gt;=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy-&gt;torch&gt;=1.7-&gt;timm) (1.3.0)
Installing collected packages: timm
Successfully installed timm-0.9.12</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.imports <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zipfile</span>
<span id="cb3-5"></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Function for loading kaggle datasets locally or on kaggle</span></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Returns a local path to data files</span></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">- input: Kaggle API Login Credentials, Kaggle Contest Name '''</span></span>
<span id="cb3-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> loadData(creds, dataFile):</span>
<span id="cb3-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable to check whether we're running on kaggle website or not</span></span>
<span id="cb3-11">    iskaggle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.environ.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'KAGGLE_KERNEL_RUN_TYPE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb3-12"></span>
<span id="cb3-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># path for kaggle API credentials</span></span>
<span id="cb3-14">    cred_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'~/.kaggle/kaggle.json'</span>).expanduser()</span>
<span id="cb3-15"></span>
<span id="cb3-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> cred_path.exists():</span>
<span id="cb3-17">        cred_path.parent.mkdir(exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-18">        cred_path.write_text(creds)</span>
<span id="cb3-19">        cred_path.chmod(<span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0o600</span>)</span>
<span id="cb3-20"></span>
<span id="cb3-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from Kaggle to path and extract files at path location</span></span>
<span id="cb3-22"></span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># local machine</span></span>
<span id="cb3-24">    path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(dataFile)</span>
<span id="cb3-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> iskaggle <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> path.exists():</span>
<span id="cb3-26">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> kaggle</span>
<span id="cb3-27">        kaggle.api.competition_download_cli(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(path))</span>
<span id="cb3-28">        zipfile.ZipFile(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.zip'</span>).extractall(path)</span>
<span id="cb3-29"></span>
<span id="cb3-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kaggle</span></span>
<span id="cb3-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> iskaggle:</span>
<span id="cb3-32">        fileName <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'../input/'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dataFile</span>
<span id="cb3-33">        path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fileName</span>
<span id="cb3-34"></span>
<span id="cb3-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> path</span></code></pre></div>
</div>
<div class="cell" data-outputid="331c994a-0e72-4a13-ae3b-d179876d7832" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">creds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb4-2">dataFile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'titanic'</span></span>
<span id="cb4-3">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loadData(creds, dataFile)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading titanic.zip to /content
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 34.1k/34.1k [00:00&lt;00:00, 38.4MB/s]</code></pre>
</div>
</div>
<div class="cell" data-outputid="49f8d412-7880-46ae-ed0e-9efb21394e6c" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check data files</span></span>
<span id="cb7-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span> ls {path}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gender_submission.csv  test.csv  train.csv</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set up default settings</span></span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings, logging, torch</span>
<span id="cb9-3">warnings.simplefilter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>)</span>
<span id="cb9-4">logging.disable(logging.WARNING)</span>
<span id="cb9-5">np.set_printoptions(linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">130</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load data files and find modes of categories</span></span>
<span id="cb10-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>)</span>
<span id="cb10-3">tst_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.csv'</span>)</span>
<span id="cb10-4">modes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.mode().iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</div>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<section id="exploratory-data-analysis-data-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis-data-preprocessing">Exploratory Data Analysis: Data Preprocessing</h3>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standardize data types for modeling with random forests</span></span>
<span id="cb11-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> proc_data(df):</span>
<span id="cb11-3">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.Fare.fillna(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb11-4">    df.fillna(modes, inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb11-5">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.log1p(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fare'</span>])</span>
<span id="cb11-6">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Embarked'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Categorical(df.Embarked)</span>
<span id="cb11-7">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sex'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Categorical(df.Sex)</span>
<span id="cb11-8"></span>
<span id="cb11-9">proc_data(df)</span>
<span id="cb11-10">proc_data(tst_df)</span></code></pre></div>
</div>
</section>
<section id="exploratory-data-analysis-data-exploration" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis-data-exploration">Exploratory Data Analysis: Data Exploration</h3>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># categorical variables</span></span>
<span id="cb12-2">cats<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sex"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Embarked"</span>]</span>
<span id="cb12-3"></span>
<span id="cb12-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># continuous variables</span></span>
<span id="cb12-5">conts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Age'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SibSp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Parch'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pclass"</span>]</span>
<span id="cb12-6"></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dependent variable (the thing we're trying to determine)</span></span>
<span id="cb12-8">dep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Survived"</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="2941484f-5d64-4f5a-ad78-5c17ea7c4441" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1">df.Sex.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>0      male
1    female
2    female
3    female
4      male
Name: Sex, dtype: category
Categories (2, object): ['female', 'male']</code></pre>
</div>
</div>
<div class="cell" data-outputid="986a6a2f-7224-4f61-ea5f-0abbc06ecd83" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">df.Sex.cat.codes.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>0    1
1    0
2    0
3    0
4    1
dtype: int8</code></pre>
</div>
</div>
</section>
</section>
<section id="binary-split" class="level2">
<h2 class="anchored" data-anchor-id="binary-split">Binary Split</h2>
<!-- # - Random forests are made up of decision trees
# - Decision trees are made up of binary splits

# - Binary Split -> all rows placed into one of two groups, based on whether they're above or below
# some threshold of some column

# - Example: Threshold = 0.5 and column Sex (value is 0 for females and 1 for male ) -->
<ul>
<li>Random forests are made up of decision trees</li>
<li>Decision trees are made up of binary splits</li>
<li><code>Binary Split</code>: all rows placed into one of two groups based on whether they are above or below some threshold of some column. <strong>Example</strong>: Threshold = 0.5 and column Sex (<code>0</code> represents females, <code>1</code> represents males)</li>
</ul>
<div class="cell" data-outputid="49858994-0b58-4400-a566-7c6bb2e57e6f" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb17-2"></span>
<span id="cb17-3">fig,axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb17-4">sns.barplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dep, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sex"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Survival rate"</span>)</span>
<span id="cb17-5">sns.countplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sex"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Histogram"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>[Text(0.5, 1.0, 'Histogram')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-12-output-2.png" class="img-fluid"></p>
</div>
</div>
<section id="simple-model---categorical-variable-split-all-females-survive-and-no-males-do" class="level3">
<h3 class="anchored" data-anchor-id="simple-model---categorical-variable-split-all-females-survive-and-no-males-do">Simple Model - Categorical Variable Split: All females survive and no males do</h3>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split training data into training and validation data</span></span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 25% validation, 75% training</span></span>
<span id="cb19-3"></span>
<span id="cb19-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> random</span>
<span id="cb19-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.model_selection <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> train_test_split</span>
<span id="cb19-6"></span>
<span id="cb19-7">random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb19-8">trn_df,val_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_test_split(df, test_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>)</span>
<span id="cb19-9">trn_df[cats] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trn_df[cats].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x.cat.codes)</span>
<span id="cb19-10">val_df[cats] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> val_df[cats].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x.cat.codes)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create independent and dependent variables</span></span>
<span id="cb20-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> xs_y(df):</span>
<span id="cb20-3">    xs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[cats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> conts].copy()</span>
<span id="cb20-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> xs,df[dep] <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> dep <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> df <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">else</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb20-5"></span>
<span id="cb20-6">trn_xs,trn_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xs_y(trn_df)</span>
<span id="cb20-7">val_xs,val_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xs_y(val_df)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predictions for simple model -&gt; female is coded as 0</span></span>
<span id="cb21-2">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> val_xs.Sex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="78def71c-6b21-4e5f-eb37-567766cd021d" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># metrics (loss function) - Mean Absolute Error</span></span>
<span id="cb22-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.metrics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> mean_absolute_error</span>
<span id="cb22-3">mean_absolute_error(val_y, preds)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>0.21524663677130046</code></pre>
</div>
</div>
</section>
<section id="simple-model---continuous-variable-split-log-fare" class="level3">
<h3 class="anchored" data-anchor-id="simple-model---continuous-variable-split-log-fare">Simple Model - Continuous Variable Split: Log Fare</h3>
<div class="cell" data-outputid="b8e4d485-9c29-4f4d-dcfb-06118db40f6c" data-execution_count="16">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 0 -&gt; did not survive</span></span>
<span id="cb24-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 1 -&gt; survived</span></span>
<span id="cb24-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - boxen plot shows the average logfare for passengers that didn't survive is around 2.5</span></span>
<span id="cb24-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and for those who did survive it was around 3.2</span></span>
<span id="cb24-5"></span>
<span id="cb24-6">df_fare <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trn_df[trn_df.LogFare<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb24-7">fig,axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">11</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb24-8">sns.boxenplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_fare, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dep, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LogFare"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb24-9">sns.kdeplot(data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_fare, x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LogFare"</span>, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="16">
<pre><code>&lt;Axes: xlabel='LogFare', ylabel='Density'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-17-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="3546e75a-4f69-42a8-a715-47cf3de488e0" data-execution_count="17">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predictions</span></span>
<span id="cb26-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - based on the plots, data is showing that people who paid more for tickets were more likely to get put on lifeboat</span></span>
<span id="cb26-3"></span>
<span id="cb26-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test theory</span></span>
<span id="cb26-5">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> val_xs.LogFare <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.7</span></span>
<span id="cb26-6"></span>
<span id="cb26-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># less accurate than the previous model</span></span>
<span id="cb26-8">mean_absolute_error(val_y, preds)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>0.336322869955157</code></pre>
</div>
</div>
</section>
</section>
<section id="metric-score-function" class="level2">
<h2 class="anchored" data-anchor-id="metric-score-function">Metric: Score Function</h2>
<ul>
<li><code>Score</code> calculates a measure of <code>impurity</code>, how much the binary split creates two groups where the rows in a group are each similar to each other, or dissimilar</li>
<li>The similarity of rows inside a group can be measured by taking the standard deviation of the <code>dependent variable</code></li>
<li>The higher the <code>SD</code>thn the rows are more different to each other</li>
<li>Multiply the <code>SD</code> by the number of rows since a bigger group has more impact than a smaller group</li>
</ul>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - need a function to determine how good model is based on different splits</span></span>
<span id="cb28-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - need a way to try more columns and splits</span></span>
<span id="cb28-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - instead of MAE use a function that calculates a measure of impurity -&gt;</span></span>
<span id="cb28-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># how much the binary split creates two groups where the rows in a group are each similar to each other or dissimilar</span></span>
<span id="cb28-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ipywidgets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> interact</span>
<span id="cb28-6"></span>
<span id="cb28-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> _side_score(side, y):</span>
<span id="cb28-8">    tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> side.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb28-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> tot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb28-10">      <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb28-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> y[side].std() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> tot</span>
<span id="cb28-12"></span>
<span id="cb28-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - calculate the score for a split by adding up the scores for the left hand side and right hand side</span></span>
<span id="cb28-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> score(col, y, split):</span>
<span id="cb28-15">    lhs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> col<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;=</span> split</span>
<span id="cb28-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (_side_score(lhs,y) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> _side_score(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>lhs,y)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(y)</span>
<span id="cb28-17"></span>
<span id="cb28-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute score for a particular variable (categorical, continuous)</span></span>
<span id="cb28-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> iscore(nm, split):</span>
<span id="cb28-20">    col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trn_xs[nm]</span>
<span id="cb28-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> score(col, trn_y, split)</span>
<span id="cb28-22"></span>
<span id="cb28-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find the best split threshold for a particular variable (categorical, continuous)</span></span>
<span id="cb28-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for finding best split</span></span>
<span id="cb28-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> min_col(df, nm):</span>
<span id="cb28-26">    col,y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[nm],df[dep]</span>
<span id="cb28-27">    unq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> col.dropna().unique()</span>
<span id="cb28-28">    scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([score(col, y, o) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> unq <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> np.isnan(o)])</span>
<span id="cb28-29">    idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> scores.argmin()</span>
<span id="cb28-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> unq[idx],scores[idx]</span></code></pre></div>
</div>
<div class="cell" data-outputid="1e65cda6-67e3-4e5e-f65d-d0aae147e7b5" data-execution_count="19">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># impurity score for Sex Split</span></span>
<span id="cb29-2">score(trn_xs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sex"</span>], trn_y, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>0.40787530982063946</code></pre>
</div>
</div>
<div class="cell" data-outputid="292f6565-08f5-4bdd-a443-427a7801b297" data-execution_count="20">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># impurity score for Log Fare</span></span>
<span id="cb31-2">score(trn_xs[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"LogFare"</span>], trn_y, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.7</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>0.47180873952099694</code></pre>
</div>
</div>
<div class="cell" data-outputid="61bfea00-40ac-4a94-b6c9-6a698d36f6ff" data-execution_count="21">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># interactive widget for finding the best threshold and split for continuous variables</span></span>
<span id="cb33-2">interact(nm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>conts, split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">15.5</span>)(iscore)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"183e82e7ea674a68b6f099a7fc9c180c","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>&lt;function __main__.iscore(nm, split)&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="d81a2056-8e18-4ab2-91ef-3b6a33751ba5" data-execution_count="22">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># interactive widget for finding best threshold and split for categorical variables</span></span>
<span id="cb35-2">interact(nm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cats, split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)(iscore)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"0f15c68276e8474480c45541d87b4cb5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>&lt;function __main__.iscore(nm, split)&gt;</code></pre>
</div>
</div>
<div class="cell" data-outputid="ad9ae608-ff9a-41ff-fe63-b00fc076f3e5" data-execution_count="23">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Automating Split Finding - Find Split for Age</span></span>
<span id="cb37-2">nm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age"</span></span>
<span id="cb37-3">col <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trn_xs[nm]</span>
<span id="cb37-4">unq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> col.unique()</span>
<span id="cb37-5">unq.sort()</span>
<span id="cb37-6">unq</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>array([ 0.42,  0.67,  0.75,  0.83,  0.92,  1.  ,  2.  ,  3.  ,  4.  ,  5.  ,  6.  ,  7.  ,  8.  ,  9.  , 10.  , 11.  , 12.  ,
       13.  , 14.  , 14.5 , 15.  , 16.  , 17.  , 18.  , 19.  , 20.  , 21.  , 22.  , 23.  , 24.  , 24.5 , 25.  , 26.  , 27.  ,
       28.  , 28.5 , 29.  , 30.  , 31.  , 32.  , 32.5 , 33.  , 34.  , 34.5 , 35.  , 36.  , 36.5 , 37.  , 38.  , 39.  , 40.  ,
       40.5 , 41.  , 42.  , 43.  , 44.  , 45.  , 45.5 , 46.  , 47.  , 48.  , 49.  , 50.  , 51.  , 52.  , 53.  , 54.  , 55.  ,
       55.5 , 56.  , 57.  , 58.  , 59.  , 60.  , 61.  , 62.  , 64.  , 65.  , 70.  , 70.5 , 74.  , 80.  ])</code></pre>
</div>
</div>
<div class="cell" data-outputid="4c7bedd3-d5b8-4323-d8aa-145f920ee14f" data-execution_count="24">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find index where score is the lowest</span></span>
<span id="cb39-2">scores <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([score(col, trn_y, o) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> unq <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> np.isnan(o)])</span>
<span id="cb39-3">unq[scores.argmin()]</span>
<span id="cb39-4"></span>
<span id="cb39-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - In Age column, 6 is the optimal threshold cutoff in the training set</span></span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>6.0</code></pre>
</div>
</div>
<div class="cell" data-outputid="23dcde8c-28b9-4b38-9df0-202cd274d688" data-execution_count="25">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test split finding function on age category</span></span>
<span id="cb41-2">min_col(trn_df, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Age"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>(6.0, 0.478316717508991)</code></pre>
</div>
</div>
<div class="cell" data-outputid="92b39538-ea97-48b8-b376-34f95d3c4557" data-execution_count="26">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find best split for all variables</span></span>
<span id="cb43-2">cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> cats <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> conts</span>
<span id="cb43-3"></span>
<span id="cb43-4">{o:min_col(trn_df, o) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cols}</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>{'Sex': (0, 0.40787530982063946),
 'Embarked': (0, 0.47883342573147836),
 'Age': (6.0, 0.478316717508991),
 'SibSp': (4, 0.4783740258817434),
 'Parch': (0, 0.4805296527841601),
 'LogFare': (2.4390808375825834, 0.4620823937736597),
 'Pclass': (2, 0.46048261885806596)}</code></pre>
</div>
</div>
</section>
<section id="decision-tree" class="level2">
<h2 class="anchored" data-anchor-id="decision-tree">Decision Tree</h2>
<ul>
<li>Take each group (male, female) and create one more binary split for each group</li>
<li>Find the single best split for male, and single best split for female</li>
<li>repeat same steps for male group and female group</li>
<li>remove <code>Sex</code> from list of possible splits (since it’s already been used and there’s only one possible split for that binary column and create two new groups</li>
</ul>
<div class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Improve OneR classifier which currently predicts survival based only on Sex category</span></span>
<span id="cb45-2"></span>
<span id="cb45-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - take each group (male, female) and create one more binary split for each of them</span></span>
<span id="cb45-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - find the single best split for male, and single best split fo ffemale</span></span>
<span id="cb45-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - repeat same steps once for males, once for females</span></span>
<span id="cb45-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - remove sex from list of posssible spits and create two groups</span></span>
<span id="cb45-7"></span>
<span id="cb45-8">cols.remove(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sex"</span>)</span>
<span id="cb45-9">ismale <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trn_df.Sex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb45-10">males,females <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trn_df[ismale],trn_df[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>ismale]</span></code></pre></div>
</div>
<div class="cell" data-outputid="d010f571-c540-422e-abb8-eb5d1147466c" data-execution_count="28">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># best split for males</span></span>
<span id="cb46-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  - best split for males is Age &lt;= 6</span></span>
<span id="cb46-3">{o:min_col(males, o) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cols}</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>{'Embarked': (0, 0.3875581870410906),
 'Age': (6.0, 0.3739828371010595),
 'SibSp': (4, 0.3875864227586273),
 'Parch': (0, 0.3874704821461959),
 'LogFare': (2.803360380906535, 0.3804856231758151),
 'Pclass': (1, 0.38155442004360934)}</code></pre>
</div>
</div>
<div class="cell" data-outputid="fd4c7888-f0a8-4a26-911f-11d6ed46ca17" data-execution_count="29">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># best split for females</span></span>
<span id="cb48-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - best split for females is PClass &lt;= 2</span></span>
<span id="cb48-3">{o:min_col(females, o) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> cols}</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>{'Embarked': (0, 0.4295252982857327),
 'Age': (50.0, 0.4225927658431649),
 'SibSp': (4, 0.42319212059713535),
 'Parch': (3, 0.4193314500446158),
 'LogFare': (4.256321678298823, 0.41350598332911376),
 'Pclass': (2, 0.3335388911567601)}</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - adding these two rules creates a decision tree where the model will first check whether sex is female or male</span></span>
<span id="cb50-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - depending onthe result it will then check either age or pclass as appropriate</span></span>
<span id="cb50-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - repeat the same process creating new rules for each of the four groups</span></span>
<span id="cb50-4"></span>
<span id="cb50-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - this process can be automated using the Decision Tree Classifier from sklearn</span></span>
<span id="cb50-6"></span>
<span id="cb50-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.tree <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DecisionTreeClassifier, export_graphviz</span>
<span id="cb50-8"></span>
<span id="cb50-9">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DecisionTreeClassifier(max_leaf_nodes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>).fit(trn_xs, trn_y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># draw decision tree</span></span>
<span id="cb51-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> graphviz</span>
<span id="cb51-3"></span>
<span id="cb51-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> draw_tree(t, df, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, ratio<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, precision<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb51-5">    s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>export_graphviz(t, out_file<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, feature_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df.columns, filled<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, rounded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb51-6">                      special_characters<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, rotate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, precision<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>precision, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs)</span>
<span id="cb51-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> graphviz.Source(re.sub(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tree {'</span>, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Tree </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">{{</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> size=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>size<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">; ratio=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ratio<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, s))</span></code></pre></div>
</div>
<ul>
<li><code>Orange Nodes</code> - have lower survival rate</li>
<li><code>Blue Nodes</code> - have larger survival rate</li>
<li><code>Samples</code> - how many rows match a particular rule</li>
<li><code>Values</code> - how many passengers perished or survived. Data is represented as <strong>(perished, survived)</strong></li>
<li><code>Gini</code> - measure of impurity. similar to value calculated using <code>score</code> function. Gini calculates the probability that if you pick two rows from a group, you’ll get the same <code>dependent variable</code> result each time. If the group is all the same, the probability is <code>1.0</code> and <code>0.0</code> if they are all different.</li>
</ul>
<div class="cell" data-outputid="e618291a-bc1f-493d-cef2-f346e98b3891" data-execution_count="32">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1">draw_tree(m, trn_xs, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-33-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gini definition</span></span>
<span id="cb53-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> gini(cond):</span>
<span id="cb53-3">    act <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.loc[cond, dep]</span>
<span id="cb53-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> act.mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> act).mean()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="c92c04da-24f0-4924-e1e1-eacc90086293" data-execution_count="34">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1">gini(df.Sex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'female'</span>), gini(df.Sex<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'male'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(0.3828350034484158, 0.3064437162277842)</code></pre>
</div>
</div>
<div class="cell" data-outputid="60675e9e-543d-4bc3-8c99-f927ebe0911c" data-execution_count="35">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare to original oneR model (simple model 1)</span></span>
<span id="cb56-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - did worse than simple model 1</span></span>
<span id="cb56-3">mean_absolute_error(val_y, m.predict(val_xs))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>0.2242152466367713</code></pre>
</div>
</div>
<div class="cell" data-outputid="0de1b4a3-27aa-4fe5-89fa-5a365a6b9a48" data-execution_count="36">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># make a larger tree</span></span>
<span id="cb58-2">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DecisionTreeClassifier(min_samples_leaf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb58-3">m.fit(trn_xs, trn_y)</span>
<span id="cb58-4">draw_tree(m, trn_xs, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-37-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="7ed401ea-027b-4bd1-97f9-92f146d02b83" data-execution_count="37">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compare this model to OneR version</span></span>
<span id="cb59-2">mean_absolute_error(val_y, m.predict(val_xs))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>0.18385650224215247</code></pre>
</div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># submit to kaggle - Jeremy got a score of 0.765</span></span>
<span id="cb61-2">tst_df[cats] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_df[cats].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">apply</span>(<span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">lambda</span> x: x.cat.codes)</span>
<span id="cb61-3">tst_xs,_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xs_y(tst_df)</span>
<span id="cb61-4"></span>
<span id="cb61-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> subm(preds, suff):</span>
<span id="cb61-6">    tst_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survived'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> preds</span>
<span id="cb61-7">    sub_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PassengerId'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survived'</span>]]</span>
<span id="cb61-8">    sub_df.to_csv(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'sub-</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>suff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb61-9"></span>
<span id="cb61-10">subm(m.predict(tst_xs), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tree'</span>)</span></code></pre></div>
</div>
</section>
<section id="random-forests" class="level2">
<h2 class="anchored" data-anchor-id="random-forests">Random Forests</h2>
<!-- # - Leo Breiman -> create a bunch of bigger decision trees and take average of predictions
# - this is called bagging
# - want each model's prediction in the average ensemble to be uncorrelated with each other model. When averaging
# all the predictions, the average will be equal to the true target value -> average of lots of uncorrelated random errors
# is 0. -->
<ul>
<li><a href="https://en.wikipedia.org/wiki/Leo_Breiman">Leo Breiman</a> came up with <code>bagging</code>: if we take a bunch of large decision trees and take the average of their predictions then the averaged predictions will be equal to the true target value</li>
<li>Each of the model’s predictions in the averaged ensembled need to be <strong>uncorrelated</strong> with each other model in order for the average predictions to equal the true value because <strong>the average of lots of uncorrelated random errors is zero</strong>.</li>
<li>One way to create a bunch of uncorrelated values is to train each of them on a <strong>different random subset</strong> of the data.</li>
</ul>
<div class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb62" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create tree on a random subset of data</span></span>
<span id="cb62-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_tree(prop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>):</span>
<span id="cb62-3">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trn_y)</span>
<span id="cb62-4">    idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> random.choice(n, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>prop))</span>
<span id="cb62-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> DecisionTreeClassifier(min_samples_leaf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>).fit(trn_xs.iloc[idxs], trn_y.iloc[idxs])</span></code></pre></div>
</div>
<div class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create a bunch of trees</span></span>
<span id="cb63-2">trees <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [get_tree() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)]</span></code></pre></div>
</div>
<div class="cell" data-outputid="894a8ef9-50c5-47f9-e4c6-0643bd42fa2a" data-execution_count="41">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># prediction - average of all tree predictions</span></span>
<span id="cb64-2">all_probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [t.predict(val_xs) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> trees]</span>
<span id="cb64-3">avg_probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.stack(all_probs).mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb64-4"></span>
<span id="cb64-5">mean_absolute_error(val_y, avg_probs)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>0.2272645739910314</code></pre>
</div>
</div>
<ul>
<li>the above result is close to the <code>sklearn random forest classifier</code></li>
<li>In a real random forest, the <code>sklearn randomforest classifier</code> chooses a <strong>random subset of columns for each split</strong> in addition to choosing a <strong>random sample of data</strong> for each tree</li>
</ul>
<div class="cell" data-outputid="b88ae651-271f-49f9-a5eb-62c056c17fb9" data-execution_count="42">
<div class="sourceCode cell-code" id="cb66" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.ensemble <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RandomForestClassifier</span>
<span id="cb66-2"></span>
<span id="cb66-3">rf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RandomForestClassifier(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, min_samples_leaf<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb66-4">rf.fit(trn_xs, trn_y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb66-5">mean_absolute_error(val_y, rf.predict(val_xs))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>0.18834080717488788</code></pre>
</div>
</div>
<div class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># submit to kaggle</span></span>
<span id="cb68-2">subm(rf.predict(tst_xs), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rf'</span>)</span></code></pre></div>
</div>
</section>
<section id="feature-importance" class="level2">
<h2 class="anchored" data-anchor-id="feature-importance">Feature Importance</h2>
<ul>
<li>Random forests can tell us which <strong>independent variables</strong> were the most important in the model using <code>feature importances</code>.</li>
</ul>
<div class="cell" data-outputid="f6a7ecdb-9ef2-4606-89d9-d3045c3ecbcf" data-execution_count="44">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Feature Importance</span></span>
<span id="cb69-2">pd.DataFrame(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(cols<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>trn_xs.columns, imp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>m.feature_importances_)).plot(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cols'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'barh'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>&lt;Axes: ylabel='cols'&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-45-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="paddy-doctor" class="level2">
<h2 class="anchored" data-anchor-id="paddy-doctor">Paddy Doctor</h2>
<section id="part-1" class="level3">
<h3 class="anchored" data-anchor-id="part-1">Part 1</h3>
<section id="load-data" class="level4">
<h4 class="anchored" data-anchor-id="load-data">Load Data</h4>
<div class="cell" data-outputid="d2b108d7-9816-4bd4-b528-241a37c8d7ac" data-execution_count="45">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1">creds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb71-2">dataFile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'paddy-disease-classification'</span></span>
<span id="cb71-3">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loadData(creds, dataFile)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading paddy-disease-classification.zip to /content
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 1.02G/1.02G [00:11&lt;00:00, 94.5MB/s]</code></pre>
</div>
</div>
<div class="cell" data-outputid="80ad6ea2-2c87-4017-8a4f-d7beebf42e05" data-execution_count="46">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check data files</span></span>
<span id="cb74-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span> ls {path}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>sample_submission.csv  test_images  train.csv  train_images</code></pre>
</div>
</div>
<div class="cell" data-outputid="6089b7cc-72e5-4078-fe0d-9116a188a7e8" data-execution_count="47">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set up default settings</span></span>
<span id="cb76-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb76-3">set_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb76-4"></span>
<span id="cb76-5">path.ls()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>(#4) [Path('paddy-disease-classification/sample_submission.csv'),Path('paddy-disease-classification/train_images'),Path('paddy-disease-classification/train.csv'),Path('paddy-disease-classification/test_images')]</code></pre>
</div>
</div>
</section>
<section id="exploratory-data-analysis-1" class="level4">
<h4 class="anchored" data-anchor-id="exploratory-data-analysis-1">Exploratory Data Analysis</h4>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1">trn_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train_images'</span></span>
<span id="cb78-2">files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_image_files(trn_path)</span></code></pre></div>
</div>
<div class="cell" data-outputid="de256536-527b-4a31-d588-0f2fe3eb9a76" data-execution_count="49">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1">img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PILImage.create(files[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb79-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(img.size)</span>
<span id="cb79-3">img.to_thumb(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(480, 640)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="49">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-50-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="b8a58d10-26cd-4e53-ae77-dbb1c61463e2" data-execution_count="50">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check image sizes in parallel</span></span>
<span id="cb81-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastcore.parallel <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb81-3"></span>
<span id="cb81-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f(o):</span>
<span id="cb81-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> PILImage.create(o).size</span>
<span id="cb81-6"></span>
<span id="cb81-7">sizes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> parallel(f, files, n_workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb81-8">pd.Series(sizes).value_counts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>(480, 640)    10403
(640, 480)        4
dtype: int64</code></pre>
</div>
</div>
</section>
<section id="data-loaders" class="level4">
<h4 class="anchored" data-anchor-id="data-loaders">Data Loaders</h4>
<div class="cell" data-outputid="51edb6d2-23f2-4144-ce65-c511feac9880" data-execution_count="51">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>,</span>
<span id="cb83-2">    item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>),</span>
<span id="cb83-3">    batch_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))</span>
<span id="cb83-4"></span>
<span id="cb83-5">dls.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-52-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="first-model" class="level4">
<h4 class="anchored" data-anchor-id="first-model">First Model</h4>
<div class="cell" data-outputid="49e698c8-83e9-44fd-b153-5ae839754815" data-execution_count="52">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'resnet26d'</span>, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>error_rate, path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>).to_fp16()</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9c67875ce246407a9e67f1e0f7f10f03","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
</section>
<section id="find-learning-rate" class="level4">
<h4 class="anchored" data-anchor-id="find-learning-rate">Find Learning Rate</h4>
<div class="cell" data-outputid="ae79524f-6cde-46af-ce63-e716e8abe2b6" data-execution_count="53">
<div class="sourceCode cell-code" id="cb85" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1">learn.lr_find(suggest_funcs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(valley, slide))</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>SuggestedLRs(valley=0.0014454397605732083, slide=0.0030199517495930195)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-54-output-4.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="train-model" class="level4">
<h4 class="anchored" data-anchor-id="train-model">Train Model</h4>
<div class="cell" data-outputid="68eb228c-a0b8-4357-e44e-07d2dc5cc1e0" data-execution_count="54">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1">learn.fine_tune(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.752005</td>
<td>1.081317</td>
<td>0.356079</td>
<td>01:20</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.155641</td>
<td>0.716448</td>
<td>0.227295</td>
<td>01:21</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.779499</td>
<td>0.463007</td>
<td>0.148967</td>
<td>01:21</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.545381</td>
<td>0.374054</td>
<td>0.116290</td>
<td>01:20</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="submit-to-kaggle" class="level4">
<h4 class="anchored" data-anchor-id="submit-to-kaggle">Submit to Kaggle</h4>
<div class="cell" data-outputid="e14f0e6d-c395-4ea1-8b4c-174526e9109a" data-execution_count="55">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1">sample_sub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_submission.csv'</span>)</span>
<span id="cb88-2">sample_sub</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="55">

  <div id="df-1fe4644c-4750-4a35-afb2-7c91a3385e8e" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">image_id</th>
<th data-quarto-table-cell-role="th">label</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>200001.jpg</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>200002.jpg</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>200003.jpg</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>200004.jpg</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>200005.jpg</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3464</td>
<td>203465.jpg</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3465</td>
<td>203466.jpg</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3466</td>
<td>203467.jpg</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3467</td>
<td>203468.jpg</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3468</td>
<td>203469.jpg</td>
<td>NaN</td>
</tr>
</tbody>
</table>


<p>3469 rows × 2 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-1fe4644c-4750-4a35-afb2-7c91a3385e8e')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-1fe4644c-4750-4a35-afb2-7c91a3385e8e button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-1fe4644c-4750-4a35-afb2-7c91a3385e8e');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-43aeafa9-328c-4496-8d2b-ba54e9f14918">
  <button class="colab-df-quickchart" onclick="quickchart('df-43aeafa9-328c-4496-8d2b-ba54e9f14918')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-43aeafa9-328c-4496-8d2b-ba54e9f14918 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

  <div id="id_a0e1cf5e-0195-4f14-a4d6-da9aec29cc26">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('sample_sub')" title="Generate code using this dataframe." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"></path>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_a0e1cf5e-0195-4f14-a4d6-da9aec29cc26 button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('sample_sub');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create test set</span></span>
<span id="cb89-2">tst_files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_image_files(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test_images'</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>()</span>
<span id="cb89-3">tst_dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dls.test_dl(tst_files)</span></code></pre></div>
</div>
<div class="cell" data-outputid="698bac46-856e-4419-8ada-a10db544be9b" data-execution_count="57">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get model predictions for test set</span></span>
<span id="cb90-2">probs,_,idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.get_preds(dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tst_dl, with_decoded<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb90-3">idxs</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>tensor([7, 8, 7,  ..., 8, 1, 5])</code></pre>
</div>
</div>
<div class="cell" data-outputid="7d82bed0-1311-45b1-b644-a8713a82ea47" data-execution_count="58">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># map indexes to actual values</span></span>
<span id="cb92-2">dls.vocab</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>['bacterial_leaf_blight', 'bacterial_leaf_streak', 'bacterial_panicle_blight', 'blast', 'brown_spot', 'dead_heart', 'downy_mildew', 'hispa', 'normal', 'tungro']</code></pre>
</div>
</div>
<div class="cell" data-outputid="c30b859f-6f3f-406b-9c08-2aab6d01b859" data-execution_count="59">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1">mapping <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(dls.vocab))</span>
<span id="cb94-2">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(idxs.numpy(), name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idxs"</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(mapping)</span>
<span id="cb94-3">results</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">
<pre><code>0                       hispa
1                      normal
2                       hispa
3                       blast
4                       blast
                ...          
3464               dead_heart
3465                    hispa
3466                   normal
3467    bacterial_leaf_streak
3468               dead_heart
Name: idxs, Length: 3469, dtype: object</code></pre>
</div>
</div>
<div class="cell" data-outputid="6cef65d5-a616-47b9-af2a-4ed3f827c455" data-execution_count="60">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## save submission</span></span>
<span id="cb96-2">sample_sub[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> results</span>
<span id="cb96-3">sample_sub.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'part1_subm.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb96-4"></span>
<span id="cb96-5"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head part1_subm.csv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,hispa
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,normal</code></pre>
</div>
</div>
</section>
</section>
<section id="part-2" class="level3">
<h3 class="anchored" data-anchor-id="part-2">Part 2</h3>
<section id="load-data-resize-images" class="level4">
<h4 class="anchored" data-anchor-id="load-data-resize-images">Load Data + Resize Images</h4>
<div class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1">trn_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sml'</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resize images to 192 x 256</span></span>
<span id="cb99-2">resize_images(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train_images'</span>, dest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>trn_path, max_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, recurse<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
</div>
</section>
<section id="data-loaders-1" class="level4">
<h4 class="anchored" data-anchor-id="data-loaders-1">Data Loaders</h4>
<div class="cell" data-outputid="b51a776f-a874-43e7-aac5-8493da73ace1" data-execution_count="63">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>,</span>
<span id="cb100-2">    item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>)))</span>
<span id="cb100-3"></span>
<span id="cb100-4">dls.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-64-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="train-model-1" class="level4">
<h4 class="anchored" data-anchor-id="train-model-1">Train Model</h4>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> train(arch, item, batch, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>):</span>
<span id="cb101-2">    dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataLoaders.from_folder(trn_path, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>, valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>item, batch_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch)</span>
<span id="cb101-3">    learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, arch, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>error_rate).to_fp16()</span>
<span id="cb101-4">    learn.fine_tune(epochs, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb101-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> learn</span></code></pre></div>
</div>
</section>
<section id="learner" class="level4">
<h4 class="anchored" data-anchor-id="learner">Learner</h4>
<div class="cell" data-outputid="b1cda26c-d8f6-4b44-ad46-144a0efdea20" data-execution_count="65">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'resnet26d'</span>, item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>),</span>
<span id="cb102-2">              batch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.899457</td>
<td>1.388609</td>
<td>0.453628</td>
<td>00:26</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.295517</td>
<td>0.951328</td>
<td>0.316675</td>
<td>00:27</td>
</tr>
<tr class="even">
<td>1</td>
<td>1.016938</td>
<td>0.664715</td>
<td>0.213359</td>
<td>00:28</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.712072</td>
<td>0.473869</td>
<td>0.157136</td>
<td>00:28</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.533225</td>
<td>0.334353</td>
<td>0.113407</td>
<td>00:27</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.444198</td>
<td>0.322105</td>
<td>0.107160</td>
<td>00:27</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="convnext-model" class="level4">
<h4 class="anchored" data-anchor-id="convnext-model">ConvNeXT Model</h4>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1">arch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'convnext_small_in22k'</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="2ba83c0d-f32a-4ee2-a83e-c7ce3367642d" data-execution_count="67">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train(arch, item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>),</span>
<span id="cb104-2">              batch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"9bb0f62d9183495a81e83fec2db9c8dc","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.334298</td>
<td>0.838287</td>
<td>0.277271</td>
<td>00:33</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.660261</td>
<td>0.457503</td>
<td>0.147045</td>
<td>00:42</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.499239</td>
<td>0.358292</td>
<td>0.108602</td>
<td>00:41</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.326860</td>
<td>0.206613</td>
<td>0.064873</td>
<td>00:41</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.195506</td>
<td>0.147441</td>
<td>0.044210</td>
<td>00:42</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.122859</td>
<td>0.135444</td>
<td>0.043729</td>
<td>00:42</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="preprocessing-experiments" class="level4">
<h4 class="anchored" data-anchor-id="preprocessing-experiments">Preprocessing Experiments</h4>
<section id="experiment-1-square-cropping" class="level5">
<h5 class="anchored" data-anchor-id="experiment-1-square-cropping">Experiment 1: Square Cropping</h5>
<div class="cell" data-outputid="80599f06-86f6-4506-b496-517155c7a3de" data-execution_count="68">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train(arch, item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>),</span>
<span id="cb105-2">              batch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.322280</td>
<td>0.803323</td>
<td>0.258049</td>
<td>00:32</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.719919</td>
<td>0.449919</td>
<td>0.144642</td>
<td>00:39</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.554835</td>
<td>0.352141</td>
<td>0.111004</td>
<td>00:39</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.361483</td>
<td>0.254937</td>
<td>0.083133</td>
<td>00:39</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.213894</td>
<td>0.178465</td>
<td>0.053820</td>
<td>00:39</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.163988</td>
<td>0.167601</td>
<td>0.053820</td>
<td>00:39</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="experiment-2-padding" class="level5">
<h5 class="anchored" data-anchor-id="experiment-2-padding">Experiment 2: Padding</h5>
<div class="cell" data-outputid="9f837ae3-a21e-40ec-ba48-a815cce4a59f" data-execution_count="69">
<div class="sourceCode cell-code" id="cb106" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataLoaders.from_folder(trn_path, valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>,</span>
<span id="cb106-2">                                   item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ResizeMethod.Pad, pad_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>PadMode.Zeros))</span>
<span id="cb106-3">dls.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-70-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="a157090c-c65f-475e-95cf-9b3cce56814f" data-execution_count="70">
<div class="sourceCode cell-code" id="cb107" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train(arch, item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>), method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ResizeMethod.Pad, pad_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>PadMode.Zeros),</span>
<span id="cb107-2">              batch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">171</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>), min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.268145</td>
<td>0.720653</td>
<td>0.234983</td>
<td>00:33</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.661217</td>
<td>0.485095</td>
<td>0.160980</td>
<td>00:43</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.548201</td>
<td>0.309334</td>
<td>0.091783</td>
<td>00:42</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.342416</td>
<td>0.222194</td>
<td>0.067756</td>
<td>00:55</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.213852</td>
<td>0.183673</td>
<td>0.053340</td>
<td>00:42</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.142283</td>
<td>0.149697</td>
<td>0.047093</td>
<td>00:45</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="experiment-3-time-test-augmentation" class="level5">
<h5 class="anchored" data-anchor-id="experiment-3-time-test-augmentation">Experiment 3: Time Test Augmentation</h5>
<p><code>Test Time Augmentation</code> - During the inference or validation, creating multiple versions of each image, using data augmentation, and then taking the <strong>average</strong> or <strong>maximum</strong> of the predictions for each augmented version of the image.</p>
<div class="cell" data-outputid="414b4d45-5978-4f3c-b519-f8a4a55dded5" data-execution_count="71">
<div class="sourceCode cell-code" id="cb108" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check predictions and error rate of model without TTA</span></span>
<span id="cb108-2">valid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.dls.valid</span>
<span id="cb108-3">preds,targs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.get_preds(dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>valid)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-outputid="798dca1e-99c8-4b81-c8c6-ff1a985be4dc" data-execution_count="72">
<div class="sourceCode cell-code" id="cb109" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># error (before TTA)</span></span>
<span id="cb109-2">error_rate(preds, targs)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>TensorBase(0.0471)</code></pre>
</div>
</div>
<div class="cell" data-outputid="bc324e14-f5c5-454e-a732-5f760f67e3a5" data-execution_count="73">
<div class="sourceCode cell-code" id="cb111" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># data augmentation analysis</span></span>
<span id="cb111-2">learn.dls.train.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, unique<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6_files/figure-html/cell-74-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="3f340004-3a5f-4ed0-d1fe-19e7fdb55535" data-execution_count="74">
<div class="sourceCode cell-code" id="cb112" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time Test Augmentation</span></span>
<span id="cb112-2">tta_preds,_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.tta(dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>valid)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="5" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-outputid="99b5e2c9-952b-4baa-f81d-685cea203baa" data-execution_count="75">
<div class="sourceCode cell-code" id="cb113" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># error (after TTA)</span></span>
<span id="cb113-2">error_rate(tta_preds, targs)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>TensorBase(0.0404)</code></pre>
</div>
</div>
</section>
</section>
<section id="scaling---large-images-more-epochs" class="level4">
<h4 class="anchored" data-anchor-id="scaling---large-images-more-epochs">Scaling - Large Images + More Epochs</h4>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb115" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1">trn_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train_images'</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="09a2bacd-0454-426c-faa9-0c060223475f" data-execution_count="77">
<div class="sourceCode cell-code" id="cb116" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train(arch, epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb116-2">              item<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Resize((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">480</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">360</span>), method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ResizeMethod.Pad, pad_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>PadMode.Zeros),</span>
<span id="cb116-3">              batch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>aug_transforms(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>), min_scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.092938</td>
<td>0.646208</td>
<td>0.207112</td>
<td>01:38</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.529627</td>
<td>0.281716</td>
<td>0.088419</td>
<td>01:45</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.395975</td>
<td>0.252327</td>
<td>0.083614</td>
<td>01:45</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.353087</td>
<td>0.355000</td>
<td>0.101874</td>
<td>01:44</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.296080</td>
<td>0.194901</td>
<td>0.058626</td>
<td>01:45</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.247156</td>
<td>0.180774</td>
<td>0.048534</td>
<td>01:45</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.188586</td>
<td>0.190078</td>
<td>0.045651</td>
<td>01:45</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.134304</td>
<td>0.152976</td>
<td>0.031235</td>
<td>01:45</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.110716</td>
<td>0.140041</td>
<td>0.030754</td>
<td>01:44</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.076065</td>
<td>0.121910</td>
<td>0.027871</td>
<td>01:46</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.056164</td>
<td>0.119214</td>
<td>0.026910</td>
<td>01:44</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.049165</td>
<td>0.114327</td>
<td>0.027391</td>
<td>01:45</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.035028</td>
<td>0.114869</td>
<td>0.027391</td>
<td>01:45</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-outputid="53ba9aaa-0485-4c31-aba2-f4004f52ed09" data-execution_count="78">
<div class="sourceCode cell-code" id="cb117" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1">tta_preds,targs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.tta(dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>learn.dls.valid)</span>
<span id="cb117-2">error_rate(tta_preds, targs)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>TensorBase(0.0235)</code></pre>
</div>
</div>
</section>
<section id="submit-to-kaggle-1" class="level4">
<h4 class="anchored" data-anchor-id="submit-to-kaggle-1">Submit to Kaggle</h4>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb119" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1">tst_files <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_image_files(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test_images'</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>()</span>
<span id="cb119-2">tst_dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.dls.test_dl(tst_files)</span></code></pre></div>
</div>
<div class="cell" data-outputid="aa9addf0-c9bb-4f7f-a6d8-f1e0304f4d8c" data-execution_count="80">
<div class="sourceCode cell-code" id="cb120" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># TTA for test set</span></span>
<span id="cb120-2">preds,_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.tta(dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tst_dl)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="0" class="" max="12" style="width:300px; height:20px; vertical-align: middle;"></progress>
      
    </div>
    
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb121" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># indices of largest prediction</span></span>
<span id="cb121-2">idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> preds.argmax(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb122" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find values in vocab</span></span>
<span id="cb122-2">vocab <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(learn.dls.vocab)</span>
<span id="cb122-3">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.Series(vocab[idxs], name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"idxs"</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="f787daf8-c23f-4131-b819-a5a827af6c31" data-execution_count="83">
<div class="sourceCode cell-code" id="cb123" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1">sample_sub <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_submission.csv'</span>)</span>
<span id="cb123-2">sample_sub[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> results</span>
<span id="cb123-3">sample_sub.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'part2_subm.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb123-4"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head part2_subm.csv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>image_id,label
200001.jpg,hispa
200002.jpg,normal
200003.jpg,blast
200004.jpg,blast
200005.jpg,blast
200006.jpg,brown_spot
200007.jpg,dead_heart
200008.jpg,brown_spot
200009.jpg,hispa</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ol type="1">
<li><a href="https://course.fast.ai/Lessons/lesson6.html">FastAI Lesson 6</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/how-random-forests-really-work/">How random forests really work</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/first-steps-road-to-the-top-part-1">First Steps: Road to the Top, Part 1</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/small-models-road-to-the-top-part-2/">Small models: Road to the Top, Part 2</a></li>
<li><a href="https://youtube.com/playlist?list=PLfYUBJiXbdtSLBPJ1GMx-sQWf6iNhb8mM&amp;si=WwPOjgYofy4M9QUW">Jeremy Howard FastAI Live Coding</a></li>
<li><a href="https://docs.fast.ai/">fast.ai docs</a></li>
</ol>


</section>

 ]]></description>
  <category>learning</category>
  <category>fastai</category>
  <category>deep learning</category>
  <guid>https://mozartfish.github.io/blog/posts/fastai-lesson6/fastai-lesson6.html</guid>
  <pubDate>Tue, 23 Jan 2024 08:00:00 GMT</pubDate>
</item>
<item>
  <title>FastAI Lesson 5: From-scratch model</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/fastai-lesson5/fastai-lesson5.html</link>
  <description><![CDATA[ 




<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>All of this code was written by Jeremy Howard and the FastAI team. I modified it slightly to include my own print statements, comments and additional helper functions based on Jeremy’s code. This is the source for the original code <a href="https://www.kaggle.com/code/jhoward/linear-model-and-neural-net-from-scratch">Linear model and neural net from scratch</a> and <a href="https://www.kaggle.com/code/jhoward/why-you-should-use-a-framework">Why you should use a framework</a>.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this lesson, Jeremy goes over training a model from scratch using a linear model, neural network and deep learning before finally walking through training a model using fastai + pytorch and an ensemble. This lesson is actually <a href="https://course.fast.ai/Lessons/lesson3.html">lesson 3</a>, <a href="https://course.fast.ai/Lessons/lesson5.html">lesson 5</a> and part of <a href="https://course.fast.ai/Lessons/lesson6.html">lesson 6</a> so I had to go back to review <a href="https://course.fast.ai/Lessons/lesson3.html">lesson 3</a> to make sure I understood the material for <a href="https://course.fast.ai/Lessons/lesson5.html">lesson 5</a>. I highly recommend going over <a href="https://course.fast.ai/Lessons/lesson3.html">lesson 3</a> and <a href="https://nbviewer.org/github/fastai/fastbook/blob/master/04_mnist_basics.ipynb">chapter 4</a> before this lesson because Jeremy doesn’t go too deep into the meaning of tensor shape and rank as he does in <code>chapter 4</code>. This lesson was really exciting from the programming side because I learned more about python and numerical programming with partials, broadcasting, data cleaning with pandas, and <a href="https://www.kaggle.com/code/gunesevitan/titanic-advanced-feature-engineering-tutorial/">feature engineering</a>.</p>
</section>
<section id="titanic---machine-learning-from-disaster" class="level2">
<h2 class="anchored" data-anchor-id="titanic---machine-learning-from-disaster">Titanic - Machine Learning From Disaster</h2>
<p>The Titanic - Machine Learning from Disaster Competition is used as the case study for this lesson. More information about the data can be found here <a href="https://www.kaggle.com/competitions/titanic/">Titanic - Machine Learning from Disaster</a>.</p>
</section>
<section id="load-data-and-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-data-and-libraries">Load Data and Libraries</h2>
<div class="cell" data-outputid="0df96e06-87fe-46f8-d38a-17f5adbeeac5" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import libraries and files</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># required libraries + packages for any ml/data science project</span></span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fastai library contains all the packages above and wraps them in the fastai library</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uqq fastai</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kaggle API package install</span></span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install kaggle</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: kaggle in /usr/local/lib/python3.10/dist-packages (1.5.16)
Requirement already satisfied: six&gt;=1.10 in /usr/local/lib/python3.10/dist-packages (from kaggle) (1.16.0)
Requirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from kaggle) (2023.11.17)
Requirement already satisfied: python-dateutil in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.8.2)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.31.0)
Requirement already satisfied: tqdm in /usr/local/lib/python3.10/dist-packages (from kaggle) (4.66.1)
Requirement already satisfied: python-slugify in /usr/local/lib/python3.10/dist-packages (from kaggle) (8.0.1)
Requirement already satisfied: urllib3 in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.0.7)
Requirement already satisfied: bleach in /usr/local/lib/python3.10/dist-packages (from kaggle) (6.1.0)
Requirement already satisfied: webencodings in /usr/local/lib/python3.10/dist-packages (from bleach-&gt;kaggle) (0.5.1)
Requirement already satisfied: text-unidecode&gt;=1.3 in /usr/local/lib/python3.10/dist-packages (from python-slugify-&gt;kaggle) (1.3)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;kaggle) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;kaggle) (3.6)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.imports <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zipfile</span>
<span id="cb3-5"></span>
<span id="cb3-6"></span>
<span id="cb3-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Function for loading kaggle datasets locally or on kaggle</span></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Returns a local path to data files</span></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">- input: Kaggle API Login Credentials, Kaggle Contest Name '''</span></span>
<span id="cb3-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> loadData(creds, dataFile):</span>
<span id="cb3-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable to check whether we're running on kaggle website or not</span></span>
<span id="cb3-12">    iskaggle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.environ.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'KAGGLE_KERNEL_RUN_TYPE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb3-13"></span>
<span id="cb3-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># path for kaggle API credentials</span></span>
<span id="cb3-15">    cred_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'~/.kaggle/kaggle.json'</span>).expanduser()</span>
<span id="cb3-16"></span>
<span id="cb3-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> cred_path.exists():</span>
<span id="cb3-18">        cred_path.parent.mkdir(exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-19">        cred_path.write_text(creds)</span>
<span id="cb3-20">        cred_path.chmod(<span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0o600</span>)</span>
<span id="cb3-21"></span>
<span id="cb3-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from Kaggle to path and extract files at path location</span></span>
<span id="cb3-23"></span>
<span id="cb3-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># local machine</span></span>
<span id="cb3-25">    path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(dataFile)</span>
<span id="cb3-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> iskaggle <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> path.exists():</span>
<span id="cb3-27">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> kaggle</span>
<span id="cb3-28">        kaggle.api.competition_download_cli(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(path))</span>
<span id="cb3-29">        zipfile.ZipFile(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.zip'</span>).extractall(path)</span>
<span id="cb3-30"></span>
<span id="cb3-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kaggle</span></span>
<span id="cb3-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> iskaggle:</span>
<span id="cb3-33">        fileName <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'../input/'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dataFile</span>
<span id="cb3-34">        path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fileName</span>
<span id="cb3-35"></span>
<span id="cb3-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> path</span></code></pre></div>
</div>
<div class="cell" data-outputid="aece7ca0-56a6-4499-b27e-05c469572941" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">creds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb4-2">dataFile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'titanic'</span></span>
<span id="cb4-3">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loadData(creds, dataFile)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading titanic.zip to /content
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 34.1k/34.1k [00:00&lt;00:00, 38.6MB/s]</code></pre>
</div>
</div>
<div class="cell" data-outputid="4afb59a7-4580-4e20-dfd6-59aa8e859bf1" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check data files</span></span>
<span id="cb7-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>ls {path}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>gender_submission.csv  test.csv  train.csv</code></pre>
</div>
</div>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set up default settings</span></span>
<span id="cb9-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings, logging, torch</span>
<span id="cb9-3">torch.set_printoptions(linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>, sci_mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>, edgeitems<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>)</span>
<span id="cb9-4">pd.set_option(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'display.width'</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>)</span>
<span id="cb9-5">warnings.simplefilter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>)</span>
<span id="cb9-6">logging.disable(logging.WARNING)</span></code></pre></div>
</div>
</section>
<section id="problem-statement" class="level2">
<h2 class="anchored" data-anchor-id="problem-statement">Problem Statement</h2>
<p><code>Problem</code></p>
<p>what sorts of people were more likely to survive the Titanic Disaster</p>
<ul>
<li>use machine learning to create a model that predicts which passengers survived the Titanic Shipwreck using passenger data(name, age, gender, socio-economic class, etc)</li>
</ul>
<p><code>Training Data</code></p>
<ul>
<li>contains subset of the passengers on board Titanic (891 passengers) with information on whether they survived or not(ground truth)</li>
</ul>
<p><code>Test(Inference) Data</code></p>
<ul>
<li>contains same information as train data but does disclose the ground truth (whether passenger survived or not)</li>
<li>using patterns found in train data, predict whether the other 418 passsengers on board (test data) survived</li>
</ul>
<p><code>Evaluation Goal</code></p>
<ul>
<li>Predict if a passenger survived the sinking of the titanic or not</li>
<li>For each value in test set, predict 0 or 1 value for the variable</li>
</ul>
<p><code>Evaluation Metric</code></p>
<ul>
<li>Score is the percentage of passenger correctly predicted (accuracy)</li>
</ul>
<p><code>Submission Format</code></p>
<ul>
<li>PassengerID, Survived (contains binary predictions: 1 for survived, 0 for deceased)</li>
</ul>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<section id="exploratory-data-analysis-data-processing" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis-data-processing">Exploratory Data Analysis: Data Processing</h3>
<div class="cell" data-outputid="29057cee-cd96-40d0-c0f0-3928d958bbb3" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load data and view data</span></span>
<span id="cb10-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>)</span>
<span id="cb10-3">df</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">

  <div id="df-897ca004-1e9f-4f47-9e12-2bbd60cd70e5" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PassengerId</th>
<th data-quarto-table-cell-role="th">Survived</th>
<th data-quarto-table-cell-role="th">Pclass</th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">SibSp</th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Ticket</th>
<th data-quarto-table-cell-role="th">Fare</th>
<th data-quarto-table-cell-role="th">Cabin</th>
<th data-quarto-table-cell-role="th">Embarked</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0</td>
<td>3</td>
<td>Braund, Mr. Owen Harris</td>
<td>male</td>
<td>22.0</td>
<td>1</td>
<td>0</td>
<td>A/5 21171</td>
<td>7.2500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>1</td>
<td>1</td>
<td>Cumings, Mrs. John Bradley (Florence Briggs Thayer)</td>
<td>female</td>
<td>38.0</td>
<td>1</td>
<td>0</td>
<td>PC 17599</td>
<td>71.2833</td>
<td>C85</td>
<td>C</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>1</td>
<td>3</td>
<td>Heikkinen, Miss. Laina</td>
<td>female</td>
<td>26.0</td>
<td>0</td>
<td>0</td>
<td>STON/O2. 3101282</td>
<td>7.9250</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>1</td>
<td>1</td>
<td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
<td>female</td>
<td>35.0</td>
<td>1</td>
<td>0</td>
<td>113803</td>
<td>53.1000</td>
<td>C123</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>0</td>
<td>3</td>
<td>Allen, Mr. William Henry</td>
<td>male</td>
<td>35.0</td>
<td>0</td>
<td>0</td>
<td>373450</td>
<td>8.0500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">886</td>
<td>887</td>
<td>0</td>
<td>2</td>
<td>Montvila, Rev. Juozas</td>
<td>male</td>
<td>27.0</td>
<td>0</td>
<td>0</td>
<td>211536</td>
<td>13.0000</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">887</td>
<td>888</td>
<td>1</td>
<td>1</td>
<td>Graham, Miss. Margaret Edith</td>
<td>female</td>
<td>19.0</td>
<td>0</td>
<td>0</td>
<td>112053</td>
<td>30.0000</td>
<td>B42</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">888</td>
<td>889</td>
<td>0</td>
<td>3</td>
<td>Johnston, Miss. Catherine Helen "Carrie"</td>
<td>female</td>
<td>NaN</td>
<td>1</td>
<td>2</td>
<td>W./C. 6607</td>
<td>23.4500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">889</td>
<td>890</td>
<td>1</td>
<td>1</td>
<td>Behr, Mr. Karl Howell</td>
<td>male</td>
<td>26.0</td>
<td>0</td>
<td>0</td>
<td>111369</td>
<td>30.0000</td>
<td>C148</td>
<td>C</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">890</td>
<td>891</td>
<td>0</td>
<td>3</td>
<td>Dooley, Mr. Patrick</td>
<td>male</td>
<td>32.0</td>
<td>0</td>
<td>0</td>
<td>370376</td>
<td>7.7500</td>
<td>NaN</td>
<td>Q</td>
</tr>
</tbody>
</table>


<p>891 rows × 12 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-897ca004-1e9f-4f47-9e12-2bbd60cd70e5')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-897ca004-1e9f-4f47-9e12-2bbd60cd70e5 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-897ca004-1e9f-4f47-9e12-2bbd60cd70e5');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-ce2c0fc0-049e-414e-9174-e03dd1481cd9">
  <button class="colab-df-quickchart" onclick="quickchart('df-ce2c0fc0-049e-414e-9174-e03dd1481cd9')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-ce2c0fc0-049e-414e-9174-e03dd1481cd9 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

  <div id="id_69833e9d-0f06-4706-985b-9472ac3a1ff0">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('df')" title="Generate code using this dataframe." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"></path>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_69833e9d-0f06-4706-985b-9472ac3a1ff0 button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('df');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="85722d25-98e0-4e95-ae2f-59dc610bff07" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Count number of missing values in each category</span></span>
<span id="cb11-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 1 - represents NaN value</span></span>
<span id="cb11-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - summation tells how many NaN values are in each column</span></span>
<span id="cb11-4">df.isna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>PassengerId      0
Survived         0
Pclass           0
Name             0
Sex              0
Age            177
SibSp            0
Parch            0
Ticket           0
Fare             0
Cabin          687
Embarked         2
dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace NaN with mode</span></span>
<span id="cb13-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - replace missing values with something meaningful -&gt; mean, median, mode etc</span></span>
<span id="cb13-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in case of ties select first value</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="b3a1f97e-e92f-4615-f716-952babd7b41f" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find modes in different categories</span></span>
<span id="cb14-2">modes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.mode().iloc[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb14-3">modes</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>PassengerId                      1
Survived                       0.0
Pclass                         3.0
Name           Abbing, Mr. Anthony
Sex                           male
Age                           24.0
SibSp                          0.0
Parch                          0.0
Ticket                        1601
Fare                          8.05
Cabin                      B96 B98
Embarked                         S
Name: 0, dtype: object</code></pre>
</div>
</div>
<div class="cell" data-outputid="98687b1a-0e75-45cf-8c54-172110acf9a9" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Replace NaN with mode and verify there are no NaN values</span></span>
<span id="cb16-2">df.fillna(modes, inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb16-3">df.isna().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">
<pre><code>PassengerId    0
Survived       0
Pclass         0
Name           0
Sex            0
Age            0
SibSp          0
Parch          0
Ticket         0
Fare           0
Cabin          0
Embarked       0
dtype: int64</code></pre>
</div>
</div>
</section>
<section id="exploratory-data-analysis-numeric-data" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis-numeric-data">Exploratory Data Analysis: Numeric Data</h3>
<div class="cell" data-outputid="677dd902-4c47-481e-accc-8862b66617c2" data-execution_count="11">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># summary of all numeric columns in data</span></span>
<span id="cb18-2">df.describe(include<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(np.number))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">

  <div id="df-2604a9f1-c390-46b0-a702-f428cabb6aad" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PassengerId</th>
<th data-quarto-table-cell-role="th">Survived</th>
<th data-quarto-table-cell-role="th">Pclass</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">SibSp</th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Fare</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>891.000000</td>
<td>891.000000</td>
<td>891.000000</td>
<td>891.000000</td>
<td>891.000000</td>
<td>891.000000</td>
<td>891.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>446.000000</td>
<td>0.383838</td>
<td>2.308642</td>
<td>28.566970</td>
<td>0.523008</td>
<td>0.381594</td>
<td>32.204208</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>257.353842</td>
<td>0.486592</td>
<td>0.836071</td>
<td>13.199572</td>
<td>1.102743</td>
<td>0.806057</td>
<td>49.693429</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>1.000000</td>
<td>0.000000</td>
<td>1.000000</td>
<td>0.420000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>0.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>223.500000</td>
<td>0.000000</td>
<td>2.000000</td>
<td>22.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>7.910400</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>446.000000</td>
<td>0.000000</td>
<td>3.000000</td>
<td>24.000000</td>
<td>0.000000</td>
<td>0.000000</td>
<td>14.454200</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>668.500000</td>
<td>1.000000</td>
<td>3.000000</td>
<td>35.000000</td>
<td>1.000000</td>
<td>0.000000</td>
<td>31.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>891.000000</td>
<td>1.000000</td>
<td>3.000000</td>
<td>80.000000</td>
<td>8.000000</td>
<td>6.000000</td>
<td>512.329200</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-2604a9f1-c390-46b0-a702-f428cabb6aad')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-2604a9f1-c390-46b0-a702-f428cabb6aad button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-2604a9f1-c390-46b0-a702-f428cabb6aad');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-c9f67ecc-8afb-430d-b12c-e3386d8c07a6">
  <button class="colab-df-quickchart" onclick="quickchart('df-c9f67ecc-8afb-430d-b12c-e3386d8c07a6')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-c9f67ecc-8afb-430d-b12c-e3386d8c07a6 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="8c5a2b24-f636-439a-8ab1-a32e3b2e33be" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># histogram of fare data</span></span>
<span id="cb19-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># long tail to the right histogram</span></span>
<span id="cb19-3">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fare'</span>].hist()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson5/fastai-lesson5_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="5816fb20-3bc8-4f7f-f953-8f9aa4030e06" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># log histogram of fare data to center data</span></span>
<span id="cb20-2">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.log(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb20-3">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>].hist()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson5/fastai-lesson5_files/figure-html/cell-14-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="exploratory-data-analysis-categorical-data" class="level3">
<h3 class="anchored" data-anchor-id="exploratory-data-analysis-categorical-data">Exploratory Data Analysis: Categorical Data</h3>
<div class="cell" data-outputid="177fe250-6966-46ae-b998-417064e2a27c" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Passenger Classes</span></span>
<span id="cb21-2">pclasses <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>(df.Pclass.unique())</span>
<span id="cb21-3">pclasses</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>[1, 2, 3]</code></pre>
</div>
</div>
<div class="cell" data-outputid="760c2185-6bfa-46d1-9638-fd5f14cf3555" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># non-numeric data summary</span></span>
<span id="cb23-2">df.describe(include<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">object</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="15">

  <div id="df-0483ae79-ef61-481e-85ad-152556db05a2" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Ticket</th>
<th data-quarto-table-cell-role="th">Cabin</th>
<th data-quarto-table-cell-role="th">Embarked</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>891</td>
<td>891</td>
<td>891</td>
<td>891</td>
<td>891</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unique</td>
<td>891</td>
<td>2</td>
<td>681</td>
<td>147</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">top</td>
<td>Braund, Mr. Owen Harris</td>
<td>male</td>
<td>347082</td>
<td>B96 B98</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">freq</td>
<td>1</td>
<td>577</td>
<td>7</td>
<td>691</td>
<td>646</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-0483ae79-ef61-481e-85ad-152556db05a2')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-0483ae79-ef61-481e-85ad-152556db05a2 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-0483ae79-ef61-481e-85ad-152556db05a2');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-e3eb23de-5d87-482d-9175-0a0d53a17e55">
  <button class="colab-df-quickchart" onclick="quickchart('df-e3eb23de-5d87-482d-9175-0a0d53a17e55')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-e3eb23de-5d87-482d-9175-0a0d53a17e55 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert Categorical Data to Numerical Data - Dummy Variables</span></span>
<span id="cb24-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Dummy variable is a column that contains 1 where a particular columns contains a particular value</span></span>
<span id="cb24-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and 0 otherwise</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="5f323b8d-b312-47e8-ce6a-0e27a8a7d674" data-execution_count="17">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create dummy variables for categorical variables</span></span>
<span id="cb25-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.get_dummies(df, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sex"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pclass"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Embarked"</span>])</span>
<span id="cb25-3">df.columns</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>Index(['PassengerId', 'Survived', 'Name', 'Age', 'SibSp', 'Parch', 'Ticket', 'Fare', 'Cabin', 'LogFare', 'Sex_female', 'Sex_male',
       'Pclass_1', 'Pclass_2', 'Pclass_3', 'Embarked_C', 'Embarked_Q', 'Embarked_S'],
      dtype='object')</code></pre>
</div>
</div>
<div class="cell" data-outputid="1de4e4ab-90b9-43c3-bbfe-1d186165017e" data-execution_count="18">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># new data with dummy variables</span></span>
<span id="cb27-2">added_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sex_male'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sex_female'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pclass_1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pclass_2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pclass_3'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Embarked_C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Embarked_Q'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Embarked_S'</span>]</span>
<span id="cb27-3">df[added_cols].head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">

  <div id="df-de94bd17-85e6-4feb-ab89-2042fed39681" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Sex_male</th>
<th data-quarto-table-cell-role="th">Sex_female</th>
<th data-quarto-table-cell-role="th">Pclass_1</th>
<th data-quarto-table-cell-role="th">Pclass_2</th>
<th data-quarto-table-cell-role="th">Pclass_3</th>
<th data-quarto-table-cell-role="th">Embarked_C</th>
<th data-quarto-table-cell-role="th">Embarked_Q</th>
<th data-quarto-table-cell-role="th">Embarked_S</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-de94bd17-85e6-4feb-ab89-2042fed39681')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-de94bd17-85e6-4feb-ab89-2042fed39681 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-de94bd17-85e6-4feb-ab89-2042fed39681');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-23999bec-6a08-48bc-bd43-ac4e64814911">
  <button class="colab-df-quickchart" onclick="quickchart('df-23999bec-6a08-48bc-bd43-ac4e64814911')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-23999bec-6a08-48bc-bd43-ac4e64814911 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
</section>
</section>
<section id="linear-model" class="level2">
<h2 class="anchored" data-anchor-id="linear-model">Linear Model</h2>
<section id="linear-model-variables" class="level3">
<h3 class="anchored" data-anchor-id="linear-model-variables">Linear Model Variables</h3>
<ul>
<li><strong>Independent Variables</strong> - predictors: all continuous variables + dummy variables</li>
<li><strong>Dependent Variables</strong> - target: survived</li>
</ul>
<div class="cell" data-outputid="701bba18-250a-4b0c-8938-a827a986b058" data-execution_count="19">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Linear Model Data Processing</span></span>
<span id="cb28-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tensor</span>
<span id="cb28-3"></span>
<span id="cb28-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># independent(predictors)</span></span>
<span id="cb28-5">indep_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Age'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SibSp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Parch'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> added_cols</span>
<span id="cb28-6">t_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor(df[indep_cols].values, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>)</span>
<span id="cb28-7"></span>
<span id="cb28-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dependent(target) variables - Survived</span></span>
<span id="cb28-9">t_dep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor(df.Survived)</span>
<span id="cb28-10"></span>
<span id="cb28-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print information about tensors</span></span>
<span id="cb28-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Indendent Tensors Shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t_indep<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Independent Tensors Rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(t_indep.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Dependent Tensors Shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t_dep<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Dependent Tensors Rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(t_dep.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Indendent Tensors Shape: torch.Size([891, 12])
Independent Tensors Rank: 2
Dependent Tensors Shape: torch.Size([891])
Dependent Tensors Rank: 1</code></pre>
</div>
</div>
<div class="cell" data-outputid="0a3b9f43-35da-48df-fb13-6b19f74a7a4a" data-execution_count="20">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do not use this in practice -&gt; this is to ensure reproducibility in experimentation</span></span>
<span id="cb30-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do not seed manually when done with experimentation</span></span>
<span id="cb30-3">torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">442</span>)</span>
<span id="cb30-4"></span>
<span id="cb30-5">n_coeff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t_indep.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb30-6">coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(n_coeff) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb30-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Coefficients shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>coeffs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Coefficients rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(coeffs.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb30-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Coefficients: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>coeffs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coefficients shape: torch.Size([12])
Coefficients rank: 1
Coefficients: tensor([-0.4629,  0.1386,  0.2409, -0.2262, -0.2632, -0.3147,  0.4876,  0.3136,  0.2799, -0.4392,  0.2103,  0.3625])</code></pre>
</div>
</div>
<div class="cell" data-outputid="13d98a4c-1057-4716-c5f1-60b909160e24" data-execution_count="21">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># element wise multiplication using broadcasting - multiply every row by coefficients</span></span>
<span id="cb32-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  - can be interpreted as looping 891 times and multiplying each row value by corresponding coeff value</span></span>
<span id="cb32-3">t_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> coeffs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>tensor([[-10.1838,   0.1386,   0.0000,  -0.4772,  -0.2632,  -0.0000,   0.0000,   0.0000,   0.2799,  -0.0000,   0.0000,   0.3625],
        [-17.5902,   0.1386,   0.0000,  -0.9681,  -0.0000,  -0.3147,   0.4876,   0.0000,   0.0000,  -0.4392,   0.0000,   0.0000],
        [-12.0354,   0.0000,   0.0000,  -0.4950,  -0.0000,  -0.3147,   0.0000,   0.0000,   0.2799,  -0.0000,   0.0000,   0.3625],
        [-16.2015,   0.1386,   0.0000,  -0.9025,  -0.0000,  -0.3147,   0.4876,   0.0000,   0.0000,  -0.0000,   0.0000,   0.3625],
        [-16.2015,   0.0000,   0.0000,  -0.4982,  -0.2632,  -0.0000,   0.0000,   0.0000,   0.2799,  -0.0000,   0.0000,   0.3625],
        [-11.1096,   0.0000,   0.0000,  -0.5081,  -0.2632,  -0.0000,   0.0000,   0.0000,   0.2799,  -0.0000,   0.2103,   0.0000],
        [-24.9966,   0.0000,   0.0000,  -0.8973,  -0.2632,  -0.0000,   0.4876,   0.0000,   0.0000,  -0.0000,   0.0000,   0.3625],
        ...,
        [-11.5725,   0.0000,   0.0000,  -0.4717,  -0.2632,  -0.0000,   0.0000,   0.0000,   0.2799,  -0.0000,   0.0000,   0.3625],
        [-18.0531,   0.0000,   1.2045,  -0.7701,  -0.0000,  -0.3147,   0.0000,   0.0000,   0.2799,  -0.0000,   0.2103,   0.0000],
        [-12.4983,   0.0000,   0.0000,  -0.5968,  -0.2632,  -0.0000,   0.0000,   0.3136,   0.0000,  -0.0000,   0.0000,   0.3625],
        [ -8.7951,   0.0000,   0.0000,  -0.7766,  -0.0000,  -0.3147,   0.4876,   0.0000,   0.0000,  -0.0000,   0.0000,   0.3625],
        [-11.1096,   0.1386,   0.4818,  -0.7229,  -0.0000,  -0.3147,   0.0000,   0.0000,   0.2799,  -0.0000,   0.0000,   0.3625],
        [-12.0354,   0.0000,   0.0000,  -0.7766,  -0.2632,  -0.0000,   0.4876,   0.0000,   0.0000,  -0.4392,   0.0000,   0.0000],
        [-14.8128,   0.0000,   0.0000,  -0.4905,  -0.2632,  -0.0000,   0.0000,   0.0000,   0.2799,  -0.0000,   0.2103,   0.0000]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="92201387-2e31-4050-eafc-a91f2d49d22e" data-execution_count="22">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sum of each row are dominated by Age since Age is larger than all the other variables</span></span>
<span id="cb34-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># center data to between 0 and 1 by averaging each column</span></span>
<span id="cb34-3"></span>
<span id="cb34-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find max val in each row</span></span>
<span id="cb34-5">vals,indices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t_indep.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb34-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"vals shape </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>vals<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb34-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"vals rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(vals.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb34-8"></span>
<span id="cb34-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - can be interpreted as looping 891 times and dividing each row value by corresponding value in vals</span></span>
<span id="cb34-10">t_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> vals</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>vals shape torch.Size([12])
vals rank: 1</code></pre>
</div>
</div>
<div class="cell" data-outputid="8f5e017f-8683-417b-fe77-ece4bde04087" data-execution_count="23">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Recompute coefficients using new new centered independent variable values</span></span>
<span id="cb36-2">t_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> coeffs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>tensor([[-0.1273,  0.0173,  0.0000, -0.0765, -0.2632, -0.0000,  0.0000,  0.0000,  0.2799, -0.0000,  0.0000,  0.3625],
        [-0.2199,  0.0173,  0.0000, -0.1551, -0.0000, -0.3147,  0.4876,  0.0000,  0.0000, -0.4392,  0.0000,  0.0000],
        [-0.1504,  0.0000,  0.0000, -0.0793, -0.0000, -0.3147,  0.0000,  0.0000,  0.2799, -0.0000,  0.0000,  0.3625],
        [-0.2025,  0.0173,  0.0000, -0.1446, -0.0000, -0.3147,  0.4876,  0.0000,  0.0000, -0.0000,  0.0000,  0.3625],
        [-0.2025,  0.0000,  0.0000, -0.0798, -0.2632, -0.0000,  0.0000,  0.0000,  0.2799, -0.0000,  0.0000,  0.3625],
        [-0.1389,  0.0000,  0.0000, -0.0814, -0.2632, -0.0000,  0.0000,  0.0000,  0.2799, -0.0000,  0.2103,  0.0000],
        [-0.3125,  0.0000,  0.0000, -0.1438, -0.2632, -0.0000,  0.4876,  0.0000,  0.0000, -0.0000,  0.0000,  0.3625],
        ...,
        [-0.1447,  0.0000,  0.0000, -0.0756, -0.2632, -0.0000,  0.0000,  0.0000,  0.2799, -0.0000,  0.0000,  0.3625],
        [-0.2257,  0.0000,  0.2008, -0.1234, -0.0000, -0.3147,  0.0000,  0.0000,  0.2799, -0.0000,  0.2103,  0.0000],
        [-0.1562,  0.0000,  0.0000, -0.0956, -0.2632, -0.0000,  0.0000,  0.3136,  0.0000, -0.0000,  0.0000,  0.3625],
        [-0.1099,  0.0000,  0.0000, -0.1244, -0.0000, -0.3147,  0.4876,  0.0000,  0.0000, -0.0000,  0.0000,  0.3625],
        [-0.1389,  0.0173,  0.0803, -0.1158, -0.0000, -0.3147,  0.0000,  0.0000,  0.2799, -0.0000,  0.0000,  0.3625],
        [-0.1504,  0.0000,  0.0000, -0.1244, -0.2632, -0.0000,  0.4876,  0.0000,  0.0000, -0.4392,  0.0000,  0.0000],
        [-0.1852,  0.0000,  0.0000, -0.0786, -0.2632, -0.0000,  0.0000,  0.0000,  0.2799, -0.0000,  0.2103,  0.0000]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="6c746f47-6d3c-479b-b703-8e37f6373e0c" data-execution_count="24">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate Prediction</span></span>
<span id="cb38-2">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (t_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> coeffs).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb38-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"first few predictions: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>preds[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>first few predictions: tensor([ 0.1927, -0.6239,  0.0979,  0.2056,  0.0968,  0.0066,  0.1306,  0.3476,  0.1613, -0.6285])</code></pre>
</div>
</div>
<div class="cell" data-outputid="67e9f6ef-825a-4076-f492-7703939e3d5b" data-execution_count="25">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loss Function -&gt; Mean Absolute Error</span></span>
<span id="cb40-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Loss function is required for doing gradient descent</span></span>
<span id="cb40-3">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t_dep).mean()</span>
<span id="cb40-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Loss: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Loss: 0.5382388234138489</code></pre>
</div>
</div>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functions for computing predictions and loss</span></span>
<span id="cb42-2"></span>
<span id="cb42-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute Predictions</span></span>
<span id="cb42-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_preds(coeffs, indeps):</span>
<span id="cb42-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (indeps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> coeffs).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb42-6"></span>
<span id="cb42-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute Loss</span></span>
<span id="cb42-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_loss(coeffs, indeps, deps):</span>
<span id="cb42-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(calc_preds(coeffs, indeps) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> deps).mean()</span></code></pre></div>
</div>
</section>
<section id="gradient-descent" class="level3">
<h3 class="anchored" data-anchor-id="gradient-descent">Gradient Descent</h3>
<div class="cell" data-outputid="0aa2d2a8-795b-43bf-d393-af22f25591d5" data-execution_count="27">
<div class="sourceCode cell-code" id="cb43" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tell pytorch to calculate gradients</span></span>
<span id="cb43-2">coeffs.requires_grad_()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>tensor([-0.4629,  0.1386,  0.2409, -0.2262, -0.2632, -0.3147,  0.4876,  0.3136,  0.2799, -0.4392,  0.2103,  0.3625], requires_grad=True)</code></pre>
</div>
</div>
<div class="cell" data-outputid="5cc08710-3420-4dcc-ef22-1cc9a0742c07" data-execution_count="28">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate loss</span></span>
<span id="cb45-2">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calc_loss(coeffs, t_indep, t_dep)</span>
<span id="cb45-3">loss</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>tensor(0.5382, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb47" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate gradients</span></span>
<span id="cb47-2">loss.backward()</span></code></pre></div>
</div>
<div class="cell" data-outputid="0284aa6c-8f3d-4a95-9bcc-c8f32f9c0c29" data-execution_count="30">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gradients</span></span>
<span id="cb48-2">coeffs.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>tensor([-0.0106,  0.0129, -0.0041, -0.0484,  0.2099, -0.2132, -0.1212, -0.0247,  0.1425, -0.1886, -0.0191,  0.2043])</code></pre>
</div>
</div>
<div class="cell" data-outputid="1342aa2d-043e-452b-860c-b75ffff6e244" data-execution_count="31">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - each call to backward, gradients are added to the value stored in grad attribute</span></span>
<span id="cb50-2">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calc_loss(coeffs, t_indep, t_dep)</span>
<span id="cb50-3">loss.backward()</span>
<span id="cb50-4">coeffs.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>tensor([-0.0212,  0.0258, -0.0082, -0.0969,  0.4198, -0.4265, -0.2424, -0.0494,  0.2851, -0.3771, -0.0382,  0.4085])</code></pre>
</div>
</div>
<div class="cell" data-outputid="47bb2616-b9a6-495a-b596-59bd67925046" data-execution_count="32">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># reset gradients to zero after doing a single gradient step</span></span>
<span id="cb52-2">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calc_loss(coeffs, t_indep, t_dep)</span>
<span id="cb52-3">loss.backward()</span>
<span id="cb52-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb52-5">  coeffs.sub_(coeffs.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb52-6">  coeffs.grad.zero_()</span>
<span id="cb52-7">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(calc_loss(coeffs, t_indep, t_dep))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tensor(0.4945)</code></pre>
</div>
</div>
</section>
<section id="linear-model-training" class="level3">
<h3 class="anchored" data-anchor-id="linear-model-training">Linear Model Training</h3>
<div class="cell" data-outputid="28356a2d-95a6-45bd-eba5-aba024fc5654" data-execution_count="33">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data split</span></span>
<span id="cb54-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.data.transforms <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> RandomSplitter</span>
<span id="cb54-3">trn_split,val_split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RandomSplitter(seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)(df)</span>
<span id="cb54-4"></span>
<span id="cb54-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Training Data Size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trn_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb54-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Validation Data Size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(val_split)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb54-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Training Data Indices: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>trn_split<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb54-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Validation Data Indices: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>val_split<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training Data Size: 713
Validation Data Size: 178
Training Data Indices: [788, 525, 821, 253, 374, 98, 215, 313, 281, 305, 701, 812, 76, 50, 387, 47, 516, 564, 434, 117, 150, 513, 676, 470, 569, 603, 816, 719, 120, 88, 204, 617, 615, 61, 648, 139, 840, 831, 302, 118, 58, 257, 404, 24, 618, 730, 371, 104, 370, 592, 548, 633, 216, 682, 157, 103, 512, 574, 650, 312, 757, 225, 241, 557, 808, 827, 334, 208, 23, 2, 28, 319, 463, 77, 34, 637, 842, 30, 460, 888, 217, 405, 10, 66, 852, 291, 249, 872, 75, 450, 597, 377, 178, 207, 737, 318, 573, 64, 415, 220, 184, 49, 384, 97, 121, 111, 568, 873, 343, 495, 611, 712, 723, 829, 871, 29, 641, 69, 844, 383, 560, 394, 817, 643, 820, 832, 409, 645, 441, 732, 636, 848, 475, 317, 884, 881, 367, 562, 689, 841, 805, 716, 81, 54, 44, 136, 364, 35, 796, 373, 342, 550, 543, 851, 185, 85, 451, 826, 761, 399, 16, 125, 264, 162, 197, 309, 804, 42, 545, 846, 622, 177, 273, 559, 815, 74, 248, 809, 403, 728, 613, 96, 549, 258, 192, 780, 263, 109, 803, 20, 715, 487, 375, 570, 108, 628, 153, 474, 572, 306, 341, 763, 877, 227, 454, 535, 767, 33, 193, 793, 62, 311, 285, 861, 687, 738, 498, 235, 507, 5, 743, 499, 160, 686, 445, 368, 660, 748, 813, 614, 431, 534, 152, 810, 314, 423, 166, 567, 447, 296, 621, 688, 147, 176, 662, 481, 407, 22, 878, 702, 542, 219, 604, 448, 866, 508, 267, 786, 190, 339, 222, 473, 365, 363, 469, 746, 554, 349, 428, 60, 421, 25, 331, 429, 39, 752, 419, 553, 879, 558, 802, 360, 372, 19, 156, 483, 251, 801, 882, 547, 744, 704, 602, 164, 608, 78, 750, 201, 722, 142, 171, 762, 3, 828, 482, 472, 458, 130, 576, 231, 468, 843, 43, 647, 11, 132, 760, 785, 206, 556, 72, 886, 413, 293, 284, 348, 751, 759, 488, 68, 529, 503, 389, 381, 883, 432, 830, 238, 345, 269, 555, 83, 672, 14, 818, 167, 651, 819, 718, 502, 316, 836, 410, 99, 625, 278, 352, 640, 295, 765, 741, 112, 847, 539, 165, 616, 772, 596, 320, 546, 181, 709, 395, 401, 230, 347, 510, 626, 223, 127, 205, 756, 355, 52, 773, 697, 565, 610, 337, 158, 329, 795, 15, 749, 792, 486, 789, 430, 416, 544, 149, 73, 210, 855, 254, 776, 522, 739, 114, 661, 777, 380, 600, 107, 36, 856, 396, 838, 354, 161, 351, 708, 590, 734, 393, 632, 406, 703, 138, 426, 845, 674, 668, 500, 247, 680, 659, 653, 620, 262, 41, 781, 652, 307, 350, 382, 577, 40, 209, 357, 17, 717, 527, 666, 196, 174, 116, 124, 530, 82, 133, 607, 679, 850, 272, 771, 849, 137, 57, 457, 195, 268, 601, 497, 145, 745, 95, 839, 453, 561, 287, 684, 858, 571, 675, 433, 876, 422, 654, 186, 627, 673, 511, 493, 214, 520, 308, 338, 720, 323, 727, 496, 101, 234, 692, 455, 13, 663, 237, 665, 203, 724, 501, 449, 521, 261, 860, 514, 609, 259, 726, 169, 731, 541, 80, 335, 420, 86, 612, 794, 536, 244, 332, 669, 328, 664, 655, 524, 667, 677, 461, 834, 271, 92, 199, 243, 631, 155, 696, 46, 392, 325, 711, 379, 523, 494, 578, 9, 200, 485, 93, 437, 800, 221, 87, 154, 27, 255, 290, 833, 53, 327, 678, 425, 48, 583, 198, 0, 835, 194, 491, 94, 6, 353, 594, 79, 100, 863, 90, 310, 336, 859, 402, 775, 444, 159, 634, 791, 623, 466, 528, 649, 340, 624, 887, 294, 240, 478, 823, 588, 714, 889, 671, 862, 356, 551, 304, 135, 378, 346, 552, 629, 733, 517, 212, 7, 321, 265, 398, 442, 400, 84, 228, 436, 725, 783, 681, 411, 700, 67, 584, 635, 91, 277, 875, 388, 239, 582, 774, 440, 141, 694, 4, 766, 857, 424, 105, 683, 279, 867, 55, 51, 479, 747, 657, 242, 110, 326, 260, 59, 297, 180, 408, 63, 32, 822, 106, 270, 427, 698, 806, 755, 799, 824, 693, 465, 256, 418, 446, 695, 276, 26, 885, 599, 707, 585, 646, 595, 758, 189, 8, 170, 144, 280, 146, 391, 807, 179, 173, 462, 358, 532, 344]
Validation Data Indices: [303, 778, 531, 385, 134, 476, 691, 443, 386, 128, 579, 65, 869, 359, 202, 187, 456, 880, 705, 797, 656, 467, 581, 754, 131, 768, 172, 252, 163, 300, 417, 71, 566, 814, 322, 119, 515, 369, 89, 729, 226, 563, 148, 218, 12, 638, 509, 333, 825, 376, 245, 480, 182, 784, 619, 70, 126, 605, 37, 735, 452, 721, 630, 115, 854, 102, 864, 811, 188, 706, 870, 140, 439, 868, 168, 764, 589, 224, 191, 586, 183, 742, 753, 250, 526, 685, 505, 435, 874, 658, 769, 45, 537, 798, 644, 292, 397, 330, 289, 143, 175, 274, 519, 606, 690, 288, 286, 670, 484, 477, 506, 18, 740, 412, 464, 366, 736, 790, 699, 299, 266, 587, 459, 233, 598, 782, 246, 315, 282, 236, 504, 639, 518, 123, 31, 283, 232, 713, 122, 211, 213, 591, 129, 890, 229, 275, 471, 533, 853, 362, 38, 593, 56, 787, 301, 324, 837, 113, 21, 538, 710, 361, 490, 390, 1, 779, 580, 865, 438, 492, 642, 575, 151, 770, 414, 540, 298, 489]</code></pre>
</div>
</div>
<div class="cell" data-outputid="ff9d3fa7-01e1-4d8b-d547-bbdc0fb39538" data-execution_count="34">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training Data, Validation Data</span></span>
<span id="cb56-2">trn_indep, val_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t_indep[trn_split], t_indep[val_split]</span>
<span id="cb56-3">trn_dep, val_dep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t_dep[trn_split], t_dep[val_split]</span>
<span id="cb56-4"></span>
<span id="cb56-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Training Independent Data Size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trn_indep)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb56-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Training Dependent Data Size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trn_dep)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb56-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Validation Indepdent Data Size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(val_indep)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb56-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Validation Dependent Data Size: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(val_dep)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training Independent Data Size: 713
Training Dependent Data Size: 713
Validation Indepdent Data Size: 178
Validation Dependent Data Size: 178</code></pre>
</div>
</div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Randomly initialize coefficients</span></span>
<span id="cb58-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> init_coeffs():</span>
<span id="cb58-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (torch.rand(n_coeff) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>).requires_grad_()</span>
<span id="cb58-4"></span>
<span id="cb58-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update coefficents</span></span>
<span id="cb58-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> update_coeffs(coeffs, lr):</span>
<span id="cb58-7">    coeffs.sub_(coeffs.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> lr)</span>
<span id="cb58-8">    coeffs.grad.zero_()</span>
<span id="cb58-9"></span>
<span id="cb58-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># One full gradient descent step</span></span>
<span id="cb58-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> one_epoch(coeffs, lr):</span>
<span id="cb58-12">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calc_loss(coeffs, trn_indep, trn_dep)</span>
<span id="cb58-13">    loss.backward()</span>
<span id="cb58-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb58-15">        update_coeffs(coeffs, lr)</span>
<span id="cb58-16">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"; "</span>)</span>
<span id="cb58-17"></span>
<span id="cb58-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train model</span></span>
<span id="cb58-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> train_model(epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>):</span>
<span id="cb58-20">    torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">442</span>)</span>
<span id="cb58-21">    coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_coeffs()</span>
<span id="cb58-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(epochs):</span>
<span id="cb58-23">      one_epoch(coeffs, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr)</span>
<span id="cb58-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> coeffs</span>
<span id="cb58-25"></span>
<span id="cb58-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate average accuracy of model</span></span>
<span id="cb58-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> acc(coeffs):</span>
<span id="cb58-28">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (val_dep.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (calc_preds(coeffs, val_indep) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean()</span>
<span id="cb58-29"></span>
<span id="cb58-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show coefficients for each column</span></span>
<span id="cb58-31"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> show_coeffs():</span>
<span id="cb58-32">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(indep_cols, coeffs.requires_grad_(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)))</span></code></pre></div>
</div>
<div class="cell" data-outputid="1b3206de-ff6f-41c5-b24a-bbdd83a0deb6" data-execution_count="36">
<div class="sourceCode cell-code" id="cb59" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train Model</span></span>
<span id="cb59-2">coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_model(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">18</span>, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.536; 0.502; 0.477; 0.454; 0.431; 0.409; 0.388; 0.367; 0.349; 0.336; 0.330; 0.326; 0.329; 0.304; 0.314; 0.296; 0.300; 0.289; </code></pre>
</div>
</div>
<div class="cell" data-outputid="13960e75-f139-4683-d68e-543c7fac1529" data-execution_count="37">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Coefficients for every column</span></span>
<span id="cb61-2">show_coeffs()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>{'Age': tensor(-0.2694),
 'SibSp': tensor(0.0901),
 'Parch': tensor(0.2359),
 'LogFare': tensor(0.0280),
 'Sex_male': tensor(-0.3990),
 'Sex_female': tensor(0.2345),
 'Pclass_1': tensor(0.7232),
 'Pclass_2': tensor(0.4112),
 'Pclass_3': tensor(0.3601),
 'Embarked_C': tensor(0.0955),
 'Embarked_Q': tensor(0.2395),
 'Embarked_S': tensor(0.2122)}</code></pre>
</div>
</div>
<div class="cell" data-outputid="b66bc4cd-b122-409d-be06-8624dadaa3cd" data-execution_count="38">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate accuracy</span></span>
<span id="cb63-2">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calc_preds(coeffs, val_indep)</span>
<span id="cb63-3"></span>
<span id="cb63-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - assume that any passenger with score &gt; 0.5 is predicted to survive</span></span>
<span id="cb63-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - correct for  each row where preds &gt; 0.5 is the same as dependent variable</span></span>
<span id="cb63-6">results <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> val_dep.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span>(preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb63-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"First 16 results: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>results[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb63-8"></span>
<span id="cb63-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Average accuracy</span></span>
<span id="cb63-10">avg_acc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> results.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean()</span>
<span id="cb63-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Average Accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>avg_acc<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>First 16 results: tensor([ True,  True,  True,  True,  True,  True,  True,  True,  True,  True, False, False, False,  True,  True, False])
Average Accuracy: 0.7865168452262878</code></pre>
</div>
</div>
</section>
<section id="sigmoid" class="level3">
<h3 class="anchored" data-anchor-id="sigmoid">Sigmoid</h3>
<div class="cell" data-outputid="0e916287-5fb4-4ab2-97ad-a0b0a44b6e24" data-execution_count="39">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - some of the predictions of the survival probability are &gt; 1 or &lt; 0</span></span>
<span id="cb65-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - can fix this issue by passing prediction through sigmoid function</span></span>
<span id="cb65-3">preds[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>tensor([ 0.8160,  0.1295, -0.0148,  0.1831,  0.1520,  0.1350,  0.7279,  0.7754,  0.3222,  0.6740,  0.0753,  0.0389,  0.2216,  0.7631,
         0.0678,  0.3997,  0.3324,  0.8278,  0.1078,  0.7126,  0.1023,  0.3627,  0.9937,  0.8050,  0.1153,  0.1455,  0.8652,  0.3425])</code></pre>
</div>
</div>
<div class="cell" data-outputid="e115a59e-9bdf-4924-8a3f-40267f683aa7" data-execution_count="40">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sigmoid function has a minimum of 0 and max at 1</span></span>
<span id="cb67-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sympy</span>
<span id="cb67-3">sympy.plot(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"1/(1+exp(-x))"</span>, xlim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson5/fastai-lesson5_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update calc predictions to use sigmoid</span></span>
<span id="cb68-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_preds(coeffs, indeps):</span>
<span id="cb68-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.sigmoid((indeps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>coeffs).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
</div>
<div class="cell" data-outputid="6817c764-98e1-468b-c470-daf974887c91" data-execution_count="42">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train Model with Sigmoid Predictions</span></span>
<span id="cb69-2">coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_model(lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.510; 0.327; 0.294; 0.207; 0.201; 0.199; 0.198; 0.197; 0.196; 0.196; 0.196; 0.195; 0.195; 0.195; 0.195; 0.195; 0.195; 0.195; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; </code></pre>
</div>
</div>
<div class="cell" data-outputid="f9f19621-05ab-4e4b-e2d6-36caaa321c8c" data-execution_count="43">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check coeffcients</span></span>
<span id="cb71-2">show_coeffs()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>{'Age': tensor(-1.5061),
 'SibSp': tensor(-1.1575),
 'Parch': tensor(-0.4267),
 'LogFare': tensor(0.2543),
 'Sex_male': tensor(-10.3320),
 'Sex_female': tensor(8.4185),
 'Pclass_1': tensor(3.8389),
 'Pclass_2': tensor(2.1398),
 'Pclass_3': tensor(-6.2331),
 'Embarked_C': tensor(1.4771),
 'Embarked_Q': tensor(2.1168),
 'Embarked_S': tensor(-4.7958)}</code></pre>
</div>
</div>
<div class="cell" data-outputid="ad584da5-6691-4020-f594-27238e555f22" data-execution_count="44">
<div class="sourceCode cell-code" id="cb73" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check Accuracy</span></span>
<span id="cb73-2">acc(coeffs)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>tensor(0.8258)</code></pre>
</div>
</div>
</section>
<section id="final-linear-model-setup" class="level3">
<h3 class="anchored" data-anchor-id="final-linear-model-setup">Final Linear Model Setup</h3>
<div class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb75" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of coefficients</span></span>
<span id="cb75-2">n_coeff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t_indep.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb75-3"></span>
<span id="cb75-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Randomly initialize coefficients</span></span>
<span id="cb75-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> init_coeffs():</span>
<span id="cb75-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (torch.rand(n_coeff)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>).requires_grad_()</span>
<span id="cb75-7"></span>
<span id="cb75-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loss Function - MAE (Mean Absolute Error)</span></span>
<span id="cb75-9"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_loss(coeffs, indeps, deps):</span>
<span id="cb75-10">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(calc_preds(coeffs, indeps) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> deps).mean()</span>
<span id="cb75-11"></span>
<span id="cb75-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update coefficents</span></span>
<span id="cb75-13"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> update_coeffs(coeffs, lr):</span>
<span id="cb75-14">    coeffs.sub_(coeffs.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> lr)</span>
<span id="cb75-15">    coeffs.grad.zero_()</span>
<span id="cb75-16"></span>
<span id="cb75-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># One full gradient descent step</span></span>
<span id="cb75-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> one_epoch(coeffs, lr):</span>
<span id="cb75-19">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calc_loss(coeffs, trn_indep, trn_dep)</span>
<span id="cb75-20">    loss.backward()</span>
<span id="cb75-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb75-22">      update_coeffs(coeffs, lr)</span>
<span id="cb75-23">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"; "</span>)</span>
<span id="cb75-24"></span>
<span id="cb75-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train model</span></span>
<span id="cb75-26"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> train_model(epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>):</span>
<span id="cb75-27">    torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">442</span>)</span>
<span id="cb75-28">    coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_coeffs()</span>
<span id="cb75-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(epochs):</span>
<span id="cb75-30">      one_epoch(coeffs, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr)</span>
<span id="cb75-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> coeffs</span>
<span id="cb75-32"></span>
<span id="cb75-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate average accuracy of model</span></span>
<span id="cb75-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> acc(coeffs):</span>
<span id="cb75-35">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (val_dep.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (calc_preds(coeffs, val_indep) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean()</span>
<span id="cb75-36">acc(coeffs)</span>
<span id="cb75-37"></span>
<span id="cb75-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate predictions</span></span>
<span id="cb75-39"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_preds(coeffs, indeps):</span>
<span id="cb75-40">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.sigmoid((indeps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> coeffs).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb75-41"></span>
<span id="cb75-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show coefficients for each column</span></span>
<span id="cb75-43"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> show_coeffs():</span>
<span id="cb75-44">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(indep_cols, coeffs.requires_grad_(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)))</span></code></pre></div>
</div>
<div class="cell" data-outputid="496ff20a-9243-4455-cc01-315757e1a42e" data-execution_count="46">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1">coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_model(lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.510; 0.327; 0.294; 0.207; 0.201; 0.199; 0.198; 0.197; 0.196; 0.196; 0.196; 0.195; 0.195; 0.195; 0.195; 0.195; 0.195; 0.195; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; </code></pre>
</div>
</div>
</section>
<section id="test-model-on-inference-data" class="level3">
<h3 class="anchored" data-anchor-id="test-model-on-inference-data">Test model on inference data</h3>
<section id="inference-data-processing" class="level4">
<h4 class="anchored" data-anchor-id="inference-data-processing">Inference Data Processing</h4>
<div class="cell" data-outputid="69aa4286-ba07-4bbd-a305-538409c22d69" data-execution_count="47">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load data</span></span>
<span id="cb78-2">tst_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.csv'</span>)</span>
<span id="cb78-3"></span>
<span id="cb78-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fare data is missing one passenger -&gt; substitute 0 to fix the issue</span></span>
<span id="cb78-5">tst_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_df.Fare.fillna(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb78-6">tst_df</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="47">

  <div id="df-76359ab6-1db2-4c00-9de8-bfa9106efaca" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PassengerId</th>
<th data-quarto-table-cell-role="th">Pclass</th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">SibSp</th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Ticket</th>
<th data-quarto-table-cell-role="th">Fare</th>
<th data-quarto-table-cell-role="th">Cabin</th>
<th data-quarto-table-cell-role="th">Embarked</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>892</td>
<td>3</td>
<td>Kelly, Mr. James</td>
<td>male</td>
<td>34.5</td>
<td>0</td>
<td>0</td>
<td>330911</td>
<td>7.8292</td>
<td>NaN</td>
<td>Q</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>893</td>
<td>3</td>
<td>Wilkes, Mrs. James (Ellen Needs)</td>
<td>female</td>
<td>47.0</td>
<td>1</td>
<td>0</td>
<td>363272</td>
<td>7.0000</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>894</td>
<td>2</td>
<td>Myles, Mr. Thomas Francis</td>
<td>male</td>
<td>62.0</td>
<td>0</td>
<td>0</td>
<td>240276</td>
<td>9.6875</td>
<td>NaN</td>
<td>Q</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>895</td>
<td>3</td>
<td>Wirz, Mr. Albert</td>
<td>male</td>
<td>27.0</td>
<td>0</td>
<td>0</td>
<td>315154</td>
<td>8.6625</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>896</td>
<td>3</td>
<td>Hirvonen, Mrs. Alexander (Helga E Lindqvist)</td>
<td>female</td>
<td>22.0</td>
<td>1</td>
<td>1</td>
<td>3101298</td>
<td>12.2875</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">413</td>
<td>1305</td>
<td>3</td>
<td>Spector, Mr. Woolf</td>
<td>male</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>A.5. 3236</td>
<td>8.0500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">414</td>
<td>1306</td>
<td>1</td>
<td>Oliva y Ocana, Dona. Fermina</td>
<td>female</td>
<td>39.0</td>
<td>0</td>
<td>0</td>
<td>PC 17758</td>
<td>108.9000</td>
<td>C105</td>
<td>C</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">415</td>
<td>1307</td>
<td>3</td>
<td>Saether, Mr. Simon Sivertsen</td>
<td>male</td>
<td>38.5</td>
<td>0</td>
<td>0</td>
<td>SOTON/O.Q. 3101262</td>
<td>7.2500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">416</td>
<td>1308</td>
<td>3</td>
<td>Ware, Mr. Frederick</td>
<td>male</td>
<td>NaN</td>
<td>0</td>
<td>0</td>
<td>359309</td>
<td>8.0500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">417</td>
<td>1309</td>
<td>3</td>
<td>Peter, Master. Michael J</td>
<td>male</td>
<td>NaN</td>
<td>1</td>
<td>1</td>
<td>2668</td>
<td>22.3583</td>
<td>NaN</td>
<td>C</td>
</tr>
</tbody>
</table>


<p>418 rows × 11 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-76359ab6-1db2-4c00-9de8-bfa9106efaca')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-76359ab6-1db2-4c00-9de8-bfa9106efaca button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-76359ab6-1db2-4c00-9de8-bfa9106efaca');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-a34ff39b-9737-4853-9c2d-048729226a78">
  <button class="colab-df-quickchart" onclick="quickchart('df-a34ff39b-9737-4853-9c2d-048729226a78')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-a34ff39b-9737-4853-9c2d-048729226a78 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

  <div id="id_2d54cad4-991f-4178-b69f-65a9f5aff224">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('tst_df')" title="Generate code using this dataframe." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"></path>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_2d54cad4-991f-4178-b69f-65a9f5aff224 button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('tst_df');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - these steps follow the same process as the training data processing</span></span>
<span id="cb79-2">tst_df.fillna(modes, inplace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb79-3">tst_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.log(tst_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb79-4">tst_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.get_dummies(tst_df, columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sex"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pclass"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Embarked"</span>])</span>
<span id="cb79-5"></span>
<span id="cb79-6">added_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sex_male'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Sex_female'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pclass_1'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pclass_2'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pclass_3'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Embarked_C'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Embarked_Q'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Embarked_S'</span>]</span>
<span id="cb79-7">indep_cols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Age'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SibSp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Parch'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> added_cols</span>
<span id="cb79-8"></span>
<span id="cb79-9">tst_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor(tst_df[indep_cols].values, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>)</span>
<span id="cb79-10">tst_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_indep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> vals</span></code></pre></div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate predictions of which passengers survived in titanic dataset</span></span>
<span id="cb80-2">tst_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survived'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (calc_preds(tst_indep, coeffs) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>()</span></code></pre></div>
</div>
</section>
</section>
<section id="linear-model-submit-results-to-kaggle" class="level3">
<h3 class="anchored" data-anchor-id="linear-model-submit-results-to-kaggle">Linear Model: Submit Results to Kaggle</h3>
<div class="cell" data-outputid="1d16f97c-e69a-4227-d2cd-fe5ba9ba6014" data-execution_count="50">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Submit to Kaggle</span></span>
<span id="cb81-2">sub_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PassengerId'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survived'</span>]]</span>
<span id="cb81-3">sub_df.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sub.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb81-4"></span>
<span id="cb81-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check first few rows</span></span>
<span id="cb81-6"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head sub.csv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PassengerId,Survived
892,0
893,0
894,0
895,0
896,0
897,0
898,1
899,0
900,1</code></pre>
</div>
</div>
</section>
</section>
<section id="cleaning-up-linear-model-code" class="level2">
<h2 class="anchored" data-anchor-id="cleaning-up-linear-model-code">Cleaning up Linear Model Code</h2>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb83" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Multiplying elements together and then adding across rows is the same as matrix-vector multiply</span></span></code></pre></div>
</div>
<div class="cell" data-outputid="df7e57e4-281e-484f-8ccf-91f6427b685f" data-execution_count="52">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Original Matrix-Vector multiply</span></span>
<span id="cb84-2">(val_indep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>coeffs).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="52">
<pre><code>tensor([ 12.3288, -14.8119, -15.4540, -13.1513, -13.3512, -13.6469,   3.6248,   5.3429, -22.0878,   3.1233, -21.8742, -15.6421, -21.5504,
          3.9393, -21.9190, -12.0010, -12.3775,   5.3550, -13.5880,  -3.1015, -21.7237, -12.2081,  12.9767,   4.7427, -21.6525, -14.9135,
         -2.7433, -12.3210, -21.5886,   3.9387,   5.3890,  -3.6196, -21.6296, -21.8454,  12.2159,  -3.2275, -12.0289,  13.4560, -21.7230,
         -3.1366, -13.2462, -21.7230, -13.6831,  13.3092, -21.6477,  -3.5868, -21.6854, -21.8316, -14.8158,  -2.9386,  -5.3103, -22.2384,
        -22.1097, -21.7466, -13.3780, -13.4909, -14.8119, -22.0690, -21.6666, -21.7818,  -5.4439, -21.7407, -12.6551, -21.6671,   4.9238,
        -11.5777, -13.3323, -21.9638, -15.3030,   5.0243, -21.7614,   3.1820, -13.4721, -21.7170, -11.6066, -21.5737, -21.7230, -11.9652,
        -13.2382, -13.7599, -13.2170,  13.1347, -21.7049, -21.7268,   4.9207,  -7.3198,  -5.3081,   7.1065,  11.4948, -13.3135, -21.8723,
        -21.7230,  13.3603, -15.5670,   3.4105,  -7.2857, -13.7197,   3.6909,   3.9763, -14.7227, -21.8268,   3.9387, -21.8743, -21.8367,
        -11.8518, -13.6712, -21.8299,   4.9440,  -5.4471, -21.9666,   5.1333,  -3.2187, -11.6008,  13.7920, -21.7230,  12.6369,  -3.7268,
        -14.8119, -22.0637,  12.9468, -22.1610,  -6.1827, -14.8119,  -3.2838, -15.4540, -11.6950,  -2.9926,  -3.0110, -21.5664, -13.8268,
          7.3426, -21.8418,   5.0744,   5.2582,  13.3415, -21.6289, -13.9898, -21.8112,  -7.3316,   5.2296, -13.4453,  12.7891, -22.1235,
        -14.9625,  -3.4339,   6.3089, -21.9839,   3.1968,   7.2400,   2.8558,  -3.1187,   3.7965,   5.4667, -15.1101, -15.0597, -22.9391,
        -21.7230,  -3.0346, -13.5206, -21.7011,  13.4425,  -7.2690, -21.8335, -12.0582,  13.0489,   6.7993,   5.2160,   5.0794, -12.6957,
        -12.1838,  -3.0873, -21.6070,   7.0744, -21.7170, -22.1001,   6.8159, -11.6002, -21.6310], grad_fn=&lt;SumBackward1&gt;)</code></pre>
</div>
</div>
<div class="cell" data-outputid="27b20f90-0610-4691-8b7b-f519f17e14ec" data-execution_count="53">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pytorch optimized matrix-vector multiply</span></span>
<span id="cb86-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - python uses @ operator to indicate matrix products and is supported by pytorch tensors</span></span>
<span id="cb86-3">val_indep<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>coeffs</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>tensor([ 12.3288, -14.8119, -15.4540, -13.1513, -13.3511, -13.6468,   3.6248,   5.3429, -22.0878,   3.1233, -21.8742, -15.6421, -21.5504,
          3.9393, -21.9190, -12.0010, -12.3775,   5.3550, -13.5880,  -3.1015, -21.7237, -12.2081,  12.9767,   4.7427, -21.6525, -14.9135,
         -2.7433, -12.3210, -21.5886,   3.9387,   5.3890,  -3.6196, -21.6296, -21.8454,  12.2159,  -3.2275, -12.0289,  13.4560, -21.7230,
         -3.1366, -13.2462, -21.7230, -13.6831,  13.3092, -21.6477,  -3.5868, -21.6854, -21.8316, -14.8158,  -2.9386,  -5.3103, -22.2384,
        -22.1097, -21.7466, -13.3780, -13.4909, -14.8119, -22.0690, -21.6666, -21.7818,  -5.4439, -21.7407, -12.6551, -21.6671,   4.9238,
        -11.5777, -13.3323, -21.9638, -15.3030,   5.0243, -21.7614,   3.1820, -13.4721, -21.7170, -11.6066, -21.5737, -21.7230, -11.9652,
        -13.2382, -13.7599, -13.2170,  13.1347, -21.7049, -21.7268,   4.9207,  -7.3198,  -5.3081,   7.1065,  11.4948, -13.3135, -21.8723,
        -21.7230,  13.3603, -15.5670,   3.4105,  -7.2857, -13.7197,   3.6909,   3.9763, -14.7227, -21.8268,   3.9387, -21.8743, -21.8367,
        -11.8518, -13.6712, -21.8299,   4.9440,  -5.4471, -21.9666,   5.1333,  -3.2187, -11.6008,  13.7920, -21.7230,  12.6369,  -3.7268,
        -14.8119, -22.0637,  12.9468, -22.1610,  -6.1827, -14.8119,  -3.2838, -15.4540, -11.6950,  -2.9926,  -3.0110, -21.5664, -13.8268,
          7.3426, -21.8418,   5.0744,   5.2582,  13.3415, -21.6289, -13.9898, -21.8112,  -7.3316,   5.2296, -13.4453,  12.7891, -22.1235,
        -14.9625,  -3.4339,   6.3089, -21.9839,   3.1968,   7.2400,   2.8558,  -3.1187,   3.7965,   5.4667, -15.1101, -15.0597, -22.9391,
        -21.7230,  -3.0346, -13.5206, -21.7011,  13.4425,  -7.2690, -21.8335, -12.0582,  13.0489,   6.7993,   5.2160,   5.0794, -12.6957,
        -12.1838,  -3.0873, -21.6070,   7.0744, -21.7170, -22.1001,   6.8159, -11.6002, -21.6310], grad_fn=&lt;MvBackward0&gt;)</code></pre>
</div>
</div>
<section id="linear-model-pytorch-matrix-vector-multiply" class="level3">
<h3 class="anchored" data-anchor-id="linear-model-pytorch-matrix-vector-multiply">Linear Model: PyTorch Matrix-Vector Multiply</h3>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of coefficients</span></span>
<span id="cb88-2">n_coeff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t_indep.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb88-3"></span>
<span id="cb88-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Randomly initialize coefficients</span></span>
<span id="cb88-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> init_coeffs():</span>
<span id="cb88-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 1 turns torch.rand() into a column vector</span></span>
<span id="cb88-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (torch.rand(n_coeff, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>).requires_grad_()</span>
<span id="cb88-8"></span>
<span id="cb88-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loss Function - MAE (Mean Absolute Error)</span></span>
<span id="cb88-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_loss(coeffs, indeps, deps):</span>
<span id="cb88-11">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(calc_preds(coeffs, indeps) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> deps).mean()</span>
<span id="cb88-12"></span>
<span id="cb88-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update coefficents</span></span>
<span id="cb88-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> update_coeffs(coeffs, lr):</span>
<span id="cb88-15">    coeffs.sub_(coeffs.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> lr)</span>
<span id="cb88-16">    coeffs.grad.zero_()</span>
<span id="cb88-17"></span>
<span id="cb88-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># One full gradient descent step</span></span>
<span id="cb88-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> one_epoch(coeffs, lr):</span>
<span id="cb88-20">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> calc_loss(coeffs, trn_indep, trn_dep)</span>
<span id="cb88-21">    loss.backward()</span>
<span id="cb88-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb88-23">      update_coeffs(coeffs, lr)</span>
<span id="cb88-24">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.3f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>, end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"; "</span>)</span>
<span id="cb88-25"></span>
<span id="cb88-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train model</span></span>
<span id="cb88-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> train_model(epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>):</span>
<span id="cb88-28">    torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">442</span>)</span>
<span id="cb88-29">    coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_coeffs()</span>
<span id="cb88-30">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(epochs):</span>
<span id="cb88-31">      one_epoch(coeffs, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr)</span>
<span id="cb88-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> coeffs</span>
<span id="cb88-33"></span>
<span id="cb88-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate average accuracy of model</span></span>
<span id="cb88-35"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> acc(coeffs):</span>
<span id="cb88-36">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (val_dep.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">bool</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> (calc_preds(coeffs, val_indep) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean()</span>
<span id="cb88-37">acc(coeffs)</span>
<span id="cb88-38"></span>
<span id="cb88-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate predictions</span></span>
<span id="cb88-40"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_preds(coeffs, indeps):</span>
<span id="cb88-41">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.sigmoid(indeps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>coeffs)</span>
<span id="cb88-42"></span>
<span id="cb88-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show coefficients for each column</span></span>
<span id="cb88-44"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> show_coeffs():</span>
<span id="cb88-45">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(indep_cols, coeffs.requires_grad_(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)))</span></code></pre></div>
</div>
<div class="cell" data-outputid="de046e90-5f84-4c85-8cb1-7676d7f984c8" data-execution_count="55">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># change dependent variable into a column vector - rank 2 tensor</span></span>
<span id="cb89-2">trn_dep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trn_dep[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb89-3">val_dep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> val_dep[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb89-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Training Data Shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>trn_dep<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb89-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Training Data Rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trn_dep.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb89-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Validation Data Shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>val_dep<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb89-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Validation Data Rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(val_dep.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Training Data Shape: torch.Size([713, 1])
Training Data Rank: 2
Validation Data Shape: torch.Size([178, 1])
Validation Data Rank: 2</code></pre>
</div>
</div>
<div class="cell" data-outputid="0aab6bfe-dbdb-49fd-e91e-0ae3015e076a" data-execution_count="56">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1">coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_model(lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb91-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span>
<span id="cb91-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"coefficients shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>coeffs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb91-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"coefficients rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(coeffs.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb91-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>acc(coeffs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.512; 0.323; 0.290; 0.205; 0.200; 0.198; 0.197; 0.197; 0.196; 0.196; 0.196; 0.195; 0.195; 0.195; 0.195; 0.195; 0.195; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 0.194; 
coefficients shape: torch.Size([12, 1])
coefficients rank: 2
accuracy: 0.8258426785469055</code></pre>
</div>
</div>
</section>
</section>
<section id="neural-network" class="level2">
<h2 class="anchored" data-anchor-id="neural-network">Neural Network</h2>
<ul>
<li>Define coefficients for each layer of the neural network</li>
</ul>
<p><code>n hidden</code> - higher number gives more flexibility for neural network to approximate data but slower and harder to train</p>
<p><code>First Layer</code> <code>input</code> - n_coeff values <code>output</code> - n_hidden values (input to second layer) - need matrix of size n_coeffs by n_hidden - divide coefficients by n_hidden so that when we sum them up in the next layer so that we end up with similar magnitude numbers to what we started with</p>
<p><code>Second Layer</code> <code>input</code> - n_hidden values (output of first layer) <code>output</code> - 1 value - need n_hidden by 1 + constant term</p>
<p><code>Steps</code> 1. Two matrix products - indeps@l1 and res@l2 (res is output of first layer) 2. First layer output is passed to F.relu (non-linearity) 3. Second layer output is passed to sigmoid</p>
<div class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb93" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> init_coeffs(n_hidden<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb93-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set of coefficients to go from input to hidden</span></span>
<span id="cb93-3">    layer1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (torch.rand(n_coeff, n_hidden) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> n_hidden</span>
<span id="cb93-4"></span>
<span id="cb93-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set of coefficients to from hiddent to an output</span></span>
<span id="cb93-6">    layer2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(n_hidden, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb93-7">    const <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb93-8"></span>
<span id="cb93-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># return a tuple of layer1 gradient, layer2 gradient, and constant gradient</span></span>
<span id="cb93-10">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> layer1.requires_grad_(), layer2.requires_grad_(), const.requires_grad_()</span></code></pre></div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb94-2"></span>
<span id="cb94-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># neural network</span></span>
<span id="cb94-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_preds(coeffs, indeps):</span>
<span id="cb94-5">    l1, l2, const <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coeffs</span>
<span id="cb94-6"></span>
<span id="cb94-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># layer 1</span></span>
<span id="cb94-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># replace negative values with zeroes</span></span>
<span id="cb94-9">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.relu(indeps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>l1)</span>
<span id="cb94-10"></span>
<span id="cb94-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># layer 2</span></span>
<span id="cb94-12">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>l2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> const</span>
<span id="cb94-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.sigmoid(res)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb95" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update Coefficients</span></span>
<span id="cb95-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Three sets of coefficients to update per epoch(layer1, layer2, constant)</span></span>
<span id="cb95-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> update_coeffs(coeffs, lr):</span>
<span id="cb95-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> coeffs:</span>
<span id="cb95-5">    layer.sub_(layer.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> lr)</span>
<span id="cb95-6">    layer.grad.zero_()</span></code></pre></div>
</div>
<div class="cell" data-outputid="8bc288ae-6d05-4692-ca95-585d18a6f161" data-execution_count="60">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train Model</span></span>
<span id="cb96-2">coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_model(lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.543; 0.532; 0.520; 0.505; 0.487; 0.466; 0.439; 0.407; 0.373; 0.343; 0.319; 0.301; 0.286; 0.274; 0.264; 0.256; 0.250; 0.245; 0.240; 0.237; 0.234; 0.231; 0.229; 0.227; 0.226; 0.224; 0.223; 0.222; 0.221; 0.220; </code></pre>
</div>
</div>
<div class="cell" data-outputid="3bdf211d-9ad8-41cc-c722-22f930117720" data-execution_count="61">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train Model</span></span>
<span id="cb98-2">coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_model(lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.543; 0.400; 0.260; 0.390; 0.221; 0.211; 0.197; 0.195; 0.193; 0.193; 0.193; 0.193; 0.193; 0.193; 0.193; 0.193; 0.193; 0.192; 0.192; 0.192; 0.192; 0.192; 0.192; 0.192; 0.192; 0.192; 0.192; 0.192; 0.192; 0.192; </code></pre>
</div>
</div>
<div class="cell" data-outputid="84c0e5f9-cbd4-4e6b-d669-7ed3a69fc83a" data-execution_count="62">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check Accuracy</span></span>
<span id="cb100-2">acc(coeffs)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>tensor(0.8258)</code></pre>
</div>
</div>
</section>
<section id="deep-learning" class="level2">
<h2 class="anchored" data-anchor-id="deep-learning">Deep Learning</h2>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> init_coeffs():</span>
<span id="cb102-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># size of each hidden layer</span></span>
<span id="cb102-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># two hidden layers - 10 activations in each layer</span></span>
<span id="cb102-4">    hiddens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span>
<span id="cb102-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - n_coeffs to 10</span></span>
<span id="cb102-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 10 to 10</span></span>
<span id="cb102-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - 10 to 1</span></span>
<span id="cb102-8">    sizes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [n_coeff] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> hiddens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb102-9">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sizes)</span>
<span id="cb102-10">    layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(torch.rand(sizes[i], sizes[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>sizes[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)]</span>
<span id="cb102-11">    consts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [(torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)]</span>
<span id="cb102-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> l <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> consts:</span>
<span id="cb102-13">      l.requires_grad_()</span>
<span id="cb102-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> layers,consts</span></code></pre></div>
</div>
<div class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb103-2"></span>
<span id="cb103-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_preds(coeffs, indeps):</span>
<span id="cb103-4">    layers,consts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coeffs</span>
<span id="cb103-5">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(layers)</span>
<span id="cb103-6">    res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> indeps</span>
<span id="cb103-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i,l <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(layers):</span>
<span id="cb103-8">        res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> res<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>l <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> consts[i]</span>
<span id="cb103-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RELU for every layer except for last layer</span></span>
<span id="cb103-10">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:</span>
<span id="cb103-11">          res <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.relu(res)</span>
<span id="cb103-12">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sigmoid only for the last layer</span></span>
<span id="cb103-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.sigmoid(res)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> update_coeffs(coeffs, lr):</span>
<span id="cb104-2">    layers,consts <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> coeffs</span>
<span id="cb104-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> layer <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> layers <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> consts:</span>
<span id="cb104-4">        layer.sub_(layer.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> lr)</span>
<span id="cb104-5">        layer.grad.zero_()</span></code></pre></div>
</div>
<div class="cell" data-outputid="397f1f48-a955-44ea-b609-71399611318f" data-execution_count="66">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train Model</span></span>
<span id="cb105-2">coeffs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_model(lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.521; 0.483; 0.427; 0.379; 0.379; 0.379; 0.379; 0.378; 0.378; 0.378; 0.378; 0.378; 0.378; 0.378; 0.378; 0.378; 0.377; 0.376; 0.371; 0.333; 0.239; 0.224; 0.208; 0.204; 0.203; 0.203; 0.207; 0.197; 0.196; 0.195; </code></pre>
</div>
</div>
<div class="cell" data-outputid="4c2b324a-5575-492d-df95-a88c2a150668" data-execution_count="67">
<div class="sourceCode cell-code" id="cb107" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check Accuracy</span></span>
<span id="cb107-2">acc(coeffs)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>tensor(0.8258)</code></pre>
</div>
</div>
</section>
<section id="framework-fastai-pytorch" class="level2">
<h2 class="anchored" data-anchor-id="framework-fastai-pytorch">Framework: fastai + PyTorch</h2>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb109" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load stuff</span></span>
<span id="cb109-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.tabular.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb109-3"></span>
<span id="cb109-4">pd.options.display.float_format <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.2f}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span></span>
<span id="cb109-5">set_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb110" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load Data</span></span>
<span id="cb110-2">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>)</span>
<span id="cb110-3"></span>
<span id="cb110-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Feature Engineering</span></span>
<span id="cb110-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add_features(df):</span>
<span id="cb110-6">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.log1p(df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fare'</span>])</span>
<span id="cb110-7">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Deck'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.Cabin.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(A<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ABC"</span>, B<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ABC"</span>, C<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ABC"</span>, D<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DE"</span>, E<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"DE"</span>, F<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FG"</span>, G<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"FG"</span>))</span>
<span id="cb110-8">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Family'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.SibSp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>df.Parch</span>
<span id="cb110-9">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Alone'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.Family<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb110-10">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TicketFreq'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.groupby(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ticket'</span>)[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Ticket'</span>].transform(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'count'</span>)</span>
<span id="cb110-11">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Title'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.Name.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">', '</span>, expand<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.split(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'.'</span>, expand<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb110-12">    df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Title'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.Title.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">dict</span>(Mr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mr"</span>,Miss<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Miss"</span>,Mrs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Mrs"</span>,Master<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Master"</span>))</span>
<span id="cb110-13"></span>
<span id="cb110-14">add_features(df)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb111" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Data Split</span></span>
<span id="cb111-2">splits <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RandomSplitter(seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)(df)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb112" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tabular Dataloaders</span></span>
<span id="cb112-2">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TabularPandas(</span>
<span id="cb112-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># splits for indices of training and validation sets</span></span>
<span id="cb112-4">    df, splits<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>splits,</span>
<span id="cb112-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Turn strings into categories, fill missing values in numeric columns with the median, normalise all numeric columns</span></span>
<span id="cb112-6">    procs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [Categorify, FillMissing, Normalize],</span>
<span id="cb112-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># categorical independent variables</span></span>
<span id="cb112-8">    cat_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sex"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Pclass"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Embarked"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Deck"</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Title"</span>],</span>
<span id="cb112-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># continuous independent variables</span></span>
<span id="cb112-10">    cont_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Age'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'SibSp'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Parch'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'LogFare'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Alone'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'TicketFreq'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Family'</span>],</span>
<span id="cb112-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dependent variable</span></span>
<span id="cb112-12">    y_names<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Survived"</span>,</span>
<span id="cb112-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dependent variable is categorical(build a classification model)</span></span>
<span id="cb112-14">    y_block <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> CategoryBlock(),</span>
<span id="cb112-15">).dataloaders(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"."</span>)</span>
<span id="cb112-16"></span></code></pre></div>
</div>
<div class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb113" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train Model</span></span>
<span id="cb113-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - data + model = Learner</span></span>
<span id="cb113-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - dls -&gt; data</span></span>
<span id="cb113-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - layers -&gt; size of each hidden layer</span></span>
<span id="cb113-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - metrics -&gt; any metric we want to use for loss function</span></span>
<span id="cb113-6">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tabular_learner(dls, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>accuracy, layers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>])</span></code></pre></div>
</div>
<div class="cell" data-outputid="ae543bcd-42c1-4de7-ecf7-5045b9fca5b4" data-execution_count="73">
<div class="sourceCode cell-code" id="cb114" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># find learning rate</span></span>
<span id="cb114-2">learn.lr_find(suggest_funcs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(slide, valley))</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>SuggestedLRs(slide=0.05754399299621582, valley=0.013182567432522774)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson5/fastai-lesson5_files/figure-html/cell-74-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="c83792a3-e19c-4c4a-8f78-ac4b263a36a4" data-execution_count="74">
<div class="sourceCode cell-code" id="cb116" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># specify number of epochs and learning rate and train model</span></span>
<span id="cb116-2">learn.fit(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.577146</td>
<td>0.582949</td>
<td>0.606742</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.510818</td>
<td>0.498523</td>
<td>0.786517</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.467023</td>
<td>0.459841</td>
<td>0.797753</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.439957</td>
<td>0.468547</td>
<td>0.797753</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.427232</td>
<td>0.415261</td>
<td>0.825843</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.416340</td>
<td>0.437362</td>
<td>0.820225</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.408347</td>
<td>0.413253</td>
<td>0.848315</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.400442</td>
<td>0.406075</td>
<td>0.803371</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.397265</td>
<td>0.443730</td>
<td>0.820225</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.392389</td>
<td>0.432267</td>
<td>0.831461</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.389977</td>
<td>0.416234</td>
<td>0.837079</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.386176</td>
<td>0.424609</td>
<td>0.814607</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.382634</td>
<td>0.440516</td>
<td>0.837079</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.378518</td>
<td>0.432545</td>
<td>0.825843</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.374405</td>
<td>0.434594</td>
<td>0.825843</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.372745</td>
<td>0.426979</td>
<td>0.837079</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<section id="test-fastai-model-on-inference-data" class="level3">
<h3 class="anchored" data-anchor-id="test-fastai-model-on-inference-data">Test fastai model on inference data</h3>
<div class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb117" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Inference Data Processing</span></span>
<span id="cb117-2">tst_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.csv'</span>)</span>
<span id="cb117-3">tst_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Fare'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_df.Fare.fillna(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb117-4">add_features(tst_df)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb118" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># apply data modeling information from learner to inference</span></span>
<span id="cb118-2">tst_dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.dls.test_dl(tst_df)</span></code></pre></div>
</div>
<div class="cell" data-outputid="77011cd2-2163-4b29-adc1-ccf8c6a0afca" data-execution_count="77">
<div class="sourceCode cell-code" id="cb119" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># get predictions for the inference data</span></span>
<span id="cb119-2">preds,_ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.get_preds(dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tst_dl)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
</section>
<section id="fastai-model-submit-to-kaggle" class="level3">
<h3 class="anchored" data-anchor-id="fastai-model-submit-to-kaggle">fastai Model: Submit to Kaggle</h3>
<div class="cell" data-outputid="02994aa8-0136-45da-876d-b2276f3cdc0c" data-execution_count="78">
<div class="sourceCode cell-code" id="cb120" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># submit to kaggle</span></span>
<span id="cb120-2">tst_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survived'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (preds[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>()</span>
<span id="cb120-3">sub_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PassengerId'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survived'</span>]]</span>
<span id="cb120-4">sub_df.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'framework_sub.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb120-5"></span>
<span id="cb120-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check predictions file</span></span>
<span id="cb120-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head framework_sub.csv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PassengerId,Survived
892,0
893,0
894,0
895,0
896,1
897,0
898,1
899,0
900,1</code></pre>
</div>
</div>
</section>
</section>
<section id="ensembling" class="level2">
<h2 class="anchored" data-anchor-id="ensembling">Ensembling</h2>
<ul>
<li>create multiple models and combine predictions</li>
</ul>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb122" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> ensemble():</span>
<span id="cb122-2">    learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tabular_learner(dls, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>accuracy, layers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>])</span>
<span id="cb122-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> learn.no_bar(),learn.no_logging():</span>
<span id="cb122-4">      learn.fit(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.03</span>)</span>
<span id="cb122-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> learn.get_preds(dl<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tst_dl)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
</div>
<div class="cell" data-outputid="a474c3f0-14f8-4289-a394-eb7437cf3398" data-execution_count="80">
<div class="sourceCode cell-code" id="cb123" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create a set of 5 different predictions</span></span>
<span id="cb123-2">learns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [ensemble() <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)]</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb124" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># take average of all predictions</span></span>
<span id="cb124-2">ens_preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack(learns).mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
</div>
<section id="ensembling-submit-to-kaggle" class="level3">
<h3 class="anchored" data-anchor-id="ensembling-submit-to-kaggle">Ensembling: Submit to Kaggle</h3>
<div class="cell" data-outputid="9508d6d9-9068-4e70-d335-a09af2d44d81" data-execution_count="82">
<div class="sourceCode cell-code" id="cb125" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># submit to kaggle</span></span>
<span id="cb125-2">tst_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survived'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (preds[:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>()</span>
<span id="cb125-3">sub_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tst_df[[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PassengerId'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Survived'</span>]]</span>
<span id="cb125-4">sub_df.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ensemble_sub.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb125-5"></span>
<span id="cb125-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check predictions file</span></span>
<span id="cb125-7"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>head ensemble_sub.csv</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>PassengerId,Survived
892,0
893,0
894,0
895,0
896,1
897,0
898,1
899,0
900,1</code></pre>
</div>
</div>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ol type="1">
<li><a href="https://course.fast.ai/Lessons/lesson3.html">FastAI Lesson 3</a></li>
<li><a href="https://course.fast.ai/Lessons/lesson5.html">FastAI Lesson 5</a></li>
<li><a href="https://nbviewer.org/github/fastai/fastbook/blob/master/04_mnist_basics.ipynb">FastAI Chapter 4</a></li>
<li><a href="https://nbviewer.org/github/fastai/fastbook/blob/master/09_tabular.ipynb">FastAI Chapter 9</a></li>
<li><a href="https://www.kaggle.com/competitions/titanic">Titanic - Machine Learning from Disaster</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/how-does-a-neural-net-really-work">How does a neural net really work?</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/linear-model-and-neural-net-from-scratch">Linear model and neural net from scratch</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/why-you-should-use-a-framework">Why you should use a framework</a></li>
<li><a href="https://www.kaggle.com/code/gunesevitan/titanic-advanced-feature-engineering-tutorial/">Titanic - Advanced Feature Engineering Tutorial</a></li>
<li><a href="https://youtube.com/playlist?list=PLfYUBJiXbdtSLBPJ1GMx-sQWf6iNhb8mM&amp;si=WwPOjgYofy4M9QUW">Jeremy Howard FastAI Live Coding</a></li>
<li><a href="https://docs.fast.ai/">fast.ai docs</a></li>
</ol>


</section>

 ]]></description>
  <category>learning</category>
  <category>fastai</category>
  <category>deep learning</category>
  <guid>https://mozartfish.github.io/blog/posts/fastai-lesson5/fastai-lesson5.html</guid>
  <pubDate>Wed, 17 Jan 2024 08:00:00 GMT</pubDate>
</item>
<item>
  <title>FastAI Lesson 4: Natural Language(NLP)</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4.html</link>
  <description><![CDATA[ 




<section id="announcements" class="level2">
<h2 class="anchored" data-anchor-id="announcements">Announcements</h2>
<p>Happy New Year! I’m finally back to FastAI after taking a break due to job applications, trying to learn Golang and reflecting on my job search. This lesson was particularly challenging for me because I ran into a bunch of weird bugs and updates with the Hugging Face Transformer API. I had no idea what the code was doing in the FastAI example despite copying Jeremy’s code verbatim and printing print statements. After spending some time trying to debug and understand what each part of the code setup was doing with Hugging Face and Jeremy’s code I finally feel comfortable trying to write a blog post about this lesson.</p>
</section>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>All of this code was written by Jeremy Howard and the FastAI team. I modified it slightly to include my own print statements, comments and additional helper functions based on Jeremy’s code. This is the source for the original code <a href="https://www.kaggle.com/code/jhoward/getting-started-with-nlp-for-absolute-beginners">Getting Start With NLP for Absolute Begginers</a> and <a href="https://www.kaggle.com/code/jhoward/iterate-like-a-grandmaster/">Iterate Like A Grandmaster</a>.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this lesson, Jeremy gives an overview of his pioneering work on ULMFit, how to use Transformers and the set up for participating on Kaggle. I’m no NLP expert and don’t have an interest in NLP but what really excited me was that I finally understood what the iteration and development process was for a Kaggle Competition. This had been one of my goals when I embarked on FastAI.</p>
</section>
<section id="jeremy-howards-advice" class="level2">
<h2 class="anchored" data-anchor-id="jeremy-howards-advice">Jeremy Howard’s Advice</h2>
<p>Know the tools for your trade really well - <strong>Data Science Core Tools</strong>: Python, Numpy, Pandas Matplotlib, ScikitLearn, Pytorch, Scipy</p>
</section>
<section id="data-sciencekaggle-competition-workflow" class="level2">
<h2 class="anchored" data-anchor-id="data-sciencekaggle-competition-workflow">Data Science/Kaggle Competition Workflow</h2>
<p>This is the workflow that I figured out from this chapter.</p>
<ol type="1">
<li>Import data and check files</li>
<li>Exploratory Data Analysis</li>
<li>Data Representation (Wrangling, Tokenization, Numericalization)</li>
<li>Metrics</li>
<li>Training Model</li>
<li>Evaluate Model Performance</li>
</ol>
<p>I found the steps similar to the visualization process and could have dedicated some more time to iterating and fine-tuning my model for scoring high on this kaggle competition but in this chapter I was aiming to get an understanding of the general workflow and process that goes into building and iterating a model.</p>
</section>
<section id="us-patent-phrase-to-phrase-matching-competition" class="level2">
<h2 class="anchored" data-anchor-id="us-patent-phrase-to-phrase-matching-competition">US Patent Phrase to Phrase Matching Competition</h2>
<p>The US Patent Phrase to Phrase Matching Kaggle Competition is used as the case study for learning the basics of NLP, how to use transformers and the kaggle workflow. More information about the data and competition can be found here <a href="https://www.kaggle.com/competitions/us-patent-phrase-to-phrase-matching/">US Patent Phrase to Phrase Matching Competition</a></p>
</section>
<section id="load-data-and-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-data-and-libraries">Load Data and Libraries</h2>
<div class="cell" data-outputid="4aa23978-1998-4603-d9df-c315ba3d8640" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import libraries and files</span></span>
<span id="cb1-2"></span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># required libraries + packages for any ml/data science project</span></span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fastai library contains all the packages above and wraps them in the fastai library</span></span>
<span id="cb1-10"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uqq fastai</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kaggle API package install</span></span>
<span id="cb1-13"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install kaggle</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Hugging Face required libraries + packages</span></span>
<span id="cb1-16"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>q datasets</span>
<span id="cb1-17"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install transformers sentencepiece</span>
<span id="cb1-18"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install transformers[torch]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: kaggle in /usr/local/lib/python3.10/dist-packages (1.5.16)
Requirement already satisfied: six&gt;=1.10 in /usr/local/lib/python3.10/dist-packages (from kaggle) (1.16.0)
Requirement already satisfied: certifi in /usr/local/lib/python3.10/dist-packages (from kaggle) (2023.11.17)
Requirement already satisfied: python-dateutil in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.8.2)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.31.0)
Requirement already satisfied: tqdm in /usr/local/lib/python3.10/dist-packages (from kaggle) (4.66.1)
Requirement already satisfied: python-slugify in /usr/local/lib/python3.10/dist-packages (from kaggle) (8.0.1)
Requirement already satisfied: urllib3 in /usr/local/lib/python3.10/dist-packages (from kaggle) (2.0.7)
Requirement already satisfied: bleach in /usr/local/lib/python3.10/dist-packages (from kaggle) (6.1.0)
Requirement already satisfied: webencodings in /usr/local/lib/python3.10/dist-packages (from bleach-&gt;kaggle) (0.5.1)
Requirement already satisfied: text-unidecode&gt;=1.3 in /usr/local/lib/python3.10/dist-packages (from python-slugify-&gt;kaggle) (1.3)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;kaggle) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;kaggle) (3.6)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 507.1/507.1 kB 6.7 MB/s eta 0:00:00
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 115.3/115.3 kB 11.3 MB/s eta 0:00:00
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 134.8/134.8 kB 9.9 MB/s eta 0:00:00
Requirement already satisfied: transformers in /usr/local/lib/python3.10/dist-packages (4.35.2)
Collecting sentencepiece
  Downloading sentencepiece-0.1.99-cp310-cp310-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (1.3 MB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.3/1.3 MB 13.0 MB/s eta 0:00:00
Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from transformers) (3.13.1)
Requirement already satisfied: huggingface-hub&lt;1.0,&gt;=0.16.4 in /usr/local/lib/python3.10/dist-packages (from transformers) (0.20.2)
Requirement already satisfied: numpy&gt;=1.17 in /usr/local/lib/python3.10/dist-packages (from transformers) (1.23.5)
Requirement already satisfied: packaging&gt;=20.0 in /usr/local/lib/python3.10/dist-packages (from transformers) (23.2)
Requirement already satisfied: pyyaml&gt;=5.1 in /usr/local/lib/python3.10/dist-packages (from transformers) (6.0.1)
Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.10/dist-packages (from transformers) (2023.6.3)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from transformers) (2.31.0)
Requirement already satisfied: tokenizers&lt;0.19,&gt;=0.14 in /usr/local/lib/python3.10/dist-packages (from transformers) (0.15.0)
Requirement already satisfied: safetensors&gt;=0.3.1 in /usr/local/lib/python3.10/dist-packages (from transformers) (0.4.1)
Requirement already satisfied: tqdm&gt;=4.27 in /usr/local/lib/python3.10/dist-packages (from transformers) (4.66.1)
Requirement already satisfied: fsspec&gt;=2023.5.0 in /usr/local/lib/python3.10/dist-packages (from huggingface-hub&lt;1.0,&gt;=0.16.4-&gt;transformers) (2023.6.0)
Requirement already satisfied: typing-extensions&gt;=3.7.4.3 in /usr/local/lib/python3.10/dist-packages (from huggingface-hub&lt;1.0,&gt;=0.16.4-&gt;transformers) (4.5.0)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;transformers) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;transformers) (3.6)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;transformers) (2.0.7)
Requirement already satisfied: certifi&gt;=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;transformers) (2023.11.17)
Installing collected packages: sentencepiece
Successfully installed sentencepiece-0.1.99
Requirement already satisfied: transformers[torch] in /usr/local/lib/python3.10/dist-packages (4.35.2)
Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (3.13.1)
Requirement already satisfied: huggingface-hub&lt;1.0,&gt;=0.16.4 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (0.20.2)
Requirement already satisfied: numpy&gt;=1.17 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (1.23.5)
Requirement already satisfied: packaging&gt;=20.0 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (23.2)
Requirement already satisfied: pyyaml&gt;=5.1 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (6.0.1)
Requirement already satisfied: regex!=2019.12.17 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (2023.6.3)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (2.31.0)
Requirement already satisfied: tokenizers&lt;0.19,&gt;=0.14 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (0.15.0)
Requirement already satisfied: safetensors&gt;=0.3.1 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (0.4.1)
Requirement already satisfied: tqdm&gt;=4.27 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (4.66.1)
Requirement already satisfied: torch!=1.12.0,&gt;=1.10 in /usr/local/lib/python3.10/dist-packages (from transformers[torch]) (2.1.0+cu121)
Collecting accelerate&gt;=0.20.3 (from transformers[torch])
  Downloading accelerate-0.26.1-py3-none-any.whl (270 kB)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 270.9/270.9 kB 6.2 MB/s eta 0:00:00
Requirement already satisfied: psutil in /usr/local/lib/python3.10/dist-packages (from accelerate&gt;=0.20.3-&gt;transformers[torch]) (5.9.5)
Requirement already satisfied: fsspec&gt;=2023.5.0 in /usr/local/lib/python3.10/dist-packages (from huggingface-hub&lt;1.0,&gt;=0.16.4-&gt;transformers[torch]) (2023.6.0)
Requirement already satisfied: typing-extensions&gt;=3.7.4.3 in /usr/local/lib/python3.10/dist-packages (from huggingface-hub&lt;1.0,&gt;=0.16.4-&gt;transformers[torch]) (4.5.0)
Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch!=1.12.0,&gt;=1.10-&gt;transformers[torch]) (1.12)
Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch!=1.12.0,&gt;=1.10-&gt;transformers[torch]) (3.2.1)
Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch!=1.12.0,&gt;=1.10-&gt;transformers[torch]) (3.1.3)
Requirement already satisfied: triton==2.1.0 in /usr/local/lib/python3.10/dist-packages (from torch!=1.12.0,&gt;=1.10-&gt;transformers[torch]) (2.1.0)
Requirement already satisfied: charset-normalizer&lt;4,&gt;=2 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;transformers[torch]) (3.3.2)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;transformers[torch]) (3.6)
Requirement already satisfied: urllib3&lt;3,&gt;=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;transformers[torch]) (2.0.7)
Requirement already satisfied: certifi&gt;=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;transformers[torch]) (2023.11.17)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2-&gt;torch!=1.12.0,&gt;=1.10-&gt;transformers[torch]) (2.1.3)
Requirement already satisfied: mpmath&gt;=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy-&gt;torch!=1.12.0,&gt;=1.10-&gt;transformers[torch]) (1.3.0)
Installing collected packages: accelerate
Successfully installed accelerate-0.26.1</code></pre>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import stuff from fastai</span></span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.imports <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb3-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb3-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> pathlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Path</span>
<span id="cb3-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> zipfile</span>
<span id="cb3-6"></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">'''Function for loading kaggle datasets locally or on kaggle</span></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">Returns a local path to data files</span></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">- input: Kaggle API Login Credentials, Kaggle Contest Name '''</span></span>
<span id="cb3-11"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> loadData(creds, dataFile):</span>
<span id="cb3-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># variable to check whether we're running on kaggle website or not</span></span>
<span id="cb3-13">    iskaggle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.environ.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'KAGGLE_KERNEL_RUN_TYPE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb3-14"></span>
<span id="cb3-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># path for kaggle API credentials</span></span>
<span id="cb3-16">    cred_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'~/.kaggle/kaggle.json'</span>).expanduser()</span>
<span id="cb3-17"></span>
<span id="cb3-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> cred_path.exists():</span>
<span id="cb3-19">        cred_path.parent.mkdir(exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-20">        cred_path.write_text(creds)</span>
<span id="cb3-21">        cred_path.chmod(<span class="bn" style="color: #AD0000;
background-color: null;
font-style: inherit;">0o600</span>)</span>
<span id="cb3-22"></span>
<span id="cb3-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Download data from Kaggle to path and extract files at path location</span></span>
<span id="cb3-24"></span>
<span id="cb3-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># local machine</span></span>
<span id="cb3-26">    path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(dataFile)</span>
<span id="cb3-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> iskaggle <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">and</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> path.exists():</span>
<span id="cb3-28">        <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> kaggle</span>
<span id="cb3-29">        kaggle.api.competition_download_cli(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>(path))</span>
<span id="cb3-30">        zipfile.ZipFile(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.zip'</span>).extractall(path)</span>
<span id="cb3-31"></span>
<span id="cb3-32">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># kaggle</span></span>
<span id="cb3-33">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> iskaggle:</span>
<span id="cb3-34">        fileName <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'../input/'</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dataFile</span>
<span id="cb3-35">        path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fileName</span>
<span id="cb3-36"></span>
<span id="cb3-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> path</span></code></pre></div>
</div>
<div class="cell" data-outputid="0ae9c328-2cc7-4bdf-9cc3-48401467a86a" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">creds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span></span>
<span id="cb4-2">dataFile <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'us-patent-phrase-to-phrase-matching'</span></span>
<span id="cb4-3">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> loadData(creds, dataFile)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading us-patent-phrase-to-phrase-matching.zip to /content
</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 682k/682k [00:00&lt;00:00, 727kB/s]</code></pre>
</div>
</div>
<p><strong>Document</strong> - A file containing some text</p>
<p><strong>Large Documents</strong> - One text file per document, often organized into one folder per category</p>
<p><strong>Smaller Documents</strong> - One document per row in a CSV File</p>
<div class="cell" data-outputid="939d6b04-1f79-4a01-aa94-820d963b3926" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check data files</span></span>
<span id="cb7-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>ls {path}</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>sample_submission.csv  test.csv  train.csv</code></pre>
</div>
</div>
</section>
<section id="problem-statement" class="level2">
<h2 class="anchored" data-anchor-id="problem-statement">Problem Statement</h2>
<p><code>Problem</code> given a pairs of phrases (an <code>anchor</code> or <code>target</code> phrase), rate how similar they are on a scale of <code>0</code>(not similar) to <code>1</code>(identical in meaning). Similarity has been scored within a patent’s <code>context</code> specifically the <code>CPC Classification</code> which indicates the subject to which the patent relates.</p>
<p><code>Training Data</code></p>
<ul>
<li>contains phrases, contexts and similarity scores</li>
</ul>
<p><code>Test(Inference) Data</code></p>
<ul>
<li><p>unseen test contains approximately <code>12k</code> pairs of phrases. Small public test set has been provided for testing purposes <strong>but is not use in scoring</strong>.</p></li>
<li><p>contains identitical structure to <code>training data</code> <strong>but without the score</strong></p></li>
</ul>
<p><code>Evaluation Goal</code></p>
<ul>
<li>Build model to match phrases in order to extract contextual information helping the patent community connect the dots between millions of patent documents</li>
</ul>
<p><code>Evaluation Metric</code></p>
<ul>
<li>Submissions are evaluated on the <code>Pearson Correlation Coefficient</code> between <strong>predicted</strong> and <strong>actual</strong> similarity scores.</li>
</ul>
<p><code>Submission Format</code></p>
<ul>
<li><p>id(representing a pair of phrases) in test set, score representing the similarity score</p></li>
<li><p>A score of 1 is considered that the two inputs have identical meaning</p></li>
<li><p>A score of 0 is considered that the two inputs have totally different meaning</p></li>
<li><p>A score in between ie. 0.5 means they’re somewhat similar but not identical</p></li>
<li><p>Problem Type - NLP Classification Problem -&gt; classify document automatically into some category</p></li>
</ul>
</section>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">Exploratory Data Analysis</h2>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set up data path</span></span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># training data path</span></span>
<span id="cb9-4">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train.csv'</span>)</span>
<span id="cb9-5"></span>
<span id="cb9-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># testing data path</span></span>
<span id="cb9-7">eval_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test.csv'</span>)</span>
<span id="cb9-8"></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sample submission data path</span></span>
<span id="cb9-10">submit_df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.read_csv(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sample_submission.csv'</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="65780dc6-9e74-42e2-b047-72adf1504620" data-execution_count="6">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test Data Length</span></span>
<span id="cb10-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>36473</code></pre>
</div>
</div>
<div class="cell" data-outputid="8b632c7f-b28c-426d-f576-7b5483c5f66a" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training Data Info</span></span>
<span id="cb12-2">df</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">

  <div id="df-2edd3614-417f-4145-8600-02a200374d89" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">anchor</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">context</th>
<th data-quarto-table-cell-role="th">score</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>37d61fd2272659b1</td>
<td>abatement</td>
<td>abatement of pollution</td>
<td>A47</td>
<td>0.50</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>7b9652b17b68b7a4</td>
<td>abatement</td>
<td>act of abating</td>
<td>A47</td>
<td>0.75</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>36d72442aefd8232</td>
<td>abatement</td>
<td>active catalyst</td>
<td>A47</td>
<td>0.25</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>5296b0c19e1ce60e</td>
<td>abatement</td>
<td>eliminating process</td>
<td>A47</td>
<td>0.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>54c1e3b9184cb5b6</td>
<td>abatement</td>
<td>forest region</td>
<td>A47</td>
<td>0.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36468</td>
<td>8e1386cbefd7f245</td>
<td>wood article</td>
<td>wooden article</td>
<td>B44</td>
<td>1.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">36469</td>
<td>42d9e032d1cd3242</td>
<td>wood article</td>
<td>wooden box</td>
<td>B44</td>
<td>0.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36470</td>
<td>208654ccb9e14fa3</td>
<td>wood article</td>
<td>wooden handle</td>
<td>B44</td>
<td>0.50</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">36471</td>
<td>756ec035e694722b</td>
<td>wood article</td>
<td>wooden material</td>
<td>B44</td>
<td>0.75</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36472</td>
<td>8d135da0b55b8c88</td>
<td>wood article</td>
<td>wooden substrate</td>
<td>B44</td>
<td>0.50</td>
</tr>
</tbody>
</table>


<p>36473 rows × 5 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-2edd3614-417f-4145-8600-02a200374d89')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-2edd3614-417f-4145-8600-02a200374d89 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-2edd3614-417f-4145-8600-02a200374d89');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-391d5c4a-0836-480f-8beb-673c368018f7">
  <button class="colab-df-quickchart" onclick="quickchart('df-391d5c4a-0836-480f-8beb-673c368018f7')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-391d5c4a-0836-480f-8beb-673c368018f7 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

  <div id="id_2e7ce4b4-1723-4168-83b7-24f849aebdeb">
    <style>
      .colab-df-generate {
        background-color: #E8F0FE;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        fill: #1967D2;
        height: 32px;
        padding: 0 0 0 0;
        width: 32px;
      }

      .colab-df-generate:hover {
        background-color: #E2EBFA;
        box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
        fill: #174EA6;
      }

      [theme=dark] .colab-df-generate {
        background-color: #3B4455;
        fill: #D2E3FC;
      }

      [theme=dark] .colab-df-generate:hover {
        background-color: #434B5C;
        box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
        filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
        fill: #FFFFFF;
      }
    </style>
    <button class="colab-df-generate" onclick="generateWithVariable('df')" title="Generate code using this dataframe." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M7,19H8.4L18.45,9,17,7.55,7,17.6ZM5,21V16.75L18.45,3.32a2,2,0,0,1,2.83,0l1.4,1.43a1.91,1.91,0,0,1,.58,1.4,1.91,1.91,0,0,1-.58,1.4L9.25,21ZM18.45,9,17,7.55Zm-12,3A5.31,5.31,0,0,0,4.9,8.1,5.31,5.31,0,0,0,1,6.5,5.31,5.31,0,0,0,4.9,4.9,5.31,5.31,0,0,0,6.5,1,5.31,5.31,0,0,0,8.1,4.9,5.31,5.31,0,0,0,12,6.5,5.46,5.46,0,0,0,6.5,12Z"></path>
  </svg>
    </button>
    <script>
      (() => {
      const buttonEl =
        document.querySelector('#id_2e7ce4b4-1723-4168-83b7-24f849aebdeb button.colab-df-generate');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      buttonEl.onclick = () => {
        google.colab.notebook.generateWithVariable('df');
      }
      })();
    </script>
  </div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="66396cd1-445e-4f3e-dfdf-b29312830bd9" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training Data Summary</span></span>
<span id="cb13-2">df.describe(include<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'object'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">

  <div id="df-6f77dc64-b9f4-4e0c-abbe-93821a226958" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">anchor</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">context</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>36473</td>
<td>36473</td>
<td>36473</td>
<td>36473</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unique</td>
<td>36473</td>
<td>733</td>
<td>29340</td>
<td>106</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">top</td>
<td>37d61fd2272659b1</td>
<td>component composite coating</td>
<td>composition</td>
<td>H01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">freq</td>
<td>1</td>
<td>152</td>
<td>24</td>
<td>2186</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-6f77dc64-b9f4-4e0c-abbe-93821a226958')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-6f77dc64-b9f4-4e0c-abbe-93821a226958 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-6f77dc64-b9f4-4e0c-abbe-93821a226958');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-a72d54ed-b7a1-4755-8be9-b7047b711be3">
  <button class="colab-df-quickchart" onclick="quickchart('df-a72d54ed-b7a1-4755-8be9-b7047b711be3')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-a72d54ed-b7a1-4755-8be9-b7047b711be3 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="d830b9a2-9656-4ede-f5a4-64633598b9fd" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test Data Length</span></span>
<span id="cb14-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(eval_df)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>36</code></pre>
</div>
</div>
<div class="cell" data-outputid="f370b948-fd2c-4425-fd4b-17fbb1ec6785" data-execution_count="10">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test Data Info</span></span>
<span id="cb16-2">eval_df.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="10">

  <div id="df-338be838-7db2-427e-ac28-fe84fe8be184" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">anchor</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">context</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>4112d61851461f60</td>
<td>opc drum</td>
<td>inorganic photoconductor drum</td>
<td>G02</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>09e418c93a776564</td>
<td>adjust gas flow</td>
<td>altering gas flow</td>
<td>F23</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>36baf228038e314b</td>
<td>lower trunnion</td>
<td>lower locating</td>
<td>B60</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>1f37ead645e7f0c8</td>
<td>cap component</td>
<td>upper portion</td>
<td>D06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>71a5b6ad068d531f</td>
<td>neural stimulation</td>
<td>artificial neural network</td>
<td>H04</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-338be838-7db2-427e-ac28-fe84fe8be184')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-338be838-7db2-427e-ac28-fe84fe8be184 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-338be838-7db2-427e-ac28-fe84fe8be184');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-18d6fefa-aa3e-4967-a695-789f04dbe510">
  <button class="colab-df-quickchart" onclick="quickchart('df-18d6fefa-aa3e-4967-a695-789f04dbe510')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-18d6fefa-aa3e-4967-a695-789f04dbe510 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="3af2c37f-8d43-4c70-9956-92868774d0c6" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test Data Summary</span></span>
<span id="cb17-2">eval_df.describe()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">

  <div id="df-2da52b7f-9590-46d0-ada8-3c6f222518aa" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">anchor</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">context</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>36</td>
<td>36</td>
<td>36</td>
<td>36</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unique</td>
<td>36</td>
<td>34</td>
<td>36</td>
<td>29</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">top</td>
<td>4112d61851461f60</td>
<td>el display</td>
<td>inorganic photoconductor drum</td>
<td>G02</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">freq</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>3</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-2da52b7f-9590-46d0-ada8-3c6f222518aa')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-2da52b7f-9590-46d0-ada8-3c6f222518aa button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-2da52b7f-9590-46d0-ada8-3c6f222518aa');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-6cbb5aac-8c82-4b87-afce-1e4381f47819">
  <button class="colab-df-quickchart" onclick="quickchart('df-6cbb5aac-8c82-4b87-afce-1e4381f47819')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-6cbb5aac-8c82-4b87-afce-1e4381f47819 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
</section>
<section id="data-representation-tokenization-numericalization-data-wrangling" class="level2">
<h2 class="anchored" data-anchor-id="data-representation-tokenization-numericalization-data-wrangling">Data Representation (Tokenization, Numericalization, Data Wrangling)</h2>
<p>Models require numbers as inputs -&gt; need some strategy of mapping words, characters etc to a numerical value</p>
<p><strong>Tokenization</strong>: Split each text up into tokens</p>
<p><strong>Numericalization</strong>: Convert each token to a number</p>
<p><strong>Autokenizer</strong>:function for creating a tokenizer appropriate for the selected NLP model</p>
<p><strong>Vocab</strong>: A special list in the tokenizer which contains a unique integer for every possible token string</p>
<p>The start of a new word is indicated by __</p>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.utils.data <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DataLoader</span>
<span id="cb18-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> warnings,transformers,logging,torch</span>
<span id="cb18-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> TrainingArguments,Trainer</span>
<span id="cb18-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutoModelForSequenceClassification,AutoTokenizer</span>
<span id="cb18-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datasets</span>
<span id="cb18-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> datasets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> load_dataset, Dataset, DatasetDict</span>
<span id="cb18-7"></span>
<span id="cb18-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ignore hugging face warnings</span></span>
<span id="cb18-9">warnings.simplefilter(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ignore'</span>)</span>
<span id="cb18-10">logging.disable(logging.WARNING)</span></code></pre></div>
</div>
<div class="cell" data-outputid="fd3dad5a-f355-4219-f012-0bfa5de1f6bc" data-execution_count="13">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tokenization + Numericalization</span></span>
<span id="cb19-2"></span>
<span id="cb19-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Models require numbers as inputs -&gt; need to convert text to numbers:</span></span>
<span id="cb19-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tokenization - split each text into tokens</span></span>
<span id="cb19-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Numericalization - convert each word into a number</span></span>
<span id="cb19-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - This process depends on the model that is used. AutoTokenizer creates the appropriate tokenizer based on the selected model</span></span>
<span id="cb19-7"></span>
<span id="cb19-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Model</span></span>
<span id="cb19-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - This is a reasonable model to start nearly NLP problem. Replace small with large for a slower but more accurate model</span></span>
<span id="cb19-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># once data exploration and experimentation is completed</span></span>
<span id="cb19-11">model_nm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'microsoft/deberta-v3-small'</span></span>
<span id="cb19-12"></span>
<span id="cb19-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tokenizer</span></span>
<span id="cb19-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> transformers <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> AutoModelForSequenceClassification,AutoTokenizer</span>
<span id="cb19-15">tokz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoTokenizer.from_pretrained(model_nm)</span>
<span id="cb19-16"></span>
<span id="cb19-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test Tokenizer</span></span>
<span id="cb19-18"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Favorite Line from The Bear: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tokz<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>tokenize(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Every Second Counts'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Uncommon words: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tokz<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>tokenize(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'A platypus is an ornithorhynchus anatinus.'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-20"></span>
<span id="cb19-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for tokenizing</span></span>
<span id="cb19-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> tok_func(x):</span>
<span id="cb19-23">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> tokz(x[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"input"</span>])</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"12a6c5f0a65347a4bf6baf5d074425da","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"a740848213e749dd9ce5c9fec143ea16","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"e9465118d32d44b58ebdaf9fba17fc76","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Favorite Line from The Bear: ['▁Every', '▁Second', '▁Counts']
Uncommon words: ['▁A', '▁platypus', '▁is', '▁an', '▁or', 'ni', 'tho', 'rhynch', 'us', '▁an', 'at', 'inus', '.']</code></pre>
</div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine Context + Anchor + Target</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 1 - Baseline</span></span>
<span id="cb22-2">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CONTEXT: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; TEXT1: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; TEXT2: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.target</span>
<span id="cb22-3">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CONTEXT: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; TEXT1: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; TEXT2: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.target</span></code></pre></div>
</div>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert data to Transformer DataSet Data Structure</span></span>
<span id="cb23-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># rename score to labels for training data -&gt; Transformers require a label column</span></span>
<span id="cb23-3">ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dataset.from_pandas(df).rename_column(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'score'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>)</span>
<span id="cb23-4">eval_ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dataset.from_pandas(eval_df)</span></code></pre></div>
</div>
<div class="cell" data-outputid="81d52899-4583-4236-ad99-06d4fe8bbe56" data-execution_count="17">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tokenize Training Data</span></span>
<span id="cb24-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original Input Data"</span>)</span>
<span id="cb24-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(ds)</span>
<span id="cb24-4"></span>
<span id="cb24-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test tokenizing function</span></span>
<span id="cb24-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tok_func(ds[0])</span></span>
<span id="cb24-7"></span>
<span id="cb24-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tokenize all input data in parallel</span></span>
<span id="cb24-9">tok_ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ds.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(tok_func, batched<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb24-10"></span>
<span id="cb24-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tokenized Input Data"</span>)</span>
<span id="cb24-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(tok_ds)</span>
<span id="cb24-13"></span>
<span id="cb24-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check tokenized data</span></span>
<span id="cb24-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Check Tokenized Input Data"</span>)</span>
<span id="cb24-16"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(tok_ds[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original Input Data
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'label', 'input'],
    num_rows: 36473
})
Tokenized Input Data
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'input_ids', 'token_type_ids', 'attention_mask'],
    num_rows: 36473
})
Check Tokenized Input Data
{'id': '37d61fd2272659b1', 'anchor': 'abatement', 'target': 'abatement of pollution', 'context': 'A47', 'label': 0.5, 'input': 'CONTEXT: A47; TEXT1: abatement; TEXT2: abatement of pollution', 'input_ids': [1, 20967, 104917, 294, 336, 5753, 346, 54453, 435, 294, 47284, 346, 54453, 445, 294, 47284, 265, 6435, 2], 'token_type_ids': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 'attention_mask': [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]}</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"085d3e4d1efe4a2d93c08e37c2dd3146","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-outputid="f3032322-901f-46d8-f602-7ec0123f9bd9" data-execution_count="18">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tokenize Inference Data</span></span>
<span id="cb26-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original Inference Data"</span>)</span>
<span id="cb26-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(eval_ds)</span>
<span id="cb26-4"></span>
<span id="cb26-5">eval_ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eval_ds.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(tok_func, batched<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb26-6"></span>
<span id="cb26-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tokenized Inference Data"</span>)</span>
<span id="cb26-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(eval_ds)</span>
<span id="cb26-9"></span>
<span id="cb26-10"></span>
<span id="cb26-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Check Tokenized Inference Data"</span>)</span>
<span id="cb26-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(eval_ds[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original Inference Data
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input'],
    num_rows: 36
})
Tokenized Inference Data
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'input_ids', 'token_type_ids', 'attention_mask'],
    num_rows: 36
})
Check Tokenized Inference Data
{'id': '4112d61851461f60', 'anchor': 'opc drum', 'target': 'inorganic photoconductor drum', 'context': 'G02', 'input': 'CONTEXT: G02; TEXT1: opc drum; TEXT2: inorganic photoconductor drum', 'input_ids': [1, 20967, 104917, 294, 1098, 4159, 346, 54453, 435, 294, 8847, 1207, 8263, 346, 54453, 445, 294, 31553, 1456, 48133, 8263, 2], 'token_type_ids': [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], 'attention_mask': [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]}</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"96388a349ed34dbaaca243d48144f5f2","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-outputid="8aebc8c1-4d8b-45e1-e5ef-7a465c8dd6b7" data-execution_count="19">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tokenization Exploration</span></span>
<span id="cb28-2"></span>
<span id="cb28-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Vocab -&gt; specal list in the tokenizer which contains a unique integer for every possible token string</span></span>
<span id="cb28-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Input IDs are generated from the vocab list</span></span>
<span id="cb28-5">row <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tok_ds[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb28-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Input: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Input IDs: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>row[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input_ids'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb28-7"></span>
<span id="cb28-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Token for the word "of"</span></span>
<span id="cb28-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Token for the word of: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tokz<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>vocab[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'▁of'</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Input: CONTEXT: A47; TEXT1: abatement; TEXT2: abatement of pollution, Input IDs: [1, 20967, 104917, 294, 336, 5753, 346, 54453, 435, 294, 47284, 346, 54453, 445, 294, 47284, 265, 6435, 2]
Token for the word of: 265</code></pre>
</div>
</div>
</section>
<section id="datasets-training-validation-testinginference" class="level2">
<h2 class="anchored" data-anchor-id="datasets-training-validation-testinginference">Datasets Training, Validation, Testing(Inference)</h2>
<section id="training-dataset" class="level3">
<h3 class="anchored" data-anchor-id="training-dataset">Training Dataset</h3>
<p>A set of data that the model uses to learn the weights needed to create a function that best approximates the data.</p>
</section>
<section id="validation-dataset" class="level3">
<h3 class="anchored" data-anchor-id="validation-dataset">Validation Dataset</h3>
<ul>
<li>A dataset that is used to determine whether the model is under-fitting, overfitting or fitting the data (to some threshold degree). - This dataset is withheld from training and the model never sees it. The validation set is only used for evaluating the model during training and never used as inputs to train the model</li>
<li>Creating validation datasets is an active area of research and engineering. See this post by Dr.&nbsp;Rachel Thomas on validation datasets - <a href="https://www.fast.ai/posts/2017-11-13-validation-sets.html">How (and why) to create a good validation set</a></li>
<li>Transformers call the validation dataset in the DataSetDict object test</li>
</ul>
</section>
<section id="testinference-set" class="level3">
<h3 class="anchored" data-anchor-id="testinference-set">Test(Inference Set)</h3>
<ul>
<li>A dataset that is withheld from training and reporting metrics. The accuracy of the model on the test set is only checked <code>after</code> completing the entire training process -&gt; trying different models, training methods, data processing, optimizations etc.</li>
<li>Kaggle has a second test set which is a held out dataset used only at the end of competitions to assess predictions (private leaderboard).</li>
</ul>
<div class="cell" data-outputid="79c4840a-73b0-4fb3-b623-f4e33c469a55" data-execution_count="20">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Validation Set - subset of training dataset which the model doesn't see at all</span></span>
<span id="cb30-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - The validation set is used to check if model is underfit, overfit or just right</span></span>
<span id="cb30-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - The validation set is nost used as input to the training model</span></span>
<span id="cb30-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Transformers use DatasetDict to store both the training and validation dataset</span></span>
<span id="cb30-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - fastai automatically creates the validation set for you if you don't have one and reports the metrics</span></span>
<span id="cb30-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (accuracy of model) using the validation set</span></span>
<span id="cb30-7"></span>
<span id="cb30-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 25% validation set, 75% training set using hugging face transformer</span></span>
<span id="cb30-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test refers to the validation set</span></span>
<span id="cb30-10">dds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tok_ds.train_test_split(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb30-11"></span>
<span id="cb30-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Check Training-Validation Split"</span>)</span>
<span id="cb30-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(dds)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Check Training-Validation Split
DatasetDict({
    train: Dataset({
        features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'input_ids', 'token_type_ids', 'attention_mask'],
        num_rows: 27354
    })
    test: Dataset({
        features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'input_ids', 'token_type_ids', 'attention_mask'],
        num_rows: 9119
    })
})</code></pre>
</div>
</div>
</section>
</section>
<section id="metrics" class="level2">
<h2 class="anchored" data-anchor-id="metrics">Metrics</h2>
<ul>
<li><p>Measurements that help evaluate how good the model is</p></li>
<li><p>Kaggle tells users the metric and how submissions are evaluated in the problem description. In industry and research problems developing metrics is more complicated. See this post by Dr.&nbsp;Rachel Thomas on metrics - <a href="https://www.fast.ai/posts/2019-09-24-metrics.html">The problem with metrics is a big problem for AI</a></p></li>
<li><p>In this challenge, Kaggle has stated that submissions are evaluated based on the <em>Pearson Correlation Coefficient between the predicted and actual similarity scores</em>.</p></li>
<li><p>Pearson’s Correlation Coefficient is represented with <strong>r</strong> and is one of the most widely used measures of the degree of relationship between two variables.</p></li>
<li><p><em>r</em> can vary between <strong>-1</strong> indicating a <strong>perfect inverse correlation</strong> and <em>+1</em> indicating a <strong>perfect positive correlation</strong></p></li>
<li><p><em>r</em> is sensitive to outliers -&gt; outliers will dominate the data in a pearson correlation visualization producing skewed results.</p></li>
</ul>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Metrics - Correlation</span></span>
<span id="cb32-2"></span>
<span id="cb32-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for returning the correlation between two variables</span></span>
<span id="cb32-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> corr(x,y):</span>
<span id="cb32-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> np.corrcoef(x,y)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb32-6"></span>
<span id="cb32-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Transformers expect metrics to be returned as a dict, since that way the trainer knows what label to use</span></span>
<span id="cb32-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> corr_d(eval_pred):</span>
<span id="cb32-9">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pearson'</span>: corr(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>eval_pred)}</span></code></pre></div>
</div>
</section>
<section id="train-model" class="level2">
<h2 class="anchored" data-anchor-id="train-model">Train Model</h2>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up hyperparameter values</span></span>
<span id="cb33-2"></span>
<span id="cb33-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># learning rate</span></span>
<span id="cb33-4">lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8e-5</span></span>
<span id="cb33-5"></span>
<span id="cb33-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch size</span></span>
<span id="cb33-7">bs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb33-8"></span>
<span id="cb33-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># weight decay</span></span>
<span id="cb33-10">wd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb33-11"></span>
<span id="cb33-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># epochs</span></span>
<span id="cb33-13">epochs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Transformer uses Trainging Arguments class to set up arguments</span></span>
<span id="cb34-2">args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TrainingArguments(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'outputs'</span>, learning_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr, warmup_ratio<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, lr_scheduler_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cosine'</span>, fp16<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb34-3">    evaluation_strategy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epoch"</span>, per_device_train_batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bs, per_device_eval_batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb34-4">    num_train_epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>epochs, weight_decay<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>wd, report_to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'none'</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="51660704-a33f-4e50-9d3e-052a05f3d830" data-execution_count="24">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create model and Trainer -&gt; trainer is a class combining the data and model together (like learner does in fastai)</span></span>
<span id="cb35-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoModelForSequenceClassification.from_pretrained(model_nm, num_labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb35-3">trainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Trainer(model, args, train_dataset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dds[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>], eval_dataset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dds[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>],</span>
<span id="cb35-4">                  tokenizer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tokz, compute_metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>corr_d)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"adce93b79ee844968dc0d5c2511079a1","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-outputid="52d58af7-65a3-44e8-dcbf-28c2f26ee626" data-execution_count="25">
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train the model</span></span>
<span id="cb36-2">trainer.train()</span></code></pre></div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="856" max="856" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [856/856 03:37, Epoch 4/4]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">Pearson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No log</td>
<td>0.028198</td>
<td>0.803834</td>
</tr>
<tr class="even">
<td>2</td>
<td>No log</td>
<td>0.022185</td>
<td>0.823395</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0.034200</td>
<td>0.022253</td>
<td>0.833714</td>
</tr>
<tr class="even">
<td>4</td>
<td>0.034200</td>
<td>0.022595</td>
<td>0.834576</td>
</tr>
</tbody>
</table>
<p>
</p></div>
<div class="cell-output cell-output-display" data-execution_count="25">
<pre><code>TrainOutput(global_step=856, training_loss=0.025547120615700695, metrics={'train_runtime': 220.4986, 'train_samples_per_second': 496.221, 'train_steps_per_second': 3.882, 'total_flos': 717218678299260.0, 'train_loss': 0.025547120615700695, 'epoch': 4.0})</code></pre>
</div>
</div>
</section>
<section id="evaluate-model-performance" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-model-performance">Evaluate Model Performance</h2>
<div class="cell" data-outputid="976eaf46-65b6-4ee3-8a41-ee644b220dd0" data-execution_count="26">
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate Model on the Inference Data</span></span>
<span id="cb38-2">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trainer.predict(eval_ds).predictions.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>)</span>
<span id="cb38-3">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.clip(preds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb38-4">preds</span></code></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="26">
<pre><code>array([[0.4855957 ],
       [0.69238281],
       [0.54833984],
       [0.34765625],
       [0.        ],
       [0.47460938],
       [0.49023438],
       [0.        ],
       [0.34765625],
       [1.        ],
       [0.23352051],
       [0.27612305],
       [0.76757812],
       [0.91113281],
       [0.81347656],
       [0.37280273],
       [0.26318359],
       [0.        ],
       [0.63720703],
       [0.34619141],
       [0.40063477],
       [0.23999023],
       [0.14367676],
       [0.22607422],
       [0.60595703],
       [0.        ],
       [0.        ],
       [0.        ],
       [0.        ],
       [0.57910156],
       [0.30908203],
       [0.07293701],
       [0.71191406],
       [0.53564453],
       [0.42602539],
       [0.24609375]])</code></pre>
</div>
</div>
</section>
<section id="improving-iterating-on-the-model-for-kaggle-and-beyond" class="level2">
<h2 class="anchored" data-anchor-id="improving-iterating-on-the-model-for-kaggle-and-beyond">Improving + Iterating on the Model for Kaggle and Beyond</h2>
<p>In the previous code, I mostly followed a standard template for how to get a model running and producing values for a kaggle competition.</p>
<p>This section is based on Jeremy’s advice and experience for understanding how one might go about refining and finetune a model using transfer learning to win a kaggle competition. My goal was to try and beat the original base line evaluation I had in the previous section but I didn’t do enough experiments to develop a model that could match or produce a better result than my first attempt. In this section, I was more interested in getting a feel for the iteration and engineering workflow process of developing a model for a kaggle contest/data science challenge so I might revisit this post in the future to see if I can produce a better result once I gain more experience iterating and building models.</p>
<section id="problem-statement-1" class="level3">
<h3 class="anchored" data-anchor-id="problem-statement-1">Problem Statement</h3>
<ul>
<li><p>Compare two words or short phrases and score them based on whether they’re similar or not based on the patent class they were used in.</p></li>
<li><p>A score of 1 is considered that the two inputs have identical meaning</p></li>
<li><p>A score of 0 is considered that the two inputs have totally different meaning</p></li>
<li><p>A score in between ie. 0.5 means they’re somewhat similar but not identical</p></li>
<li><p>Problem Type - NLP Classification Problem -&gt; classify document automatically into some category</p></li>
</ul>
</section>
<section id="data-exploration-data-meaning-representation" class="level3">
<h3 class="anchored" data-anchor-id="data-exploration-data-meaning-representation">Data Exploration: Data Meaning + Representation</h3>
<p><code>anchor</code> - first phrase</p>
<p><code>target</code> - second phrase</p>
<p><code>context</code> - cpc classification which indicates the subject within which the similarity is to be scored</p>
<p><code>score</code> - the similarity. A combination of one or more manual expert ratings</p>
</section>
</section>
<section id="exploratory-data-analysis-1" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis-1">Exploratory Data Analysis</h2>
<div class="cell" data-outputid="e26ac741-b4ce-404f-dfde-4d533ab97e67" data-execution_count="27">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Distribution of values of Target</span></span>
<span id="cb40-2">df.target.value_counts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="27">
<pre><code>composition                    24
data                           22
metal                          22
motor                          22
assembly                       21
                               ..
switching switch over valve     1
switching switch off valve      1
switching over valve            1
switching off valve             1
wooden substrate                1
Name: target, Length: 29340, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="494f92dc-0848-4e49-ce95-9a9238a395fe" data-execution_count="28">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Distribution of values of Anchor</span></span>
<span id="cb42-2">df.anchor.value_counts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>component composite coating              152
sheet supply roller                      150
source voltage                           140
perfluoroalkyl group                     136
el display                               135
                                        ... 
plug nozzle                                2
shannon                                    2
dry coating composition1                   2
peripheral nervous system stimulation      1
conduct conducting material                1
Name: anchor, Length: 733, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="c3960bc6-1b95-4828-e728-c8d42e0141d6" data-execution_count="29">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Distribution of values of Context</span></span>
<span id="cb44-2">df.context.value_counts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>H01    2186
H04    2177
G01    1812
A61    1477
F16    1091
       ... 
B03      47
F17      33
B31      24
A62      23
F26      18
Name: context, Length: 106, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="96c67272-4874-47bd-bde1-0686887b9a50" data-execution_count="30">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Distribution of values of Section</span></span>
<span id="cb46-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Patent Section - first character of context is the section the patent was filed under</span></span>
<span id="cb46-3">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.context.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb46-4">df.section.value_counts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="30">
<pre><code>B    8019
H    6195
G    6013
C    5288
A    4094
F    4054
E    1531
D    1279
Name: section, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="921a8e0b-6f22-4295-eff0-fd54e0730b57" data-execution_count="31">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eval_df.context.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb48-2">eval_df.section.value_counts()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>B    8
G    7
F    6
H    5
C    4
A    3
E    2
D    1
Name: section, dtype: int64</code></pre>
</div>
</div>
<div class="cell" data-outputid="124db021-a0f0-431b-c7e7-fe78f90cb84c" data-execution_count="32">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Distribution of values of Score</span></span>
<span id="cb50-2">df.score.hist()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-33-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="6734f940-36e0-4f48-cadf-471f19ebee77" data-execution_count="33">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Items that were identical</span></span>
<span id="cb52-2">df[df.score<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">

  <div id="df-e039fa57-77d0-482f-be32-2716d4362d95" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">anchor</th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">context</th>
<th data-quarto-table-cell-role="th">score</th>
<th data-quarto-table-cell-role="th">input</th>
<th data-quarto-table-cell-role="th">section</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">28</td>
<td>473137168ebf7484</td>
<td>abatement</td>
<td>abating</td>
<td>F24</td>
<td>1.0</td>
<td>CONTEXT: F24; TEXT1: abatement; TEXT2: abating</td>
<td>F</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">158</td>
<td>621b048d70aa8867</td>
<td>absorbent properties</td>
<td>absorbent characteristics</td>
<td>D01</td>
<td>1.0</td>
<td>CONTEXT: D01; TEXT1: absorbent properties; TEXT2: absorbent characteristics</td>
<td>D</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">161</td>
<td>bc20a1c961cb073a</td>
<td>absorbent properties</td>
<td>absorption properties</td>
<td>D01</td>
<td>1.0</td>
<td>CONTEXT: D01; TEXT1: absorbent properties; TEXT2: absorption properties</td>
<td>D</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">311</td>
<td>e955700dffd68624</td>
<td>acid absorption</td>
<td>absorption of acid</td>
<td>B08</td>
<td>1.0</td>
<td>CONTEXT: B08; TEXT1: acid absorption; TEXT2: absorption of acid</td>
<td>B</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">315</td>
<td>3a09aba546aac675</td>
<td>acid absorption</td>
<td>acid absorption</td>
<td>B08</td>
<td>1.0</td>
<td>CONTEXT: B08; TEXT1: acid absorption; TEXT2: acid absorption</td>
<td>B</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36398</td>
<td>913141526432f1d6</td>
<td>wiring trough</td>
<td>wiring troughs</td>
<td>F16</td>
<td>1.0</td>
<td>CONTEXT: F16; TEXT1: wiring trough; TEXT2: wiring troughs</td>
<td>F</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">36435</td>
<td>ee0746f2a8ecef97</td>
<td>wood article</td>
<td>wood articles</td>
<td>B05</td>
<td>1.0</td>
<td>CONTEXT: B05; TEXT1: wood article; TEXT2: wood articles</td>
<td>B</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36440</td>
<td>ecaf479135cf0dfd</td>
<td>wood article</td>
<td>wooden article</td>
<td>B05</td>
<td>1.0</td>
<td>CONTEXT: B05; TEXT1: wood article; TEXT2: wooden article</td>
<td>B</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">36464</td>
<td>8ceaa2b5c2d56250</td>
<td>wood article</td>
<td>wood article</td>
<td>B44</td>
<td>1.0</td>
<td>CONTEXT: B44; TEXT1: wood article; TEXT2: wood article</td>
<td>B</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">36468</td>
<td>8e1386cbefd7f245</td>
<td>wood article</td>
<td>wooden article</td>
<td>B44</td>
<td>1.0</td>
<td>CONTEXT: B44; TEXT1: wood article; TEXT2: wooden article</td>
<td>B</td>
</tr>
</tbody>
</table>


<p>1154 rows × 7 columns</p>
</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-e039fa57-77d0-482f-be32-2716d4362d95')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-e039fa57-77d0-482f-be32-2716d4362d95 button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-e039fa57-77d0-482f-be32-2716d4362d95');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-743a2a7c-adc4-4556-b7b9-20205409ac3f">
  <button class="colab-df-quickchart" onclick="quickchart('df-743a2a7c-adc4-4556-b7b9-20205409ac3f')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-743a2a7c-adc4-4556-b7b9-20205409ac3f button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
</section>
<section id="training-model---setup" class="level2">
<h2 class="anchored" data-anchor-id="training-model---setup">Training Model - Setup</h2>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Constants for Training</span></span>
<span id="cb53-2"></span>
<span id="cb53-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># model</span></span>
<span id="cb53-4">model_nm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'microsoft/deberta-v3-small'</span></span>
<span id="cb53-5"></span>
<span id="cb53-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tokenizer</span></span>
<span id="cb53-7">tokz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AutoTokenizer.from_pretrained(model_nm)</span>
<span id="cb53-8"></span>
<span id="cb53-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># learning rate</span></span>
<span id="cb53-10">lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">8e-5</span></span>
<span id="cb53-11"></span>
<span id="cb53-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># batch size</span></span>
<span id="cb53-13">bs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb53-14"></span>
<span id="cb53-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># weight decay</span></span>
<span id="cb53-16">wd <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb53-17"></span>
<span id="cb53-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># epochs</span></span>
<span id="cb53-19">epochs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span></code></pre></div>
</div>
<div class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function that determines the split for validation and training data</span></span>
<span id="cb54-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set a default validation dataset split percentage as 25%</span></span>
<span id="cb54-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set a default training dataset split percentage as 75%</span></span>
<span id="cb54-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_dataSplit(vp):</span>
<span id="cb54-5">  anchors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.anchor.unique()</span>
<span id="cb54-6">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Unique Anchors: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(anchors)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb54-7">  np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb54-8">  np.random.shuffle(anchors)</span>
<span id="cb54-9"></span>
<span id="cb54-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># specify how much validation set we want</span></span>
<span id="cb54-11">  val_prop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vp</span>
<span id="cb54-12">  val_sz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(anchors)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>val_prop)</span>
<span id="cb54-13">  val_anchors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> anchors[:val_sz]</span>
<span id="cb54-14"></span>
<span id="cb54-15">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find which rows match the valid anchors and get their indices</span></span>
<span id="cb54-16">  is_val <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.isin(df.anchor, val_anchors)</span>
<span id="cb54-17">  idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.arange(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(df))</span>
<span id="cb54-18"></span>
<span id="cb54-19">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Validation Data</span></span>
<span id="cb54-20">  val_idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idxs[ is_val]</span>
<span id="cb54-21">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Validation Dataset Length: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(val_idxs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb54-22">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training Data</span></span>
<span id="cb54-23">  trn_idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> idxs[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">~</span>is_val]</span>
<span id="cb54-24">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Training Dataset Length: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(trn_idxs)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb54-25"></span>
<span id="cb54-26">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (val_idxs, trn_idxs)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to tokenize training data</span></span>
<span id="cb55-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_dds(df, vp<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.25</span>):</span>
<span id="cb55-3">  ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dataset.from_pandas(df).rename_column(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'score'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'label'</span>)</span>
<span id="cb55-4">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original Input Dataset"</span>)</span>
<span id="cb55-5">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(ds)</span>
<span id="cb55-6">  eval_ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Dataset.from_pandas(eval_df)</span>
<span id="cb55-7">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original Inference Dataset"</span>)</span>
<span id="cb55-8">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(eval_ds)</span>
<span id="cb55-9">  inps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"anchor"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"target"</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"context"</span></span>
<span id="cb55-10">  tok_ds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ds.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(tok_func, batched<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, remove_columns<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>inps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>,<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'section'</span>))</span>
<span id="cb55-11">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tokenized Input Dataset"</span>)</span>
<span id="cb55-12">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(tok_ds)</span>
<span id="cb55-13">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Tokenized Inference Dataset"</span>)</span>
<span id="cb55-14">  <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(eval_ds)</span>
<span id="cb55-15">  val_idxs, trn_idxs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_dataSplit(vp)</span>
<span id="cb55-16">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> DatasetDict({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"train"</span>:tok_ds.select(trn_idxs), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"test"</span>: tok_ds.select(val_idxs)})</span></code></pre></div>
</div>
<div class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to get the model</span></span>
<span id="cb56-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_model():</span>
<span id="cb56-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> AutoModelForSequenceClassification.from_pretrained(model_nm, num_labels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb57" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to create a Trainer</span></span>
<span id="cb57-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - Trainer -&gt; class which combines the data and model together (similar to Learner in FastAI)</span></span>
<span id="cb57-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> get_trainer(dds, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb57-4"></span>
<span id="cb57-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize model</span></span>
<span id="cb57-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> model <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>: model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model()</span>
<span id="cb57-7"></span>
<span id="cb57-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transformers require the TrainingArguments class to set up the arguments for the trainer</span></span>
<span id="cb57-9">    args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TrainingArguments(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'outputs'</span>, learning_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr, warmup_ratio<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, lr_scheduler_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cosine'</span>, fp16<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb57-10">        evaluation_strategy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epoch"</span>, per_device_train_batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bs, per_device_eval_batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb57-11">        num_train_epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>epochs, weight_decay<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>wd, report_to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'none'</span>)</span>
<span id="cb57-12"></span>
<span id="cb57-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Trainer(model, args, train_dataset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dds[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>], eval_dataset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dds[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>],</span>
<span id="cb57-14">                   tokenizer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tokz, compute_metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>corr_d)</span></code></pre></div>
</div>
</section>
<section id="data-representation" class="level2">
<h2 class="anchored" data-anchor-id="data-representation">Data Representation</h2>
<section id="combine-context-anchor-target-experiments" class="level3">
<h3 class="anchored" data-anchor-id="combine-context-anchor-target-experiments">Combine Context + Anchor + Target Experiments</h3>
<section id="method-1---baseline" class="level4">
<h4 class="anchored" data-anchor-id="method-1---baseline">Method 1 - Baseline</h4>
<div class="cell" data-outputid="86d5bae5-282a-466d-daae-bbcc9826d0ca" data-execution_count="39">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 1 - Baseline</span></span>
<span id="cb58-2">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CONTEXT: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; TEXT1: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; TEXT2: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.target</span>
<span id="cb58-3">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'CONTEXT: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; TEXT1: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'; TEXT2: '</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.target</span>
<span id="cb58-4"></span>
<span id="cb58-5">dds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_dds(df)</span>
<span id="cb58-6"></span>
<span id="cb58-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create and train model</span></span>
<span id="cb58-8">get_trainer(dds).train()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original Input Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'section'],
    num_rows: 36473
})
Original Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section'],
    num_rows: 36
})
Tokenized Input Dataset
Dataset({
    features: ['label', 'input_ids', 'token_type_ids', 'attention_mask'],
    num_rows: 36473
})
Tokenized Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section'],
    num_rows: 36
})
Unique Anchors: 733
Validation Dataset Length: 9116
Training Dataset Length: 27357</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"3239c7a5e0f64bac844ab4a9b6c0534d","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="856" max="856" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [856/856 03:36, Epoch 4/4]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">Pearson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No log</td>
<td>0.026578</td>
<td>0.796921</td>
</tr>
<tr class="even">
<td>2</td>
<td>No log</td>
<td>0.023371</td>
<td>0.818602</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0.036700</td>
<td>0.024409</td>
<td>0.820100</td>
</tr>
<tr class="even">
<td>4</td>
<td>0.036700</td>
<td>0.023927</td>
<td>0.819576</td>
</tr>
</tbody>
</table>
<p>
</p></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>TrainOutput(global_step=856, training_loss=0.02694343183642236, metrics={'train_runtime': 217.0934, 'train_samples_per_second': 504.059, 'train_steps_per_second': 3.943, 'total_flos': 723683047099410.0, 'train_loss': 0.02694343183642236, 'epoch': 4.0})</code></pre>
</div>
</div>
</section>
<section id="method-2---separate-token" class="level4">
<h4 class="anchored" data-anchor-id="method-2---separate-token">Method 2 - Separate Token</h4>
<div class="cell" data-outputid="e03b9e57-f068-4b8c-9c6f-ad25ab0d8e34" data-execution_count="40">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 2 - Separate Token</span></span>
<span id="cb61-2">sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tokz.sep_token</span>
<span id="cb61-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Separate Token: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>sep<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb61-4">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.target</span>
<span id="cb61-5">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eval_df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.target</span>
<span id="cb61-6"></span>
<span id="cb61-7">dds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_dds(df)</span>
<span id="cb61-8"></span>
<span id="cb61-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create and train model</span></span>
<span id="cb61-10">get_trainer(dds).train()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Separate Token: [SEP]
Original Input Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'section'],
    num_rows: 36473
})
Original Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section'],
    num_rows: 36
})
Tokenized Input Dataset
Dataset({
    features: ['label', 'input_ids', 'token_type_ids', 'attention_mask'],
    num_rows: 36473
})
Tokenized Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section'],
    num_rows: 36
})
Unique Anchors: 733
Validation Dataset Length: 9116
Training Dataset Length: 27357</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"2b971764e7934b1d8d8936ddc3d2f6f5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="856" max="856" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [856/856 03:10, Epoch 4/4]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">Pearson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No log</td>
<td>0.026330</td>
<td>0.792181</td>
</tr>
<tr class="even">
<td>2</td>
<td>No log</td>
<td>0.025083</td>
<td>0.809545</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0.032000</td>
<td>0.024699</td>
<td>0.812255</td>
</tr>
<tr class="even">
<td>4</td>
<td>0.032000</td>
<td>0.024956</td>
<td>0.812318</td>
</tr>
</tbody>
</table>
<p>
</p></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>TrainOutput(global_step=856, training_loss=0.024021479013924287, metrics={'train_runtime': 190.9271, 'train_samples_per_second': 573.14, 'train_steps_per_second': 4.483, 'total_flos': 468872298987930.0, 'train_loss': 0.024021479013924287, 'epoch': 4.0})</code></pre>
</div>
</div>
</section>
<section id="method-3---change-token-separator" class="level4">
<h4 class="anchored" data-anchor-id="method-3---change-token-separator">Method 3 - Change Token Separator</h4>
<div class="cell" data-outputid="e84a4979-f6a4-4d7a-b95b-93cdcb556d89" data-execution_count="41">
<div class="sourceCode cell-code" id="cb64" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 3 - change the type of separator</span></span>
<span id="cb64-2">sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">" [s] "</span></span>
<span id="cb64-3">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.target</span>
<span id="cb64-4">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eval_df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.target</span>
<span id="cb64-5"></span>
<span id="cb64-6">dds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_dds(df)</span>
<span id="cb64-7"></span>
<span id="cb64-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create and train model</span></span>
<span id="cb64-9">get_trainer(dds).train()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original Input Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'section'],
    num_rows: 36473
})
Original Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section'],
    num_rows: 36
})
Tokenized Input Dataset
Dataset({
    features: ['label', 'input_ids', 'token_type_ids', 'attention_mask'],
    num_rows: 36473
})
Tokenized Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section'],
    num_rows: 36
})
Unique Anchors: 733
Validation Dataset Length: 9116
Training Dataset Length: 27357</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"d7d1be6406ad48a48b81f7863a3771be","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="856" max="856" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [856/856 03:17, Epoch 4/4]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">Pearson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No log</td>
<td>0.027578</td>
<td>0.789799</td>
</tr>
<tr class="even">
<td>2</td>
<td>No log</td>
<td>0.025510</td>
<td>0.814414</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0.031600</td>
<td>0.023443</td>
<td>0.817882</td>
</tr>
<tr class="even">
<td>4</td>
<td>0.031600</td>
<td>0.024294</td>
<td>0.817224</td>
</tr>
</tbody>
</table>
<p>
</p></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>TrainOutput(global_step=856, training_loss=0.023982213479336177, metrics={'train_runtime': 197.7627, 'train_samples_per_second': 553.33, 'train_steps_per_second': 4.328, 'total_flos': 582121520370810.0, 'train_loss': 0.023982213479336177, 'epoch': 4.0})</code></pre>
</div>
</div>
</section>
<section id="method-4---method-3-lowercase" class="level4">
<h4 class="anchored" data-anchor-id="method-4---method-3-lowercase">Method 4 - Method 3 + Lowercase</h4>
<div class="cell" data-outputid="0da593cf-571d-4bd3-f1ea-64fdf7a33b0a" data-execution_count="42">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 4 - change to all lower case</span></span>
<span id="cb67-2">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.target</span>
<span id="cb67-3">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.lower()</span>
<span id="cb67-4">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eval_df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.anchor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.target</span>
<span id="cb67-5">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eval_df.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">input</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.lower()</span>
<span id="cb67-6"></span>
<span id="cb67-7">dds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_dds(df)</span>
<span id="cb67-8">get_trainer(dds).train()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original Input Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'section'],
    num_rows: 36473
})
Original Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section'],
    num_rows: 36
})
Tokenized Input Dataset
Dataset({
    features: ['label', 'input_ids', 'token_type_ids', 'attention_mask'],
    num_rows: 36473
})
Tokenized Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section'],
    num_rows: 36
})
Unique Anchors: 733
Validation Dataset Length: 9116
Training Dataset Length: 27357</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"b81b5743ecc140f09fd3c577ef57cf65","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="856" max="856" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [856/856 03:13, Epoch 4/4]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">Pearson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No log</td>
<td>0.026599</td>
<td>0.794113</td>
</tr>
<tr class="even">
<td>2</td>
<td>No log</td>
<td>0.024963</td>
<td>0.817053</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0.031500</td>
<td>0.023034</td>
<td>0.818722</td>
</tr>
<tr class="even">
<td>4</td>
<td>0.031500</td>
<td>0.024056</td>
<td>0.818191</td>
</tr>
</tbody>
</table>
<p>
</p></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>TrainOutput(global_step=856, training_loss=0.02395056954054075, metrics={'train_runtime': 193.6779, 'train_samples_per_second': 565.0, 'train_steps_per_second': 4.42, 'total_flos': 582121520370810.0, 'train_loss': 0.02395056954054075, 'epoch': 4.0})</code></pre>
</div>
</div>
</section>
<section id="method-5---special-tokens" class="level4">
<h4 class="anchored" data-anchor-id="method-5---special-tokens">Method 5 - Special Tokens</h4>
<div class="cell" data-outputid="267ee3c6-43f5-4587-cfc7-a2cfbdc1d6e8" data-execution_count="43">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Method 5 - Special Tokens</span></span>
<span id="cb70-2">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sectok'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'['</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.section <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">']'</span></span>
<span id="cb70-3">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'sectok'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'['</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.section <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">']'</span></span>
<span id="cb70-4">sectoks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(df.sectok.unique())</span>
<span id="cb70-5">tokz.add_special_tokens({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'additional_special_tokens'</span>: sectoks})</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>8</code></pre>
</div>
</div>
<div class="cell" data-outputid="e284d6da-17fb-4893-b75e-7df0ed791027" data-execution_count="44">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1">df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df.sectok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.anchor.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.lower() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> df.target</span>
<span id="cb72-2">eval_df[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'input'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> eval_df.sectok <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.context <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.anchor.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">str</span>.lower() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sep <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> eval_df.target</span>
<span id="cb72-3">dds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_dds(df)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original Input Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'section', 'sectok'],
    num_rows: 36473
})
Original Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section', 'sectok'],
    num_rows: 36
})
Tokenized Input Dataset
Dataset({
    features: ['label', 'sectok', 'input_ids', 'token_type_ids', 'attention_mask'],
    num_rows: 36473
})
Tokenized Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section', 'sectok'],
    num_rows: 36
})
Unique Anchors: 733
Validation Dataset Length: 9116
Training Dataset Length: 27357</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bcdf2004db124e83bd66ba2ca3e4c009","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
</div>
<div class="cell" data-outputid="cf787449-2547-4791-f545-3fa820b41ae1" data-execution_count="45">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># resize embedding matrix in model</span></span>
<span id="cb74-2">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model()</span>
<span id="cb74-3">model.resize_token_embeddings(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(tokz))</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="45">
<pre><code>Embedding(128009, 768)</code></pre>
</div>
</div>
<div class="cell" data-outputid="3e5d44dc-5a09-4189-c979-c02559d7a2bb" data-execution_count="46">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train the model</span></span>
<span id="cb76-2">trainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_trainer(dds, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model)</span>
<span id="cb76-3">trainer.train()</span></code></pre></div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="856" max="856" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [856/856 03:33, Epoch 4/4]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">Pearson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No log</td>
<td>0.029230</td>
<td>0.803785</td>
</tr>
<tr class="even">
<td>2</td>
<td>No log</td>
<td>0.024406</td>
<td>0.821807</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0.031400</td>
<td>0.023469</td>
<td>0.820734</td>
</tr>
<tr class="even">
<td>4</td>
<td>0.031400</td>
<td>0.024289</td>
<td>0.820907</td>
</tr>
</tbody>
</table>
<p>
</p></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>TrainOutput(global_step=856, training_loss=0.023841174406425976, metrics={'train_runtime': 214.1222, 'train_samples_per_second': 511.054, 'train_steps_per_second': 3.998, 'total_flos': 695370741753690.0, 'train_loss': 0.023841174406425976, 'epoch': 4.0})</code></pre>
</div>
</div>
<div class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train on the entire training dataset before doing final tests with inference dataset</span></span>
<span id="cb78-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> final_get_trainer(dds, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb78-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initialize model</span></span>
<span id="cb78-4">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> model <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb78-5">        model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_model()</span>
<span id="cb78-6"></span>
<span id="cb78-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Transformers require the TrainingArguments class to set up the arguments for the trainer</span></span>
<span id="cb78-8">    args <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> TrainingArguments(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'outputs'</span>, learning_rate<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr, warmup_ratio<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, lr_scheduler_type<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cosine'</span>, fp16<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb78-9">        evaluation_strategy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"epoch"</span>, per_device_train_batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bs, per_device_eval_batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>bs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,</span>
<span id="cb78-10">        num_train_epochs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>epochs, weight_decay<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>wd, report_to<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'none'</span>)</span>
<span id="cb78-11"></span>
<span id="cb78-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> Trainer(model, args, train_dataset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dds[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>], eval_dataset<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dds[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>],</span>
<span id="cb78-13">                   tokenizer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>tokz, compute_metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>corr_d)</span></code></pre></div>
</div>
<div class="cell" data-outputid="935d3fd4-2c44-4e29-8255-c42d38438de4" data-execution_count="48">
<div class="sourceCode cell-code" id="cb79" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1">dds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_dds(df, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span>)</span>
<span id="cb79-2">trainer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> final_get_trainer(dds, model<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>model)</span>
<span id="cb79-3">trainer.train()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Original Input Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'label', 'input', 'section', 'sectok'],
    num_rows: 36473
})
Original Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section', 'sectok'],
    num_rows: 36
})
Tokenized Input Dataset
Dataset({
    features: ['label', 'sectok', 'input_ids', 'token_type_ids', 'attention_mask'],
    num_rows: 36473
})
Tokenized Inference Dataset
Dataset({
    features: ['id', 'anchor', 'target', 'context', 'input', 'section', 'sectok'],
    num_rows: 36
})
Unique Anchors: 733
Validation Dataset Length: 347
Training Dataset Length: 36126</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"bf5d43881c9543e4acc9cc89cb2b4565","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

    <div>
      
      <progress value="1132" max="1132" style="width:300px; height:20px; vertical-align: middle;"></progress>
      [1132/1132 04:31, Epoch 4/4]
    </div>
    
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">Epoch</th>
<th data-quarto-table-cell-role="th">Training Loss</th>
<th data-quarto-table-cell-role="th">Validation Loss</th>
<th data-quarto-table-cell-role="th">Pearson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No log</td>
<td>0.021583</td>
<td>0.836893</td>
</tr>
<tr class="even">
<td>2</td>
<td>0.015400</td>
<td>0.019293</td>
<td>0.863323</td>
</tr>
<tr class="odd">
<td>3</td>
<td>0.015400</td>
<td>0.018774</td>
<td>0.860989</td>
</tr>
<tr class="even">
<td>4</td>
<td>0.009500</td>
<td>0.018202</td>
<td>0.864261</td>
</tr>
</tbody>
</table>
<p>
</p></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>TrainOutput(global_step=1132, training_loss=0.011905024835161943, metrics={'train_runtime': 272.1518, 'train_samples_per_second': 530.968, 'train_steps_per_second': 4.159, 'total_flos': 918764683369440.0, 'train_loss': 0.011905024835161943, 'epoch': 4.0})</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="evaluate-performance-of-model-on-inference-data" class="level2">
<h2 class="anchored" data-anchor-id="evaluate-performance-of-model-on-inference-data">Evaluate Performance of Model on Inference Data</h2>
<div class="cell" data-outputid="3deac220-b33f-41b6-8c40-0286ee4ef096" data-execution_count="49">
<div class="sourceCode cell-code" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test model on the evaluation data</span></span>
<span id="cb82-2">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trainer.predict(eval_ds).predictions.astype(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>)</span>
<span id="cb82-3">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.clip(preds, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb82-4">preds</span></code></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display" data-execution_count="49">
<pre><code>array([[0.57763672],
       [0.57177734],
       [0.47412109],
       [0.34521484],
       [0.        ],
       [0.48852539],
       [0.51611328],
       [0.        ],
       [0.3503418 ],
       [0.64208984],
       [0.33959961],
       [0.28930664],
       [0.65234375],
       [0.71289062],
       [0.56591797],
       [0.37866211],
       [0.30786133],
       [0.05584717],
       [0.61181641],
       [0.4050293 ],
       [0.58447266],
       [0.26806641],
       [0.28491211],
       [0.29077148],
       [0.53857422],
       [0.        ],
       [0.        ],
       [0.        ],
       [0.        ],
       [0.59912109],
       [0.35766602],
       [0.07025146],
       [0.68945312],
       [0.48779297],
       [0.41601562],
       [0.29858398]])</code></pre>
</div>
</div>
</section>
<section id="submission-for-kaggle-competition" class="level2">
<h2 class="anchored" data-anchor-id="submission-for-kaggle-competition">Submission for Kaggle Competition</h2>
<div class="cell" data-outputid="4c00156f-c7db-402d-ca78-c3c9eda576a7" data-execution_count="50">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Submit for kaggle competition</span></span>
<span id="cb84-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> datasets</span>
<span id="cb84-3"></span>
<span id="cb84-4">submission <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> datasets.Dataset.from_dict({</span>
<span id="cb84-5">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>: eval_ds[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'id'</span>],</span>
<span id="cb84-6">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'score'</span>: preds</span>
<span id="cb84-7">})</span>
<span id="cb84-8"></span>
<span id="cb84-9">submission.to_csv(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'submission.csv'</span>, index<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"97ab4fe9be8e4516964e367b017c3033","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>1039</code></pre>
</div>
</div>
</section>
<section id="validation-set-and-modeling-experiments" class="level2">
<h2 class="anchored" data-anchor-id="validation-set-and-modeling-experiments">Validation Set and Modeling Experiments</h2>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to model</span></span>
<span id="cb86-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f(x):</span>
<span id="cb86-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span></span>
<span id="cb86-4"></span>
<span id="cb86-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function for visualization Data</span></span>
<span id="cb86-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> plot_function(f, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>):</span>
<span id="cb86-7">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb86-8">    plt.plot(x, f(x), color)</span></code></pre></div>
</div>
<div class="cell" data-outputid="042aa1c1-1a36-4c17-b04b-3d3a69f4416f" data-execution_count="52">
<div class="sourceCode cell-code" id="cb87" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Function we're trying to fit"</span>)</span>
<span id="cb87-2">plot_function(f)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Function we're trying to fit</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-53-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb89" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Functions for creating noisy data</span></span>
<span id="cb89-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpy.random <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> normal,seed,uniform</span>
<span id="cb89-3">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb89-4"></span>
<span id="cb89-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> noise(x, scale):</span>
<span id="cb89-6">   <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> normal(scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>scale, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.shape)</span>
<span id="cb89-7"></span>
<span id="cb89-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add_noise(x, mult, add):</span>
<span id="cb89-9">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>noise(x,mult)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise(x,add)</span></code></pre></div>
</div>
<div class="cell" data-outputid="47db4bb0-5416-41d4-8ed5-414fe915813d" data-execution_count="54">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate Noisy Data</span></span>
<span id="cb90-2">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, num<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb90-3">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> add_noise(f(x), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.3</span>)</span>
<span id="cb90-4">plt.scatter(x,y)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-55-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb91" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function for trying to find polynomial function that fits data</span></span>
<span id="cb91-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.linear_model <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LinearRegression</span>
<span id="cb91-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.preprocessing <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PolynomialFeatures</span>
<span id="cb91-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.pipeline <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_pipeline</span>
<span id="cb91-5"></span>
<span id="cb91-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> plot_poly(degree):</span>
<span id="cb91-7">    model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_pipeline(PolynomialFeatures(degree), LinearRegression())</span>
<span id="cb91-8">    model.fit(x, y)</span>
<span id="cb91-9">    plt.scatter(x,y)</span>
<span id="cb91-10">    plot_function(model.predict)</span></code></pre></div>
</div>
<div class="cell" data-outputid="8a3ab95e-3110-4a50-cd9c-a2d2cfcf6ebc" data-execution_count="56">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Underfit</span></span>
<span id="cb92-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Polynomial of Degree 1: Underfit"</span>)</span>
<span id="cb92-3">plot_poly(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Polynomial of Degree 1: Underfit</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-57-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="7e884243-ae3a-42c0-e606-d322565ea1f1" data-execution_count="57">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Overfit</span></span>
<span id="cb94-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Polynomial of Degree 10: Overfit"</span>)</span>
<span id="cb94-3">plot_poly(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Polynomial of Degree 10: Overfit</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-58-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="0fd17a0a-ab10-4063-98b8-86fe123d4859" data-execution_count="58">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Approximation of Close fit</span></span>
<span id="cb96-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Polynmomial of Degree 2: A close approximation of exact fit"</span>)</span>
<span id="cb96-3">plot_poly(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb96-4"></span>
<span id="cb96-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the original true function (one we're trying to fit)</span></span>
<span id="cb96-6">plot_function(f, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'b'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Polynmomial of Degree 2: A close approximation of exact fit</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-59-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="metric-experiments-correlation" class="level2">
<h2 class="anchored" data-anchor-id="metric-experiments-correlation">Metric Experiments: Correlation</h2>
<div class="cell" data-outputid="bf71216c-4597-4460-9f0f-3bb6ce100e95" data-execution_count="59">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> sklearn.datasets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fetch_california_housing</span>
<span id="cb98-2">housing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fetch_california_housing(as_frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb98-3">housing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> housing[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'data'</span>].join(housing[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'target'</span>]).sample(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, random_state<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">52</span>)</span>
<span id="cb98-4">housing.head()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">

  <div id="df-c05f5d73-b60c-4344-bce3-7248453ae1ff" class="colab-df-container">
    <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MedInc</th>
<th data-quarto-table-cell-role="th">HouseAge</th>
<th data-quarto-table-cell-role="th">AveRooms</th>
<th data-quarto-table-cell-role="th">AveBedrms</th>
<th data-quarto-table-cell-role="th">Population</th>
<th data-quarto-table-cell-role="th">AveOccup</th>
<th data-quarto-table-cell-role="th">Latitude</th>
<th data-quarto-table-cell-role="th">Longitude</th>
<th data-quarto-table-cell-role="th">MedHouseVal</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">7506</td>
<td>3.0550</td>
<td>37.0</td>
<td>5.152778</td>
<td>1.048611</td>
<td>729.0</td>
<td>5.062500</td>
<td>33.92</td>
<td>-118.28</td>
<td>1.054</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4720</td>
<td>3.0862</td>
<td>35.0</td>
<td>4.697897</td>
<td>1.055449</td>
<td>1159.0</td>
<td>2.216061</td>
<td>34.05</td>
<td>-118.37</td>
<td>3.453</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12888</td>
<td>2.5556</td>
<td>24.0</td>
<td>4.864905</td>
<td>1.129222</td>
<td>1631.0</td>
<td>2.395007</td>
<td>38.66</td>
<td>-121.35</td>
<td>1.057</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13344</td>
<td>3.0057</td>
<td>32.0</td>
<td>4.212687</td>
<td>0.936567</td>
<td>1378.0</td>
<td>5.141791</td>
<td>34.05</td>
<td>-117.64</td>
<td>0.969</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7173</td>
<td>1.9083</td>
<td>42.0</td>
<td>3.888554</td>
<td>1.039157</td>
<td>1535.0</td>
<td>4.623494</td>
<td>34.05</td>
<td>-118.19</td>
<td>1.192</td>
</tr>
</tbody>
</table>


</div>
    <div class="colab-df-buttons">

  <div class="colab-df-container">
    <button class="colab-df-convert" onclick="convertToInteractive('df-c05f5d73-b60c-4344-bce3-7248453ae1ff')" title="Convert this dataframe to an interactive table." style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 -960 960 960">
    <path d="M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z"></path>
  </svg>
    </button>

  <style>
    .colab-df-container {
      display:flex;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    .colab-df-buttons div {
      margin-bottom: 4px;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

    <script>
      const buttonEl =
        document.querySelector('#df-c05f5d73-b60c-4344-bce3-7248453ae1ff button.colab-df-convert');
      buttonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';

      async function convertToInteractive(key) {
        const element = document.querySelector('#df-c05f5d73-b60c-4344-bce3-7248453ae1ff');
        const dataTable =
          await google.colab.kernel.invokeFunction('convertToInteractive',
                                                    [key], {});
        if (!dataTable) return;

        const docLinkHtml = 'Like what you see? Visit the ' +
          '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
          + ' to learn more about interactive tables.';
        element.innerHTML = '';
        dataTable['output_type'] = 'display_data';
        await google.colab.output.renderOutput(dataTable, element);
        const docLink = document.createElement('div');
        docLink.innerHTML = docLinkHtml;
        element.appendChild(docLink);
      }
    </script>
  </div>


<div id="df-e76f1739-dda6-4b69-86a6-1b142c57c780">
  <button class="colab-df-quickchart" onclick="quickchart('df-e76f1739-dda6-4b69-86a6-1b142c57c780')" title="Suggest charts" style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"></path>
    </g>
</svg>
  </button>

<style>
  .colab-df-quickchart {
      --bg-color: #E8F0FE;
      --fill-color: #1967D2;
      --hover-bg-color: #E2EBFA;
      --hover-fill-color: #174EA6;
      --disabled-fill-color: #AAA;
      --disabled-bg-color: #DDD;
  }

  [theme=dark] .colab-df-quickchart {
      --bg-color: #3B4455;
      --fill-color: #D2E3FC;
      --hover-bg-color: #434B5C;
      --hover-fill-color: #FFFFFF;
      --disabled-bg-color: #3B4455;
      --disabled-fill-color: #666;
  }

  .colab-df-quickchart {
    background-color: var(--bg-color);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: var(--fill-color);
    height: 32px;
    padding: 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: var(--hover-bg-color);
    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: var(--button-hover-fill-color);
  }

  .colab-df-quickchart-complete:disabled,
  .colab-df-quickchart-complete:disabled:hover {
    background-color: var(--disabled-bg-color);
    fill: var(--disabled-fill-color);
    box-shadow: none;
  }

  .colab-df-spinner {
    border: 2px solid var(--fill-color);
    border-color: transparent;
    border-bottom-color: var(--fill-color);
    animation:
      spin 1s steps(1) infinite;
  }

  @keyframes spin {
    0% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
      border-left-color: var(--fill-color);
    }
    20% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    30% {
      border-color: transparent;
      border-left-color: var(--fill-color);
      border-top-color: var(--fill-color);
      border-right-color: var(--fill-color);
    }
    40% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-top-color: var(--fill-color);
    }
    60% {
      border-color: transparent;
      border-right-color: var(--fill-color);
    }
    80% {
      border-color: transparent;
      border-right-color: var(--fill-color);
      border-bottom-color: var(--fill-color);
    }
    90% {
      border-color: transparent;
      border-bottom-color: var(--fill-color);
    }
  }
</style>

  <script>
    async function quickchart(key) {
      const quickchartButtonEl =
        document.querySelector('#' + key + ' button');
      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.
      quickchartButtonEl.classList.add('colab-df-spinner');
      try {
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      } catch (error) {
        console.error('Error during call to suggestCharts:', error);
      }
      quickchartButtonEl.classList.remove('colab-df-spinner');
      quickchartButtonEl.classList.add('colab-df-quickchart-complete');
    }
    (() => {
      let quickchartButtonEl =
        document.querySelector('#df-e76f1739-dda6-4b69-86a6-1b142c57c780 button');
      quickchartButtonEl.style.display =
        google.colab.kernel.accessAllowed ? 'block' : 'none';
    })();
  </script>
</div>

    </div>
  </div>
</div>
</div>
<div class="cell" data-outputid="d54e92de-f873-420a-b990-f08928ae2635" data-execution_count="60">
<div class="sourceCode cell-code" id="cb99" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># correlation coefficients for every combination of columns</span></span>
<span id="cb99-2">np.set_printoptions(precision<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, suppress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb99-3">np.corrcoef(housing, rowvar<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>array([[ 1.  , -0.12,  0.43, -0.08,  0.01, -0.07, -0.12,  0.04,  0.68],
       [-0.12,  1.  , -0.17, -0.06, -0.31,  0.  ,  0.03, -0.13,  0.12],
       [ 0.43, -0.17,  1.  ,  0.76, -0.09, -0.07,  0.12, -0.03,  0.21],
       [-0.08, -0.06,  0.76,  1.  , -0.08, -0.07,  0.09,  0.  , -0.04],
       [ 0.01, -0.31, -0.09, -0.08,  1.  ,  0.16, -0.15,  0.13,  0.  ],
       [-0.07,  0.  , -0.07, -0.07,  0.16,  1.  , -0.16,  0.17, -0.27],
       [-0.12,  0.03,  0.12,  0.09, -0.15, -0.16,  1.  , -0.93, -0.16],
       [ 0.04, -0.13, -0.03,  0.  ,  0.13,  0.17, -0.93,  1.  , -0.03],
       [ 0.68,  0.12,  0.21, -0.04,  0.  , -0.27, -0.16, -0.03,  1.  ]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="014c3e1c-ed73-469d-c007-7bfb2853be1e" data-execution_count="61">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Correlation for two variables</span></span>
<span id="cb101-2">np.corrcoef(housing.MedInc, housing.MedHouseVal)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="61">
<pre><code>array([[1.  , 0.68],
       [0.68, 1.  ]])</code></pre>
</div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for returning single coefficient correlation</span></span>
<span id="cb103-2"></span>
<span id="cb103-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> corr(x,y):</span>
<span id="cb103-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> np.corrcoef(x,y)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb103-5"></span>
<span id="cb103-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test function</span></span>
<span id="cb103-7">corr(housing.MedInc, housing.MedHouseVal)</span>
<span id="cb103-8"></span>
<span id="cb103-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for visualizing correlation between two variables</span></span>
<span id="cb103-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> show_corr(df, a, b):</span>
<span id="cb103-11">    x,y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> df[a],df[b]</span>
<span id="cb103-12">    plt.scatter(x,y, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb103-13">    plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>a<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> vs </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">; r: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>corr(x, y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="6acb3eb0-78cc-437c-ea3e-0da6a8ee6201" data-execution_count="63">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1">show_corr(housing, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MedInc'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MedHouseVal'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-64-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="997f4dd6-6023-435b-a929-2d6b16d4b1c2" data-execution_count="64">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1">show_corr(housing, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MedInc'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AveRooms'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-65-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="761d3eb6-1506-40ee-dd08-f538b224d668" data-execution_count="65">
<div class="sourceCode cell-code" id="cb106" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb106-1">subset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> housing[housing.AveRooms <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>]</span>
<span id="cb106-2">show_corr(subset, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'MedInc'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'AveRooms'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4_files/figure-html/cell-66-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ol type="1">
<li><a href="https://course.fast.ai/Lessons/lesson4.html">FastAI Lesson 4</a></li>
<li><a href="https://nbviewer.org/github/fastai/fastbook/blob/master/10_nlp.ipynb">FastAI Chapter 10</a></li>
<li><a href="https://www.kaggle.com/competitions/us-patent-phrase-to-phrase-matching/">US Patent Phrase to Phrase Matching</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/getting-started-with-nlp-for-absolute-beginners">Getting Started with NLP for Absolute Beginners</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/iterate-like-a-grandmaster/">Iterate Like a Grandmaster</a></li>
<li><a href="https://www.fast.ai/posts/2017-11-13-validation-sets.html">How (and why) to create a good validation dataset</a></li>
<li><a href="https://www.fast.ai/posts/2019-09-24-metrics.html">The problem with metrics is a big problem for AI</a></li>
<li><a href="https://utah-intro-nlp.github.io/#calendar">Utah CS 5340/6340 - Natural Language Processing</a></li>
<li><a href="https://huggingface.co/docs/transformers/index">Hugging Face Transformers docs</a></li>
<li><a href="https://youtube.com/playlist?list=PLfYUBJiXbdtSLBPJ1GMx-sQWf6iNhb8mM&amp;si=WwPOjgYofy4M9QUW">Jeremy Howard FastAI Live Coding</a></li>
<li><a href="https://docs.fast.ai/">fast.ai docs</a></li>
</ol>


</section>

 ]]></description>
  <category>learning</category>
  <category>fastai</category>
  <category>deep learning</category>
  <guid>https://mozartfish.github.io/blog/posts/fastai-lesson4/fastai-lesson4.html</guid>
  <pubDate>Tue, 09 Jan 2024 08:00:00 GMT</pubDate>
</item>
<item>
  <title>FastAI Lesson 3: Neural Network Foundations</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3.html</link>
  <description><![CDATA[ 




<section id="announcements" class="level2">
<h2 class="anchored" data-anchor-id="announcements">Announcements</h2>
<p>Finally back after a long hiatus. I took a break from posting and FASTAI to try <a href="https://adventofcode.com/">Advent of Code</a> and get back to interview prep but I’m back. Normally I only write a single summary for a blog post but this time I’m writing two summaries because Chapter 4 of the book goes deeper into the foundations of neural networks than the lesson video.</p>
</section>
<section id="acknowledgements" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgements">Acknowledgements</h2>
<p>All of this code was written by Jeremy Howard and the authors of the FastAI book. I modified it slightly to include my own print statements, comments and additional helper functions to understand how the code works. This is the source for the original code <a href="https://www.kaggle.com/code/jhoward/how-does-a-neural-net-really-work">How does a neural net really work</a> and <a href="https://nbviewer.org/github/fastai/fastbook/blob/master/04_mnist_basics.ipynb">FastAI Chapter 4</a>.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<section id="summary-fastai-lesson-3-video" class="level3">
<h3 class="anchored" data-anchor-id="summary-fastai-lesson-3-video">Summary: FastAI Lesson 3 Video</h3>
<p>In this lesson, Jeremy gives a high level overview of pytorch, gradient descent and the evolution of models. Most of the lesson focuses on approximating a quadratic equation and building the intuition towards how a neural network works. Towards the end of the video, Jeremy introduces the Titanic dataset and how to do some basic modeling with excel.</p>
</section>
<section id="summary-fastai-chapter-4" class="level3">
<h3 class="anchored" data-anchor-id="summary-fastai-chapter-4">Summary: FastAI Chapter 4</h3>
<p>The MNIST dataset was used as the case study to understand how pytorch and the fastai library work under the hood. I found this chapter to be a mind bender because I struggled to wrap my head around the concept of a tensor and tensor operations. I struggled with the meaning of rank and dimension of tensors because they do not have the same meaning as rank and dimension from linear algebra and calculus. By the end of this chapter, I understood the following concepts:</p>
<ul>
<li>what a tensor represents and performing operations on a tensor</li>
<li>how to set up a classifier using pytorch</li>
<li>how a training loop, optimizer, batch work in pytorch and fastai</li>
<li>the operations and functions that fastai provides a wrapper on top of</li>
</ul>
<p>I do agree with Jeremy that this book chapter might scare people away because of the technical and mathematical jargon. It’s definitely worth spending a few days to go over because it makes it much easier to understand how things work in the subsequent lessons.</p>
</section>
</section>
<section id="jeremy-howards-advice" class="level2">
<h2 class="anchored" data-anchor-id="jeremy-howards-advice">Jeremy Howard’s Advice</h2>
<ul>
<li>Model: Mathematical function consisting of a Matrix Multiply operation + nonlinearity (RELU, Sigmoid etc)</li>
<li>Things to thing about when picking a class of model for a problem we’re trying to solve:
<ol type="1">
<li>How fast is the model</li>
<li>How much memory does it consume</li>
<li>How accurate is it</li>
</ol></li>
<li>Models fit functions to data and try to recognize patterns in data that we give it</li>
</ul>
</section>
<section id="terminology" class="level2">
<h2 class="anchored" data-anchor-id="terminology">Terminology</h2>
<p><strong>Activations(Neural Network)</strong> - Numbers that are calculated (both by linear and non-linear layers)</p>
<p><strong>Parameters(Neural Network)</strong> - Numbers that are randomly initialized, and optimized (that is, the numbers that define the model)</p>
<p><strong>Axis(Numpy), Dimensions(PyTorch Tensors)</strong> - For a matrix, the rows and columns define the axis</p>
<p><strong>Tensor Rank</strong> - The number of dimensions in a tensor</p>
<p><strong>Rank Zero Tensor</strong> - Scalar</p>
<p><strong>Rank One Tensor</strong> - Vector</p>
<p><strong>Rank Two Tensor</strong> - Matrix</p>
<p><strong>Nonlinearity (Activation Function)</strong> - one type of layer in a neural network. Typically a neural network alternates between a linear layer and non-linear layer. Occasionally people refer to a single layer = linear layer + nonlinearity</p>
<p><strong>Relu</strong> - Function that returns 0 for negative numbers and doesn’t change positive numbers</p>
<p><strong>Mini-Batch</strong> - A small group of inputs and labels gathered together in two arrays. A gradient desccent step is updated on this batch rather than a whole epoch</p>
<p><strong>Forward Pass</strong> - Applying the model to some input and computing the predictions</p>
<p><strong>Loss</strong> - A value that represents how well (or bad) the model is doing <strong>Gradient</strong> - The derivative(slope) of the loss with respect to some parameter of the model</p>
<p><strong>Backward Pass</strong> - Computing the gradients of the loss with respect to all model parameters</p>
<p><strong>Gradient Descent</strong> - Taking a step in the directions opposite to the gradients to make the model parameters a little bit better</p>
<p><strong>Learning Rate</strong> - The size of the step we take when applying SGD to update the parameters of the model. Usually a very tiny model</p>
</section>
<section id="mnist-dataset" class="level2">
<h2 class="anchored" data-anchor-id="mnist-dataset">MNIST Dataset</h2>
<p><a href="https://en.wikipedia.org/wiki/MNIST_database">MNIST</a> is a dataset containing handwritten digits collected by NIST (National Institute of Standards and Technology) and turned into dataset by Yann Lecun and his colleagues. More information about the dataset can be found in <a href="https://nbviewer.org/github/fastai/fastbook/blob/master/04_mnist_basics.ipynb">Chapter 4</a> and <a href="https://www.kaggle.com/datasets/hojjatk/mnist-dataset">MNIST Kaggle Competition</a>.</p>
<p>The MNIST dataset follows traditional machine learning dataset layouts: Training Data and Validation Data each containing images associated with a particular digit between 0-9.</p>
</section>
<section id="load-data-and-libraries" class="level2">
<h2 class="anchored" data-anchor-id="load-data-and-libraries">Load Data and Libraries</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load libraries and imports</span></span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uqq fastai duckduckgo_search</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> PIL <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Image</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> functools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> partial</span>
<span id="cb1-9"></span>
<span id="cb1-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># import fastai libraries</span></span>
<span id="cb1-11"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># update grayscale colormap for matplotlib</span></span>
<span id="cb1-14">matplotlib.rc(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image'</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Greys'</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="0f4b1b3a-c38c-4c6c-86ef-61f414543dc0">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># LOAD MNIST DATA</span></span>
<span id="cb2-2">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> untar_data(URLs.MNIST_SAMPLE)</span>
<span id="cb2-3">Path.BASE_PATH <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> path</span>
<span id="cb2-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Contents of MNIST DATA: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ls()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MNIST Training Data</span></span>
<span id="cb2-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MNIST Training Data Directory Contents: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>ls()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MNIST Training Data for 3s and 7s in sorted order</span></span>
<span id="cb2-10">threes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'3'</span>).ls().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>()</span>
<span id="cb2-11">sevens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'7'</span>).ls().<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sorted</span>()</span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(f"Sorted Training Data for 3: {threes}")</span></span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Training Data Example</span></span>
<span id="cb2-15">im3_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> threes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-16">im3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(im3_path)</span>
<span id="cb2-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Test Image of 3 from 3 training data set"</span>)</span>
<span id="cb2-18">im3</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Contents of MNIST DATA: [Path('valid'), Path('labels.csv'), Path('train')]
MNIST Training Data Directory Contents: [Path('train/7'), Path('train/3')]
Test Image of 3 from 3 training data set</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="66">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-3-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="data-processing" class="level2">
<h2 class="anchored" data-anchor-id="data-processing">Data Processing</h2>
<section id="representing-images-as-numbers" class="level3">
<h3 class="anchored" data-anchor-id="representing-images-as-numbers">Representing Images as Numbers</h3>
<p>Images are represented on computers as an array of pixels where each index contains a list of 3 numbers between 0-255 corresponding to a particular color according to RGB. Assembling all of these colors together we get an image.</p>
<p>The MNIST images are represented differently: each index in the image array contains a number between 0-255 where 0 represents white and 255 black. All other values between 0-255 represent a different shade of gray. A unique digit image in the MNIST data is then defined by the black and gray pixels that together outline and define the digit. The size of an image in the MNIST data is 28 x 28 which is 784 pixels in the Image Array.</p>
<p>In the following examples, [4:10, 4:10] means the following: request rows from index 4 (included) to 10(not included) and the same for the columns. Numpy and Pytorch index from top to bottom and left to right.</p>
<p>In the image slice below, we select a part of the digit with just the top part and then color code the slice based on the values in the slice with their mapping in the gray scale (0-255) where 0 represents white and 255 black.</p>
<div class="cell" data-outputid="0dcde0df-075b-4a20-83be-a55fdfb41b45">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MNIST image dimensions are 28 x 28 = 784 pixel array</span></span>
<span id="cb4-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"im3 represented as an array of numbers using numpy array"</span>)</span>
<span id="cb4-3">array(im3)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>im3 represented as an array of numbers using numpy array</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>array([[  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,  29, 150, 195, 254,
        255, 254, 176, 193, 150,  96,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,  48, 166, 224, 253, 253, 234,
        196, 253, 253, 253, 253, 233,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,  93, 244, 249, 253, 187,  46,  10,   8,
          4,  10, 194, 253, 253, 233,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0, 107, 253, 253, 230,  48,   0,   0,   0,
          0,   0, 192, 253, 253, 156,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   3,  20,  20,  15,   0,   0,   0,   0,
          0,  43, 224, 253, 245,  74,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0, 249, 253, 245, 126,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  14, 101,
        223, 253, 248, 124,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,  11, 166, 239, 253,
        253, 253, 187,  30,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,  16, 248, 250, 253,
        253, 253, 253, 232, 213, 111,   2,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  43,  98,
         98, 208, 253, 253, 253, 253, 187,  22,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   9,  51, 119, 253, 253, 253,  76,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   1, 183, 253, 253, 139,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0, 182, 253, 253, 104,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,  85, 249, 253, 253,  36,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,  60, 214, 253, 253, 173,  11,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,  98, 247, 253, 253, 226,   9,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  42,
        150, 252, 253, 253, 233,  53,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,  42, 115,  42,  60, 115, 159, 240,
        253, 253, 250, 175,  25,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0, 187, 253, 253, 253, 253, 253, 253,
        253, 197,  86,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0, 103, 253, 253, 253, 253, 253, 232,
         67,   1,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0],
       [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          0,   0]], dtype=uint8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="e40dc669-0082-4aea-fb3a-ee834c5be48c">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Slice of im3</span></span>
<span id="cb7-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [4:10, 4:10] - get rows and columns starting from 4(included) to 10 (excluded)</span></span>
<span id="cb7-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Numpy Array representation</span></span>
<span id="cb7-4">array(im3)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>array([[  0,   0,   0,   0,   0,   0],
       [  0,   0,   0,   0,   0,  29],
       [  0,   0,   0,  48, 166, 224],
       [  0,  93, 244, 249, 253, 187],
       [  0, 107, 253, 253, 230,  48],
       [  0,   3,  20,  20,  15,   0]], dtype=uint8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="7ae68ffa-21e8-43fe-9fa7-60fe548a11d2">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MNIST image dimensions are 28 x 28 = 784 pixel array</span></span>
<span id="cb9-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"im3 represented as an array of numbers using tensors"</span>)</span>
<span id="cb9-3">tensor(im3)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>im3 represented as an array of numbers using tensors</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>tensor([[  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,  29, 150, 195, 254, 255,
         254, 176, 193, 150,  96,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,  48, 166, 224, 253, 253, 234, 196,
         253, 253, 253, 253, 233,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,  93, 244, 249, 253, 187,  46,  10,   8,   4,
          10, 194, 253, 253, 233,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0, 107, 253, 253, 230,  48,   0,   0,   0,   0,
           0, 192, 253, 253, 156,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   3,  20,  20,  15,   0,   0,   0,   0,   0,
          43, 224, 253, 245,  74,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
         249, 253, 245, 126,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  14, 101, 223,
         253, 248, 124,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,  11, 166, 239, 253, 253,
         253, 187,  30,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,  16, 248, 250, 253, 253,
         253, 253, 232, 213, 111,   2,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  43,  98,  98,
         208, 253, 253, 253, 253, 187,  22,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           9,  51, 119, 253, 253, 253,  76,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   1, 183, 253, 253, 139,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0, 182, 253, 253, 104,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,  85, 249, 253, 253,  36,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,  60, 214, 253, 253, 173,  11,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
          98, 247, 253, 253, 226,   9,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,  42, 150,
         252, 253, 253, 233,  53,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,  42, 115,  42,  60, 115, 159, 240, 253,
         253, 250, 175,  25,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0, 187, 253, 253, 253, 253, 253, 253, 253,
         197,  86,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0, 103, 253, 253, 253, 253, 253, 232,  67,
           1,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,
           0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0,   0]],
       dtype=torch.uint8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="2a23ec28-b5bb-4e50-9a49-8a38295d380e">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Slice of im3</span></span>
<span id="cb12-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [4:10, 4:10] - get rows and columns starting from 4(included) to 10 (excluded)</span></span>
<span id="cb12-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tensor representation</span></span>
<span id="cb12-4">tensor(im3)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>]</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>tensor([[  0,   0,   0,   0,   0,   0],
        [  0,   0,   0,   0,   0,  29],
        [  0,   0,   0,  48, 166, 224],
        [  0,  93, 244, 249, 253, 187],
        [  0, 107, 253, 253, 230,  48],
        [  0,   3,  20,  20,  15,   0]], dtype=torch.uint8)</code></pre>
</div>
</div>
<div class="cell" data-outputid="9db25735-9dd0-4015-ff55-44034639e833">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># slice data to obtain the top part of the number and color code data to show digit outline</span></span>
<span id="cb14-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># slice data rows: 4(included)-15(excluded)</span></span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># slice data columns: 4(included)-22(excluded)</span></span>
<span id="cb14-4">im3_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor(im3)</span>
<span id="cb14-5">df <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame(im3_t[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">22</span>])</span>
<span id="cb14-6">df.style.set_properties(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>{<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'font-size'</span>:<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'6pt'</span>}).background_gradient(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Greys'</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">


<table id="T_137c6" class="dataframe table table-sm table-striped small" data-quarto-postprocess="true">
<thead>
<tr class="header">
<th class="blank level0" data-quarto-table-cell-role="th">&nbsp;</th>
<th id="T_137c6_level0_col0" class="col_heading level0 col0" data-quarto-table-cell-role="th">0</th>
<th id="T_137c6_level0_col1" class="col_heading level0 col1" data-quarto-table-cell-role="th">1</th>
<th id="T_137c6_level0_col2" class="col_heading level0 col2" data-quarto-table-cell-role="th">2</th>
<th id="T_137c6_level0_col3" class="col_heading level0 col3" data-quarto-table-cell-role="th">3</th>
<th id="T_137c6_level0_col4" class="col_heading level0 col4" data-quarto-table-cell-role="th">4</th>
<th id="T_137c6_level0_col5" class="col_heading level0 col5" data-quarto-table-cell-role="th">5</th>
<th id="T_137c6_level0_col6" class="col_heading level0 col6" data-quarto-table-cell-role="th">6</th>
<th id="T_137c6_level0_col7" class="col_heading level0 col7" data-quarto-table-cell-role="th">7</th>
<th id="T_137c6_level0_col8" class="col_heading level0 col8" data-quarto-table-cell-role="th">8</th>
<th id="T_137c6_level0_col9" class="col_heading level0 col9" data-quarto-table-cell-role="th">9</th>
<th id="T_137c6_level0_col10" class="col_heading level0 col10" data-quarto-table-cell-role="th">10</th>
<th id="T_137c6_level0_col11" class="col_heading level0 col11" data-quarto-table-cell-role="th">11</th>
<th id="T_137c6_level0_col12" class="col_heading level0 col12" data-quarto-table-cell-role="th">12</th>
<th id="T_137c6_level0_col13" class="col_heading level0 col13" data-quarto-table-cell-role="th">13</th>
<th id="T_137c6_level0_col14" class="col_heading level0 col14" data-quarto-table-cell-role="th">14</th>
<th id="T_137c6_level0_col15" class="col_heading level0 col15" data-quarto-table-cell-role="th">15</th>
<th id="T_137c6_level0_col16" class="col_heading level0 col16" data-quarto-table-cell-role="th">16</th>
<th id="T_137c6_level0_col17" class="col_heading level0 col17" data-quarto-table-cell-role="th">17</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td id="T_137c6_level0_row0" class="row_heading level0 row0" data-quarto-table-cell-role="th">0</td>
<td id="T_137c6_row0_col0" class="data row0 col0">0</td>
<td id="T_137c6_row0_col1" class="data row0 col1">0</td>
<td id="T_137c6_row0_col2" class="data row0 col2">0</td>
<td id="T_137c6_row0_col3" class="data row0 col3">0</td>
<td id="T_137c6_row0_col4" class="data row0 col4">0</td>
<td id="T_137c6_row0_col5" class="data row0 col5">0</td>
<td id="T_137c6_row0_col6" class="data row0 col6">0</td>
<td id="T_137c6_row0_col7" class="data row0 col7">0</td>
<td id="T_137c6_row0_col8" class="data row0 col8">0</td>
<td id="T_137c6_row0_col9" class="data row0 col9">0</td>
<td id="T_137c6_row0_col10" class="data row0 col10">0</td>
<td id="T_137c6_row0_col11" class="data row0 col11">0</td>
<td id="T_137c6_row0_col12" class="data row0 col12">0</td>
<td id="T_137c6_row0_col13" class="data row0 col13">0</td>
<td id="T_137c6_row0_col14" class="data row0 col14">0</td>
<td id="T_137c6_row0_col15" class="data row0 col15">0</td>
<td id="T_137c6_row0_col16" class="data row0 col16">0</td>
<td id="T_137c6_row0_col17" class="data row0 col17">0</td>
</tr>
<tr class="even">
<td id="T_137c6_level0_row1" class="row_heading level0 row1" data-quarto-table-cell-role="th">1</td>
<td id="T_137c6_row1_col0" class="data row1 col0">0</td>
<td id="T_137c6_row1_col1" class="data row1 col1">0</td>
<td id="T_137c6_row1_col2" class="data row1 col2">0</td>
<td id="T_137c6_row1_col3" class="data row1 col3">0</td>
<td id="T_137c6_row1_col4" class="data row1 col4">0</td>
<td id="T_137c6_row1_col5" class="data row1 col5">29</td>
<td id="T_137c6_row1_col6" class="data row1 col6">150</td>
<td id="T_137c6_row1_col7" class="data row1 col7">195</td>
<td id="T_137c6_row1_col8" class="data row1 col8">254</td>
<td id="T_137c6_row1_col9" class="data row1 col9">255</td>
<td id="T_137c6_row1_col10" class="data row1 col10">254</td>
<td id="T_137c6_row1_col11" class="data row1 col11">176</td>
<td id="T_137c6_row1_col12" class="data row1 col12">193</td>
<td id="T_137c6_row1_col13" class="data row1 col13">150</td>
<td id="T_137c6_row1_col14" class="data row1 col14">96</td>
<td id="T_137c6_row1_col15" class="data row1 col15">0</td>
<td id="T_137c6_row1_col16" class="data row1 col16">0</td>
<td id="T_137c6_row1_col17" class="data row1 col17">0</td>
</tr>
<tr class="odd">
<td id="T_137c6_level0_row2" class="row_heading level0 row2" data-quarto-table-cell-role="th">2</td>
<td id="T_137c6_row2_col0" class="data row2 col0">0</td>
<td id="T_137c6_row2_col1" class="data row2 col1">0</td>
<td id="T_137c6_row2_col2" class="data row2 col2">0</td>
<td id="T_137c6_row2_col3" class="data row2 col3">48</td>
<td id="T_137c6_row2_col4" class="data row2 col4">166</td>
<td id="T_137c6_row2_col5" class="data row2 col5">224</td>
<td id="T_137c6_row2_col6" class="data row2 col6">253</td>
<td id="T_137c6_row2_col7" class="data row2 col7">253</td>
<td id="T_137c6_row2_col8" class="data row2 col8">234</td>
<td id="T_137c6_row2_col9" class="data row2 col9">196</td>
<td id="T_137c6_row2_col10" class="data row2 col10">253</td>
<td id="T_137c6_row2_col11" class="data row2 col11">253</td>
<td id="T_137c6_row2_col12" class="data row2 col12">253</td>
<td id="T_137c6_row2_col13" class="data row2 col13">253</td>
<td id="T_137c6_row2_col14" class="data row2 col14">233</td>
<td id="T_137c6_row2_col15" class="data row2 col15">0</td>
<td id="T_137c6_row2_col16" class="data row2 col16">0</td>
<td id="T_137c6_row2_col17" class="data row2 col17">0</td>
</tr>
<tr class="even">
<td id="T_137c6_level0_row3" class="row_heading level0 row3" data-quarto-table-cell-role="th">3</td>
<td id="T_137c6_row3_col0" class="data row3 col0">0</td>
<td id="T_137c6_row3_col1" class="data row3 col1">93</td>
<td id="T_137c6_row3_col2" class="data row3 col2">244</td>
<td id="T_137c6_row3_col3" class="data row3 col3">249</td>
<td id="T_137c6_row3_col4" class="data row3 col4">253</td>
<td id="T_137c6_row3_col5" class="data row3 col5">187</td>
<td id="T_137c6_row3_col6" class="data row3 col6">46</td>
<td id="T_137c6_row3_col7" class="data row3 col7">10</td>
<td id="T_137c6_row3_col8" class="data row3 col8">8</td>
<td id="T_137c6_row3_col9" class="data row3 col9">4</td>
<td id="T_137c6_row3_col10" class="data row3 col10">10</td>
<td id="T_137c6_row3_col11" class="data row3 col11">194</td>
<td id="T_137c6_row3_col12" class="data row3 col12">253</td>
<td id="T_137c6_row3_col13" class="data row3 col13">253</td>
<td id="T_137c6_row3_col14" class="data row3 col14">233</td>
<td id="T_137c6_row3_col15" class="data row3 col15">0</td>
<td id="T_137c6_row3_col16" class="data row3 col16">0</td>
<td id="T_137c6_row3_col17" class="data row3 col17">0</td>
</tr>
<tr class="odd">
<td id="T_137c6_level0_row4" class="row_heading level0 row4" data-quarto-table-cell-role="th">4</td>
<td id="T_137c6_row4_col0" class="data row4 col0">0</td>
<td id="T_137c6_row4_col1" class="data row4 col1">107</td>
<td id="T_137c6_row4_col2" class="data row4 col2">253</td>
<td id="T_137c6_row4_col3" class="data row4 col3">253</td>
<td id="T_137c6_row4_col4" class="data row4 col4">230</td>
<td id="T_137c6_row4_col5" class="data row4 col5">48</td>
<td id="T_137c6_row4_col6" class="data row4 col6">0</td>
<td id="T_137c6_row4_col7" class="data row4 col7">0</td>
<td id="T_137c6_row4_col8" class="data row4 col8">0</td>
<td id="T_137c6_row4_col9" class="data row4 col9">0</td>
<td id="T_137c6_row4_col10" class="data row4 col10">0</td>
<td id="T_137c6_row4_col11" class="data row4 col11">192</td>
<td id="T_137c6_row4_col12" class="data row4 col12">253</td>
<td id="T_137c6_row4_col13" class="data row4 col13">253</td>
<td id="T_137c6_row4_col14" class="data row4 col14">156</td>
<td id="T_137c6_row4_col15" class="data row4 col15">0</td>
<td id="T_137c6_row4_col16" class="data row4 col16">0</td>
<td id="T_137c6_row4_col17" class="data row4 col17">0</td>
</tr>
<tr class="even">
<td id="T_137c6_level0_row5" class="row_heading level0 row5" data-quarto-table-cell-role="th">5</td>
<td id="T_137c6_row5_col0" class="data row5 col0">0</td>
<td id="T_137c6_row5_col1" class="data row5 col1">3</td>
<td id="T_137c6_row5_col2" class="data row5 col2">20</td>
<td id="T_137c6_row5_col3" class="data row5 col3">20</td>
<td id="T_137c6_row5_col4" class="data row5 col4">15</td>
<td id="T_137c6_row5_col5" class="data row5 col5">0</td>
<td id="T_137c6_row5_col6" class="data row5 col6">0</td>
<td id="T_137c6_row5_col7" class="data row5 col7">0</td>
<td id="T_137c6_row5_col8" class="data row5 col8">0</td>
<td id="T_137c6_row5_col9" class="data row5 col9">0</td>
<td id="T_137c6_row5_col10" class="data row5 col10">43</td>
<td id="T_137c6_row5_col11" class="data row5 col11">224</td>
<td id="T_137c6_row5_col12" class="data row5 col12">253</td>
<td id="T_137c6_row5_col13" class="data row5 col13">245</td>
<td id="T_137c6_row5_col14" class="data row5 col14">74</td>
<td id="T_137c6_row5_col15" class="data row5 col15">0</td>
<td id="T_137c6_row5_col16" class="data row5 col16">0</td>
<td id="T_137c6_row5_col17" class="data row5 col17">0</td>
</tr>
<tr class="odd">
<td id="T_137c6_level0_row6" class="row_heading level0 row6" data-quarto-table-cell-role="th">6</td>
<td id="T_137c6_row6_col0" class="data row6 col0">0</td>
<td id="T_137c6_row6_col1" class="data row6 col1">0</td>
<td id="T_137c6_row6_col2" class="data row6 col2">0</td>
<td id="T_137c6_row6_col3" class="data row6 col3">0</td>
<td id="T_137c6_row6_col4" class="data row6 col4">0</td>
<td id="T_137c6_row6_col5" class="data row6 col5">0</td>
<td id="T_137c6_row6_col6" class="data row6 col6">0</td>
<td id="T_137c6_row6_col7" class="data row6 col7">0</td>
<td id="T_137c6_row6_col8" class="data row6 col8">0</td>
<td id="T_137c6_row6_col9" class="data row6 col9">0</td>
<td id="T_137c6_row6_col10" class="data row6 col10">249</td>
<td id="T_137c6_row6_col11" class="data row6 col11">253</td>
<td id="T_137c6_row6_col12" class="data row6 col12">245</td>
<td id="T_137c6_row6_col13" class="data row6 col13">126</td>
<td id="T_137c6_row6_col14" class="data row6 col14">0</td>
<td id="T_137c6_row6_col15" class="data row6 col15">0</td>
<td id="T_137c6_row6_col16" class="data row6 col16">0</td>
<td id="T_137c6_row6_col17" class="data row6 col17">0</td>
</tr>
<tr class="even">
<td id="T_137c6_level0_row7" class="row_heading level0 row7" data-quarto-table-cell-role="th">7</td>
<td id="T_137c6_row7_col0" class="data row7 col0">0</td>
<td id="T_137c6_row7_col1" class="data row7 col1">0</td>
<td id="T_137c6_row7_col2" class="data row7 col2">0</td>
<td id="T_137c6_row7_col3" class="data row7 col3">0</td>
<td id="T_137c6_row7_col4" class="data row7 col4">0</td>
<td id="T_137c6_row7_col5" class="data row7 col5">0</td>
<td id="T_137c6_row7_col6" class="data row7 col6">0</td>
<td id="T_137c6_row7_col7" class="data row7 col7">14</td>
<td id="T_137c6_row7_col8" class="data row7 col8">101</td>
<td id="T_137c6_row7_col9" class="data row7 col9">223</td>
<td id="T_137c6_row7_col10" class="data row7 col10">253</td>
<td id="T_137c6_row7_col11" class="data row7 col11">248</td>
<td id="T_137c6_row7_col12" class="data row7 col12">124</td>
<td id="T_137c6_row7_col13" class="data row7 col13">0</td>
<td id="T_137c6_row7_col14" class="data row7 col14">0</td>
<td id="T_137c6_row7_col15" class="data row7 col15">0</td>
<td id="T_137c6_row7_col16" class="data row7 col16">0</td>
<td id="T_137c6_row7_col17" class="data row7 col17">0</td>
</tr>
<tr class="odd">
<td id="T_137c6_level0_row8" class="row_heading level0 row8" data-quarto-table-cell-role="th">8</td>
<td id="T_137c6_row8_col0" class="data row8 col0">0</td>
<td id="T_137c6_row8_col1" class="data row8 col1">0</td>
<td id="T_137c6_row8_col2" class="data row8 col2">0</td>
<td id="T_137c6_row8_col3" class="data row8 col3">0</td>
<td id="T_137c6_row8_col4" class="data row8 col4">0</td>
<td id="T_137c6_row8_col5" class="data row8 col5">11</td>
<td id="T_137c6_row8_col6" class="data row8 col6">166</td>
<td id="T_137c6_row8_col7" class="data row8 col7">239</td>
<td id="T_137c6_row8_col8" class="data row8 col8">253</td>
<td id="T_137c6_row8_col9" class="data row8 col9">253</td>
<td id="T_137c6_row8_col10" class="data row8 col10">253</td>
<td id="T_137c6_row8_col11" class="data row8 col11">187</td>
<td id="T_137c6_row8_col12" class="data row8 col12">30</td>
<td id="T_137c6_row8_col13" class="data row8 col13">0</td>
<td id="T_137c6_row8_col14" class="data row8 col14">0</td>
<td id="T_137c6_row8_col15" class="data row8 col15">0</td>
<td id="T_137c6_row8_col16" class="data row8 col16">0</td>
<td id="T_137c6_row8_col17" class="data row8 col17">0</td>
</tr>
<tr class="even">
<td id="T_137c6_level0_row9" class="row_heading level0 row9" data-quarto-table-cell-role="th">9</td>
<td id="T_137c6_row9_col0" class="data row9 col0">0</td>
<td id="T_137c6_row9_col1" class="data row9 col1">0</td>
<td id="T_137c6_row9_col2" class="data row9 col2">0</td>
<td id="T_137c6_row9_col3" class="data row9 col3">0</td>
<td id="T_137c6_row9_col4" class="data row9 col4">0</td>
<td id="T_137c6_row9_col5" class="data row9 col5">16</td>
<td id="T_137c6_row9_col6" class="data row9 col6">248</td>
<td id="T_137c6_row9_col7" class="data row9 col7">250</td>
<td id="T_137c6_row9_col8" class="data row9 col8">253</td>
<td id="T_137c6_row9_col9" class="data row9 col9">253</td>
<td id="T_137c6_row9_col10" class="data row9 col10">253</td>
<td id="T_137c6_row9_col11" class="data row9 col11">253</td>
<td id="T_137c6_row9_col12" class="data row9 col12">232</td>
<td id="T_137c6_row9_col13" class="data row9 col13">213</td>
<td id="T_137c6_row9_col14" class="data row9 col14">111</td>
<td id="T_137c6_row9_col15" class="data row9 col15">2</td>
<td id="T_137c6_row9_col16" class="data row9 col16">0</td>
<td id="T_137c6_row9_col17" class="data row9 col17">0</td>
</tr>
<tr class="odd">
<td id="T_137c6_level0_row10" class="row_heading level0 row10" data-quarto-table-cell-role="th">10</td>
<td id="T_137c6_row10_col0" class="data row10 col0">0</td>
<td id="T_137c6_row10_col1" class="data row10 col1">0</td>
<td id="T_137c6_row10_col2" class="data row10 col2">0</td>
<td id="T_137c6_row10_col3" class="data row10 col3">0</td>
<td id="T_137c6_row10_col4" class="data row10 col4">0</td>
<td id="T_137c6_row10_col5" class="data row10 col5">0</td>
<td id="T_137c6_row10_col6" class="data row10 col6">0</td>
<td id="T_137c6_row10_col7" class="data row10 col7">43</td>
<td id="T_137c6_row10_col8" class="data row10 col8">98</td>
<td id="T_137c6_row10_col9" class="data row10 col9">98</td>
<td id="T_137c6_row10_col10" class="data row10 col10">208</td>
<td id="T_137c6_row10_col11" class="data row10 col11">253</td>
<td id="T_137c6_row10_col12" class="data row10 col12">253</td>
<td id="T_137c6_row10_col13" class="data row10 col13">253</td>
<td id="T_137c6_row10_col14" class="data row10 col14">253</td>
<td id="T_137c6_row10_col15" class="data row10 col15">187</td>
<td id="T_137c6_row10_col16" class="data row10 col16">22</td>
<td id="T_137c6_row10_col17" class="data row10 col17">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="baseline-model-pixel-similarity" class="level2">
<h2 class="anchored" data-anchor-id="baseline-model-pixel-similarity">Baseline Model: Pixel Similarity</h2>
<p>The problem we’re trying to solve is the following: How do we write a computer program to be able to distinguish between images of handwritten 3 and 7 digits.</p>
<p>The first approach we try is <strong>Pixel Similarity</strong>. The FASTAI book authors define this as the following:</p>
<ol type="1">
<li>Take the average pixel value for every pixel of the 3 images and do the same for the 7 images. These averages will produce a baseline image 3 and image 7.</li>
<li>Go through every image in the 3 and 7 images and compare them to the baseline images to see which digit they are most similar to</li>
</ol>
<div class="cell" data-outputid="8dd68ea9-f83e-4f36-ed73-a006a51b05bb">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a list of tensors for each image in 3 and 7 directories</span></span>
<span id="cb15-2">three_tensors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [tensor(Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(o)) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> threes]</span>
<span id="cb15-3">seven_tensors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [tensor(Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(o)) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> sevens]</span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Number of images in threes: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(threes)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Number of images in three tensors: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(three_tensors)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Number of images in sevens: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sevens)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Number of images in seven tensors: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(seven_tensors)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb15-9"></span>
<span id="cb15-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># verify images</span></span>
<span id="cb15-11">show_image(three_tensors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb15-12">show_image(seven_tensors[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of images in threes: 6131
Number of images in three tensors: 6131
Number of images in sevens: 6265
Number of images in seven tensors: 6265</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-9-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-9-output-4.png" class="img-fluid"></p>
</div>
</div>
<p>The way I understand tensors is that they are data structures for storing information. The way I understand the stack operation is storing all the images into a pile of images that we then then can average all the pixel values for each pixel index in the image.</p>
<div class="cell" data-outputid="76bfe1f5-8ca9-4020-8640-bbf457b140c7">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the average intensity of each pixel across all images for 3 and 7</span></span>
<span id="cb18-2">stacked_sevens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack(seven_tensors).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb18-3">stacked_threes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack(three_tensors).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb18-4"></span>
<span id="cb18-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"stacked_sevens shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stacked_sevens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"stacked_sevens tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(stacked_sevens.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"stacked_threes shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>stacked_threes<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb18-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"stacked_threes tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(stacked_threes.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>stacked_sevens shape: torch.Size([6265, 28, 28])
stacked_sevens tensor rank: 3
stacked_threes shape: torch.Size([6131, 28, 28])
stacked_threes tensor rank: 3</code></pre>
</div>
</div>
<p>In this step, we take the list of tensor images and condense them down into a new image where each pixel index in this new image is the average of all the values at a particular index.</p>
<div class="cell" data-outputid="7ad37063-a0f6-4a2d-b7f5-694d64fa97af">
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Average of all image tensors by taking mean along the 0 dimension (collapse all the rows into a single row) of stacked 3 rank tensors</span></span>
<span id="cb20-2">mean3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_threes.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-3">mean7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_sevens.mean(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb20-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"mean3 shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mean3<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb20-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"mean3 tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(mean3.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb20-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"mean7 shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mean7<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb20-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"mean7 tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(mean7.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb20-8">show_image(mean3)</span>
<span id="cb20-9">show_image(mean7)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>mean3 shape: torch.Size([28, 28])
mean3 tensor rank: 2
mean7 shape: torch.Size([28, 28])
mean7 tensor rank: 2</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="74">
<pre><code>&lt;Axes: &gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-11-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-11-output-4.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="measuring-distance" class="level2">
<h2 class="anchored" data-anchor-id="measuring-distance">Measuring Distance</h2>
<p>To compare the baseline image with a randomly chosen image from one of the datasets we need to measure the difference between pixels such that we have a standardized form so that the differences accurately reflect what pixels are dark and light when comparing the two images.</p>
<div class="cell" data-outputid="fc253ecb-1eb9-43c7-d14b-fcc6683403bd">
<div class="sourceCode cell-code" id="cb23" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean Absolute Difference (L1 Norm)</span></span>
<span id="cb23-2">a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_threes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb23-3">a_7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_sevens[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb23-4"></span>
<span id="cb23-5">dist_3_abs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean3).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().mean()</span>
<span id="cb23-6">dist_7_abs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (a_7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean7).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().mean()</span>
<span id="cb23-7"></span>
<span id="cb23-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Mean Absolute Difference between 3 image and ideal 3 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dist_3_abs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb23-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Mean Absolute Difference between 7 image and ideal 7 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dist_7_abs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb23-10"></span>
<span id="cb23-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># see how close 3 is to ideal 7</span></span>
<span id="cb23-12">dist_test_abs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean7).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().mean()</span>
<span id="cb23-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Mean Absolute Difference between 3 image and ideal 7 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dist_test_abs<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean Absolute Difference between 3 image and ideal 3 image: 0.11143654584884644
Mean Absolute Difference between 7 image and ideal 7 image: 0.13037648797035217
Mean Absolute Difference between 3 image and ideal 7 image: 0.15861910581588745</code></pre>
</div>
</div>
<div class="cell" data-outputid="e92b7fd3-7510-4729-b26c-bc7a41b4a1bc">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Root Mean Squared Error (L2 Norm)</span></span>
<span id="cb25-2">a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_threes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb25-3">a_7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> stacked_sevens[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb25-4"></span>
<span id="cb25-5">dist_3_sqr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean3)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean().sqrt()</span>
<span id="cb25-6">dist_7_sqr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((a_7 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean7)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean().sqrt()</span>
<span id="cb25-7">dist_test_sqr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((a_3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean7)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean().sqrt()</span>
<span id="cb25-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Root Mean Squared Difference between 3 image and ideal 3 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dist_3_sqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Root Mean Squared Difference between 7 image and ideal 7 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dist_7_sqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb25-10"></span>
<span id="cb25-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># see how close 3 is to ideal 7</span></span>
<span id="cb25-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Root Mean Squared Difference between 3 image and ideal 7 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>dist_test_sqr<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Root Mean Squared Difference between 3 image and ideal 3 image: 0.20208320021629333
Root Mean Squared Difference between 7 image and ideal 7 image: 0.2584923207759857
Root Mean Squared Difference between 3 image and ideal 7 image: 0.30210891366004944</code></pre>
</div>
</div>
<div class="cell" data-outputid="633c8a1f-9d87-415d-da64-0b4118a4f938">
<div class="sourceCode cell-code" id="cb27" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pytorch Mean Squared Error and Mean Absolute Value Loss</span></span>
<span id="cb27-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Pytorch Mean Absolute Value Loss between 3 image and ideal 7 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>F<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>l1_loss(a_3.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(), mean7)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb27-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Pytorch Mean Squared Error Loss between 3 image and ideal 7 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>F<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mse_loss(a_3, mean7)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>sqrt()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Pytorch Mean Absolute Value Loss between 3 image and ideal 7 image: 0.15861910581588745
Pytorch Mean Squared Error Loss between 3 image and ideal 7 image: 0.30210891366004944</code></pre>
</div>
</div>
</section>
<section id="pytorch-numpy" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-numpy">Pytorch + Numpy</h2>
<p>The main difference between pytorch and numpy is that pytorch supports using the GPU and calculating gradients which numpy does not.</p>
<div class="cell" data-outputid="319b5123-edad-46ca-f72b-fb33d5753eb1">
<div class="sourceCode cell-code" id="cb29" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1">data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>]]</span>
<span id="cb29-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># numpy array</span></span>
<span id="cb29-3">arr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> array(data)</span>
<span id="cb29-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tensor</span></span>
<span id="cb29-5">tns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor(data)</span>
<span id="cb29-6"></span>
<span id="cb29-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># select a row</span></span>
<span id="cb29-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"select the second row of tensor: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tns[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb29-9"></span>
<span id="cb29-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># select a column</span></span>
<span id="cb29-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"select the second column of tensor: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tns[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb29-12"></span>
<span id="cb29-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># slicing</span></span>
<span id="cb29-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"select slice of tensor: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tns[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb29-15"></span>
<span id="cb29-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># addition</span></span>
<span id="cb29-17"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Addition with tensors: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb29-18"></span>
<span id="cb29-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># types</span></span>
<span id="cb29-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"tensor type: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tns<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb29-21"></span>
<span id="cb29-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scale and update tensor type</span></span>
<span id="cb29-23"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"changing tensor type from int to float: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tns <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>select the second row of tensor: tensor([4, 5, 6])
select the second column of tensor: tensor([[1, 2, 3]])
select slice of tensor: tensor([5, 6])
Addition with tensors: tensor([[2, 3, 4],
        [5, 6, 7]])
tensor type: torch.LongTensor
changing tensor type from int to float: tensor([[1.5000, 3.0000, 4.5000],
        [6.0000, 7.5000, 9.0000]])</code></pre>
</div>
</div>
</section>
<section id="computing-metrics" class="level2">
<h2 class="anchored" data-anchor-id="computing-metrics">Computing Metrics</h2>
<p>A metric is a number that is calculated based on the predictions of the model and the correct labels and inform us how good the model is. For classification models, <strong>accuracy</strong> is a popular metric.</p>
<div class="cell" data-outputid="5f5a6f60-f33b-4241-d116-ad060993cf35">
<div class="sourceCode cell-code" id="cb31" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># create validation data set</span></span>
<span id="cb31-2">valid_3_tens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack([tensor(Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(o))</span>
<span id="cb31-3">                            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'valid'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'3'</span>).ls()])</span>
<span id="cb31-4">valid_3_tens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> valid_3_tens.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb31-5">valid_7_tens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack([tensor(Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(o))</span>
<span id="cb31-6">                            <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'valid'</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'7'</span>).ls()])</span>
<span id="cb31-7">valid_7_tens <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> valid_7_tens.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">255</span></span>
<span id="cb31-8"></span>
<span id="cb31-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"3 validation set shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>valid_3_tens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"3 validation set tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_3_tens.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"7 validation set shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>valid_7_tens<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb31-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"7 validation set tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_7_tens.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>3 validation set shape: torch.Size([1010, 28, 28])
3 validation set tensor rank: 3
7 validation set shape: torch.Size([1028, 28, 28])
7 validation set tensor rank: 3</code></pre>
</div>
</div>
<div class="cell" data-outputid="3429b680-3ec6-497c-a0de-be5911c73e1e">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># MNIST Data Distance Function</span></span>
<span id="cb33-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> mnist_distance(a, b):</span>
<span id="cb33-3">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (-1, -2) represent a range of axes. Tell Pytorch to take the mean ranging over the values</span></span>
<span id="cb33-4">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># indexed by the last two axes of the tensor (horizontal and vertical dimensions of the image)</span></span>
<span id="cb33-5">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># leaves only the first tensor axis which indexes over images and the final size -&gt; averaged the intensity of all the pixels</span></span>
<span id="cb33-6">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># in the image</span></span>
<span id="cb33-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> b).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>().mean((<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb33-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Distance function measuring the distance between 3 image and ideal 3 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mnist_distance(a_3, mean3)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-9"></span>
<span id="cb33-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># measure distance between validation set 3 and ideal 3 tensor</span></span>
<span id="cb33-11">valid_3_dist <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mnist_distance(valid_3_tens, mean3)</span>
<span id="cb33-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Distance between validation set 3 image and ideal training data set 3 image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>valid_3_dist<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Valid 3 distance tensor shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>valid_3_dist<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb33-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Valid 3 distance tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_3_dist.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Distance function measuring the distance between 3 image and ideal 3 image: 0.11143654584884644
Distance between validation set 3 image and ideal training data set 3 image: tensor([0.1663, 0.1148, 0.1325,  ..., 0.1173, 0.1100, 0.1460])
Valid 3 distance tensor shape: torch.Size([1010])
Valid 3 distance tensor rank: 1</code></pre>
</div>
</div>
<div class="cell" data-outputid="37d8ba1b-b911-45a9-bf29-928df0e61eeb">
<div class="sourceCode cell-code" id="cb35" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check if image is a 3</span></span>
<span id="cb35-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> is_3(x):</span>
<span id="cb35-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> mnist_distance(x, mean3) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> mnist_distance(x, mean7)</span>
<span id="cb35-4"></span>
<span id="cb35-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Check if 3 image is actually a 3 image as a boolean: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_3(a_3)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb35-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1.0 - true</span></span>
<span id="cb35-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 0.0 - false</span></span>
<span id="cb35-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Check if 3 image is actually a 3 image as a float: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_3(a_3)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb35-9"></span>
<span id="cb35-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check all 3 images</span></span>
<span id="cb35-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"check if all 3 images in validation set are 3 images: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_3(valid_3_tens)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Check if 3 image is actually a 3 image as a boolean: True
Check if 3 image is actually a 3 image as a float: 1.0
check if all 3 images in validation set are 3 images: tensor([False,  True,  True,  ...,  True,  True,  True])</code></pre>
</div>
</div>
<div class="cell" data-outputid="09617ac9-2f4f-4de7-dee9-0f7a38f0cf4a">
<div class="sourceCode cell-code" id="cb37" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute Accuracy of 3 and 7 Images</span></span>
<span id="cb37-2">accuracy_3s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> is_3(valid_3_tens).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() .mean()</span>
<span id="cb37-3">accuracy_7s <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> is_3(valid_7_tens).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()).mean()</span>
<span id="cb37-4"></span>
<span id="cb37-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Model accuracy for classifying 3 images: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>accuracy_3s<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb37-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Model accuracy for classifying 7 images: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>accuracy_7s<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb37-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Average model accuracy for classifying 3 and 7 images: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>(accuracy_3s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>accuracy_7s)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model accuracy for classifying 3 images: 0.9168316721916199
Model accuracy for classifying 7 images: 0.9854085445404053
Average model accuracy for classifying 3 and 7 images: 0.951120138168335</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for plotting</span></span>
<span id="cb39-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> ipywidgets <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> interact</span>
<span id="cb39-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.basics <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb39-4"></span>
<span id="cb39-5">plt.rc(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'figure'</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">90</span>)</span>
<span id="cb39-6"></span>
<span id="cb39-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> plot_function(f, title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.1</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'r'</span>, ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb39-8">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>,<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb39-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ylim: plt.ylim(ylim)</span>
<span id="cb39-10">    plt.plot(x, f(x), color)</span>
<span id="cb39-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> title <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">not</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>: plt.title(title)</span></code></pre></div>
</div>
</section>
<section id="fit-a-function-with-gradient-descent" class="level2">
<h2 class="anchored" data-anchor-id="fit-a-function-with-gradient-descent">Fit a Function with Gradient Descent</h2>
<ul>
<li>A neural network can be thought of as a mathematical function</li>
<li>A simple neural network does the following things:</li>
</ul>
<ol type="1">
<li>Multiplies each input by a number of values(parameters).</li>
<li>Sums up results for each group values</li>
<li>Replaces the negative numbers with zeroes</li>
</ol>
<ul>
<li>These steps define a single layer. The three steps are repeated using the outputs of the previous layer as inputs to the next layer. The initial parameters are selected randomly</li>
</ul>
<div class="cell" data-outputid="2fec0b7f-55b3-4d03-a46c-2e27d6c82ebc">
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quadratic Function</span></span>
<span id="cb40-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - The quadratic function below is the one we are trying to fit(approximate)</span></span>
<span id="cb40-3"></span>
<span id="cb40-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f(x):</span>
<span id="cb40-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb40-6">plot_function(f, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"$3x^2 + 2x + 1$"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-21-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># General Quadratic Function</span></span>
<span id="cb41-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> quad(a, b, c, x):</span>
<span id="cb41-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c</span></code></pre></div>
</div>
<div class="cell" data-outputid="1149e92d-dc05-4838-9535-941b19bb698d">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to make quadratic functions</span></span>
<span id="cb42-2"></span>
<span id="cb42-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># partial allows for fixing particular values</span></span>
<span id="cb42-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> functools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> partial</span>
<span id="cb42-5"></span>
<span id="cb42-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> mk_quad(a, b, c):</span>
<span id="cb42-7">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> partial(quad, a, b, c)</span>
<span id="cb42-8"></span>
<span id="cb42-9">f2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mk_quad(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb42-10"></span>
<span id="cb42-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test partial and quadratic</span></span>
<span id="cb42-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Quadtratic Function: f(10.5) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.5</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb42-13"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"General Quadratic Function: f(10.5) = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>f2(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">10.5</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Quadtratic Function: f(10.5) = 352.75
General Quadratic Function: f(10.5) = 352.75</code></pre>
</div>
</div>
<div class="cell" data-outputid="90a79aa2-772d-4166-adce-fb1e5bf5e1b2">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Test and plot quadratic function using make quad function</span></span>
<span id="cb44-2">f2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mk_quad(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb44-3">plot_function(f2)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-24-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Simulate noisy measurements of quadratic function f</span></span>
<span id="cb45-2"></span>
<span id="cb45-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># noisy data generation functions</span></span>
<span id="cb45-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> noise(x, scale):</span>
<span id="cb45-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> np.random.normal(scale<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>scale, size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>x.shape)</span>
<span id="cb45-6"></span>
<span id="cb45-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> add_noise(x, mult, add):</span>
<span id="cb45-8">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise(x, mult)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise(x,add)</span></code></pre></div>
</div>
<div class="cell" data-outputid="e76e47e6-0c6f-47a6-a231-280bd3ea2b75">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create noisy data based on the the quadratic function f(x)</span></span>
<span id="cb46-2">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb46-3"></span>
<span id="cb46-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)[:,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>]</span>
<span id="cb46-5">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> add_noise(f(x), <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.15</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span>
<span id="cb46-6"></span>
<span id="cb46-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"First 5 x values: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>x[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb46-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"First 5 y values: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>First 5 x values: tensor([[-2.0000],
        [-1.7895],
        [-1.5789],
        [-1.3684],
        [-1.1579]])
First 5 y values: tensor([[11.8690],
        [ 6.5433],
        [ 5.9396],
        [ 2.6304],
        [ 1.7947]], dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell" data-outputid="417354cc-00ac-405b-929f-b671294519f5">
<div class="sourceCode cell-code" id="cb48" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot noisy data</span></span>
<span id="cb48-2">plt.scatter(x, y)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="90">
<pre><code>&lt;matplotlib.collections.PathCollection at 0x78344829a260&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-27-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="fb34c085-3682-4762-d3f8-f7ac6e1ad7bd">
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find a, b, c values that create a function that fits noisy data</span></span>
<span id="cb50-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@interact</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>)</span>
<span id="cb50-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> plot_quad(a, b, c):</span>
<span id="cb50-4">  plt.scatter(x, y)</span>
<span id="cb50-5">  plot_function(mk_quad(a,b,c), ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">13</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-28-output-1.png" class="img-fluid"></p>
</div>
</div>
<section id="metric-loss-function" class="level3">
<h3 class="anchored" data-anchor-id="metric-loss-function">Metric (Loss Function)</h3>
<ul>
<li>numerical way of measuring whether function is fitting data better or worse</li>
<li>Mean Absolute Error (MAE) is a <code>metric</code> that measures the distance from each data point to the curve</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb51" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> mae(preds, acts):</span>
<span id="cb51-2">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> acts)).mean()</span></code></pre></div>
</div>
<div class="cell" data-outputid="05db1cd0-637c-4d94-a82e-3b7444fa674f">
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Find a, b, c values that create a function that fits noisy data using metrics</span></span>
<span id="cb52-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@interact</span>(a<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, c<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>)</span>
<span id="cb52-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> plot_quad(a, b, c):</span>
<span id="cb52-4">    f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mk_quad(a,b,c)</span>
<span id="cb52-5">    plt.scatter(x,y)</span>
<span id="cb52-6">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mae(f(x), y)</span>
<span id="cb52-7">    plot_function(f, ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>), title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"MAE: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-30-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="automating-gradient-descent" class="level3">
<h3 class="anchored" data-anchor-id="automating-gradient-descent">Automating Gradient Descent</h3>
<ul>
<li><p>Calculus can be used to determine how much each neural network parameter should be increased or decreased to fit the data using the derivative(gradient).</p></li>
<li><p>Given the gradient of the <code>mean absolute error</code> with respect to parameters <code>a</code>, <code>b</code>, <code>c</code> then we know how adjusting a parameters such as <code>a</code> will change the value of the <code>mean absolute error</code></p></li>
<li><p>If a paramaeter has a <em>negative gradient</em> then <code>increasing</code> the parameter will <code>decrease</code> the <code>mean absolute error</code></p></li>
<li><p>Goal is to <code>minimize</code> the value of the metric function we use for the <code>loss function</code>.</p></li>
</ul>
<p><strong>Steps</strong>: 1. Find the gradient of MAE for each parameter 2. Adjust parameters a bit in the opposite direction to the sign of the gradient</p>
<div class="cell" data-outputid="3e0ada2f-c5f1-4660-bcce-2a580be4ef33">
<div class="sourceCode cell-code" id="cb53" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function for generating MAE for quadratic functions</span></span>
<span id="cb53-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> quad_mae(params):</span>
<span id="cb53-3">  f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mk_quad(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>params)</span>
<span id="cb53-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> mae(f(x), y)</span>
<span id="cb53-5"></span>
<span id="cb53-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test quad_mae</span></span>
<span id="cb53-7">quad_mae([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>])</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>tensor(2.4219, dtype=torch.float64)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># starting vector containing arbitrary position</span></span>
<span id="cb55-2">abc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.1</span>])</span></code></pre></div>
</div>
<div class="cell" data-outputid="1f3e659d-ffbd-4b13-f9c7-8abfa78f58f1">
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># tell pytorch to calculate gradient for parameters</span></span>
<span id="cb56-2">abc.requires_grad_()</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>tensor([1.1000, 1.1000, 1.1000], requires_grad=True)</code></pre>
</div>
</div>
<div class="cell" data-outputid="d5adc5fc-c17e-4a62-8046-9325276a3009">
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate MAE</span></span>
<span id="cb58-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - When doing gradient descent we are trying to minimize the metric which is called the loss</span></span>
<span id="cb58-3">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quad_mae(abc)</span>
<span id="cb58-4">loss</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>tensor(2.4219, dtype=torch.float64, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># calculate gradients</span></span>
<span id="cb60-2">loss.backward()</span></code></pre></div>
</div>
<div class="cell" data-outputid="e4ae5b4b-29f1-4607-8aab-ca23b58a2d65">
<div class="sourceCode cell-code" id="cb61" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># gradients with respect to each parameter (a, b, c)</span></span>
<span id="cb61-2">abc.grad</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>tensor([-1.3529, -0.0316, -0.5000])</code></pre>
</div>
</div>
<div class="cell" data-outputid="29f93f9d-106f-4628-b777-b34cfaafccc8">
<div class="sourceCode cell-code" id="cb63" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - gradients are a bit low -&gt; increase gradients a little bit will decrease loss</span></span>
<span id="cb63-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - update abc vector by decreasing it by gradient * learning rate</span></span>
<span id="cb63-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - torch.no_grad turns of gradient calculation when we update the vector since</span></span>
<span id="cb63-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># abc -= abc.grad * learning rate is not part of quadtratic function model and we</span></span>
<span id="cb63-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># do not want the derivatives to include that calculation</span></span>
<span id="cb63-6"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb63-7">    abc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> abc.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb63-8">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quad_mae(abc)</span>
<span id="cb63-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'loss=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>loss=2.40</code></pre>
</div>
</div>
<div class="cell" data-outputid="d28a0e4a-b33c-40c1-cda5-66694dd2b677">
<div class="sourceCode cell-code" id="cb65" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute loss for 10 iterations</span></span>
<span id="cb65-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb65-3">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> quad_mae(abc)</span>
<span id="cb65-4">    loss.backward()</span>
<span id="cb65-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb65-6">      abc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> abc.grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span></span>
<span id="cb65-7">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'step=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">; loss=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>step=0; loss=2.40
step=1; loss=2.36
step=2; loss=2.30
step=3; loss=2.21
step=4; loss=2.11
step=5; loss=1.98
step=6; loss=1.85
step=7; loss=1.72
step=8; loss=1.58
step=9; loss=1.46</code></pre>
</div>
</div>
</section>
<section id="neural-network" class="level3">
<h3 class="anchored" data-anchor-id="neural-network">Neural Network</h3>
<ul>
<li>Neural Networks can approximate any computable function given enough parameters</li>
<li>A comptuable function covers any type of problem</li>
<li>Neural Networks approximate a function using the following steps:</li>
</ul>
<ol type="1">
<li>Matrix multiplication - multiply things together and add them up</li>
<li>The function max(x, 0) which replaces all negative numbers with 0</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb67" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - f(x) = max(x, 0) is represented as torch.clip(x, 0)</span></span>
<span id="cb67-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> rectified_linear(m, b, x):</span>
<span id="cb67-3">  y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> b</span>
<span id="cb67-4">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.clip(y, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="f9f5be71-4f41-48c0-c411-fc64027dab90">
<div class="sourceCode cell-code" id="cb68" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot rectified linear</span></span>
<span id="cb68-2">plot_function(partial(rectified_linear, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-40-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="b6763fa7-4c32-4036-9458-e5624d475acc">
<div class="sourceCode cell-code" id="cb69" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot rectified linear using pytorch RELU function</span></span>
<span id="cb69-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb69-3"></span>
<span id="cb69-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> rectified_linear2(m,b,x):</span>
<span id="cb69-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> F.relu(m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>b)</span>
<span id="cb69-6"></span>
<span id="cb69-7">plot_function(partial(rectified_linear2, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="06a80fb5-3e90-4afb-e560-23d5e50631c2">
<div class="sourceCode cell-code" id="cb70" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># interactive relu</span></span>
<span id="cb70-2"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@interact</span>(m<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span>
<span id="cb70-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> plot_relu(m, b):</span>
<span id="cb70-4">    plot_function(partial(rectified_linear, m,b), ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-42-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="0ee97a9c-e34c-4301-aad7-5e42bcf889fc">
<div class="sourceCode cell-code" id="cb71" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine RELUs</span></span>
<span id="cb71-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> double_relu(m1,b1,m2,b2,x):</span>
<span id="cb71-3">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> rectified_linear(m1,b1,x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> rectified_linear(m2,b2,x)</span>
<span id="cb71-4"></span>
<span id="cb71-5"><span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@interact</span>(m1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, b1<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, m2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>, b2<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span>)</span>
<span id="cb71-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> plot_double_relu(m1, b1, m2, b2):</span>
<span id="cb71-7">    plot_function(partial(double_relu, m1,b1,m2,b2), ylim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-43-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="stochastic-gradient-descent" class="level2">
<h2 class="anchored" data-anchor-id="stochastic-gradient-descent">Stochastic Gradient Descent</h2>
<p>In the <strong>Pixel Similarity</strong> approach from above, we don’t have a way for the model to learn and improve its accuracy. Instead of trying to compare an image with an ideal image, we can use <strong>Stochastic Gradient Descent (SGD)</strong> to look at each individual pixel and come up with a set of weights with large weights associated with pixels that are the most black for a particular label (ie. digit in MNIST data) using Arthur Samuel’s definition of machine learning</p>
<section id="stochastic-gradient-descent-steps-for-an-image-classifier" class="level3">
<h3 class="anchored" data-anchor-id="stochastic-gradient-descent-steps-for-an-image-classifier">Stochastic Gradient Descent Steps for an Image Classifier</h3>
<ol type="1">
<li>initialize weights</li>
<li>Calculate Predictions</li>
<li>Based on the predictions, calculate how good the model is (its loss)</li>
<li>Calculate the gradient which measures for each weight, how changing that weight would change the loss</li>
<li>Step (change) all the weights based on Step 4</li>
<li>Go back to Step 2 and repeat the process</li>
<li>Iterate until you decide to stop the training process until you decide the model is good enough for your problem</li>
</ol>
<p>The problem below is an example from the FastAI Book simulating a roller coaster and trying to find a function that best fits the data to understand how speed changes over time. There has been some discussion on the FastAI discord and forums about the loss value being too high (see <a href="https://forums.fast.ai/t/04-mnist-basics-some-questions-about-sgd/85431">Chapter 4 SGD Discussion</a>) because of the data not being centered similar to the way Jeremy centered the Titantic data in Lesson 5. The book examples are slightly older and different from how the 2022 FastAI course is running so I’d recommend going over the course notebook examples first and then checking the relevant book chapters mentioned.</p>
<div class="cell" data-outputid="d6304288-54af-47cc-91d9-b39d69e44d8b">
<div class="sourceCode cell-code" id="cb72" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Roller Coaster Problem with Stochastic Gradient Descent</span></span>
<span id="cb72-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># generate data</span></span>
<span id="cb72-3">time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()</span>
<span id="cb72-4">speed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.75</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (time <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">9.5</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb72-5">plt.scatter(time,speed)</span>
<span id="cb72-6"></span>
<span id="cb72-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use SGD to find a function that fits the data for the rollercoaster data</span></span>
<span id="cb72-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># t - the time when we are measuring the rollercoaster speed</span></span>
<span id="cb72-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># params - the values that define which quadratic we're trying</span></span>
<span id="cb72-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> f(t, params):</span>
<span id="cb72-11">    a,b,c <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb72-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> c</span>
<span id="cb72-13"></span>
<span id="cb72-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a loss function - returns a value based on a prediction and a target</span></span>
<span id="cb72-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># where lower values of the functions correspond to better predictions. Need</span></span>
<span id="cb72-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  loss function to return lower values when predictions are more accurate, as</span></span>
<span id="cb72-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  SGD is trying to minimize this loss. For continuous data, Mean Square Error is</span></span>
<span id="cb72-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  frequently used</span></span>
<span id="cb72-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> mse(preds, targets):</span>
<span id="cb72-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> ((preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>targets)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).mean()</span>
<span id="cb72-21"></span>
<span id="cb72-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># SGD Process</span></span>
<span id="cb72-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for visualizing how close our predictions are to targets</span></span>
<span id="cb72-24"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> show_preds(preds, ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>):</span>
<span id="cb72-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>: ax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>plt.subplots()[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb72-26">    ax.scatter(time, speed)</span>
<span id="cb72-27">    ax.scatter(time, to_np(preds), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>)</span>
<span id="cb72-28">    ax.set_ylim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb72-29"></span>
<span id="cb72-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. initialize weights</span></span>
<span id="cb72-31">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>).requires_grad_()</span>
<span id="cb72-32"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The parameter values after initialization: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb72-33">orig_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params.clone()</span>
<span id="cb72-34"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The original parameters: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>orig_params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb72-35"></span>
<span id="cb72-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Calculate Predictions</span></span>
<span id="cb72-37">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(time, params)</span>
<span id="cb72-38">show_preds(preds)</span>
<span id="cb72-39"></span>
<span id="cb72-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. Based on the predictions, calculate how good the model is (its loss)</span></span>
<span id="cb72-41">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mse(preds, speed)</span>
<span id="cb72-42"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Loss value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb72-43"></span>
<span id="cb72-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. Calculate the gradient which measures for each weight, how changing that weight would change the loss</span></span>
<span id="cb72-45">loss.backward()</span>
<span id="cb72-46"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Gradient values for each argument: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>grad<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb72-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate approximation of how parameters need to change</span></span>
<span id="cb72-48"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Test a new gradient with a learning rate of 1e^-5: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb72-49"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Parameter values after computing the gradient: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>params<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb72-50"></span>
<span id="cb72-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5. Step (change) all the weights based on Step 4</span></span>
<span id="cb72-52">learning_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span></span>
<span id="cb72-53">params.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> learning_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> params.grad.data</span>
<span id="cb72-54">params.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb72-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if loss has improved</span></span>
<span id="cb72-56">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(time, params)</span>
<span id="cb72-57">mse(preds, speed)</span>
<span id="cb72-58">show_preds(preds)</span>
<span id="cb72-59"></span>
<span id="cb72-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 6. Go back to Step 2 and repeat the process</span></span>
<span id="cb72-61"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> apply_step(params, prn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb72-62">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> f(time, params)</span>
<span id="cb72-63">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mse(preds, speed)</span>
<span id="cb72-64">    loss.backward()</span>
<span id="cb72-65">    params.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> learning_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> params.grad.data</span>
<span id="cb72-66">    params.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span>
<span id="cb72-67">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> prn:</span>
<span id="cb72-68">      <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Loss Value: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb72-69">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> preds</span>
<span id="cb72-70"></span>
<span id="cb72-71"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb72-72">  apply_step(params)</span>
<span id="cb72-73">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> orig_params.detach().requires_grad_()</span>
<span id="cb72-74"></span>
<span id="cb72-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 7. Iterate until you decide to stop the training process until you decide the model is good enough for your problem</span></span>
<span id="cb72-76">_,axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>,figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb72-77"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> ax <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> axs: show_preds(apply_step(params, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>), ax)</span>
<span id="cb72-78">plt.tight_layout()</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>The parameter values after initialization: tensor([-1.7438,  0.5342, -0.5521], requires_grad=True)
The original parameters: tensor([-1.7438,  0.5342, -0.5521], grad_fn=&lt;CloneBackward0&gt;)
Loss value: 97225.4375
Gradient values for each argument: tensor([-104254.5703,   -6678.1953,    -473.9090])
Test a new gradient with a learning rate of 1e^-5: tensor([-1.0425, -0.0668, -0.0047])
Parameter values after computing the gradient: tensor([-1.7438,  0.5342, -0.5521], requires_grad=True)
Loss Value: 18918.27734375
Loss Value: 4100.1640625
Loss Value: 1296.121337890625
Loss Value: 765.5072631835938
Loss Value: 665.0955810546875
Loss Value: 646.0914306640625
Loss Value: 642.4918823242188
Loss Value: 641.8074951171875
Loss Value: 641.6746215820312
Loss Value: 641.6461791992188</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-44-output-2.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-44-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-44-output-4.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-44-output-5.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="building-the-mnist-image-classifier" class="level2">
<h2 class="anchored" data-anchor-id="building-the-mnist-image-classifier">Building the MNIST Image Classifier</h2>
<section id="training-dataset" class="level3">
<h3 class="anchored" data-anchor-id="training-dataset">Training Dataset</h3>
<div class="cell" data-outputid="145ff788-d550-4c48-a32c-dd2614daf596">
<div class="sourceCode cell-code" id="cb74" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build Training Dataset</span></span>
<span id="cb74-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># -1 view function -&gt; make this axis as big as necessary to fit all the data</span></span>
<span id="cb74-3">train_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat([stacked_threes, stacked_sevens]).view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>)</span>
<span id="cb74-4">train_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(threes) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(sevens)).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb74-5"></span>
<span id="cb74-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"train_x data shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>train_x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb74-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"train_x data tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(train_x.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb74-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"train_y data shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>train_y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb74-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"train_y data tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(train_y.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>train_x data shape: torch.Size([12396, 784])
train_x data tensor rank: 2
train_y data shape: torch.Size([12396, 1])
train_y data tensor rank: 2</code></pre>
</div>
</div>
</section>
<section id="validation-dataset" class="level3">
<h3 class="anchored" data-anchor-id="validation-dataset">Validation Dataset</h3>
<div class="cell" data-outputid="d05d5deb-cc87-4c69-8a6b-d3ea23b4ab2e">
<div class="sourceCode cell-code" id="cb76" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build Validation Dataset</span></span>
<span id="cb76-2">valid_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat([valid_3_tens, valid_7_tens]).view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>)</span>
<span id="cb76-3">valid_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_3_tens) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_7_tens)).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb76-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"valid_x data shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>valid_x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb76-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"valid_x data tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_x.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb76-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"valid_y data shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>valid_y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb76-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"valid_y data tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(valid_y.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>valid_x data shape: torch.Size([2038, 784])
valid_x data tensor rank: 2
valid_y data shape: torch.Size([2038, 1])
valid_y data tensor rank: 2</code></pre>
</div>
</div>
<div class="cell" data-outputid="b92ae766-1989-4350-c0ac-34f176fd705e">
<div class="sourceCode cell-code" id="cb78" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build a Dataset object(training data) for PyTorch</span></span>
<span id="cb78-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dataset is required to return a tuple of (x, y) when indexed</span></span>
<span id="cb78-3">dset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(train_x,train_y))</span>
<span id="cb78-4">x,y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dset[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb78-5"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"datset x shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>x<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb78-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"dataset x tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb78-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"datset y shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb78-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"dataset y tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(y.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>datset x shape: torch.Size([784])
dataset x tensor rank: 1
datset y shape: torch.Size([1])
dataset y tensor rank: 1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build a Dataset object(validation data) for PyTorch</span></span>
<span id="cb80-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dataset is required to return a tuple of (x, y) when indexed</span></span>
<span id="cb80-3">valid_dset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">zip</span>(valid_x,valid_y))</span></code></pre></div>
</div>
</section>
<section id="initialize-model-weights" class="level3">
<h3 class="anchored" data-anchor-id="initialize-model-weights">Initialize Model Weights</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb81" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize model weights</span></span>
<span id="cb81-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> init_params(size, std<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>):</span>
<span id="cb81-3">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> (torch.randn(size)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>std).requires_grad_()</span>
<span id="cb81-4"></span>
<span id="cb81-5">weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb81-6"></span>
<span id="cb81-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize a Bias Value</span></span>
<span id="cb81-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need a bias to ensure its not 0 when the pixels are 0</span></span>
<span id="cb81-9">bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="edf26a79-06ec-45e9-b83e-5f92d4b35629">
<div class="sourceCode cell-code" id="cb82" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate a prediction for one image</span></span>
<span id="cb82-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Prediction for a single image from training data: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>(train_x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>weights.T)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bias<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Prediction for a single image from training data: tensor([14.6702], grad_fn=&lt;AddBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="linear-classifier" class="level3">
<h3 class="anchored" data-anchor-id="linear-classifier">Linear Classifier</h3>
<div class="cell" data-outputid="b3406ca3-3c00-4a51-eb90-500ac6718168">
<div class="sourceCode cell-code" id="cb84" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Matrix Multiplication</span></span>
<span id="cb84-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#  Create a linear combination for the prediction values</span></span>
<span id="cb84-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># compute predictions for all the images in the training data</span></span>
<span id="cb84-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> linear1(xb):</span>
<span id="cb84-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> xb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span>weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bias</span>
<span id="cb84-6">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> linear1(train_x)</span>
<span id="cb84-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Predictions"</span>)</span>
<span id="cb84-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(preds)</span>
<span id="cb84-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Prediction shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>preds<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb84-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Prediction tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(preds.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Predictions
tensor([[14.6702],
        [23.8813],
        [21.2188],
        ...,
        [ 5.4375],
        [ 9.9480],
        [ 3.1540]], grad_fn=&lt;AddBackward0&gt;)
Prediction shape: torch.Size([12396, 1])
Prediction tensor rank: 2</code></pre>
</div>
</div>
<div class="cell" data-outputid="e2ed2756-27e5-4be9-82e0-c4914c1c310b">
<div class="sourceCode cell-code" id="cb86" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check accuracy of prediction</span></span>
<span id="cb86-2">corrects <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> train_y</span>
<span id="cb86-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Accuracy of Predictions: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>corrects<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb86-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Average accuracy of all predictions: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>corrects<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy of Predictions: tensor([[ True],
        [ True],
        [ True],
        ...,
        [False],
        [False],
        [False]])
Average accuracy of all predictions: 0.5291222929954529</code></pre>
</div>
</div>
<div class="cell" data-outputid="8c911a78-4c82-4c70-c90a-0ade8f5c542b">
<div class="sourceCode cell-code" id="cb88" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Improve Accuracy</span></span>
<span id="cb88-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># test to see if we can improve accuracy with a small change</span></span>
<span id="cb88-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb88-4">  weights[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0001</span></span>
<span id="cb88-5">preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> linear1(train_x)</span>
<span id="cb88-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Average accuracy after updating the weights: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>((preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> train_y)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb88-7"></span>
<span id="cb88-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># there is no change because the change in weights is so small that (y_new - y_old) is very close to 0 ie.</span></span>
<span id="cb88-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the gradient is almost 0 everywhere</span></span>
<span id="cb88-10"></span>
<span id="cb88-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to find a loss function which when our weights result in slightly better predictions produces a slightly better loss</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Average accuracy after updating the weights: 0.5291222929954529</code></pre>
</div>
</div>
</section>
<section id="loss-function" class="level3">
<h3 class="anchored" data-anchor-id="loss-function">Loss Function</h3>
<div class="cell" data-outputid="f3290120-04ff-4e6b-ea06-6c7e8e381225">
<div class="sourceCode cell-code" id="cb90" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb90-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build a Loss Function</span></span>
<span id="cb90-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss function receive predictions from the model about the images</span></span>
<span id="cb90-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># the purpose of the loss function is to measure the difference between predicted values and true values ie the labels</span></span>
<span id="cb90-4">trgts  <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb90-5">prds   <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.9</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.4</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>])</span>
<span id="cb90-6"></span>
<span id="cb90-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># first attempt at a loss function</span></span>
<span id="cb90-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> mnist_loss(predictions, targets):</span>
<span id="cb90-9">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># measures how distant each predictions is from 1 if it should be 1, how distant it is from 0 if it should be 0</span></span>
<span id="cb90-10">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># and takes the mean of all the distances</span></span>
<span id="cb90-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.where(targets<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>predictions, predictions).mean()</span>
<span id="cb90-12"></span>
<span id="cb90-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need a scalar for the final loss -&gt; the lower the loss value the better</span></span>
<span id="cb90-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># indicates accurate predictions are more confident and when inaccurate predictions are less confident</span></span>
<span id="cb90-15"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Test loss function: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mnist_loss(prds,trgts)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb90-16"></span>
<span id="cb90-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># issue with this loss function is that it assumes all predictions are between 0 and 1</span></span>
<span id="cb90-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sigmoid function always outputs a number between 0 and 1</span></span>
<span id="cb90-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> sigmoid(x):</span>
<span id="cb90-20">  <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span>torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x))</span>
<span id="cb90-21"></span>
<span id="cb90-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># second attempt at a loss function using sigmoid</span></span>
<span id="cb90-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> mnist_loss_sigmoid(predictions, targets):</span>
<span id="cb90-24">    predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> predictions.sigmoid()</span>
<span id="cb90-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> torch.where(targets<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>predictions, predictions).mean()</span>
<span id="cb90-26"></span>
<span id="cb90-27"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Test loss function with sigmoid: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>mnist_loss_sigmoid(prds,trgts)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test loss function: 0.43333330750465393
Test loss function with sigmoid: 0.44596806168556213</code></pre>
</div>
</div>
</section>
<section id="sgd-mini-batches" class="level3">
<h3 class="anchored" data-anchor-id="sgd-mini-batches">SGD + Mini Batches</h3>
<div class="cell" data-outputid="ef36603f-72c1-40fa-98d8-436af5bb6c21">
<div class="sourceCode cell-code" id="cb92" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># SGD + Mini Batches</span></span>
<span id="cb92-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optimization Step - updating the weights based on gradients</span></span>
<span id="cb92-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># need to calculate loss over one or more data items</span></span>
<span id="cb92-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solution: Calculate the average loss for a data items at a time (mini-batch)</span></span>
<span id="cb92-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Batch Size - number of items in mini batch</span></span>
<span id="cb92-6"></span>
<span id="cb92-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># use fastai to build a dataloader object to shuffle data</span></span>
<span id="cb92-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># randomly shuffle data on every epoch before creating mini batches</span></span>
<span id="cb92-9">coll <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>)</span>
<span id="cb92-10">dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(coll, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb92-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Example of randomly generated mini-batch of batch size 5: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(dl)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Example of randomly generated mini-batch of batch size 5: [tensor([ 8,  4,  9,  5, 14]), tensor([ 6,  0, 11,  7, 12]), tensor([ 2, 10,  3, 13,  1])]</code></pre>
</div>
</div>
</section>
<section id="mnist-model-training-loop-using-sgd" class="level3">
<h3 class="anchored" data-anchor-id="mnist-model-training-loop-using-sgd">MNIST Model Training Loop using SGD</h3>
<div class="cell" data-outputid="805805ed-926d-4822-d0de-110997aceafd">
<div class="sourceCode cell-code" id="cb94" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build a training loop for a model</span></span>
<span id="cb94-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize weights and bias randomly</span></span>
<span id="cb94-3">weights <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb94-4">bias <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb94-5"></span>
<span id="cb94-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create DataLoader for the training data</span></span>
<span id="cb94-7">dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(dset, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span>
<span id="cb94-8">xb,yb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> first(dl)</span>
<span id="cb94-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"xb shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>xb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-10"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"xb tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(xb.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"yb shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>yb<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-12"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"yb tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(yb.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-13"></span>
<span id="cb94-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create DataLoader for the validation data</span></span>
<span id="cb94-15">valid_dl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(valid_dset, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span>
<span id="cb94-16"></span>
<span id="cb94-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a Mini-Batch of batch size 4 for testing</span></span>
<span id="cb94-18">batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> train_x[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>]</span>
<span id="cb94-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"batch shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>batch<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"batch tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(batch.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-21"></span>
<span id="cb94-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create Predictions</span></span>
<span id="cb94-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># preds = linear1(batch)</span></span>
<span id="cb94-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(f"predictions: {preds}")</span></span>
<span id="cb94-25"></span>
<span id="cb94-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Measure loss</span></span>
<span id="cb94-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss = mnist_loss_sigmoid(preds, train_y[:4])</span></span>
<span id="cb94-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(f"Loss: {loss}")</span></span>
<span id="cb94-29"></span>
<span id="cb94-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute Gradients</span></span>
<span id="cb94-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss.backward()</span></span>
<span id="cb94-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(f"weights gradient shape: {weights.grad.shape}")</span></span>
<span id="cb94-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(f"Average of weight gradients: {weights.grad.mean()}")</span></span>
<span id="cb94-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(f"bias gradient: {bias.grad}")</span></span>
<span id="cb94-35"></span>
<span id="cb94-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for calculating gradient</span></span>
<span id="cb94-37"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> calc_grad(xb, yb, model):</span>
<span id="cb94-38">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(xb)</span>
<span id="cb94-39">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mnist_loss(preds, yb)</span>
<span id="cb94-40">    loss.backward()</span>
<span id="cb94-41"></span>
<span id="cb94-42"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Test calculating gradients: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>calc_grad(batch, train_y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>], linear1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-43"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Average of weight gradients: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>weights<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>grad<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>mean()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-44"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"bias gradient: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>bias<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>grad<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-45"></span>
<span id="cb94-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># loss.backward adds the gradients of loss to any gradients that are currently stored</span></span>
<span id="cb94-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># so have to set the current gradients to 0 first</span></span>
<span id="cb94-48"></span>
<span id="cb94-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># training loop for an epoch</span></span>
<span id="cb94-50"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> train_epoch(model, lr, params):</span>
<span id="cb94-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> xb,yb <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> dl:</span>
<span id="cb94-52">        calc_grad(xb, yb, model)</span>
<span id="cb94-53">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> params:</span>
<span id="cb94-54">            p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> p.grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>lr</span>
<span id="cb94-55">            p.grad.zero_()</span>
<span id="cb94-56"></span>
<span id="cb94-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check accuracy at this point</span></span>
<span id="cb94-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># print(f"Check Accuracy at this point: {(preds&gt;0.0).float() == train_y[:4]}")</span></span>
<span id="cb94-59"></span>
<span id="cb94-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># function for calculating validation accuracy</span></span>
<span id="cb94-61"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> batch_accuracy(xb, yb):</span>
<span id="cb94-62">    preds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xb.sigmoid()</span>
<span id="cb94-63">    correct <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (preds<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> yb</span>
<span id="cb94-64">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> correct.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>().mean()</span>
<span id="cb94-65"></span>
<span id="cb94-66"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Testing batch accuracy: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>batch_accuracy(linear1(batch), train_y[:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>])<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-67"></span>
<span id="cb94-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># put batches together to create a validation epoch</span></span>
<span id="cb94-69"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> validate_epoch(model):</span>
<span id="cb94-70">    accs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [batch_accuracy(model(xb), yb) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> xb,yb <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> valid_dl]</span>
<span id="cb94-71">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">round</span>(torch.stack(accs).mean().item(), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb94-72"></span>
<span id="cb94-73"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Test validation epoch: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>validate_epoch(linear1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-74"></span>
<span id="cb94-75"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train for 1 epoch and see if things improve</span></span>
<span id="cb94-76">lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.</span></span>
<span id="cb94-77">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> weights, bias</span>
<span id="cb94-78">train_epoch(linear1, lr, params)</span>
<span id="cb94-79"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"check if accuracy has improved from earlier: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>validate_epoch(linear1)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb94-80"></span>
<span id="cb94-81"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train for a few epochs</span></span>
<span id="cb94-82"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>):</span>
<span id="cb94-83">    train_epoch(linear1, lr, params)</span>
<span id="cb94-84">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(validate_epoch(linear1), end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>xb shape: torch.Size([256, 784])
xb tensor rank: 2
yb shape: torch.Size([256, 1])
yb tensor rank: 2
batch shape: torch.Size([4, 784])
batch tensor rank: 2
Test calculating gradients: None
Average of weight gradients: -0.15112045407295227
bias gradient: tensor([-1.])
Testing batch accuracy: 0.0
Test validation epoch: 0.4707
check if accuracy has improved from earlier: 0.9483
0.9538 0.9543 0.9528 0.9528 0.9528 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9538 0.9538 0.9533 0.9533 0.9533 0.9533 </code></pre>
</div>
</div>
</section>
</section>
<section id="pytorch-setup-for-sgd-pytorch-optimizer" class="level2">
<h2 class="anchored" data-anchor-id="pytorch-setup-for-sgd-pytorch-optimizer">PyTorch setup for SGD + Pytorch Optimizer</h2>
<div class="cell" data-outputid="7081a988-ccff-4475-d28e-11ec6f9d650d">
<div class="sourceCode cell-code" id="cb96" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Build SGD Functionality - PyTorch Optimizer</span></span>
<span id="cb96-2"></span>
<span id="cb96-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># intialize weights and biases in a single pytorch class</span></span>
<span id="cb96-4">linear_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb96-5">w,b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> linear_model.parameters()</span>
<span id="cb96-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"weights shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>w<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb96-7"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"weight tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(w.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb96-8"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"bias shape: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>b<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb96-9"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"bias tensor rank: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(b.shape)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb96-10"></span>
<span id="cb96-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pytorch Optimizer Setup</span></span>
<span id="cb96-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">class</span> BasicOptim:</span>
<span id="cb96-13">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>,params,lr): <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params,<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lr <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">list</span>(params),lr</span>
<span id="cb96-14"></span>
<span id="cb96-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> step(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb96-16">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params: p.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-=</span> p.grad.data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.lr</span>
<span id="cb96-17"></span>
<span id="cb96-18">    <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> zero_grad(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>args, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span>kwargs):</span>
<span id="cb96-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> p <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.params: p.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>weights shape: torch.Size([1, 784])
weight tensor rank: 2
bias shape: torch.Size([1])
bias tensor rank: 1</code></pre>
</div>
</div>
<div class="cell" data-outputid="1df949d5-6475-42d0-9ddc-1bf62376f14d">
<div class="sourceCode cell-code" id="cb98" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define training epoch function that use SGD</span></span>
<span id="cb98-2">opt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> BasicOptim(linear_model.parameters(), lr)</span>
<span id="cb98-3"></span>
<span id="cb98-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> train_epoch(model):</span>
<span id="cb98-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> xb,yb <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> dl:</span>
<span id="cb98-6">        calc_grad(xb, yb, model)</span>
<span id="cb98-7">        opt.step()</span>
<span id="cb98-8">        opt.zero_grad()</span>
<span id="cb98-9"></span>
<span id="cb98-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># check validation epoch</span></span>
<span id="cb98-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Check accuracy after adding SGD: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>validate_epoch(linear_model)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb98-12"></span>
<span id="cb98-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update Model Training</span></span>
<span id="cb98-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> train_model(model, epochs):</span>
<span id="cb98-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(epochs):</span>
<span id="cb98-16">        train_epoch(model)</span>
<span id="cb98-17">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(validate_epoch(model), end<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">' '</span>)</span>
<span id="cb98-18"></span>
<span id="cb98-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Test training model: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>train_model(linear_model, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Check accuracy after adding SGD: 0.7631
0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 0.9533 Test training model: None</code></pre>
</div>
</div>
</section>
<section id="train-mnist-model-using-fastai-library" class="level2">
<h2 class="anchored" data-anchor-id="train-mnist-model-using-fastai-library">Train MNIST Model using FastAI Library</h2>
<div class="cell" data-outputid="0de84d4e-6345-4072-f42d-dbbcec9c3a3b">
<div class="sourceCode cell-code" id="cb100" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Modify Model Training Code with FastAI</span></span>
<span id="cb100-2"></span>
<span id="cb100-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define model information that uses SGD</span></span>
<span id="cb100-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># linear_model = nn.Linear(28 * 28,1)</span></span>
<span id="cb100-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># opt = SGD(linear_model.parameters(), lr)</span></span>
<span id="cb100-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train_model(linear_model, 20)</span></span>
<span id="cb100-7"></span>
<span id="cb100-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define new DataLoaders</span></span>
<span id="cb100-9">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoaders(dl, valid_dl)</span>
<span id="cb100-10"></span>
<span id="cb100-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a general purpose Learner class</span></span>
<span id="cb100-12">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), opt_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>SGD,</span>
<span id="cb100-13">                loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mnist_loss_sigmoid, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch_accuracy)</span>
<span id="cb100-14"></span>
<span id="cb100-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Train Model with Learner.fit</span></span>
<span id="cb100-16">learn.fit(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>lr)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="5" class="" max="10" style="width:300px; height:20px; vertical-align: middle;"></progress>
      50.00% [5/10 00:00&lt;00:00]
    </div>
    

<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">batch_accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.637277</td>
<td>0.502527</td>
<td>0.495584</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.352531</td>
<td>0.309337</td>
<td>0.688911</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.136486</td>
<td>0.154489</td>
<td>0.861629</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.063793</td>
<td>0.097085</td>
<td>0.918057</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.036680</td>
<td>0.072898</td>
<td>0.937193</td>
<td>00:00</td>
</tr>
</tbody>
</table>
<p>

    </p><div>
      <progress value="3" class="" max="8" style="width:300px; height:20px; vertical-align: middle;"></progress>
      37.50% [3/8 00:00&lt;00:00 0.0259]
    </div>
    
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">batch_accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.637277</td>
<td>0.502527</td>
<td>0.495584</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.352531</td>
<td>0.309337</td>
<td>0.688911</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.136486</td>
<td>0.154489</td>
<td>0.861629</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.063793</td>
<td>0.097085</td>
<td>0.918057</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.036680</td>
<td>0.072898</td>
<td>0.937193</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.025862</td>
<td>0.059382</td>
<td>0.950442</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.021269</td>
<td>0.050823</td>
<td>0.957802</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.019119</td>
<td>0.045053</td>
<td>0.963690</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.017956</td>
<td>0.040945</td>
<td>0.965653</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.017213</td>
<td>0.037881</td>
<td>0.967615</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="neural-networks" class="level2">
<h2 class="anchored" data-anchor-id="neural-networks">Neural Networks</h2>
<p>Linear classifiers are limited in what they can do. To handle more complex functions we need to add a nonlinear function between two linear classifiers. This is what defines a <strong>neural network</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define a simple neural network</span></span>
<span id="cb101-2"></span>
<span id="cb101-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># randomly intialize weights and biases</span></span>
<span id="cb101-4">w1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>))</span>
<span id="cb101-5">b1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb101-6">w2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb101-7">b2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> init_params(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb101-8"></span>
<span id="cb101-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># def simple_net(xb):</span></span>
<span id="cb101-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     res = xb@w1 + b1</span></span>
<span id="cb101-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     # Rectified Linear Unit - RELU -&gt; replaces every negative number with 0</span></span>
<span id="cb101-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     res = res.max(tensor(0.0))</span></span>
<span id="cb101-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     res = res@w2 + b2</span></span>
<span id="cb101-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     return res</span></span></code></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Pytorch version of a simple neural network</span></span>
<span id="cb102-2">simple_net <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Sequential(</span>
<span id="cb102-3">    nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">28</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>),</span>
<span id="cb102-4">    nn.ReLU(),</span>
<span id="cb102-5">    nn.Linear(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb102-6">)</span></code></pre></div>
</div>
<div class="cell" data-outputid="37cdef1b-a12d-4a30-ba86-51db20b76df2">
<div class="sourceCode cell-code" id="cb103" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply Simplenet to MNIST data</span></span>
<span id="cb103-2">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Learner(dls, simple_net, opt_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>SGD,</span>
<span id="cb103-3">                loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>mnist_loss_sigmoid, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>batch_accuracy)</span>
<span id="cb103-4"></span>
<span id="cb103-5">learn.fit(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">batch_accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.298695</td>
<td>0.416960</td>
<td>0.504907</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.142627</td>
<td>0.227632</td>
<td>0.810108</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.080331</td>
<td>0.116664</td>
<td>0.913150</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.053554</td>
<td>0.079320</td>
<td>0.938175</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.040960</td>
<td>0.061973</td>
<td>0.954367</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.034424</td>
<td>0.052130</td>
<td>0.962218</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.030614</td>
<td>0.045893</td>
<td>0.964671</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.028108</td>
<td>0.041631</td>
<td>0.966143</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.026289</td>
<td>0.038535</td>
<td>0.968106</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.024872</td>
<td>0.036179</td>
<td>0.969578</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>10</td>
<td>0.023721</td>
<td>0.034313</td>
<td>0.971050</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>11</td>
<td>0.022760</td>
<td>0.032791</td>
<td>0.972031</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>12</td>
<td>0.021941</td>
<td>0.031517</td>
<td>0.972031</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>13</td>
<td>0.021234</td>
<td>0.030427</td>
<td>0.973013</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>14</td>
<td>0.020615</td>
<td>0.029480</td>
<td>0.973994</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>15</td>
<td>0.020067</td>
<td>0.028645</td>
<td>0.976448</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>16</td>
<td>0.019578</td>
<td>0.027902</td>
<td>0.977429</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>17</td>
<td>0.019137</td>
<td>0.027234</td>
<td>0.977429</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>18</td>
<td>0.018736</td>
<td>0.026632</td>
<td>0.977920</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>19</td>
<td>0.018370</td>
<td>0.026085</td>
<td>0.978410</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>20</td>
<td>0.018033</td>
<td>0.025586</td>
<td>0.979392</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>21</td>
<td>0.017722</td>
<td>0.025129</td>
<td>0.979882</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>22</td>
<td>0.017433</td>
<td>0.024710</td>
<td>0.980373</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>23</td>
<td>0.017163</td>
<td>0.024323</td>
<td>0.980864</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>24</td>
<td>0.016911</td>
<td>0.023966</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>25</td>
<td>0.016674</td>
<td>0.023635</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>26</td>
<td>0.016451</td>
<td>0.023328</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>27</td>
<td>0.016240</td>
<td>0.023042</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>28</td>
<td>0.016040</td>
<td>0.022775</td>
<td>0.981354</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>29</td>
<td>0.015850</td>
<td>0.022527</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>30</td>
<td>0.015670</td>
<td>0.022294</td>
<td>0.981845</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>31</td>
<td>0.015498</td>
<td>0.022077</td>
<td>0.982336</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>32</td>
<td>0.015334</td>
<td>0.021873</td>
<td>0.982336</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>33</td>
<td>0.015177</td>
<td>0.021682</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>34</td>
<td>0.015026</td>
<td>0.021502</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>35</td>
<td>0.014882</td>
<td>0.021333</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>36</td>
<td>0.014743</td>
<td>0.021173</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>37</td>
<td>0.014609</td>
<td>0.021022</td>
<td>0.982826</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>38</td>
<td>0.014480</td>
<td>0.020880</td>
<td>0.983317</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>39</td>
<td>0.014356</td>
<td>0.020745</td>
<td>0.983317</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell" data-outputid="71e2826f-8449-45f6-9d36-4342525ee976">
<div class="sourceCode cell-code" id="cb104" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># visualize the accuracy of model using simplenet</span></span>
<span id="cb104-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># y axis - accuracy</span></span>
<span id="cb104-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x-axis number of epochs</span></span>
<span id="cb104-4">plt.plot(L(learn.recorder.values).itemgot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3_files/figure-html/cell-63-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="616d9fbd-f560-424d-904f-1471c02533ac">
<div class="sourceCode cell-code" id="cb105" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Final Accuracy of model on the MNIST dataset: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>learn<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>recorder<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>values[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>][<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Final Accuracy of model on the MNIST dataset: 0.983316957950592</code></pre>
</div>
</div>
</section>
<section id="going-deeper-into-deep-learning-neural-networks" class="level2">
<h2 class="anchored" data-anchor-id="going-deeper-into-deep-learning-neural-networks">Going Deeper into Deep Learning + Neural Networks</h2>
<p>The following code below is an 18 layer resnet model with nearly 100% accuracy on the MNIST data. The above code was a simple neural network with 2 layers so the results of resnet-18 on this data show that accuracy improves as we add more layers. One thing to consider are the trade off’s mentioned by Jeremy in the lecture video</p>
<div class="cell" data-outputid="eb3bdc50-02ac-49a5-a938-b25721f7eb07">
<div class="sourceCode cell-code" id="cb107" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Going Deeper into Deep Learning + Neural Networks</span></span>
<span id="cb107-2">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ImageDataLoaders.from_folder(path)</span>
<span id="cb107-3">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, resnet18, pretrained<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb107-4">                    loss_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>F.cross_entropy, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>accuracy)</span>
<span id="cb107-5">learn.fit_one_cycle(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.100045</td>
<td>0.014498</td>
<td>0.994603</td>
<td>00:16</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ol type="1">
<li><a href="https://course.fast.ai/Lessons/lesson3.html">FastAI Lesson 3</a></li>
<li><a href="https://nbviewer.org/github/fastai/fastbook/blob/master/04_mnist_basics.ipynb">FastAI Chapter 4</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/how-does-a-neural-net-really-work">How Does a Neural Net Really Work</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/which-image-models-are-best/">Which Image Models are Best</a></li>
<li><a href="https://youtu.be/aircAruvnKk?feature=shared">3Blue1Brown Neural Networks</a></li>
<li><a href="https://karpathy.ai/zero-to-hero.html">Andrej Karpathy Neural Networks Zero to Hero</a></li>
<li><a href="https://towardsdatascience.com/understanding-dimensions-in-pytorch-6edf9972d3be">Understanding Dimensions in PyTorch</a></li>
<li><a href="https://medium.com/intuitionmath/numpy-sum-axis-intuition-6eb94926a5d1">Understanding Numpy Axis</a></li>
<li><a href="https://pytorch.org/docs/stable/index.html">PyTorch docs</a></li>
<li><a href="https://youtube.com/playlist?list=PLfYUBJiXbdtSLBPJ1GMx-sQWf6iNhb8mM&amp;si=WwPOjgYofy4M9QUW">Jeremy Howard FastAI Live Coding</a></li>
<li><a href="https://docs.fast.ai/">fast.ai docs</a></li>
</ol>


</section>

 ]]></description>
  <category>learning</category>
  <category>fastai</category>
  <category>deep learning</category>
  <guid>https://mozartfish.github.io/blog/posts/fastai-lesson3/fastai-lesson3.html</guid>
  <pubDate>Mon, 18 Dec 2023 08:00:00 GMT</pubDate>
</item>
<item>
  <title>FastAI Lesson 2: Production</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/fastai-lesson2/fastai-lesson2.html</link>
  <description><![CDATA[ 




<section id="announcments" class="level2">
<h2 class="anchored" data-anchor-id="announcments">Announcments</h2>
<p>Finally back! Had some deadlines followed by issues with gradio, kaggle, Firefox gtk, quarto and jupyter but now everything is working for me to publish this post. I’d like to give a shoutout to Kevin Liu for his help in getting up to speed with the updated gradio API. Kevin reviewed my gradio example and took some helpful notes about the errors he ran into which helped me debug the differences between the current version of gradio and that used in Tanishq’s example.</p>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this lesson, Jeremy walks through a bear classification model example and then spends most of the lesson focusing on how to deploy a model into production. The production example in this lesson works well for personal projects but is different from what the process is in industry. I thought it was a useful lesson for how to quickly get a model and simple web interface up and running.</p>
</section>
<section id="my-thoughts" class="level2">
<h2 class="anchored" data-anchor-id="my-thoughts">My Thoughts</h2>
<p>Although Jeremy didn’t directly address this in the lecture video, designing user interfaces for data science tasks is difficult (this is based on my personal experience) because there are many different requirements to satisfy. If your audience is a <strong>boss, manager, team, data scientists</strong>, they probably want to interact with a model ASAP. To save development time and get a basic application working tools like <a href="https://www.gradio.app/">gradio</a>, <a href="https://streamlit.io/">streamlit</a>, <a href="https://altair-viz.github.io/">altair</a> and <a href="https://colab.research.google.com/">colab</a> do a great job but trade <strong>performance, user experience and features</strong> for iteration speed and immediate results. Another audience is <strong>enthusiasts and expert users</strong> who want a core set of features that address <strong>performance, utility, interaction, and end user experience</strong> who may be willing to trade development time for a well crafted interactive data experience. For these needs, tools like <a href="https://d3js.org/">D3</a>, <a href="https://svelte.dev/">Svelte</a>, <a href="https://vuejs.org/">Vue</a>, <a href="https://react.dev/">React</a> will give greater control and freedom for creative expression and delivery but require significant development time and testing.</p>
<p>I would probably start off with gradio or streamlit for prototyping and then gradually work with a designer/web developer to build a scalable performant web interface to interact with the model. Through personal experience, I’ve learned that debugging python code that renders javascript, html and css for the web can be a nightmare especially when working with 1,000+ datapoints for interactive web data interfaces.</p>
<p>Gradio reminded me a lot of streamlit. I liked streamlit for its simplicity in creating components but the downside was that its simplicity offered few opportunities for cusomizing components beyond what streamlit offered. The syntax for both streamlit and gradio were difficult for me to follow initially because during debugging I sometimes ran into web rendering bugs that were caused by the way I used a function from the streamlit/gradio library. Through trial and error I figured out what works but the process took a long time because I couldn’t come up with an effective development process.</p>
<p>I try to avoid using streamlit and gradio whenever I can but the process of learning how to set up gradio and deploying a model + interface on hugging face spaces was definitely worth it. I might come back to this lesson in the future once I finish the rest of the course to experiment with how to build an interface for a model.</p>
</section>
<section id="jeremy-howards-advice" class="level2">
<h2 class="anchored" data-anchor-id="jeremy-howards-advice">Jeremy Howard’s Advice</h2>
<ul>
<li>Train a model before data cleaning because it helps find data issues more quickly and easily.</li>
</ul>
</section>
<section id="terminology" class="level2">
<h2 class="anchored" data-anchor-id="terminology">Terminology</h2>
<p><strong>Object Recognition</strong> - Computers can recognize what items are in an image at least as well as people can.</p>
<p><strong>Object Detection</strong> - Computers can recgonize where objects in an image are, and can highlight their locations and name each found object.</p>
<p><strong>Segmentation</strong> - A sub-area of <code>object detection</code> where every pixel is categorized on what kind of object it is part of</p>
<p><strong>Data Augmentation</strong> - creating random variations of our input data such that they appear different but do not change the information in the data. Augmentation techniques for images include rotation, flipping, perspective warping, brightness, contrast.</p>
</section>
<section id="picasso-or-matisse-model" class="level2">
<h2 class="anchored" data-anchor-id="picasso-or-matisse-model">Picasso or Matisse Model</h2>
<p>Inspired by Jeremy’s bear example, I changed my Picasso Braque example from my previous post and decided to instead try two different artists who weren’t so similar, in this case I chose Henri Matisse and Pablo Picasso. I trained the model the same way I did the Picasso Braques example but one thing I noticed was that some of the images seemed off for a duckduckgo search where duckduckgo would pull up a portrait of Picasso that didn’t look like it was from the same period I was searching. To try and fix this I tried to refresh the notebook runs multiple times until I got base images from actual Picasso and Matisse paintings. Similar to the Picasso Braque example, my Picasso predictions were off even though the label was correct but the Matisse ones were accurate.</p>
<p>After I tried Picasso and Matisse paintings, I tried different Picasso artworks such as his sculptures and got correct classifications. One person I shared the model with tried uploading their family thanksgiving photo to see what happened and the model classified the photo as 97%. This was quite intriguing to me because I had not even trained the model on images other than picasso and matisse paintings. I’m only writing on Lesson 2, but Jeremy’s discussion about transfer learning in Lesson 1 and the book has me wondering if the classification of the 97% Picasso Thanksgiving photo is a bug and use case I didn’t consider or if it has something to do with the resnet-18 base model with how it picked up the color, line and movement.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># install the latest libraries</span></span>
<span id="cb1-2"><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uqq fastai duckduckgo_search</span></code></pre></div>
</div>
<section id="step-1-gather-data" class="level3">
<h3 class="anchored" data-anchor-id="step-1-gather-data">Step 1: Gather Data</h3>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> duckduckgo_search <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ddg_images</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastcore.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># helper function for searching for images</span></span>
<span id="cb2-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> search_images(term, max_images<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb2-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Searching for '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>term<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span>
<span id="cb2-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> L(ddg_images(term, max_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>max_images)).itemgot(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image'</span>)</span></code></pre></div>
</div>
<div class="cell" data-outputid="6469196d-efd1-4e70-f9ae-21da7cae8718" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">urls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> search_images(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pablo Picasso Fauvism Paintings'</span>, max_images<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-2">urls[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'Pablo Picasso Fauvism Paintings'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.10/dist-packages/duckduckgo_search/compat.py:40: UserWarning: ddg_images is deprecated. Use DDGS().images() generator
  warnings.warn("ddg_images is deprecated. Use DDGS().images() generator")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>'https://i.pinimg.com/736x/b5/69/e1/b569e151ba0a9adf0136f5bdd7d4401b.jpg'</code></pre>
</div>
</div>
<div class="cell" data-outputid="3696c818-6658-4da8-dfee-ff9a0553f4ee" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastdownload <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> download_url</span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb7-3">dest <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'picasso.jpg'</span></span>
<span id="cb7-4">download_url(urls[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], dest, show_progress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-5">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(dest)</span>
<span id="cb7-6">im.to_thumb(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson2/fastai-lesson2_files/figure-html/cell-5-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="a8183896-c442-4137-a429-71b716fef8ff" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">download_url(search_images(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Henri Matisse Fauvism Paintings'</span>, max_images<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb8-2">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matisse.jpg'</span>,</span>
<span id="cb8-3">            show_progress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb8-4">Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matisse.jpg'</span>).to_thumb(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'Henri Matisse Fauvism Paintings'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.10/dist-packages/duckduckgo_search/compat.py:40: UserWarning: ddg_images is deprecated. Use DDGS().images() generator
  warnings.warn("ddg_images is deprecated. Use DDGS().images() generator")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson2/fastai-lesson2_files/figure-html/cell-6-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="ad422104-34f2-4d49-a4e2-0b5036eac642" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">searches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pablo Picasso'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Henri Matisse'</span></span>
<span id="cb11-2">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'picasso_or_matisse'</span>)</span>
<span id="cb11-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sleep</span>
<span id="cb11-4"></span>
<span id="cb11-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> searches:</span>
<span id="cb11-6">    dest <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o)</span>
<span id="cb11-7">    dest.mkdir(exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, parents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb11-8">    download_images(dest,urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> fauvism paintings'</span>))</span>
<span id="cb11-9">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server</span></span>
<span id="cb11-10">    download_images(dest,urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> still life fauvism paintings'</span>))</span>
<span id="cb11-11">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server</span></span>
<span id="cb11-12">    download_images(dest,urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> fauvism scenic paintings'</span>))</span>
<span id="cb11-13">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server</span></span>
<span id="cb11-14">    resize_images(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o, max_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, dest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'Pablo Picasso fauvism paintings'
Searching for 'Pablo Picasso still life fauvism paintings'
Searching for 'Pablo Picasso fauvism scenic paintings'
Searching for 'Henri Matisse fauvism paintings'
Searching for 'Henri Matisse still life fauvism paintings'
Searching for 'Henri Matisse fauvism scenic paintings'</code></pre>
</div>
</div>
</section>
<section id="step-2-train-model" class="level3">
<h3 class="anchored" data-anchor-id="step-2-train-model">Step 2: Train Model</h3>
<div class="cell" data-outputid="429acff4-66aa-4a83-edb2-bfe578ead261" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove images that failed to download properly</span></span>
<span id="cb13-2">failed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> verify_images(get_image_files(path))</span>
<span id="cb13-3">failed.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(Path.unlink)</span>
<span id="cb13-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(failed)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>0</code></pre>
</div>
</div>
<div class="cell" data-outputid="012ee09f-5275-4f48-dd64-c22a631d28f8" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split data into training set, validation set</span></span>
<span id="cb15-2">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataBlock(</span>
<span id="cb15-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># specify input type(image), output type(category aka label)</span></span>
<span id="cb15-4">    blocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb15-5">    get_items<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>get_image_files,</span>
<span id="cb15-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split data into 80% training data, and 20% validation data</span></span>
<span id="cb15-7">    splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RandomSplitter(valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>),</span>
<span id="cb15-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define the label</span></span>
<span id="cb15-9">    get_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>parent_label,</span>
<span id="cb15-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># standardize and resize all images to 192 x 192</span></span>
<span id="cb15-11">    item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>)]</span>
<span id="cb15-12">).dataloaders(path, bs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb15-13"></span>
<span id="cb15-14">dls.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson2/fastai-lesson2_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="3337aab5-1727-4520-d4b6-9863c25d2359" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train a resnet model on the data</span></span>
<span id="cb16-2">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, resnet18, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>error_rate)</span>
<span id="cb16-3">learn.fine_tune(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.003311</td>
<td>0.399668</td>
<td>0.160377</td>
<td>00:04</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.362328</td>
<td>0.233523</td>
<td>0.084906</td>
<td>00:02</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.323960</td>
<td>0.221361</td>
<td>0.075472</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.253416</td>
<td>0.133047</td>
<td>0.037736</td>
<td>00:04</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.199347</td>
<td>0.111490</td>
<td>0.037736</td>
<td>00:02</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="step-3-test-model" class="level3">
<h3 class="anchored" data-anchor-id="step-3-test-model">Step 3: Test Model</h3>
<div class="cell" data-outputid="00f7b617-3796-450e-883a-f6dad2b4eb67" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">is_picasso,_,probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.predict(PILImage.create(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'picasso.jpg'</span>))</span>
<span id="cb17-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This is a: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_picasso<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb17-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Probability it's a picasso: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>probs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>This is a: Pablo Picasso.
Probability it's a picasso: 0.0005</code></pre>
</div>
</div>
<div class="cell" data-outputid="008c95d8-0c6a-493c-81a2-ab733366c777" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">is_matisse,_,probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.predict(PILImage.create(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matisse.jpg'</span>))</span>
<span id="cb19-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This is a: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_matisse<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb19-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Probability it's a matisse: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>probs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>This is a: Henri Matisse.
Probability it's a matisse: 0.9936</code></pre>
</div>
</div>
</section>
<section id="step-4-save-and-export-model" class="level3">
<h3 class="anchored" data-anchor-id="step-4-save-and-export-model">Step 4: Save and Export Model</h3>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">learn.export(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'model.pkl'</span>)</span></code></pre></div>
</div>
</section>
</section>
<section id="gradio-hugging-face-spaces" class="level2">
<h2 class="anchored" data-anchor-id="gradio-hugging-face-spaces">Gradio + Hugging Face Spaces</h2>
<p>The following code was originally written by Dr.&nbsp;Tanishq Abraham and published in the blog post: <a href="https://www.tanishq.ai/blog/posts/2021-11-16-gradio-huggingface.html">Gradio + Hugging Face Spaces: A Tutorial</a>. It was modified by me and Kevin Liu to work with the current version of the gradio api. Currently the code works on Hugging Face Spaces but may break in the future as gradio continues updating its API.</p>
<p>My recommendation to get gradio and Hugging Face Spaces working is to start off with Tanishq’s article and consult the gradio documentation to figure out the differences between the current version of the API and the version used in the article. I tried getting the pet classifier example working first before moving on to applying gradio to my Picasso Matisse Model which saved a lot of headache trying to figure out how git LFS and Hugging Face Spaces worked with my example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gradio <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> gr</span>
<span id="cb22-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb22-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> skimage</span>
<span id="cb22-4"></span>
<span id="cb22-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># load model </span></span>
<span id="cb22-6">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> load_learner(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'model.pkl'</span>) </span>
<span id="cb22-7"></span>
<span id="cb22-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define prediction function </span></span>
<span id="cb22-9">labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.dls.vocab</span>
<span id="cb22-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> predict(img):</span>
<span id="cb22-11">    img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PILImage.create(img)</span>
<span id="cb22-12">    pred,pred_idx,probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.predict(img)</span>
<span id="cb22-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> {labels[i]: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(probs[i]) <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(labels))}</span>
<span id="cb22-14"></span>
<span id="cb22-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define interface structure </span></span>
<span id="cb22-16">title <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Picasso or Mattise Classifier"</span></span>
<span id="cb22-17">description <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"A classifier trained on Pablo Picasso and Henri Mattise paintings with fast.ai."</span></span>
<span id="cb22-18">examples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'picasso.jpg'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'matisse.jpg'</span>]</span>
<span id="cb22-19">gr.Interface(fn<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>predict, inputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[gr.Image(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">type</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"pil"</span>)], outputs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>gr.Label(num_top_classes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)).launch(share<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb22-20"></span>
<span id="cb22-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># interpretation = 'default'</span></span>
<span id="cb22-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># enable_queue = True </span></span>
<span id="cb22-23"></span>
<span id="cb22-24"></span>
<span id="cb22-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># def greet(name):</span></span>
<span id="cb22-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#     return "Hello " + name + "!!"</span></span>
<span id="cb22-27"></span>
<span id="cb22-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># iface = gr.Interface(fn=greet, inputs="text", outputs="text")</span></span>
<span id="cb22-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># iface.launch()</span></span></code></pre></div>
</div>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ol type="1">
<li><a href="https://huggingface.co/spaces/mozartfish/picasso_or_matisse">Picasso or Mattise Gradio + Hugging Face Spaces Application</a></li>
<li><a href="https://course.fast.ai/Lessons/lesson2.html">FastAI Lesson 2</a></li>
<li><a href="https://nbviewer.org/github/fastai/fastbook/blob/master/02_production.ipynb">FastAI Chapter 2</a></li>
<li><a href="https://www.tanishq.ai/blog/posts/2021-11-16-gradio-huggingface.html">Gradio + Hugging Face Spaces: A Tutorial</a></li>
<li><a href="https://www.youtube.com/watch?v=8X4u9sca3Io">How to Set Up an SSH Key(GitHub, Hugging Face Spaces)</a></li>
<li><a href="https://huggingface.co/spaces">Hugging Face Spaces</a></li>
<li><a href="https://www.gradio.app/docs/interface">Gradio docs</a></li>
<li><a href="https://youtube.com/playlist?list=PLfYUBJiXbdtSLBPJ1GMx-sQWf6iNhb8mM&amp;si=WwPOjgYofy4M9QUW">Jeremy Howard FastAI Live Coding</a></li>
<li><a href="https://docs.fast.ai/">fastai docs</a></li>
</ol>


</section>

 ]]></description>
  <category>learning</category>
  <category>fastai</category>
  <category>deep learning</category>
  <guid>https://mozartfish.github.io/blog/posts/fastai-lesson2/fastai-lesson2.html</guid>
  <pubDate>Thu, 30 Nov 2023 08:00:00 GMT</pubDate>
</item>
<item>
  <title>FastAI Lesson 1: Getting Started</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/fastai-lesson1/fastai-lesson1.html</link>
  <description><![CDATA[ 




<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>In this lesson, Jeremy walks through a bird classification example which back in 2015 was considered the bleeding edge of state of the art. 8 years later, it’s hard to believe that I can run this on my own local machine. Even though my training is in computer science, I found some of the definitions and the code in this lesson challenging. <a href="https://nbviewer.org/github/fastai/fastbook/blob/master/01_intro.ipynb">Chapter 1</a> goes over the terms in depth and was very helpful for understanding the concepts described in <code>lesson 1</code> I would strongly recommend checking out the definitions in this chapter because they are still used today when talking about more advanced models like GPT-4.</p>
</section>
<section id="terminology" class="level2">
<h2 class="anchored" data-anchor-id="terminology">Terminology</h2>
<ul>
<li><p><strong>Machine Learning</strong> - The training of programs developed by teaching a computer learn from experience rather than coding the individual steps</p></li>
<li><p><strong>Deep Learning</strong> - A computer technique that uses layers of neural networks to extract and transform data. Neural networks layers are trained by algorithms that minimize their errors and improve their accuracy. This is how a network learns to perform a specific task. Deep learning is a sub-discipline of <code>machine learning</code>.</p></li>
<li><p><strong>Dataset</strong> - A bunch of data ie. images, sounds, text, files or anything else.</p></li>
<li><p><strong>Label</strong> - The data we’re trying to predict ie. dog or cat.</p></li>
<li><p><strong>Independent Variable</strong> - Data that does not include labels</p></li>
<li><p><strong>Dependent Variable</strong> - the correct label ie. dog or cat. Also called <strong>targets.</strong></p></li>
<li><p><strong>Architecture</strong> - The structure of the model we’re trying to fit. A mathematical function that we’re passing the input data and parameters to.</p></li>
<li><p><strong>Parameters</strong> - The values in the model that change what task it can do and are updated through model training. In Arthur Samuel’s definitions the synonym for parameters is weights which has a different meaning in modern deep learning.</p></li>
<li><p><strong>Parameter(Weight) Assignment</strong> - Particular choice of values for parameters.</p></li>
<li><p><strong>Weights</strong> - A particular type of model parameter.</p></li>
<li><p><strong>Fit</strong> - Update the model parameters such that the predictions of the model using the input data match the target labels.</p></li>
<li><p><strong>Train</strong> - Synoym for fit.</p></li>
<li><p><strong>Pretrained Model</strong> - A model that has already been trained, generally using a large dataset and will be fine-tuned ie. resnet class of models.</p></li>
<li><p><strong>Fine-Tune</strong> - Update a pretrained model for a different task.</p></li>
<li><p><strong>Epoch</strong> - One complete pass through the input data.</p></li>
<li><p><strong>Loss</strong> - A measure of how good the model is, chosen to drive training via <code>Stochastic Gradient Descent (SGD)</code>.</p></li>
<li><p><strong>Metric</strong> - A measurement of how good the model is, using the validation set, chosen for human consumption.</p></li>
<li><p><strong>Validation Set</strong> - A set of data held out from training, used only for measuring how good the model is.</p></li>
<li><p><strong>Training Set</strong> - The data used for fitting the model; does not include any data from the validation set.</p></li>
<li><p><strong>Overfitting</strong> - Training a model in such a way that it remembers specific features of the input data rather than generalizing.</p></li>
<li><p><strong>Convolutional Neural Network (CNN)</strong> - A type of neural network that works particularly well for computer vision tasks.</p></li>
<li><p><strong>Transfer Learning</strong> - Using a pretrained model for a task different to what it was originally trained for.</p></li>
<li><p><strong>Head Layer</strong> - When using a pretrained model, replace the last layer with one or more layers with randomized weights of an appropriate size for the dataset you are working with. This customizes a model specifically for your task when using a pretrained model.</p></li>
</ul>
</section>
<section id="limitations-of-machine-learning" class="level2">
<h2 class="anchored" data-anchor-id="limitations-of-machine-learning">Limitations of Machine Learning</h2>
<ol type="1">
<li>A model cannot be created without data</li>
<li>A model can only learn to operate on patterns seen in input data used to train it</li>
<li>This learning approach only creates <code>predictions</code> <strong>not</strong> <code>recommend actions</code></li>
<li>We need <code>labels</code> + <code>data</code> (pictures of dogs and cats that have labels saying which ones are dogs and which ones are cats)</li>
</ol>
</section>
<section id="is-it-a-bird-example" class="level2">
<h2 class="anchored" data-anchor-id="is-it-a-bird-example">Is It a Bird? Example</h2>
<p>The following code in this example is created and written by Jeremy Howard and FastAI as found in the example <a href="https://www.kaggle.com/code/jhoward/is-it-a-bird-creating-a-model-from-your-own-data">Is it a bird? Creating a model from your own data</a>. My modification was adding comments for myself to the data block section so that I could understand what each part of the datablock is doing.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:05:02.130923Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:05:02.130165Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:05:18.134163Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:05:18.132504Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:05:02.130893Z&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os </span>
<span id="cb1-2">iskaggle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> os.environ.get(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'KAGGLE_KERNEL_RUN_TYPE'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb1-3"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">if</span> iskaggle:</span>
<span id="cb1-4">    <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!</span>pip install <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Uqq fastai duckduckgo_search</span></code></pre></div>
</div>
<section id="step-1-gather-data" class="level3">
<h3 class="anchored" data-anchor-id="step-1-gather-data">Step 1: Gather Data</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:11:11.575122Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:11:11.574696Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:11:11.933428Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:11:11.932692Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:11:11.575080Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> duckduckgo_search <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> ddg_images </span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastcore.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> </span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># helper function for searching for images </span></span>
<span id="cb2-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">def</span> search_images(term, max_images<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>):</span>
<span id="cb2-6">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Searching for '</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>term<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'"</span>)</span>
<span id="cb2-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">return</span> L(ddg_images(term, max_results<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>max_images)).itemgot(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'image'</span>)</span></code></pre></div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:11:50.875794Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:11:50.875301Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:11:51.988151Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:11:51.987179Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:11:50.875763Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">urls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> search_images(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bird photos'</span>, max_images<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-2">urls[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'bird photos'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/duckduckgo_search/compat.py:40: UserWarning: ddg_images is deprecated. Use DDGS().images() generator
  warnings.warn("ddg_images is deprecated. Use DDGS().images() generator")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>'https://images.alphacoders.com/492/492674.jpg'</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:13:07.435284Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:13:07.434751Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:13:15.880636Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:13:15.879720Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:13:07.435241Z&quot;}" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastdownload <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> download_url </span>
<span id="cb7-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb7-3">dest <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bird.jpg'</span></span>
<span id="cb7-4">download_url(urls[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], dest, show_progress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb7-5">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(dest)</span>
<span id="cb7-6">im.to_thumb(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span>
<span id="cb7-7"></span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/scipy/__init__.py:146: UserWarning: A NumPy version &gt;=1.16.5 and &lt;1.23.0 is required for this version of SciPy (detected version 1.24.3
  warnings.warn(f"A NumPy version &gt;={np_minversion} and &lt;{np_maxversion}"</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson1/fastai-lesson1_files/figure-html/cell-5-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:15:07.714114Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:15:07.713714Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:15:09.048645Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:15:09.047656Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:15:07.714085Z&quot;}" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">download_url(search_images(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'forest photos'</span>, max_images<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'forest.jpg'</span>, </span>
<span id="cb9-2">             show_progress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb9-3">Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'forest.jpg'</span>).to_thumb(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'forest photos'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/duckduckgo_search/compat.py:40: UserWarning: ddg_images is deprecated. Use DDGS().images() generator
  warnings.warn("ddg_images is deprecated. Use DDGS().images() generator")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="5">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson1/fastai-lesson1_files/figure-html/cell-6-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:19:42.776156Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:19:42.775040Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:21:22.118506Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:21:22.117220Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:19:42.776115Z&quot;}" data-execution_count="6">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">searches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'forest'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bird'</span></span>
<span id="cb12-2">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bird_or_not'</span>)</span>
<span id="cb12-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sleep </span>
<span id="cb12-4"></span>
<span id="cb12-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> searches:</span>
<span id="cb12-6">    dest <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o)</span>
<span id="cb12-7">    dest.mkdir(exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, parents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb12-8">    download_images(dest, urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> photo'</span>))</span>
<span id="cb12-9">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server</span></span>
<span id="cb12-10">    download_images(dest, urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> sun photo'</span>))</span>
<span id="cb12-11">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server </span></span>
<span id="cb12-12">    download_images(dest, urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> shade photo'</span>))</span>
<span id="cb12-13">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server </span></span>
<span id="cb12-14">    resize_images(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o, max_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, dest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'forest photo'
Searching for 'forest sun photo'
Searching for 'forest shade photo'
Searching for 'bird photo'
Searching for 'bird sun photo'
Searching for 'bird shade photo'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/duckduckgo_search/compat.py:40: UserWarning: ddg_images is deprecated. Use DDGS().images() generator
  warnings.warn("ddg_images is deprecated. Use DDGS().images() generator")</code></pre>
</div>
</div>
</section>
<section id="step-2-train-model" class="level3">
<h3 class="anchored" data-anchor-id="step-2-train-model">Step 2: Train Model</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:21:43.415508Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:21:43.415132Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:21:44.330428Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:21:44.329327Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:21:43.415478Z&quot;}" data-execution_count="8">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove images that failed to download properly </span></span>
<span id="cb15-2">failed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> verify_images(get_image_files(path))</span>
<span id="cb15-3">failed.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(Path.unlink)</span>
<span id="cb15-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(failed)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<pre><code>3</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:24:10.522517Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:24:10.522169Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:24:15.181854Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:24:15.180708Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:24:10.522489Z&quot;}" data-execution_count="14">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split data into training set, validation set </span></span>
<span id="cb17-2">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataBlock(</span>
<span id="cb17-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># specify input type(image), output type(category aka label)</span></span>
<span id="cb17-4">    blocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb17-5">    get_items<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>get_image_files,</span>
<span id="cb17-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split data into 80% training data, and 20% validation data</span></span>
<span id="cb17-7">    splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RandomSplitter(valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>),</span>
<span id="cb17-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define the label </span></span>
<span id="cb17-9">    get_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>parent_label,</span>
<span id="cb17-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># standardize and resize all images to 192 x 192</span></span>
<span id="cb17-11">    item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>)]</span>
<span id="cb17-12">).dataloaders(path, bs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb17-13"></span>
<span id="cb17-14">dls.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson1/fastai-lesson1_files/figure-html/cell-9-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:29:36.801651Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:29:36.800809Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:29:42.341723Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:29:42.340624Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:29:36.801604Z&quot;}" data-execution_count="18">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train resnet on the data</span></span>
<span id="cb18-2">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, resnet18, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>error_rate)</span>
<span id="cb18-3">learn.fine_tune(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.744936</td>
<td>0.402673</td>
<td>0.156250</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.178611</td>
<td>0.097689</td>
<td>0.031250</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.117756</td>
<td>0.136063</td>
<td>0.031250</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.079709</td>
<td>0.154602</td>
<td>0.031250</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="step-3-test-model" class="level3">
<h3 class="anchored" data-anchor-id="step-3-test-model">Step 3: Test Model</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:29:43.986183Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:29:43.985792Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:29:44.105360Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:29:44.104307Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:29:43.986152Z&quot;}" data-execution_count="19">
<div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">is_bird,_,probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.predict(PILImage.create(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bird.jpg'</span>))</span>
<span id="cb19-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This is a : </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_bird<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb19-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Probability it's a bird: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>probs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>This is a : bird.
Probability it's a bird: 0.9996</code></pre>
</div>
</div>
</section>
</section>
<section id="picasso-cubist-painting-or-georges-braque-cubist-painting" class="level2">
<h2 class="anchored" data-anchor-id="picasso-cubist-painting-or-georges-braque-cubist-painting">Picasso Cubist Painting or Georges Braque Cubist Painting</h2>
<p>This code was written by me based on Jeremy and FastAI’s bird example. I picked this example because of an interest in art, the similarity between Picasso and Braque’s cubist art, and the question of whether a computer would be able to tell the difference between the two artists when shown a random cubist painting by either Picasso or Braque.</p>
<section id="step-1-gather-data-1" class="level3">
<h3 class="anchored" data-anchor-id="step-1-gather-data-1">Step 1: Gather Data</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:32:56.351463Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:32:56.351013Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:32:57.031947Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:32:57.031020Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:32:56.351430Z&quot;}" data-execution_count="20">
<div class="sourceCode cell-code" id="cb21" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1">urls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> search_images(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pablo Picasso Cubist Painting'</span>, max_images<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb21-2">urls[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'Pablo Picasso Cubist Painting'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/opt/conda/lib/python3.10/site-packages/duckduckgo_search/compat.py:40: UserWarning: ddg_images is deprecated. Use DDGS().images() generator
  warnings.warn("ddg_images is deprecated. Use DDGS().images() generator")</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>'http://www.baaqii.com/promanage/productimage/OP/OP0288.jpg'</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:33:24.105350Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:33:24.104946Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:33:24.810112Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:33:24.809127Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:33:24.105319Z&quot;}" data-execution_count="21">
<div class="sourceCode cell-code" id="cb25" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastdownload <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> download_url </span>
<span id="cb25-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> fastai.vision.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">all</span> <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span></span>
<span id="cb25-3">dest <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'picasso.jpg'</span></span>
<span id="cb25-4">download_url(urls[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], dest, show_progress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb25-5">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(dest)</span>
<span id="cb25-6">im.to_thumb(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson1/fastai-lesson1_files/figure-html/cell-13-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:34:37.957206Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:34:37.956156Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:34:38.684411Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:34:38.683411Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:34:37.957157Z&quot;}" data-execution_count="22">
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1">download_url(search_images(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Georges Braque Cubist Painting'</span>, max_images<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], </span>
<span id="cb26-2">             <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'braque.jpg'</span>, </span>
<span id="cb26-3">             show_progress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb26-4">Image.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">open</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'braque.jpg'</span>).to_thumb(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'George Braque Cubist Painting'</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="22">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson1/fastai-lesson1_files/figure-html/cell-14-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:39:27.385024Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:39:27.384560Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:40:49.816235Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:40:49.814961Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:39:27.384989Z&quot;}" data-execution_count="27">
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1">searches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Pablo Picasso'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Georges Braque'</span></span>
<span id="cb28-2">path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Path(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'picasso_or_braque'</span>)</span>
<span id="cb28-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> time <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> sleep </span>
<span id="cb28-4"></span>
<span id="cb28-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-style: inherit;">for</span> o <span class="kw" style="color: #003B4F;
background-color: null;
font-style: inherit;">in</span> searches:</span>
<span id="cb28-6">    dest <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o)</span>
<span id="cb28-7">    dest.mkdir(exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, parents<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb28-8">    download_images(dest, urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> cubist painting'</span>))</span>
<span id="cb28-9">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server</span></span>
<span id="cb28-10">    download_images(dest, urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> fauvist painting'</span>))</span>
<span id="cb28-11">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server </span></span>
<span id="cb28-12">    download_images(dest, urls<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>search_images(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>o<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> geometric painting'</span>))</span>
<span id="cb28-13">    sleep(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sleep between searches to avoid spamming server </span></span>
<span id="cb28-14">    resize_images(path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o, max_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, dest<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>path<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>o)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Searching for 'Pablo Picasso cubist painting'
Searching for 'Pablo Picasso fauvist painting'
Searching for 'Pablo Picasso geometric painting'
Searching for 'George Braque cubist painting'
Searching for 'George Braque fauvist painting'
Searching for 'George Braque geometric painting'</code></pre>
</div>
</div>
</section>
<section id="step-2-train-model-1" class="level3">
<h3 class="anchored" data-anchor-id="step-2-train-model-1">Step 2: Train Model</h3>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:40:49.819938Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:40:49.819467Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:40:50.977727Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:40:50.976477Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:40:49.819897Z&quot;}" data-execution_count="28">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># remove images that failed to download properly </span></span>
<span id="cb30-2">failed <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> verify_images(get_image_files(path))</span>
<span id="cb30-3">failed.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">map</span>(Path.unlink)</span>
<span id="cb30-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(failed)</span></code></pre></div>
<div class="cell-output cell-output-display" data-execution_count="28">
<pre><code>2</code></pre>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:40:50.979956Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:40:50.979488Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:40:51.979411Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:40:51.978394Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:40:50.979914Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split data into training set, validation set </span></span>
<span id="cb32-2">dls <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataBlock(</span>
<span id="cb32-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># specify input type(image), output type(category aka label)</span></span>
<span id="cb32-4">    blocks<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(ImageBlock, CategoryBlock),</span>
<span id="cb32-5">    get_items<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>get_image_files,</span>
<span id="cb32-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># split data into 80% training data, and 20% validation data</span></span>
<span id="cb32-7">    splitter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>RandomSplitter(valid_pct<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span>, seed<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>),</span>
<span id="cb32-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># define the label </span></span>
<span id="cb32-9">    get_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>parent_label,</span>
<span id="cb32-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># standardize and resize all images to 192 x 192</span></span>
<span id="cb32-11">    item_tfms<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[Resize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">192</span>, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'squish'</span>)]</span>
<span id="cb32-12">).dataloaders(path, bs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>)</span>
<span id="cb32-13"></span>
<span id="cb32-14">dls.show_batch(max_n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">
<p><img src="https://mozartfish.github.io/blog/posts/fastai-lesson1/fastai-lesson1_files/figure-html/cell-17-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:43:02.501100Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:43:02.499961Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:43:10.282060Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:43:10.280941Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:43:02.501063Z&quot;}" data-execution_count="30">
<div class="sourceCode cell-code" id="cb33" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># train resnet on the data</span></span>
<span id="cb33-2">learn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vision_learner(dls, resnet18, metrics<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>error_rate)</span>
<span id="cb33-3">learn.fine_tune(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.963409</td>
<td>0.409861</td>
<td>0.157143</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.281930</td>
<td>0.232642</td>
<td>0.057143</td>
<td>00:01</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.227495</td>
<td>0.084337</td>
<td>0.028571</td>
<td>00:01</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.163790</td>
<td>0.051675</td>
<td>0.014286</td>
<td>00:01</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="step-3-test-model-1" class="level3">
<h3 class="anchored" data-anchor-id="step-3-test-model-1">Step 3: Test Model</h3>
<p>There is something wrong here because the probability is incorrect. I can’t figure out whether I messed up in the data phase, architecture choice (resnet34 instead of resnet18), or a programming mistake. My guess is that the program should have a probability of choosing the right result around the same percentage as the bird example. If anyone knows what the issue might be, please reach out.</p>
<div class="cell" data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-11-22T07:47:00.809792Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-11-22T07:47:00.808871Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-11-22T07:47:00.889913Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-11-22T07:47:00.888745Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-11-22T07:47:00.809752Z&quot;}" data-execution_count="32">
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1">is_picasso,_,probs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> learn.predict(PILImage.create(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'picasso.jpg'</span>))</span>
<span id="cb34-2"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"This is a: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>is_picasso<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb34-3"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Probability it's a picasso: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>probs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>This is a: Pablo Picasso.
Probability it's a picasso: 0.0006</code></pre>
</div>
</div>
</section>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ol type="1">
<li><a href="https://course.fast.ai/Lessons/lesson1.html">FastAI Lesson 1</a></li>
<li><a href="https://nbviewer.org/github/fastai/fastbook/blob/master/01_intro.ipynb">FastAI Chapter 1</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/jupyter-notebook-101">Jupyter Notebook 101</a></li>
<li><a href="https://www.kaggle.com/code/jhoward/is-it-a-bird-creating-a-model-from-your-own-data">Is it a bird? Creating a model from your own data</a></li>
<li><a href="https://docs.fast.ai/tutorial.vision.html">fastai computer vision tutorial</a></li>
</ol>


</section>

 ]]></description>
  <category>learning</category>
  <category>fastai</category>
  <category>deep learning</category>
  <guid>https://mozartfish.github.io/blog/posts/fastai-lesson1/fastai-lesson1.html</guid>
  <pubDate>Tue, 21 Nov 2023 08:00:00 GMT</pubDate>
</item>
<item>
  <title>FastAI Lesson 0: How to FastAI</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/fastai-lesson0/index.html</link>
  <description><![CDATA[ 




<p>I’ve recently started <a href="https://course.fast.ai/">FastAI Practical Deep Learning for Coders</a> to learn about machine learning. To hold myself accountable and finish the course I am going to try to write a blog post for every video in the series starting with <code>Lesson 0</code>. By doing this my goal is to not only learn about deep learning and track my progress but reinforce my learning by trying to explain what I’ve learned for people new to machine learning like me. <a href="https://www.youtube.com/watch?v=gGxe2mN3kAg">Lesson 0</a> isn’t officially presented in the course until <a href="https://course.fast.ai/Lessons/lesson3.html">Lesson 3</a> but it provides valuable advice for how to complete FastAI and actually learn how to write deep learning code.</p>
<p>Lesson 0 doesn’t have any code examples or notebooks but I took Jeremy’s advice about blogging and interacting with the community by setting up this Quarto blog as the Lesson 0 project. Lesson 0 was created in 2020 <em>before</em> <strong>Twitter</strong> became <strong>X</strong> and closed off to people who didn’t have an account. Since then, some of the ML community and other academic communities in CS have migrated to <code>Discord</code> , <code>Mastodon</code>, and <code>Bluesky</code>. I’d recommend checking out the <code>FastAI Forums</code>, <code>FastAI Discord</code>, and <code>BlueSky</code>.</p>
<section id="jeremy-howards-advice" class="level2">
<h2 class="anchored" data-anchor-id="jeremy-howards-advice">Jeremy Howard’s Advice</h2>
<ol type="1">
<li>Commit to finish the course</li>
<li>Try to finish one really good project to show off what you’ve learned in the course</li>
<li>Share and blog about your work</li>
</ol>
</section>
<section id="how-to-watch-a-fastai-lesson" class="level2">
<h2 class="anchored" data-anchor-id="how-to-watch-a-fastai-lesson">How to Watch A FastAI Lesson</h2>
<p>This advice was presented by Jeremy Howard in <code>Lesson 0</code></p>
<ol type="1">
<li><p>Watch FastAI Lecture</p></li>
<li><p>Run notebooks and code presented in the lecture and experiment with code</p></li>
<li><p>Reproduce notebook from a clean notebook (Jeremy provides clean notebooks on github)</p></li>
<li><p>Repeat with a different dataset (could be personal project)</p></li>
</ol>
</section>
<section id="resources" class="level2">
<h2 class="anchored" data-anchor-id="resources">Resources</h2>
<ol type="1">
<li><p><a href="https://www.youtube.com/watch?v=gGxe2mN3kAg">FastAI Lesson 0</a></p></li>
<li><p><a href="https://christinemcleavey.com/learning-about-deep-learning/">Christine Mcleavey’s Blog</a></p></li>
<li><p><a href="https://quarto.org/">Quarto</a></p></li>
<li><p><a href="https://bsky.app/">Bluesky</a></p></li>
<li><p><a href="https://forums.fast.ai/">fast.ai Forum</a></p></li>
</ol>


</section>

 ]]></description>
  <category>learning</category>
  <category>fastai</category>
  <category>deep learning</category>
  <guid>https://mozartfish.github.io/blog/posts/fastai-lesson0/index.html</guid>
  <pubDate>Sun, 19 Nov 2023 08:00:00 GMT</pubDate>
</item>
<item>
  <title>Welcome To My Blog</title>
  <dc:creator>Pranav Rajan</dc:creator>
  <link>https://mozartfish.github.io/blog/posts/welcome/index.html</link>
  <description><![CDATA[ 




<p>This is my first blog post. Welcome!</p>
<p>I decided to start a blog inspired by Jeremy Howard’s Lecture 0 from the FastAI Course. Jeremy and FastAI used to maintain a blogging and publication tool called FastPages but transitioned to a new publication system called Quarto.</p>
<p>This blog is written in Quarto. Why Quarto? In the past I had attempted to used Medium and Substack but never fully spent the time to learn the tools to write a blog post. I decided to learn and publish with Quarto because of its capabilities to produce high quality scientific and technical documents with the ability to embed code and visualizations for review. Another reason why I like Quarto is how easy it is to write markdown and publish a blog.</p>
<p>Going forward I hope to use Quarto to write about my programming projects, thoughts,and improve my writing.</p>



 ]]></description>
  <category>news</category>
  <guid>https://mozartfish.github.io/blog/posts/welcome/index.html</guid>
  <pubDate>Sun, 19 Nov 2023 08:00:00 GMT</pubDate>
  <media:content url="https://mozartfish.github.io/blog/posts/welcome/thumbnail.jpg" medium="image" type="image/jpeg"/>
</item>
</channel>
</rss>
